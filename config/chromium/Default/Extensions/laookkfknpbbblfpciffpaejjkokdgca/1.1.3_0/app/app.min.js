/*! Momentum Dashboard - app.min.js
Copyright (c) 2013-2018 Momentum Dashboard Corp. All rights reserved.

All portions of this file are the confidential and proprietary
intellectual property of Momentum Dashboard Corp.

*/
function initializeBookmarksPlaceHolder(){"true"==localStorage.getItem("bookmarksEnabled")&&(document.getElementsByClassName("bookmarks-placeholder")[0].style.display="block")}initializeBookmarksPlaceHolder(),window.m=_.extend({$window:$(window),appView:"",globals:{},models:{},collect:{},views:{},addins:{},utils:{},bootstrappers:{},commands:{},templates:{},widgets:[]},Backbone.Events),Backbone.View=function(t){return t.extend({constructor:function(e){this.options=e||{},t.apply(this,arguments)}})}(Backbone.View);var backboneSync=Backbone.sync;Backbone.sync=function(e,t,i){(i=i||{}).beforeSend=function(e){setMomentumAuthHeader(e),e.overrideMimeType("application/json")},backboneSync(e,t,i)},m.templates=m.templates||{},m.templates.background=m.templates.background||{},m.templates.background["background-info"]=Handlebars.template({1:function(e,t,i,s){return' <i class="icon icon-angle-right"></i> '},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l="function",r=this.escapeExpression;return'<span class="background-info-title">'+(null!=(o=typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:a)===l?n.call(e,{name:"title",hash:{},data:s}):n)?o:"")+(null!=(o=t.if.call(e,null!=e?e.hasDetailUrl:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+'</span>\n<span class="background-info-source">\n\t<span class="background-info-source-link" data-url="'+r(typeof(n=null!=(n=t.sourceUrl||(null!=e?e.sourceUrl:e))?n:a)===l?n.call(e,{name:"sourceUrl",hash:{},data:s}):n)+'">'+r(typeof(n=null!=(n=t.attribution||(null!=e?e.attribution:e))?n:a)===l?n.call(e,{name:"attribution",hash:{},data:s}):n)+'</span><span class="control control-heart '+r(typeof(n=null!=(n=t.fav_class||(null!=e?e.fav_class:e))?n:a)===l?n.call(e,{name:"fav_class",hash:{},data:s}):n)+'"><img src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh" title="Next Background"><img src="img/icon-refresh.svg" class="icon icon-refresh"></span>\n</span>\n'},useData:!0}),m.templates.background["background-template-1"]=Handlebars.template({1:function(e,t,i,s){return' <i class="icon icon-angle-right"></i> '},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l="function",r=this.escapeExpression;return'<span class="background-info-title">'+(null!=(o=typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:a)===l?n.call(e,{name:"title",hash:{},data:s}):n)?o:"")+(null!=(o=t.if.call(e,null!=e?e.hasDetailUrl:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+'</span>\n<span class="background-info-source">\n\t<span class="background-info-source-link" data-url="'+r(typeof(n=null!=(n=t.sourceUrl||(null!=e?e.sourceUrl:e))?n:a)===l?n.call(e,{name:"sourceUrl",hash:{},data:s}):n)+'">\n\t\t<span>Shot on a </span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 42 24"><path class="a" d="M16.78,13,19.9,0h6.85L23.19,14.75c-.68,2.84-2.82,3.53-4.79,3.53H2.62c-1.73,0-3.19-.74-2.4-4L1.64,8.37A4.44,4.44,0,0,1,6.22,4.71h11l-.89,3.68H10.72c-.83,0-1.28.17-1.51,1.13L8.3,13.28c-.32,1.34.15,1.43,1.15,1.43H14.6C15.54,14.71,16.37,14.66,16.78,13ZM35.35,4.67,32.13,18.23h6.65L42,4.67ZM24.53,15.86a4.31,4.31,0,0,1-4.16,3.54c-.17,0-5.13,0-5.13,0L14.12,24h9.33c2.44,0,6.05-1.24,7.34-6.58l3.1-12.75H27.24Z"/></svg><span class="dji mavic" style="font-weight: 600;"> MAVIC </span><span class="dji air" style="font-weight: 100;">AIR</span>\n\t</span><span class="control control-heart '+r(typeof(n=null!=(n=t.fav_class||(null!=e?e.fav_class:e))?n:a)===l?n.call(e,{name:"fav_class",hash:{},data:s}):n)+'"><img src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh" title="Next Background"><img src="img/icon-refresh.svg" class="icon icon-refresh"></span>\n</span>\n'},useData:!0}),m.templates=m.templates||{},m.templates.baseMetric=m.templates.baseMetric||{},m.templates.baseMetric.baseMetric=Handlebars.template({1:function(e,t,i,s){return'\t\t\t\t\t\t\t\t\t\t<li class="archive">Un-archive</li>\n'},3:function(e,t,i,s){return'\t\t\t\t\t\t\t\t\t\t<li class="archive">Archive</li>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l=this.escapeExpression,r="function";return'<div class="app-dash metric-dash metric-dash-empty" title="Add a '+l((t.lower||e&&e.lower||a).call(e,null!=e?e.metricType:e,{name:"lower",hash:{},data:s}))+'">\n\t<div class="metric-item">\n\t\t<div class="metric-stat">\n\t\t\t<span class="sets-height">+</span>\n\t\t\t<span class="absolute">\n\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 533.33 533.33"><path d="M516.67,200H333.33V16.67A16.66,16.66,0,0,0,316.67,0h-100A16.67,16.67,0,0,0,200,16.67V200H16.67A16.67,16.67,0,0,0,0,216.67v100a16.66,16.66,0,0,0,16.67,16.66H200V516.67a16.66,16.66,0,0,0,16.67,16.66h100a16.66,16.66,0,0,0,16.66-16.66V333.33H516.67a16.66,16.66,0,0,0,16.66-16.66v-100A16.66,16.66,0,0,0,516.67,200Z"/></svg>\n\t\t\t</span>\n\t\t</div>\n\t\t<div class="metric-label">'+l(typeof(n=null!=(n=t.metricType||(null!=e?e.metricType:e))?n:a)===r?n.call(e,{name:"metricType",hash:{},data:s}):n)+'</div>\n\t</div>\n</div>\n\n<div class="app-dash metric-dash has-multiple">\n</div>\n\n<div class="app-wrapper nipple-top-right">\n\t<div class="app app-metric nipple-top-right">\n\t\t<div class="subviews-wrapper">\n\t\t\t<div class="subviews">\x3c!--\n\t\t\t--\x3e<div class="subview metric-archive">\n\t\t\t\t<header class="header">\n\t\t\t\t\t<span class="title">Archive</span>\n\t\t\t\t\t<div class="controls">\n\t\t\t\t\t\t<span class="control icon-wrapper back"><i class="icon icon-right"></i></span>\n\t\t\t\t\t</div>\n\t\t\t\t</header>\n\t\t\t\t<div class="body">\n\t\t\t\t\t<div class="message hidden">\n\t\t\t\t\t\t<span class="loading hidden"><span class="loading-placeholder"></span><span class="loading-label">Loading...</span></span>\n\t\t\t\t\t\t<span class="error hidden">Trouble connecting… <span class="action retry">Retry</span></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<ul class="metric-list">\n\t\t\t\t\t\t\t<li class="empty">\n\t\t\t\t\t\t\t\t<div class="title">No '+l((t.lower||e&&e.lower||a).call(e,null!=e?e.metricTitle:e,{name:"lower",hash:{},data:s}))+' archived</div>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t</ul>\n\n\t\t\t\t</div>\n\t\t\t\t</div>\x3c!--\n\t\t\t\t--\x3e<div class="subview list-view metric-home">\n\t\t\t\t\t<header class="header">\n\t\t\t\t\t\t<span class="title">'+l(typeof(n=null!=(n=t.metricTitle||(null!=e?e.metricTitle:e))?n:a)===r?n.call(e,{name:"metricTitle",hash:{},data:s}):n)+'</span>\n\t\t\t\t\t\t<div class="controls">\n\t\t\t\t\t\t\t<div class="control add">\n\t\t\t\t\t\t\t\t<div class="icon-wrapper">\n\t\t\t\t\t\t\t\t\t<i class="icon-plus"></i>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t<div class="control more">\n\t\t\t\t\t\t\t\t<div class="icon-wrapper more-toggle">\n\t\t\t\t\t\t\t\t\t<i class="icon-ellipsis more-icon"></i>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="dropdown more-dropdown">\n\t\t\t\t\t\t\t\t\t<ul class="dropdown-list">\n\t\t\t\t\t\t\t\t\t\t<li class="show-archived">\n\t\t\t\t\t\t\t\t\t\t\tGo to Archive\n\t\t\t\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t\t\t\t<li class="toggle-random" title="Show a random chosen '+l((t.lower||e&&e.lower||a).call(e,null!=e?e.metricType:e,{name:"lower",hash:{},data:s}))+' each load">\n\t\t\t\t\t\t\t\t\t\t\t<span class="setting-title">Show Random</span>\n\t\t\t\t\t\t\t\t\t\t\t<span class="toggle-slider"><svg class="toggle-switch" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg></span>\n\t\t\t\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</header>\n\t\t\t\t\t<div class="body">\n\t\t\t\t\t\t<div class="empty">\n\t\t\t\t\t\t\t<div class="title">No '+l((t.lower||e&&e.lower||a).call(e,null!=e?e.metricTitle:e,{name:"lower",hash:{},data:s}))+' yet</div>\n\t\t\t\t\t\t\t<div class="description">'+l(typeof(n=null!=(n=t.metricDescription||(null!=e?e.metricDescription:e))?n:a)===r?n.call(e,{name:"metricDescription",hash:{},data:s}):n)+'</div>\n\t\t\t\t\t\t\t<div class="button add">New '+l(typeof(n=null!=(n=t.metricType||(null!=e?e.metricType:e))?n:a)===r?n.call(e,{name:"metricType",hash:{},data:s}):n)+'</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<ul class="metric-list">\n\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\n\t\t\t\t</div>\x3c!--\n\t\t\t\t--\x3e<div class="subview metric-detail metric-detail-add">\n\t\t\t\t\t<header class="header">\n\t\t\t\t\t\t<div class="control">\n\t\t\t\t\t\t\t<div class="icon-wrapper back">\n\t\t\t\t\t\t\t\t<i class="icon icon-left"></i>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="edit-mode controls">\n\t\t\t\t\t\t\t<div class="control more">\n\t\t\t\t\t\t\t\t<div class="icon-wrapper more-toggle">\n\t\t\t\t\t\t\t\t\t<i class="icon-ellipsis more-icon"></i>\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t<div class="dropdown more-dropdown">\n\t\t\t\t\t\t\t\t\t<ul class="dropdown-list">\n'+(null!=(o=t.if.call(e,null!=e?e.archived:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.program(3,s,0),data:s}))?o:"")+'\t\t\t\t\t\t\t\t\t\t<li class="delete">Delete</li>\n\t\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</header>\n\t\t\t\t\t<div class="body"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>\n'},useData:!0}),m.templates.baseMetric.defaultInstance=Handlebars.template({1:function(e,t,i,s){var o;return" (Random "+this.escapeExpression("function"==typeof(o=null!=(o=t.metricType||(null!=e?e.metricType:e))?o:t.helperMissing)?o.call(e,{name:"metricType",hash:{},data:s}):o)+")"},3:function(e,t,i,s){var o;return'<span class="list-control list-pin'+(null!=(o=t.if.call(e,null!=e?e.pinned:e,{name:"if",hash:{},fn:this.program(4,s,0),inverse:this.noop,data:s}))?o:"")+'"><svg class="icon icon-pin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 481.715 481.715"><path d="M470.951 106.124L375.59 10.765c-14.352-14.352-37.611-14.352-51.976 0a36.695 36.695 0 0 0-10.762 25.965c0 7.133 2.114 14.055 5.938 19.961L191.378 166.288c-13.12-6.07-27.472-9.416-42.217-9.416a100.534 100.534 0 0 0-71.104 29.459c-13.763 13.777-13.763 36.086 0 49.863l57.309 57.324L0 481.714l188.197-135.365 57.309 57.31c13.76 13.762 36.1 13.762 49.879 0a100.597 100.597 0 0 0 29.439-71.103c0-14.729-3.327-29.08-9.397-42.186l109.615-127.443c5.889 3.82 12.794 5.938 19.929 5.938a36.684 36.684 0 0 0 25.98-10.777c14.352-14.353 14.352-37.612 0-51.964z"/></svg></span>'},4:function(e,t,i,s){return" active "},6:function(e,t,i,s){return'<span class="list-control list-unarchive"><svg class="icon icon-unarchive" title="Unarchive" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 438.53 438.53"><path d="M421.12,134.19q-17.4-40.54-46.81-69.95t-70-46.82a216.26,216.26,0,0,0-166.3-1.57A221.7,221.7,0,0,0,68.24,60.53L31.12,23.7q-8.57-8.86-19.7-4Q0,24.56,0,36.55v127.9A17.56,17.56,0,0,0,5.43,177.3a17.56,17.56,0,0,0,12.85,5.43h127.9q12,0,16.85-11.42,4.84-11.15-4-19.71l-39.12-39.39a141.7,141.7,0,0,1,45.69-29,144.9,144.9,0,0,1,53.67-10.14A142.56,142.56,0,0,1,276,84.65a144.79,144.79,0,0,1,77.94,77.95,144.69,144.69,0,0,1,0,113.34A144.79,144.79,0,0,1,276,353.89a145,145,0,0,1-172-45.26q-2-2.85-6.57-3.43a10.28,10.28,0,0,0-7.14,2.57l-39.11,39.4A8.49,8.49,0,0,0,48.68,353a10.24,10.24,0,0,0,1.86,6.43,214.2,214.2,0,0,0,75.37,58.38,217.74,217.74,0,0,0,93.36,20.7,213.31,213.31,0,0,0,85.08-17.41q40.54-17.42,69.95-46.82t46.82-69.95a216.59,216.59,0,0,0,0-170.16Z" transform="translate(0 0)"/></svg></span>'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l="function",r=this.escapeExpression;return'<div class="metric-data" title="'+r(typeof(n=null!=(n=t.tooltip||(null!=e?e.tooltip:e))?n:a)===l?n.call(e,{name:"tooltip",hash:{},data:s}):n)+(null!=(o=t.if.call(e,null!=e?e.random:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+'">\n\t<div class="metric-stat-row">\n\t\t<div class="metric-stat">\n\t\t\t<span class="metric-stat-number">'+r(typeof(n=null!=(n=t.time||(null!=e?e.time:e))?n:a)===l?n.call(e,{name:"time",hash:{},data:s}):n)+'</span><span class="metric-stat-unit">'+r(typeof(n=null!=(n=t.unit||(null!=e?e.unit:e))?n:a)===l?n.call(e,{name:"unit",hash:{},data:s}):n)+'</span>\n\t\t</div>\n\n\t\t<div class="list-controls">\n\t\t\t<span class="list-control list-edit"><svg class="icon icon-gear" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340.274 340.274"><path d="M293.629 127.806l-5.795-13.739c19.846-44.856 18.53-46.189 14.676-50.08l-25.353-24.77-2.516-2.12h-2.937c-1.549 0-6.173 0-44.712 17.48l-14.184-5.719c-18.332-45.444-20.212-45.444-25.58-45.444h-35.765c-5.362 0-7.446-.006-24.448 45.606l-14.123 5.734C86.848 43.757 71.574 38.19 67.452 38.19l-3.381.105-27.27 26.737c-4.138 3.891-5.582 5.263 15.402 49.425l-5.774 13.691C0 146.097 0 147.838 0 153.33v35.068c0 5.501 0 7.44 46.585 24.127l5.773 13.667c-19.843 44.832-18.51 46.178-14.655 50.032l25.353 24.8 2.522 2.168h2.951c1.525 0 6.092 0 44.685-17.516l14.159 5.758c18.335 45.438 20.218 45.427 25.598 45.427h35.771c5.47 0 7.41 0 24.463-45.589l14.195-5.74c26.014 11 41.253 16.585 45.349 16.585l3.404-.096 27.479-26.901c3.909-3.945 5.278-5.309-15.589-49.288l5.734-13.702c46.496-17.967 46.496-19.853 46.496-25.221V151.88c-.005-5.519-.005-7.446-46.644-24.074zM170.128 228.474c-32.798 0-59.504-26.187-59.504-58.364 0-32.153 26.707-58.315 59.504-58.315 32.78 0 59.43 26.168 59.43 58.315-.006 32.177-26.656 58.364-59.43 58.364z"></path></svg></span>\n\n\t\t\t'+(null!=(o=t.unless.call(e,null!=e?e.archived:e,{name:"unless",hash:{},fn:this.program(3,s,0),inverse:this.noop,data:s}))?o:"")+"\n\n\t\t\t"+(null!=(o=t.if.call(e,null!=e?e.archived:e,{name:"if",hash:{},fn:this.program(6,s,0),inverse:this.noop,data:s}))?o:"")+'\n\t\t</div>\n\t</div>\n\t<span class="metric-label">'+r(typeof(n=null!=(n=t.nameOrPlaceholder||(null!=e?e.nameOrPlaceholder:e))?n:a)===l?n.call(e,{name:"nameOrPlaceholder",hash:{},data:s}):n)+"</span>\n</div>\n"},useData:!0}),m.templates=m.templates||{},m.templates.bookmarks=m.templates.bookmarks||{},m.templates.bookmarks.bookmark=Handlebars.template({1:function(e,t,i,s){return"local"},3:function(e,t,i,s){var o;return'<span class="bookmark-label">'+this.escapeExpression("function"==typeof(o=null!=(o=t.title||(null!=e?e.title:e))?o:t.helperMissing)?o.call(e,{name:"title",hash:{},data:s}):o)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l="function",r=this.escapeExpression;return'<a draggable="false" href="'+r(typeof(n=null!=(n=t.url||(null!=e?e.url:e))?n:a)===l?n.call(e,{name:"url",hash:{},data:s}):n)+'" title="'+r(typeof(n=null!=(n=t.tooltip||(null!=e?e.tooltip:e))?n:a)===l?n.call(e,{name:"tooltip",hash:{},data:s}):n)+'" class="bookmark '+r(typeof(n=null!=(n=t.classes||(null!=e?e.classes:e))?n:a)===l?n.call(e,{name:"classes",hash:{},data:s}):n)+" "+(null!=(o=t.if.call(e,null!=e?e.local:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+'"><img draggable="false" src="'+r(typeof(n=null!=(n=t.favicon_url||(null!=e?e.favicon_url:e))?n:a)===l?n.call(e,{name:"favicon_url",hash:{},data:s}):n)+'" class="bookmark-icon">'+(null!=(o=t.if.call(e,null!=e?e.title:e,{name:"if",hash:{},fn:this.program(3,s,0),inverse:this.noop,data:s}))?o:"")+"</a>\n"},useData:!0}),m.templates.bookmarks.bookmarkfolder=Handlebars.template({1:function(e,t,i,s){var o;return'<span class="bookmark-folder-label">'+this.escapeExpression("function"==typeof(o=null!=(o=t.label||(null!=e?e.label:e))?o:t.helperMissing)?o.call(e,{name:"label",hash:{},data:s}):o)+"</span>"},3:function(e,t,i,s){var o;return'<span class="bookmark-label">'+this.escapeExpression("function"==typeof(o=null!=(o=t.title||(null!=e?e.title:e))?o:t.helperMissing)?o.call(e,{name:"title",hash:{},data:s}):o)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l="function",r=this.escapeExpression;return'<span draggable="false" class="bookmark toggle-folder main-button '+r(typeof(n=null!=(n=t.classes||(null!=e?e.classes:e))?n:a)===l?n.call(e,{name:"classes",hash:{},data:s}):n)+'" title="'+r(typeof(n=null!=(n=t.tooltip||(null!=e?e.tooltip:e))?n:a)===l?n.call(e,{name:"tooltip",hash:{},data:s}):n)+'">\n\t'+(null!=(o=t.unless.call(e,null!=e?e.title:e,{name:"unless",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+'\n\n\t\x3c!-- Folder icon --\x3e\n\t<svg draggable="false" class="bookmark-icon bookmark-icon-folder" xmlns="http://www.w3.org/2000/svg" width="510" height="510" viewBox="0 0 510 510"><path d="M204 51H51C22.95 51 0 73.95 0 102v306c0 28.05 22.95 51 51 51h408c28.05 0 51-22.95 51-51V153c0-28.05-22.95-51-51-51H255l-51-51z"/></svg>\x3c!--\n\n\t--\x3e'+(null!=(o=t.if.call(e,null!=e?e.title:e,{name:"if",hash:{},fn:this.program(3,s,0),inverse:this.noop,data:s}))?o:"")+'\n\n\t<ul class= "bookmarks-folder-list"></ul>\n</span>\n'},useData:!0}),m.templates.bookmarks.bookmarks=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<div class="bookmarks-wrapper" style="left:0">\n\t<ul class="bookmarks-list" id="active-bookmarks">\n\t</ul>\n\t<ul class="bookmarks-list" id="active-bookmarks-alt">\n\t</ul>\n\t<div class="bookmarks-guide">\n\t\t<div class="bookmarks-guide-wrapper"><img src="/img/icon-pointer.svg" class="bookmarks-guide-icon"> Drag for more bookmarks</div>\n\t</div>\n</div>\n'},useData:!0}),m.templates.bookmarks.primer=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o;return'<div class="overlay-permissions-content">\n\t<div class="overlay-permissions-icon"><i class="icon-angle-up"></i></div>\n\t<div class="overlay-permissions-content-title">Would you like to see your bookmarks?</div>\n\t<div class="overlay-permissions-content-description">'+this.escapeExpression("function"==typeof(o=null!=(o=t.browser||(null!=e?e.browser:e))?o:t.helperMissing)?o.call(e,{name:"browser",hash:{},data:s}):o)+" requires your permission.</div>\n</div>\n"},useData:!0}),m.templates=m.templates||{},m.templates.centerclock=m.templates.centerclock||{},m.templates.centerclock.clock=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="time">'+l(typeof(o=null!=(o=t.time||(null!=e?e.time:e))?o:n)===a?o.call(e,{name:"time",hash:{},data:s}):o)+'</div>\n<span class="format">'+l(typeof(o=null!=(o=t.format||(null!=e?e.format:e))?o:n)===a?o.call(e,{name:"format",hash:{},data:s}):o)+"</span>\n"},useData:!0}),m.templates=m.templates||{},m.templates.focus=m.templates.focus||{},m.templates.focus["focus-prompt-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<h3>What is your main focus for today?</h3>\n<input type="text">'},useData:!0}),m.templates.focus["focus-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return"<h3>"+l(typeof(o=null!=(o=t.day||(null!=e?e.day:e))?o:n)===a?o.call(e,{name:"day",hash:{},data:s}):o)+'</h3>\n<span class="control checkbox"><i class="icon icon-checkbox-empty focus-open"></i><i class="icon icon-checkbox focus-done"></i></span><p class="todays-focus">'+l(typeof(o=null!=(o=t.focus||(null!=e?e.focus:e))?o:n)===a?o.call(e,{name:"focus",hash:{},data:s}):o)+'</p><span class="control delete"><i>✕</i></span>\n'},useData:!0}),m.templates.focus["focuses-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<ol></ol>\n<div class="message focus-message">\n    <i class="loading-icon"></i>Loading...</span>\n</div>\n'},useData:!0}),m.templates=m.templates||{},m.templates.greeting=m.templates.greeting||{},m.templates.greeting["greeting-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'Good <span class="period">'+l(typeof(o=null!=(o=t.period||(null!=e?e.period:e))?o:n)===a?o.call(e,{name:"period",hash:{},data:s}):o)+'</span>, <span class="name" spellcheck="false">'+l(typeof(o=null!=(o=t.name||(null!=e?e.name:e))?o:n)===a?o.call(e,{name:"name",hash:{},data:s}):o)+"</span>.\n"},useData:!0}),m.templates=m.templates||{},m.templates.introduction=m.templates.introduction||{},m.templates.introduction["introduction-button-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o;return'<button class="button">'+this.escapeExpression("function"==typeof(o=null!=(o=t.value||(null!=e?e.value:e))?o:t.helperMissing)?o.call(e,{name:"value",hash:{},data:s}):o)+"</button>"},useData:!0}),m.templates.introduction["introduction-content-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o;return'<div class="prompt">\n\t<div class="question"><span class="question-title">'+this.escapeExpression("function"==typeof(o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing)?o.call(e,{name:"message",hash:{},data:s}):o)+'</span></div>\n\t<div class="tip"></div>\n</div>\n<div class="buttons"></div>\n'},useData:!0}),m.templates.introduction["introduction-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<p class="logo"><img src="img/logo-white.svg"></p>\n<p class=content></p>\n'},useData:!0}),m.templates.introduction["introduction-tip-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o;return"<div>"+this.escapeExpression("function"==typeof(o=null!=(o=t.value||(null!=e?e.value:e))?o:t.helperMissing)?o.call(e,{name:"value",hash:{},data:s}):o)+"</div>"},useData:!0}),m.templates=m.templates||{},m.templates.metric=m.templates.metric||{},m.templates.metric.widget=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'<div><span class="metric-stat">'+l(typeof(o=null!=(o=t.statvalue||(null!=e?e.statvalue:e))?o:n)===a?o.call(e,{name:"statvalue",hash:{},data:s}):o)+'</span></div><span class="metric-label">'+l(typeof(o=null!=(o=t.statlabel||(null!=e?e.statlabel:e))?o:n)===a?o.call(e,{name:"statlabel",hash:{},data:s}):o)+"</span>"},useData:!0}),m.templates=m.templates||{},m.templates.notification=m.templates.notification||{},m.templates.notification.notification=Handlebars.template({1:function(e,t,i,s){var o,n;return'<div class="notification-title">'+(null!=(o=t.if.call(e,null!=e?e.icon_url:e,{name:"if",hash:{},fn:this.program(2,s,0),inverse:this.noop,data:s}))?o:"")+this.escapeExpression("function"==typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:t.helperMissing)?n.call(e,{name:"title",hash:{},data:s}):n)+"</div>"},2:function(e,t,i,s){var o;return'<img class="notification-icon" src="'+this.escapeExpression("function"==typeof(o=null!=(o=t.icon_url||(null!=e?e.icon_url:e))?o:t.helperMissing)?o.call(e,{name:"icon_url",hash:{},data:s}):o)+'">'},4:function(e,t,i,s){var o;return'<button class="notification-button">'+this.escapeExpression("function"==typeof(o=null!=(o=t.cta_text||(null!=e?e.cta_text:e))?o:t.helperMissing)?o.call(e,{name:"cta_text",hash:{},data:s}):o)+"</button>"},6:function(e,t,i,s){var o;return'<span class="button-text secondary-text">'+this.escapeExpression("function"==typeof(o=null!=(o=t.secondary_text||(null!=e?e.secondary_text:e))?o:t.helperMissing)?o.call(e,{name:"secondary_text",hash:{},data:s}):o)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n;return'<div class="app-wrapper nipple-bottom-left">\n\t<div class="app notification-app">\n\t\t<div class="icon-wrapper notification-hide"><i class="icon">✕</i></div>\n\t\t'+(null!=(o=t.if.call(e,null!=e?e.title:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+'\n\t\t<div class="notification-description">'+this.escapeExpression("function"==typeof(n=null!=(n=t.message||(null!=e?e.message:e))?n:t.helperMissing)?n.call(e,{name:"message",hash:{},data:s}):n)+"</div>\n\t\t"+(null!=(o=t.if.call(e,null!=e?e.cta_cmd:e,{name:"if",hash:{},fn:this.program(4,s,0),inverse:this.noop,data:s}))?o:"")+(null!=(o=t.if.call(e,null!=e?e.secondary_cmd:e,{name:"if",hash:{},fn:this.program(6,s,0),inverse:this.noop,data:s}))?o:"")+"\n\t</div>\n</div>\n"},useData:!0}),m.templates=m.templates||{},m.templates.quicklinks=m.templates.quicklinks||{},m.templates.quicklinks.dashlinks=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<span class="app-dash optional-link toggle toggle-icon toggle-chrome-tab" data-momo-id="chromeTab" data-place="dash" data-url="chrome-search://local-ntp/local-ntp.html" title="Chrome Tab"><svg class="icon-svg icon-chrome-tab" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 497.401 497.401"><g><path d="M478.742 154.382H320.714c28.366 21.765 47.111 55.717 47.111 94.307 0 30.63-14.345 56.386-30.933 79.445-28.322 39.41-95.817 168.878-95.817 168.878 2.567.043 5.026.388 7.636.388 137.341 0 248.69-111.348 248.69-248.69-.022-33.412-6.709-65.229-18.659-94.328z"/><path d="M248.172 129.619c54.402-.388 217.628-2.049 217.628-2.049C423.24 51.511 342.069 0 248.69 0 170.819 0 101.361 35.829 55.782 91.848l75.972 134.925c10.268-55.113 58.349-96.744 116.418-97.154z"/><path d="M248.668 367.825c-51.964 0-91.568-35.117-111.974-79.855-20.535-45.018-98.061-171.984-98.061-171.984C14.301 154.425 0 199.832 0 248.69c0 124.744 91.935 227.744 211.696 245.648l77.288-134.019c-12.641 4.615-26.101 7.506-40.316 7.506z"/><circle cx="248.668" cy="248.711" r="80.416"/></g></svg></span>\x3c!--\n--\x3e<span class="app-dash optional-link toggle toggle-icon toggle-apps" data-momo-id="apps" data-place="dash" data-url="chrome://apps" title="Apps"><svg class="icon-svg icon-apps" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M3 3h6v6H3V3zm10 0h6v6h-6V3zm10 0h6v6h-6V3zM3 13h6v6H3v-6zm10 0h6v6h-6v-6zm10 0h6v6h-6v-6zM3 23h6v6H3v-6zm10 0h6v6h-6v-6zm10 0h6v6h-6v-6z"/></svg></span>\n'},useData:!0}),m.templates.quicklinks["quicklinks-item-template"]=Handlebars.template({1:function(e,t,i,s){return' class="local"'},3:function(e,t,i,s){var o;return'<img src="'+this.escapeExpression("function"==typeof(o=null!=(o=t.favicon_url||(null!=e?e.favicon_url:e))?o:t.helperMissing)?o.call(e,{name:"favicon_url",hash:{},data:s}):o)+'">'},5:function(e,t,i,s){return' <span class="link-icon-placeholder">&nbsp;</span> '},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l="function",r=this.escapeExpression;return'<div draggable="true" class="'+r(typeof(n=null!=(n=t.classes||(null!=e?e.classes:e))?n:a)===l?n.call(e,{name:"classes",hash:{},data:s}):n)+'">\n\t<a draggable="false" href="'+r(typeof(n=null!=(n=t.url||(null!=e?e.url:e))?n:a)===l?n.call(e,{name:"url",hash:{},data:s}):n)+'"'+(null!=(o=t.if.call(e,null!=e?e.local:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+">"+(null!=(o=t.if.call(e,null!=e?e.favicon_url:e,{name:"if",hash:{},fn:this.program(3,s,0),inverse:this.program(5,s,0),data:s}))?o:"")+" "+r(typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:a)===l?n.call(e,{name:"title",hash:{},data:s}):n)+'</a>\n\t<div class="icon-wrapper destroy"><i draggable="false" class="icon">✕</i></div>\n</div>\n'},useData:!0}),m.templates.quicklinks["quicklinks-template"]=Handlebars.template({1:function(e,t,i,s){return'\t\t\t<li data-momo-id="chromeTab" data-place="links" class="optional-link"><a href="chrome-search://local-ntp/local-ntp.html" class="local"><svg class="icon-svg icon-chrome-tab" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 497.401 497.401"><g><path d="M478.742 154.382H320.714c28.366 21.765 47.111 55.717 47.111 94.307 0 30.63-14.345 56.386-30.933 79.445-28.322 39.41-95.817 168.878-95.817 168.878 2.567.043 5.026.388 7.636.388 137.341 0 248.69-111.348 248.69-248.69-.022-33.412-6.709-65.229-18.659-94.328z"/><path d="M248.172 129.619c54.402-.388 217.628-2.049 217.628-2.049C423.24 51.511 342.069 0 248.69 0 170.819 0 101.361 35.829 55.782 91.848l75.972 134.925c10.268-55.113 58.349-96.744 116.418-97.154z"/><path d="M248.668 367.825c-51.964 0-91.568-35.117-111.974-79.855-20.535-45.018-98.061-171.984-98.061-171.984C14.301 154.425 0 199.832 0 248.69c0 124.744 91.935 227.744 211.696 245.648l77.288-134.019c-12.641 4.615-26.101 7.506-40.316 7.506z"/><circle cx="248.668" cy="248.711" r="80.416"/></g></svg> Chrome Tab</a></li>\n\t\t\t<li data-momo-id="apps" class="optional-link" data-place="links"><a href="chrome://apps" id="app-return" class="local"><svg class="icon-svg icon-apps" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M3 3h6v6H3V3zm10 0h6v6h-6V3zm10 0h6v6h-6V3zM3 13h6v6H3v-6zm10 0h6v6h-6v-6zm10 0h6v6h-6v-6zM3 23h6v6H3v-6zm10 0h6v6h-6v-6zm10 0h6v6h-6v-6z"/></svg> Apps</a></li>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o;return'<span class="app-dash toggle" href="">Links</span>\n\n<div class="app-wrapper nipple-top-left">\n\t<div class="app links-app">\n\t\t<div class="message"><i class="loading-icon"></i><span class="loading-label">Loading...</span></div>\n\t\t<ol class="links-list">\n'+(null!=(o=t.if.call(e,null!=e?e.isChrome:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+'\t\t</ol>\n\t\t<div class="empty">\n\t\t\t<div class="title">No links yet</div>\n\t\t\t<div class="description">Add your favorite links</div>\n\t\t\t<span class="button new-toggle empty-toggle">New Link</span>\n\t\t</div>\n\t\t<div class="footer-input new">\n\t\t\t<div class="icon-wrapper new-hide"><i class="icon">✕</i></div>\n\t\t\t<input type="text" id="new-title" class="new-title new-toggle" placeholder="New Link">\n\t\t\t<input type="text" id="new-url" class="new-url" placeholder="URL">\n\t\t</div>\n\t</div>\n</div>\n'},useData:!0}),m.templates=m.templates||{},m.templates.quote=m.templates.quote||{},m.templates.quote.quote=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'<p class="quote-body">\n\t<span class="quote-body-text">&ldquo;'+l(typeof(o=null!=(o=t.body||(null!=e?e.body:e))?o:n)===a?o.call(e,{name:"body",hash:{},data:s}):o)+'&rdquo;</span><i class="icon-angle-right"></i>\n\t<span class="quote-source"><span class="quote-source-text">'+l(typeof(o=null!=(o=t.source||(null!=e?e.source:e))?o:n)===a?o.call(e,{name:"source",hash:{},data:s}):o)+'</span><span class="control control-heart '+l(typeof(o=null!=(o=t.fav_class||(null!=e?e.fav_class:e))?o:n)===a?o.call(e,{name:"fav_class",hash:{},data:s}):o)+'"><img src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh"><img src="img/icon-refresh.svg" class="icon icon-refresh"></span><span data-url="'+l(typeof(o=null!=(o=t.twitterIntentUrl||(null!=e?e.twitterIntentUrl:e))?o:n)===a?o.call(e,{name:"twitterIntentUrl",hash:{},data:s}):o)+'" class="control control-twitter"><i class="icon icon-twitter"></i></span></span>\n</p>'},useData:!0}),m.templates=m.templates||{},m.templates.settings=m.templates.settings||{},m.templates.settings.about=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o;return'<img src="img/logo.svg" class="logo logo-color">\n<img src="img/logo-white.svg" class="logo logo-white">\n<h3>Momentum</h3>\n<p class="made">Personal Dashboard <span id="momo-version">v'+this.escapeExpression("function"==typeof(o=null!=(o=t.version||(null!=e?e.version:e))?o:t.helperMissing)?o.call(e,{name:"version",hash:{},data:s}):o)+'</span></p>\n<p class="thanks">Thank you for your support!</p>\n<p class="links">\n\t<a href="http://momentumdash.com/help" target="_blank">Feedback</a>\n\t<a href="http://momentumdash.com" target="_blank">Website</a>\n\t<a href="http://momentumdash.com/blog" target="_blank">Blog</a>\n\t<a href="http://www.instagram.com/momentumdash" target="_blank">Instagram</a>\n\t<a href="https://www.facebook.com/momentumdash" target="_blank">Facebook</a>\n\t<a href="https://twitter.com/momentumdash" target="_blank">Twitter</a>\n</p>\n<div class="footer">\n\t<span class="footer-made">Made with &#9829; in beautiful BC, Canada</span><span class="separator">・</span><span class="footer-links"><a href="https://momentumdash.com/policies">Terms &amp; Privacy</a></span>\n</div>\n'},useData:!0}),m.templates.settings["color-picker-popup"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<div class="cp-color-picker nipple-bottom-right">\n    <div class="cp-xy-slider">\n        <div class="cp-white"></div>\n        <div class="cp-xy-cursor"></div>\n    </div>\n    <div class="cp-z-slider">\n        <div class="cp-z-cursor"></div>\n    </div>\n    <div class="cp-alpha-container">\n        <div class="cp-alpha">\n            <div class="cp-alpha-cursor"></div>\n        </div>\n    </div>\n</div>'},useData:!0}),m.templates.settings["color-picker"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<div class="swatch-container"><div class="swatch" style="background: #222;"></div></div>'},useData:!0}),m.templates.settings.connect=Handlebars.template({1:function(e,t,i,s){return"GitHub"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l="function",r=this.escapeExpression;return'<span class="icon-wrapper back" title="Back"><i class="icon icon-angle-left"></i></span>\n\n<section class="provider">\n\t<div class="provider-logo-box">\n\t\t<img  src="'+r(typeof(n=null!=(n=t.large_icon_url||(null!=e?e.large_icon_url:e))?n:a)===l?n.call(e,{name:"large_icon_url",hash:{},data:s}):n)+'" class="provider-logo '+(null!=(o=t.if.call(e,null!=e?e.GitHub:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+'">\n\t</div>\n\t<h2 class="provider-title">Connect to '+r(typeof(n=null!=(n=t.provider_title||(null!=e?e.provider_title:e))?n:a)===l?n.call(e,{name:"provider_title",hash:{},data:s}):n)+'</h2>\n</section>\n\x3c!--<section class="extra-info">--\x3e\n\t\x3c!--<label for="blah">Please enter your account name</label>--\x3e\n\t\x3c!--<input type="text" name="blah" id="blah" class="input">--\x3e\n\x3c!--</section>--\x3e\n\n<p class="description">A secure window will open.</p>\n<section class="button-group">\n\t<span id="connect-button" class="button">Connect</span>\n\t<p class="description">Momentum won\'t ever have access to your login information.</p>\n</section>\n'},useData:!0}),m.templates.settings["general-toggle-options"]=Handlebars.template({1:function(e,t,i,s){return'<span class="badge plus-badge">PLUS</span>'},3:function(e,t,i,s,o,n){var a;return null!=(a=t.unless.call(e,s&&s.last,{name:"unless",hash:{},fn:this.program(4,s,0,o,n),inverse:this.program(9,s,0,o,n),data:s}))?a:""},4:function(e,t,i,s,o,n){var a,l,r=this.lambda,d=this.escapeExpression,c=t.helperMissing,h="function";return'\t\t\t\t<span class="toggle-option '+d(r(null!=n[2]?n[2].widget:n[2],e))+'" data-related-widget="'+d(r(null!=n[2]?n[2].widget:n[2],e))+'" data-option-value='+d(typeof(l=null!=(l=t.value||(null!=e?e.value:e))?l:c)===h?l.call(e,{name:"value",hash:{},data:s}):l)+'><div class="sub-view"></div>'+d(typeof(l=null!=(l=t.label||(null!=e?e.label:e))?l:c)===h?l.call(e,{name:"label",hash:{},data:s}):l)+"</span>"+(null!=(a=t.if.call(e,null!=e?e.breakafter:e,{name:"if",hash:{},fn:this.program(5,s,0,o,n),inverse:this.program(7,s,0,o,n),data:s}))?a:"")+"\n"},5:function(e,t,i,s){return"<br>"},7:function(e,t,i,s){return' <span class="toggle-divider">|</span> '},9:function(e,t,i,s,o,n){var a,l=this.lambda,r=this.escapeExpression,d=t.helperMissing,c="function";return'\t\t\t\t<span class="toggle-option '+r(l(null!=n[2]?n[2].widget:n[2],e))+'" data-related-widget="'+r(l(null!=n[2]?n[2].widget:n[2],e))+'" data-option-value='+r(typeof(a=null!=(a=t.value||(null!=e?e.value:e))?a:d)===c?a.call(e,{name:"value",hash:{},data:s}):a)+'><div class="sub-view"></div>'+r(typeof(a=null!=(a=t.label||(null!=e?e.label:e))?a:d)===c?a.call(e,{name:"label",hash:{},data:s}):a)+"</span>\n"},11:function(e,t,i,s){var o;return'<span class="option-message">'+this.escapeExpression("function"==typeof(o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing)?o.call(e,{name:"message",hash:{},data:s}):o)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s,o,n){var a,l,r=t.helperMissing,d="function",c=this.escapeExpression;return'<li class="slide-toggle" data-related-widget="'+c(typeof(l=null!=(l=t.widget||(null!=e?e.widget:e))?l:r)===d?l.call(e,{name:"widget",hash:{},data:s}):l)+'">\n\t<span class="setting-name">'+c(typeof(l=null!=(l=t.name||(null!=e?e.name:e))?l:r)===d?l.call(e,{name:"name",hash:{},data:s}):l)+"</span>\n\t"+(null!=(a=t.if.call(e,null!=e?e.plusOnly:e,{name:"if",hash:{},fn:this.program(1,s,0,o,n),inverse:this.noop,data:s}))?a:"")+'\n\t<span class="toggle-options">\n'+(null!=(a=t.each.call(e,null!=e?e.options:e,{name:"each",hash:{},fn:this.program(3,s,0,o,n),inverse:this.noop,data:s}))?a:"")+"\t</span>\n\t"+(null!=(a=t.if.call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(11,s,0,o,n),inverse:this.noop,data:s}))?a:"")+'\n\t<div class="option-clear"></div>\n</li>\n'},useData:!0,useDepths:!0}),m.templates.settings["general-toggle-slider"]=Handlebars.template({1:function(e,t,i,s){return'<span class="badge plus-badge">PLUS</span>'},3:function(e,t,i,s){return'<span class="badge beta-badge">Preview</span>'},5:function(e,t,i,s){var o;return'<span class="option-message">'+this.escapeExpression("function"==typeof(o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing)?o.call(e,{name:"message",hash:{},data:s}):o)+"</span>"},7:function(e,t,i,s){var o;return'<span class="config-button">'+this.escapeExpression("function"==typeof(o=null!=(o=t.configLabel||(null!=e?e.configLabel:e))?o:t.helperMissing)?o.call(e,{name:"configLabel",hash:{},data:s}):o)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l="function",r=this.escapeExpression;return'<li class="slide-toggle" data-related-widget="'+r(typeof(n=null!=(n=t.widget||(null!=e?e.widget:e))?n:a)===l?n.call(e,{name:"widget",hash:{},data:s}):n)+'">\n\t<input type="checkbox">\n\t<span class="setting-name">'+r(typeof(n=null!=(n=t.name||(null!=e?e.name:e))?n:a)===l?n.call(e,{name:"name",hash:{},data:s}):n)+"</span>\n\t"+(null!=(o=t.if.call(e,null!=e?e.plusOnly:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+"\n\t"+(null!=(o=t.if.call(e,null!=e?e.beta:e,{name:"if",hash:{},fn:this.program(3,s,0),inverse:this.noop,data:s}))?o:"")+'\n\t<span class="toggle-slider">\n\t\t<svg class="toggle-switch" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg>\n\t</span>\n\t'+(null!=(o=t.if.call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(5,s,0),inverse:this.noop,data:s}))?o:"")+"\n\t"+(null!=(o=t.if.call(e,null!=e?e.configLabel:e,{name:"if",hash:{},fn:this.program(7,s,0),inverse:this.noop,data:s}))?o:"")+"\n</li>\n"},useData:!0}),m.templates.settings.general=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<h3>General</h3>\n<p class="description">Customize your dashboard</p>\n\n\n<h4>Show</h4>\n<ul id="apps-list" class="settings-list options-list"></ul>\n\n\n<h4>Customize</h4>\n<ul id="customize-list" class="settings-list options-list"></ul>\n\n\n<h4>Options</h4>\n<ul id="misc-list" class="settings-list options-list"></ul>\n\n\n<h5>Tip</h5>\n<p class="no-top-margin">Many items in Momentum can be edited by double clicking on them, including: <strong>your name</strong>, <strong>the clock</strong>, and <strong>to-dos</strong>.\n'},useData:!0}),m.templates.settings.help=Handlebars.template({1:function(e,t,i,s){return'<strong class="hotkey">C</strong>Chrome Tab<br> '},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o;return'<h3>Help</h3>\n<p class="description"></p>\n\n<h5>Tips</h5>\n<p>To change your name, toggle the clock between 12 and 24 hour, or change your location, <strong>double click</strong> on the setting you wish to change.</p>\n\n<h5>Hotkeys</h5>\n<p class="hotkeys">\n\t<span class="col">\n\t\t<strong class="hotkey">T</strong>Todo<br>\n\t\t<strong class="hotkey">F</strong>Focus<br>\n\t\t<strong class="hotkey">B</strong>Bookmarks bar<br>\n\t\t<strong class="hotkey">,</strong>Settings<br>\n\t\t<strong class="hotkey">ESC</strong>Cancel, close\n\t</span>\x3c!--\n\t--\x3e<span class="col">\n\t\t<strong class="hotkey">L</strong>Links<br>\n\t\t<strong class="hotkey">S</strong>Search<br>\n\t\t'+(null!=(o=t.if.call(e,null!=e?e.isChrome:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+'\n\t\t<strong class="hotkey">W</strong>Weather<br>\n\t\t<strong class="hotkey">SPACE</strong>Hold to admire photo<br>\n\t</span>\n</p>\n<p>\n\tPress <strong class="hotkey" style="margin: 0 2px;">TAB</strong> to focus Momentum when opening a new tab to be able to use hotkeys. You may need to press tab more than once.\n</p>\n\n<h5>Need more help?</h5>\n<p>\n\t<a href="http://momentumdash.com/help" class="button button-inline" target="_blank">Check out our Help Center</a>\n</p>\n'},useData:!0}),m.templates.settings.loading=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<div class="settings-loading">\n\t<p class="settings-loading-loading-message"><i class="loading-icon"></i>Loading...</span></p>\n\t<p class="settings-loading-error-message">We\'re having trouble loading these settings.</p>\n\t<span class="button button-retry">Retry</span>\n</div>\n'},useData:!0}),m.templates.settings.main=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<div class="app settings-app">\n\t<ul id="nav-menu" class="settings-nav"></ul>\n\t<div class="settings-view-container"></div>\n</div>\n'},useData:!0}),m.templates.settings.navmenu=Handlebars.template({1:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'\t<li data-navitem="'+l(typeof(o=null!=(o=t.id||(null!=e?e.id:e))?o:n)===a?o.call(e,{name:"id",hash:{},data:s}):o)+'" class="main-nav-item">'+l(typeof(o=null!=(o=t.title||(null!=e?e.title:e))?o:n)===a?o.call(e,{name:"title",hash:{},data:s}):o)+"</li>\n"},3:function(e,t,i,s){var o;return null!=(o=t.if.call(e,s&&s.first,{name:"if",hash:{},fn:this.program(4,s,0),inverse:this.program(6,s,0),data:s}))?o:""},4:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'\t\t<li data-navitem="'+l(typeof(o=null!=(o=t.id||(null!=e?e.id:e))?o:n)===a?o.call(e,{name:"id",hash:{},data:s}):o)+'" class="main-nav-item secondary secondary-first">'+l(typeof(o=null!=(o=t.title||(null!=e?e.title:e))?o:n)===a?o.call(e,{name:"title",hash:{},data:s}):o)+"</li>\n"},6:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'\t\t<li data-navitem="'+l(typeof(o=null!=(o=t.id||(null!=e?e.id:e))?o:n)===a?o.call(e,{name:"id",hash:{},data:s}):o)+'" class="main-nav-item secondary">'+l(typeof(o=null!=(o=t.title||(null!=e?e.title:e))?o:n)===a?o.call(e,{name:"title",hash:{},data:s}):o)+"</li>\n"},8:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'\t<div class="user u--no-transition">\n\t\t<div class="user-info" title="'+l(typeof(o=null!=(o=t.email||(null!=e?e.email:e))?o:n)===a?o.call(e,{name:"email",hash:{},data:s}):o)+'">\n\t\t\t<div class="user-avatar-wrapper">\n\t\t\t\t<div class="user-avatar"><img src="/img/gravatar_unknown.jpg"></div>\n\t\t\t\t<div class="user-avatar-hidden"><img src=""></div>\n\t\t\t\t<div class="user-badge-wrapper">\n\n\t\t\t\t\t<span class="badge plus-badge">PLUS</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<span class="name-wrapper">\n\t\t\t\t<span class="user-info-name">'+l(typeof(o=null!=(o=t.displayName||(null!=e?e.displayName:e))?o:n)===a?o.call(e,{name:"displayName",hash:{},data:s}):o)+'</span>\n\t\t\t\t<span class="anim-caret u--no-transition">\n\t\t\t\t\t<svg class="icon anim-caret-left" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52.16 11.75"><path d="M52.16,26.08A5.87,5.87,0,0,1,46.29,32H5.88A5.88,5.88,0,0,1,0,26.08H0a5.87,5.87,0,0,1,5.88-5.87H46.29a5.87,5.87,0,0,1,5.87,5.87Z" transform="translate(0 -20.21)"/></svg>\n\t\t\t\t\t<svg class="icon anim-caret-right" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52.16 11.75"><path d="M52.16,26.08A5.87,5.87,0,0,1,46.29,32H5.88A5.88,5.88,0,0,1,0,26.08H0a5.87,5.87,0,0,1,5.88-5.87H46.29a5.87,5.87,0,0,1,5.87,5.87Z" transform="translate(0 -20.21)"/></svg>\n\t\t\t\t</span>\n\t\t\t</span>\n\t\t</div>\n\t\t\t<div class="user-hidden">\n\t\t\t\t<ul class="user-nav">\n\t\t\t\t\t<li class="slide-toggle sync-option" title="'+l(typeof(o=null!=(o=t.syncMessage||(null!=e?e.syncMessage:e))?o:n)===a?o.call(e,{name:"syncMessage",hash:{},data:s}):o)+'">\n\t\t\t\t\t\t<input class="sync-check" type="checkbox">\n\t\t\t\t\t\t<span class="sync-caption setting-name">Account Sync</span>\n\t\t\t\t\t\t<span class="toggle-slider"><svg class="toggle-switch" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"></circle></svg></span>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li class="action action-profile">Profile</li>\n\t\t\t\t\t<li class="action action-logout">Log Out</li>\n\t\t\t\t</ul>\n\t\t\t<div class="user-close"></div>\n\t\t</div>\n\t</div>\n\n'},10:function(e,t,i,s){return'\t<div class="user login">\n\t\t<div class="login-button">\n\t\t\t<div class="login-title">Log In</div>\n\t\t\t<div class="login-description">Sync your account &amp; more!</div>\n\t\t</div>\n\t</div>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o;return(null!=(o=t.each.call(e,null!=(o=null!=e?e.menu:e)?o.navItems:o,{name:"each",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+(null!=(o=t.each.call(e,null!=(o=null!=e?e.menu:e)?o.secondaryNavItems:o,{name:"each",hash:{},fn:this.program(3,s,0),inverse:this.noop,data:s}))?o:"")+(null!=(o=t.if.call(e,null!=e?e.loggedIn:e,{name:"if",hash:{},fn:this.program(8,s,0),inverse:this.program(10,s,0),data:s}))?o:"")},useData:!0}),m.templates.settings.upgrade=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o;return'<div class="hero upgrade-hero">\n\t<style type="text/css">\n\t\t.upgrade-hero { padding-bottom: 30px; border-bottom: 1px solid #444; }\n\t\t.upgrade-hero h3 { margin-bottom: 6px; }\n\t\t.upgrade-hero .description { margin-bottom: 15px; opacity: 0.8; }\n\t\t.settings-upgrade .button { padding: 12px 30px; font-size: 95%; font-weight: 500; text-transform: uppercase; }\n\t</style>\n\n\t<h3>Momentum Plus is Here!</h3>\n\t<p class="description" style="margin-bottom: 15px; opacity: 0.8;" ">Level up your focus with customization, integrations, and new widgets.</p>\n\n\t<div class="login-needed">\n\t\t<span class="login-needed-title">Please log in</span>\n\t\t<span class="login-needed-desc">Go to <strong>General → Login</strong>, then come back and try again. Thanks!</span>\n\t</div>\n\n\t<span class="button button-upgrade">Get Momentum Plus</span>\n\t<span class="special">Launch Special!<strong style="margin-left: 5px;"><i class="fa fa-sun-o"></i> 33% Off</strong></span>\n\t<span class="price-line"><span class="price">$1.99/month</span> or <span class="price">$19.99/year</span> (equal to 2 months free!)<br></span>\n</div>\n\n\n\n<div class="feature-list">\n\t<style type="text/css">\n\t\t.feature-list { margin-top: 30px; }\n\t\t.feature-list h4 { margin-bottom: 15px; font-size: 95%; opacity: 0.8; text-transform: uppercase; }\n\t\t.feature-list-icon { width: 40px; margin-top: -2px; float: left; font-size: 120%; text-align: center; }\n\t\t.feature-list-info { margin-left: 40px; margin-bottom: 20px; }\n\t\t.feature-list-info h5 { margin: 0 0 4px; font-size: 92%; opacity: 1; }\n\t\t.feature-list-info p { margin-top: 5px; font-size: 13px; line-height: 135%; opacity: 0.7; }\n\t</style>\n\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Todo Integrations</h5>\n\t\t<p>Momentum Plus connects with your favorite task management services! See, update, and create new tasks from Trello, Todoist, Wunderlist, and Google Tasks.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Custom Background Photos</h5>\n\t\t<p>Light up your day every time you open a new tab. Add your own photos or choose from your favorites or past photos in Momentum.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Personalize Font and Color</h5>\n\t\t<p>Make Momentum your own by choosing a font and color that suits your personality. Incorporate your own style to motivate, inspire, and bring focus to your day.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Custom Quotes</h5>\n\t\t<p>Add your favourite quotes to maximize your inspiration. Set the quote of the day to anything you want, anytime.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Skip Photo/Quote</h5>\n\t\t<p>Not feeling the photo or quote of the day? No problem; a new one is just a refresh away. Cycle between five photos and five quotes per day.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Autofocus Mode</h5>\n\t\t<p>Set your priorities at the start of the day and Momentum will show you the one thing you need to focus on at a time. Check it off, and the next up todo becomes your focus.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Inbox, Today, and Done Lists</h5>\n\t\t<p>Keep your todo list clutter free with the Inbox list. Know exactly what you need to do for the day with the Today list. Follow up on what you’ve completed with the Done list.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Priority Support</h5>\n\t\t<p>Plus subscribers can be assured that their messages, suggestions and requests will be answered promptly by a real human. Your satisfaction is of the utmost importance to us.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Early Access</h5>\n\t\t<p>Get exclusive early access to exciting new Momentum features. Have a say in the direction of the product. Next early release feature: Notes.</p>\n\t</div>\n\n\n\t<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n\t<div class="feature-list-info">\n\t\t<h5>Support Momentum</h5>\n\t\t<p>Your subscription helps Momentum  Plus subscriptions help sustain Momentum and enable the addition of more features. Thank you for your support — we are incredibly grateful!</p>\n\t</div>\n</div>\n\n\n\n<div class="cta">\n\t<style type="text/css">\n\t\t.settings-upgrade .cta { margin: 50px 0 70px; padding: 25px 10px 10px; border-top: 1px solid #444; border-bottom: 1px solid #444; text-align: center; }\n\t\t.settings-upgrade .cta .pitch { margin: 0 0 19px; font-size: 125%; line-height: 135%; }\n\t\t.settings-upgrade .cta .button { margin-bottom: 0; }\n\t\t.settings-upgrade .link { margin: 3px 0 0; padding: 8px; display: inline-block; background: none !important; cursor: pointer; opacity: 0.5; text-decoration: none; -webkit-transition: all 0.1s ease; }\n\t\t.settings-upgrade .link:hover { opacity: 0.7; }\n\t</style>\n\n\t<p class="pitch">Upgrade to Momentum Plus today and turn<br>your potential into progress.</p>\n\n\t<div class="login-needed">\n\t\t<span class="login-needed-title">Please log in</span>\n\t\t<span class="login-needed-desc">Go to <strong>General → Login</strong>, then come back and try again. Thanks!</span>\n\t</div>\n\n\t<span class="button button-upgrade">Get Momentum Plus</span><br>\n\t<a href="https://momentumdash.com/plus?'+this.escapeExpression("function"==typeof(o=null!=(o=t.campaignDetails||(null!=e?e.campaignDetails:e))?o:t.helperMissing)?o.call(e,{name:"campaignDetails",hash:{},data:s}):o)+'" class="link">Learn More</a>\n</div>\n\n\n\n<div class="faq">\n\t<style type="text/css">\n\t\t.settings-upgrade .faq { margin-top: 0; padding: 0 75px; font-size: 90%; opacity: 1; }\n\t\t.settings-upgrade .faq:first-child { margin-top: 0; }\n\t\t.settings-upgrade .faq:last-child { margin-bottom: 10px !important; }\n\n\t\t.settings-upgrade .faq-question { opacity: 0.9; }\n\t\t.settings-upgrade .faq-answer { opacity: 0.7; }\n\t</style>\n\t<p>\n\t\t<span class="faq-question">What are the available integrations?</span>\n\t\t<span class="faq-answer">Currently we integrate with Wunderlist, Google Tasks, Todoist, and Fitbit. Coming soon: Trello and Asana.\x3c!--Github, Google Analytics, Uservoice, Harvest.--\x3e</span>\n\t</p>\n\n\t<p>\n\t\t<span class="faq-question">I thought Momentum was free?</span>\n\t\t<span class="faq-answer">Momentum Free will always be free. We created Momentum Plus to bring more control and functionality to those who desire it, while still keeping the experience simple and focused.</span>\n\t</p>\n</div>'},useData:!0}),m.templates.settings.upsell=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="right">\n\t<span class="button upsell-action">'+l(typeof(o=null!=(o=t.buttonText||(null!=e?e.buttonText:e))?o:n)===a?o.call(e,{name:"buttonText",hash:{},data:s}):o)+'</span>\n\t<span class="icon-wrapper hide"><i class="icon">✕</i></span>\n</div>\n<div class="available">Available on Plus</div>\n<div class="title">'+l(typeof(o=null!=(o=t.title||(null!=e?e.title:e))?o:n)===a?o.call(e,{name:"title",hash:{},data:s}):o)+'</div>\n<div class="description">'+l(typeof(o=null!=(o=t.description||(null!=e?e.description:e))?o:n)===a?o.call(e,{name:"description",hash:{},data:s}):o)+"</div>\n"},useData:!0}),m.templates.settings.whatsnew=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<div class="settings-detail-header">\n\t<h3>What’s New</h3>\n\t<p class="description">Updates from the Momentum Team</p>\n</div>\n\n<div class="whatsnew-body">\n</div>\n'},useData:!0}),m.templates=m.templates||{},m.templates.todos=m.templates.todos||{},m.templates.todos.addtodolist=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<span id="add-icon" class="todo-list-add-icon"><i class="icon icon-plus"></i></span>\n<input id="list-new" class="todo-input todo-list-add-input" type="text" placeholder="    New List" />\n<span class="loading todo-list-add-loading"><i class="loading-icon"></i> <span >Loading...</span></span>\n\n'},useData:!0}),m.templates.todos.dropdownmenu=Handlebars.template({1:function(e,t,i,s){var o;return'\t<div class="icon-wrapper dropdown-toggle">\n\t\t<i class="icon '+this.escapeExpression("function"==typeof(o=null!=(o=t.iClassName||(null!=e?e.iClassName:e))?o:t.helperMissing)?o.call(e,{name:"iClassName",hash:{},data:s}):o)+'"></i>\n\t</div>\n'},3:function(e,t,i,s){var o;return null!=(o=t.if.call(e,null!=e?e.providerLogo:e,{name:"if",hash:{},fn:this.program(4,s,0),inverse:this.program(6,s,0),data:s}))?o:""},4:function(e,t,i,s){var o;return'\t<div class="project-chooser-toggle"><span class="icon-wrapper control control-dropdown"><img class="provider-icon" src="'+this.escapeExpression("function"==typeof(o=null!=(o=t.providerLogo||(null!=e?e.providerLogo:e))?o:t.helperMissing)?o.call(e,{name:"providerLogo",hash:{},data:s}):o)+'"><svg class="todo-menu-dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 34 32"><path d="M16,17H2a1,1,0,0,1,0-2H16a1,1,0,0,1,0,2Z"/><path d="M16,10H2A1,1,0,0,1,2,8H16a1,1,0,0,1,0,2Z"/><path d="M16,24H2a1,1,0,0,1,0-2H16a1,1,0,0,1,0,2Z"/><path d="M28.5,19.12a.87.87,0,0,1-.62-.26l-4.5-4.5a.88.88,0,0,1,1.24-1.24L28.5,17l3.88-3.88a.88.88,0,0,1,1.24,1.24l-4.5,4.5A.87.87,0,0,1,28.5,19.12Z"/></svg></span></div>\n'},6:function(e,t,i,s){return'\t<div class="icon-wrapper dropdown-toggle">\n\t\t<i class="icon icon-ellipsis"></i>\n\t</div>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n;return(null!=(o=t.if.call(e,null!=e?e.iClassName:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.program(3,s,0),data:s}))?o:"")+'<div class="dropdown '+this.escapeExpression("function"==typeof(n=null!=(n=t.dropdownClassName||(null!=e?e.dropdownClassName:e))?n:t.helperMissing)?n.call(e,{name:"dropdownClassName",hash:{},data:s}):n)+'">\n\t<ul class="dropdown-list"></ul>\n\t<ul class="dropdown-detail"></ul>\n</div>\n'},useData:!0}),m.templates.todos["legacy-todo-complete"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="metric-stat">'+l(typeof(o=null!=(o=t.done||(null!=e?e.done:e))?o:n)===a?o.call(e,{name:"done",hash:{},data:s}):o)+'</span>\n<span class="metric-label">'+l(typeof(o=null!=(o=t.item||(null!=e?e.item:e))?o:n)===a?o.call(e,{name:"item",hash:{},data:s}):o)+" complete</span>"},useData:!0}),m.templates.todos["legacy-todo-item"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o;return'<i class="control destroy">✕</i>\n<i class="loading-icon"></i>\n<i class="control error-icon">!</i>\n<label><input class="todo-item-checkbox" type="checkbox"></label><span class="todo-item-title" >'+this.escapeExpression("function"==typeof(o=null!=(o=t.title||(null!=e?e.title:e))?o:t.helperMissing)?o.call(e,{name:"title",hash:{},data:s}):o)+"</span>\n"},useData:!0}),m.templates.todos["legacy-todo"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<div class="app-wrapper nipple-bottom-right">\n    <div class="app todo-app todo-legacy">\n        <div class="todo-header list-row">\n            <span class="todo-count active-list-container"><i class="loading-icon"></i>Loading...</span>\n\n            <div class="error-message">Connection required to add Todo</div>\n\n\t\t\t<div class="todo-actions">\n\t\t\t\t<div class="dropdown-container" id="todo-top-menu"></div>\n\t\t\t</div>\n        </div>\n        <div class="empty empty-todo">\n            <div class="content">\n                <div class="title">No todos yet</div>\n                <div class="description">Add a todo to get started</div>\n                <span class="button new-toggle">New Todo</span>\n            </div>\n        </div>\n        <ol class="todo-list"></ol>\n        <footer class="footer-input">\n            <input id="todo-new" class="todo-input todo-new" type="text" placeholder="New Todo">\n        </footer>\n    </div>\n</div>\n<span id="todo-remaining"></span>\n<span class="app-dash toggle todo-toggle">Todo</span>\n'},useData:!0}),m.templates.todos["todo-list-empty-state"]=Handlebars.template({1:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'\t\t<div class="description empty-link" data-target-list-id="'+l(typeof(o=null!=(o=t.targetListId||(null!=e?e.targetListId:e))?o:n)===a?o.call(e,{name:"targetListId",hash:{},data:s}):o)+'" data-use-command="'+l(typeof(o=null!=(o=t.use_command||(null!=e?e.use_command:e))?o:n)===a?o.call(e,{name:"use_command",hash:{},data:s}):o)+'">\n\t\t\t'+l(typeof(o=null!=(o=t.submessage||(null!=e?e.submessage:e))?o:n)===a?o.call(e,{name:"submessage",hash:{},data:s}):o)+'\n\t\t\t<i class="icon icon-angle-right"></i>\n\t\t</div>\n'},3:function(e,t,i,s){var o;return'\t\t<div class="description">\n\t\t\t'+this.escapeExpression("function"==typeof(o=null!=(o=t.submessage||(null!=e?e.submessage:e))?o:t.helperMissing)?o.call(e,{name:"submessage",hash:{},data:s}):o)+"\n\t\t</div>\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l="function",r=this.escapeExpression;return'<li class="empty">\n\t<p class="title empty-title">'+r(typeof(n=null!=(n=t.message||(null!=e?e.message:e))?n:a)===l?n.call(e,{name:"message",hash:{},data:s}):n)+"</p>\n"+(null!=(o=t.if.call(e,null!=e?e.subMessageClickable:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.program(3,s,0),data:s}))?o:"")+'\t<button class="button new-todo-button">New '+r(typeof(n=null!=(n=t.listType||(null!=e?e.listType:e))?n:a)===l?n.call(e,{name:"listType",hash:{},data:s}):n)+"</button>\n</li>\n"},useData:!0}),m.templates.todos.todoitem=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o;return'<span class="todo-item-wrapper">\n\t<div class="dropdown-container">\n\t</div>\n\n\t<i class="loading-icon"></i>\n\t<i class="control error-icon" title="Error saving click to retry">!</i>\n\n\t<label><input class="todo-item-checkbox" type="checkbox"></label>\n\t<span class="todo-item-title" >'+this.escapeExpression("function"==typeof(o=null!=(o=t.title||(null!=e?e.title:e))?o:t.helperMissing)?o.call(e,{name:"title",hash:{},data:s}):o)+"</span>\n</span>\n"},useData:!0}),m.templates.todos.todolistactive=Handlebars.template({1:function(e,t,i,s){var o;return'\t\t<div class="project-chooser todo-provider-wrapper '+(null!=(o=t.unless.call(e,null!=e?e.supportLists:e,{name:"unless",hash:{},fn:this.program(2,s,0),inverse:this.noop,data:s}))?o:"")+'">\n\t\t<div class="project-chooser-toggle"></div>\n\t\t<div class="project-chooser-dropdown"></div>\n\t</div>\n'},2:function(e,t,i,s){return"has-icon"},4:function(e,t,i,s){var o;return'<img class="provider-icon" src="'+this.escapeExpression("function"==typeof(o=null!=(o=t.providerLogo||(null!=e?e.providerLogo:e))?o:t.helperMissing)?o.call(e,{name:"providerLogo",hash:{},data:s}):o)+'">'},6:function(e,t,i,s){return"no-caps"},8:function(e,t,i,s){var o;return'<div class="message todo-message"><span class="title">'+this.escapeExpression("function"==typeof(o=null!=(o=t.statusMessage||(null!=e?e.statusMessage:e))?o:t.helperMissing)?o.call(e,{name:"statusMessage",hash:{},data:s}):o)+"</span>"},10:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="action" id="status-action" data-action="'+l(typeof(o=null!=(o=t.action||(null!=e?e.action:e))?o:n)===a?o.call(e,{name:"action",hash:{},data:s}):o)+'">'+l(typeof(o=null!=(o=t.actionMessage||(null!=e?e.actionMessage:e))?o:n)===a?o.call(e,{name:"actionMessage",hash:{},data:s}):o)+"</span></div>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l="function",r=this.escapeExpression;return'<div class="list-row">\n\t<div class="list-color" style="background-color: '+r(typeof(n=null!=(n=t.color||(null!=e?e.color:e))?n:a)===l?n.call(e,{name:"color",hash:{},data:s}):n)+'"></div>\n\n'+(null!=(o=t.if.call(e,null!=e?e.supportProjects:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+'\n\t<div class="active-list-container has-icon">\x3c!--\n\t\t--\x3e'+(null!=(o=t.unless.call(e,null!=e?e.supportProjects:e,{name:"unless",hash:{},fn:this.program(4,s,0),inverse:this.noop,data:s}))?o:"")+'\n\t\t<span class="list-name active-list-name '+(null!=(o=t.if.call(e,null!=e?e.no_caps:e,{name:"if",hash:{},fn:this.program(6,s,0),inverse:this.noop,data:s}))?o:"")+'" title='+r(typeof(n=null!=(n=t.listTitle||(null!=e?e.listTitle:e))?n:a)===l?n.call(e,{name:"listTitle",hash:{},data:s}):n)+">"+r(typeof(n=null!=(n=t.listTitle||(null!=e?e.listTitle:e))?n:a)===l?n.call(e,{name:"listTitle",hash:{},data:s}):n)+'</span>\x3c!--\n\t\t--\x3e<div class="list-chooser-toggle icon-wrapper"><i class="icon icon-angle-down"></i></div>\n\t\t<ul class="u--bg dropdown list-chooser"></ul>\n\t</div>\n\n\t<div class="todo-actions">\n\t\t<div class="dropdown-container" id="todo-top-menu"></div>\n\t</div>\n</div>\n\n'+(null!=(o=t.if.call(e,null!=e?e.statusMessage:e,{name:"if",hash:{},fn:this.program(8,s,0),inverse:this.noop,data:s}))?o:"")+"\n"+(null!=(o=t.if.call(e,null!=e?e.actionMessage:e,{name:"if",hash:{},fn:this.program(10,s,0),inverse:this.noop,data:s}))?o:"")+"\n"},useData:!0}),m.templates.todos.todolistchoice=Handlebars.template({1:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'\t<li class="'+l(typeof(o=null!=(o=t.class||(null!=e?e.class:e))?o:n)===a?o.call(e,{name:"class",hash:{},data:s}):o)+'" data-list-id="'+l(typeof(o=null!=(o=t.listId||(null!=e?e.listId:e))?o:n)===a?o.call(e,{name:"listId",hash:{},data:s}):o)+'">\n\t\t<div class="list-color" style="background-color: '+l(typeof(o=null!=(o=t.color||(null!=e?e.color:e))?o:n)===a?o.call(e,{name:"color",hash:{},data:s}):o)+'">&nbsp;</div>'+l(typeof(o=null!=(o=t.parentTitle||(null!=e?e.parentTitle:e))?o:n)===a?o.call(e,{name:"parentTitle",hash:{},data:s}):o)+"\n\t</li>\n"},3:function(e,t,i,s){return"todo-list-section"},5:function(e,t,i,s){var o;return'<div class="list-color" style="background-color: '+this.escapeExpression("function"==typeof(o=null!=(o=t.color||(null!=e?e.color:e))?o:t.helperMissing)?o.call(e,{name:"color",hash:{},data:s}):o)+'">&nbsp;</div>'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=t.helperMissing,l="function",r=this.escapeExpression;return(null!=(o=t.if.call(e,null!=e?e.parentTitle:e,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.noop,data:s}))?o:"")+'<li class="'+r(typeof(n=null!=(n=t.class||(null!=e?e.class:e))?n:a)===l?n.call(e,{name:"class",hash:{},data:s}):n)+" "+(null!=(o=t.if.call(e,null!=e?e.hasParent:e,{name:"if",hash:{},fn:this.program(3,s,0),inverse:this.noop,data:s}))?o:"")+'" data-list-id="'+r(typeof(n=null!=(n=t.listId||(null!=e?e.listId:e))?n:a)===l?n.call(e,{name:"listId",hash:{},data:s}):n)+'">\n\t'+(null!=(o=t.unless.call(e,null!=e?e.hasParent:e,{name:"unless",hash:{},fn:this.program(5,s,0),inverse:this.noop,data:s}))?o:"")+'\n\t<span class="list-name">'+r(typeof(n=null!=(n=t.title||(null!=e?e.title:e))?n:a)===l?n.call(e,{name:"title",hash:{},data:s}):n)+'</span>\n\t<span class="todo-count">'+r(typeof(n=null!=(n=t.count||(null!=e?e.count:e))?n:a)===l?n.call(e,{name:"count",hash:{},data:s}):n)+"</span>\n</li>\n"},useData:!0}),m.templates.todos.todopane=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){return'<div class="app-wrapper nipple-bottom-right">\n\t<div class="app todo-app">\n\t\t<div class="drop-zone drop-left-zone">\n\t\t\t<span class="u--bg bar left-bar">\n\t\t\t\t<span class="bar-name"></span>\n\t\t\t</span>\n\t\t</div>\n\n\t\t<div class="drop-zone drop-right-zone">\n\t\t\t<span class="u--bg bar right-bar">\n\t\t\t\t<span class="bar-name"></span>\n\t\t\t</span>\n\t\t</div>\n\n\t\t<header class="header todo-header">\n\t\t\t<div class="active-list">\n\t\t\t\t\x3c!-- Seems like this is all getting replaced with todolistactive.hbs? --\x3e\n\t\t\t\t\x3c!-- <li><span class="todo-list-name"></span><span class="todo-count active-todo-count"></span></li> --\x3e\n\t\t\t</div>\n\t\t</header>\n\n\t\t<div class="todo-list-wrapper">\n\t\t\t<ol class="todo-list animating"></ol>\n\t\t</div>\n\n\t\t<footer class="footer-input new-todo-footer">\n\t\t\t<input id="todo-new" class="todo-input todo-new" type="text" placeholder="New Todo">\n\t\t</footer>\n\n\t</div>\n</div>\n<span class="app-dash toggle todo-toggle">Todo</span></div>\n'},useData:!0}),m.templates=m.templates||{},m.templates.upsell=m.templates.upsell||{},m.templates.upsell.appupsell=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="icon-wrapper hide"><i class="icon">✕</i></span>\n<div class="available">Available on Plus</div>\n<div class="title">'+l(typeof(o=null!=(o=t.title||(null!=e?e.title:e))?o:n)===a?o.call(e,{name:"title",hash:{},data:s}):o)+'</div>\n<div class="description">'+l(typeof(o=null!=(o=t.description||(null!=e?e.description:e))?o:n)===a?o.call(e,{name:"description",hash:{},data:s}):o)+'</div>\n<a href="" class="button upsell-action">'+l(typeof(o=null!=(o=t.buttonText||(null!=e?e.buttonText:e))?o:n)===a?o.call(e,{name:"buttonText",hash:{},data:s}):o)+"</a>\n"},useData:!0}),m.templates=m.templates||{},m.templates.weather=m.templates.weather||{},m.templates.weather.weather=Handlebars.template({1:function(e,t,i,s){var o,n,a=this.lambda,l=this.escapeExpression,r=t.helperMissing,d="function";return'\t\t\t<span class="icon icon-weather" data-icon="'+l(a(null!=(o=null!=e?e.now:e)?o.icon:o,e))+'" title="'+l(a(null!=(o=null!=e?e.now:e)?o.condition:o,e))+'"></span><span class="metric-stat-number">'+l(a(null!=(o=null!=e?e.now:e)?o.temperature:o,e))+'</span><span class="weather-degree">&deg;</span><span class="unit '+l(typeof(n=null!=(n=t.unitClass||(null!=e?e.unitClass:e))?n:r)===d?n.call(e,{name:"unitClass",hash:{},data:s}):n)+'">'+l(typeof(n=null!=(n=t.unit||(null!=e?e.unit:e))?n:r)===d?n.call(e,{name:"unit",hash:{},data:s}):n)+"</span>\n"},3:function(e,t,i,s){return"\t\t\t&nbsp;\n"},5:function(e,t,i,s){return"loading"},7:function(e,t,i,s){var o;return'<span class="weather-header-message">'+this.escapeExpression("function"==typeof(o=null!=(o=t.displayDay||(null!=e?e.displayDay:e))?o:t.helperMissing)?o.call(e,{name:"displayDay",hash:{},data:s}):o)+"</span>"},9:function(e,t,i,s){var o;return'<span class="weather-header-message">'+this.escapeExpression("function"==typeof(o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing)?o.call(e,{name:"message",hash:{},data:s}):o)+"</span>"},11:function(e,t,i,s){return'\t\t\t\t\t\t\t\t<li class="weather-attribution no-hover">\n\t\t\t\t\t\t\t\t\t<img class="weather-attribution-logo" src="../img/logo-accuweather.png">\n\t\t\t\t\t\t\t\t</li>\n'},13:function(e,t,i,s){var o;return null!=(o=t.if.call(e,null!=e?e.today:e,{name:"if",hash:{},fn:this.program(14,s,0),inverse:this.noop,data:s}))?o:""},14:function(e,t,i,s){return'<i class="icon-angle-down"></i>'},16:function(e,t,i,s){var o;return'<span class="weather-current-temp">'+this.escapeExpression(this.lambda(null!=(o=null!=e?e.selected:e)?o.temperature:o,e))+"&deg;</span>"},18:function(e,t,i,s){var o,n=this.lambda,a=this.escapeExpression;return'<span class="weather-current-temp">'+a(n(null!=(o=null!=e?e.selected:e)?o.high:o,e))+'&deg;</span><span class="weather-current-temp-low">'+a(n(null!=(o=null!=e?e.selected:e)?o.low:o,e))+"&deg;</span>"},20:function(e,t,i,s){var o,n=this.lambda,a=this.escapeExpression;return'\t\t\t\t<div class="weather-current-details toggle-details">\n\t\t\t\t\t'+(null!=(o=t.if.call(e,null!=e?e.today:e,{name:"if",hash:{},fn:this.program(14,s,0),inverse:this.noop,data:s}))?o:"")+'\n\t\t\t\t\t<div title="'+a(n(null!=(o=null!=e?e.selected:e)?o.hoursOfSun:o,e))+' hours of sun">\n\t\t\t\t\t\t<span class="weather-current-details-title">Feels like</span>\n\t\t\t\t\t\t<span class="weather-current-details-value"  >\n\t\t\t\t\t\t\t'+(null!=(o=t.if.call(e,null!=e?e.today:e,{name:"if",hash:{},fn:this.program(21,s,0),inverse:this.program(23,s,0),data:s}))?o:"")+'\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div title="'+a(n(null!=(o=null!=e?e.selected:e)?o.precipitationExpected:o,e))+" "+a(n(null!=(o=null!=e?e.selected:e)?o.precipType:o,e))+' expected">\n\t\t\t\t\t\t<span class="weather-current-details-title">Chance of '+a(n(null!=(o=null!=e?e.selected:e)?o.precipType:o,e))+'</span>\n\t\t\t\t\t\t<span class="weather-current-details-value">'+a(n(null!=(o=null!=e?e.selected:e)?o.precipChance:o,e))+'%</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div title="Gust '+a(n(null!=(o=null!=e?e.now:e)?o.windGust:o,e))+'">\n\t\t\t\t\t\t<span class="weather-current-details-title">Wind</span>\n\t\t\t\t\t\t<span class="weather-current-details-value">'+a(n(null!=(o=null!=e?e.selected:e)?o.windSpeed:o,e))+" "+(null!=(o=t.if.call(e,null!=(o=null!=e?e.selected:e)?o.windSpeed:o,{name:"if",hash:{},fn:this.program(25,s,0),inverse:this.noop,data:s}))?o:"")+"</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n"},21:function(e,t,i,s){var o;return this.escapeExpression(this.lambda(null!=(o=null!=e?e.selected:e)?o.apparentTemperature:o,e))+"&deg;\n\t\t\t\t\t\t\t"},23:function(e,t,i,s){var o,n=this.lambda,a=this.escapeExpression;return a(n(null!=(o=null!=e?e.selected:e)?o.apparentHigh:o,e))+'&deg;<span class="weather-current-details-value-low">'+a(n(null!=(o=null!=e?e.selected:e)?o.apparentLow:o,e))+"&deg;</span>\n"},25:function(e,t,i,s){var o;return'<svg class="weather-arrow" style="transform: rotate('+this.escapeExpression(this.lambda(null!=(o=null!=e?e.selected:e)?o.windDirection:o,e))+'deg)" xmlns="http://www.w3.org/2000/svg" width="73.168" height="73.168" viewBox="0 0 73.168 73.168"><path d="M58.079 22.316L40.682 1.633A4.581 4.581 0 0 0 37.249 0c-1.392.075-2.599.534-3.485 1.52L15.185 22.204a4.584 4.584 0 0 0 .35 6.468 4.583 4.583 0 0 0 6.472-.354l10.109-11.253v51.531a4.578 4.578 0 0 0 4.584 4.572 4.577 4.577 0 0 0 4.581-4.572v-52.02l9.785 11.63a4.554 4.554 0 0 0 3.509 1.632 4.591 4.591 0 0 0 2.945-1.068 4.58 4.58 0 0 0 .559-6.454z"/></svg>'},27:function(e,t,i,s){var o,n=this.lambda,a=this.escapeExpression;return'\t\t\t<div class="weather-optional weather-hourly '+(null!=(o=t.if.call(e,null!=e?e.hourlyVisible:e,{name:"if",hash:{},fn:this.program(28,s,0),inverse:this.noop,data:s}))?o:"")+'" >\n\t\t\t\t<div class="weather-forecast weather-forecast-hourly">\n'+(null!=(o=t.each.call(e,null!=e?e.hours:e,{name:"each",hash:{},fn:this.program(30,s,0),inverse:this.noop,data:s}))?o:"")+'\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class="weather-optional weather-detail '+(null!=(o=t.if.call(e,null!=e?e.detailVisible:e,{name:"if",hash:{},fn:this.program(28,s,0),inverse:this.noop,data:s}))?o:"")+'">\n\t\t\t\t<div class="weather-extra">\n\t\t\t\t\t<div class="weather-extra-col">\n\t\t\t\t\t\t<div class="weather-extra-cell" title="Moon '+a(n(null!=(o=null!=e?e.selected:e)?o.moonPhase:o,e))+'">\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<span class="weather-current-details-title">Sunrise</span> <span class="weather-current-details-value">'+a(n(null!=(o=null!=e?e.selected:e)?o.sunrise:o,e))+'</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<span class="weather-current-details-title">Sunset</span> <span class="weather-current-details-value">'+a(n(null!=(o=null!=e?e.selected:e)?o.sunset:o,e))+'</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="weather-extra-cell">\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<span class="weather-current-details-title">Dewpoint</span> <span class="weather-current-details-value">'+a(n(null!=(o=null!=e?e.selected:e)?o.dewPoint:o,e))+'&deg;</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="pressure-text">\n\t\t\t\t\t\t\t\t<span class="weather-current-details-title">Pressure</span> <span class="weather-current-details-value" '+(null!=(o=t.unless.call(e,null!=(o=null!=e?e.selected:e)?o.pressureDirectionVisible:o,{name:"unless",hash:{},fn:this.program(32,s,0),inverse:this.noop,data:s}))?o:"")+">"+(null!=(o=t.if.call(e,null!=(o=null!=e?e.selected:e)?o.pressureDirectionVisible:o,{name:"if",hash:{},fn:this.program(34,s,0),inverse:this.noop,data:s}))?o:"")+a(n(null!=(o=null!=e?e.selected:e)?o.pressure:o,e))+'</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="weather-extra-col">\n\t\t\t\t\t\t<div class="weather-extra-cell">\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<span class="weather-current-details-title">Humidity</span> <span class="weather-current-details-value">'+a(n(null!=(o=null!=e?e.selected:e)?o.humidity:o,e))+'%</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div title="In the past 24 hours">\n\t\t\t\t\t\t\t\t<span class="weather-current-details-title">Precipitation</span> <span class="weather-current-details-value">'+a(n(null!=(o=null!=e?e.selected:e)?o.precipAmount:o,e))+'</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="weather-extra-cell">\n\t\t\t\t\t\t\t<div title="'+a(n(null!=(o=null!=e?e.selected:e)?o.uvIndexText:o,e))+'">\n\t\t\t\t\t\t\t\t<span class="weather-current-details-title">UV Index</span> <span class="weather-current-details-value">'+a(n(null!=(o=null!=e?e.selected:e)?o.uvIndex:o,e))+'</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div title="'+a(n(null!=(o=null!=e?e.selected:e)?o.visibilityText:o,e))+'">\n\t\t\t\t\t\t\t\t<span class="weather-current-details-title">Visibility</span> <span class="weather-current-details-value">'+a(n(null!=(o=null!=e?e.selected:e)?o.visibility:o,e))+"</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n"},28:function(e,t,i,s){return"active"},30:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'\t\t\t\t\t<div class="weather-forecast-item" title="'+l(typeof(o=null!=(o=t.condition||(null!=e?e.condition:e))?o:n)===a?o.call(e,{name:"condition",hash:{},data:s}):o)+" ("+l(typeof(o=null!=(o=t.precipChance||(null!=e?e.precipChance:e))?o:n)===a?o.call(e,{name:"precipChance",hash:{},data:s}):o)+"% chance of "+l(typeof(o=null!=(o=t.precipType||(null!=e?e.precipType:e))?o:n)===a?o.call(e,{name:"precipType",hash:{},data:s}):o)+", "+l(typeof(o=null!=(o=t.windSpeed||(null!=e?e.windSpeed:e))?o:n)===a?o.call(e,{name:"windSpeed",hash:{},data:s}):o)+' wind)">\n\t\t\t\t\t\t<div class="weather-forecast-label">'+l(typeof(o=null!=(o=t.hour||(null!=e?e.hour:e))?o:n)===a?o.call(e,{name:"hour",hash:{},data:s}):o)+'</div>\n\t\t\t\t\t\t<span class="icon icon-weather weather-forecast-icon" data-icon="'+l(typeof(o=null!=(o=t.icon||(null!=e?e.icon:e))?o:n)===a?o.call(e,{name:"icon",hash:{},data:s}):o)+'"></span>\n\t\t\t\t\t\t<span class="weather-forecast-high">'+l(typeof(o=null!=(o=t.temperature||(null!=e?e.temperature:e))?o:n)===a?o.call(e,{name:"temperature",hash:{},data:s}):o)+"&deg;</span>\n\t\t\t\t\t</div>\n"},32:function(e,t,i,s){var o;return'title="'+this.escapeExpression(this.lambda(null!=(o=null!=e?e.selected:e)?o.pressureTendency:o,e))+'"'},34:function(e,t,i,s){var o;return'<svg class="weather-arrow weather-arrow-pressure" style="transform: rotate('+this.escapeExpression(this.lambda(null!=(o=null!=e?e.selected:e)?o.pressureDirection:o,e))+'deg)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 73.168 73.168"><path d="M58.079 22.316L40.682 1.633A4.581 4.581 0 0 0 37.249 0c-1.392.075-2.599.534-3.485 1.52L15.185 22.204a4.584 4.584 0 0 0 .35 6.468 4.583 4.583 0 0 0 6.472-.354l10.109-11.253v51.531a4.578 4.578 0 0 0 4.584 4.572 4.577 4.577 0 0 0 4.581-4.572v-52.02l9.785 11.63a4.554 4.554 0 0 0 3.509 1.632 4.591 4.591 0 0 0 2.945-1.068 4.58 4.58 0 0 0 .559-6.454z"/></svg>'},36:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'\t\t\t<div class="weather-forecast-item weather-forecast-day" data-day="'+l(typeof(o=null!=(o=t.day||(null!=e?e.day:e))?o:n)===a?o.call(e,{name:"day",hash:{},data:s}):o)+'" title="'+l(typeof(o=null!=(o=t.condition||(null!=e?e.condition:e))?o:n)===a?o.call(e,{name:"condition",hash:{},data:s}):o)+'">\n\t\t\t\t<div class="weather-forecast-label">'+l(typeof(o=null!=(o=t.dayShort||(null!=e?e.dayShort:e))?o:n)===a?o.call(e,{name:"dayShort",hash:{},data:s}):o)+'</div>\n\t\t\t\t<span class="icon icon-weather weather-forecast-icon" data-icon="'+l(typeof(o=null!=(o=t.icon||(null!=e?e.icon:e))?o:n)===a?o.call(e,{name:"icon",hash:{},data:s}):o)+'" ></span>\n\t\t\t\t<span class="weather-forecast-high">'+l(typeof(o=null!=(o=t.high||(null!=e?e.high:e))?o:n)===a?o.call(e,{name:"high",hash:{},data:s}):o)+'&deg;</span><span class="weather-forecast-low">'+l(typeof(o=null!=(o=t.low||(null!=e?e.low:e))?o:n)===a?o.call(e,{name:"low",hash:{},data:s}):o)+"&deg;</span>\n\t\t\t</div>\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n,a=this.lambda,l=this.escapeExpression,r=t.helperMissing,d="function";return'\x3c!-- Metric --\x3e\n<div class="app-dash" title="'+l(a(null!=(o=null!=e?e.now:e)?o.condition:o,e))+'">\n\t<div class="metric-stat">\n'+(null!=(o=t.if.call(e,null!=(o=null!=e?e.now:e)?o.icon:o,{name:"if",hash:{},fn:this.program(1,s,0),inverse:this.program(3,s,0),data:s}))?o:"")+'\t</div>\n\t<span class="location metric-label data" title="'+l(typeof(n=null!=(n=t.locationExact||(null!=e?e.locationExact:e))?n:r)===d?n.call(e,{name:"locationExact",hash:{},data:s}):n)+'">'+l(typeof(n=null!=(n=t.location||(null!=e?e.location:e))?n:r)===d?n.call(e,{name:"location",hash:{},data:s}):n)+'</span>\n\t<span class="metric-message">'+l(typeof(n=null!=(n=t.message||(null!=e?e.message:e))?n:r)===d?n.call(e,{name:"message",hash:{},data:s}):n)+'</span>\n</div>\n\n<div class="app-wrapper nipple-top-right">\n\t<div class="app weather-app">\n\n\t\t\x3c!-- Main weather area --\x3e\n\t\t<section class="weather-current">\n\n\t\t\t\x3c!-- Header --\x3e\n\t\t\t<header class="weather-current-header">\n\n\t\t\t\t<span class="weather-current-location '+(null!=(o=t.if.call(e,null!=e?e.loading:e,{name:"if",hash:{},fn:this.program(5,s,0),inverse:this.noop,data:s}))?o:"")+'" title="'+l(typeof(n=null!=(n=t.locationExact||(null!=e?e.locationExact:e))?n:r)===d?n.call(e,{name:"locationExact",hash:{},data:s}):n)+'">\n\t\t\t\t\t<span class="weather-location-name">'+l(typeof(n=null!=(n=t.location||(null!=e?e.location:e))?n:r)===d?n.call(e,{name:"location",hash:{},data:s}):n)+"</span>\n\t\t\t\t\t"+(null!=(o=t.unless.call(e,null!=e?e.today:e,{name:"unless",hash:{},fn:this.program(7,s,0),inverse:this.noop,data:s}))?o:"")+(null!=(o=t.if.call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(9,s,0),inverse:this.noop,data:s}))?o:"")+'<i class="loading-icon"></i>\n\n\t\t\t\t\t<span class="weather-location-icon weather-location-edit"><i class="icon-edit"></i></span>\n\t\t\t\t\t<span class="weather-location-icon weather-location-reset" title="Use location"><svg class="weather-location-reset-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 51.636 51.636"><path d="M51.353.914a.999.999 0 0 0-1.135-.213L.583 23.481a1 1 0 0 0 .252 1.895l22.263 3.731 2.545 21.038a1.002 1.002 0 0 0 1.889.324l24-48.415a1 1 0 0 0-.179-1.14z"/></svg></span>\n\n\t\t\t\t\t<span class="weather-current-conditions">'+l(a(null!=(o=null!=e?e.selected:e)?o.condition:o,e))+'</span>\n\t\t\t\t</span>\n\n\t\t\t\t<div class="more">\n\t\t\t\t\t<div class="icon-wrapper more-toggle">\n\t\t\t\t\t\t<i class="icon-ellipsis more-icon"></i>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="dropdown more-dropdown">\n\t\t\t\t\t\t<ul class="dropdown-list">\n\t\t\t\t\t\t\t<li class="toggle-hourly">\n\t\t\t\t\t\t\t\tHourly forecast\n\t\t\t\t\t\t\t\t<span class="toggle-slider"><svg class="toggle-switch" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg></span>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li class="toggle-details">\n\t\t\t\t\t\t\t\tExtra weather info\n\t\t\t\t\t\t\t\t<span class="toggle-slider"><svg class="toggle-switch" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg></span>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li class="line"></li>\n\t\t\t\t\t\t\t<li class="toggle-metric">\n\t\t\t\t\t\t\t\tMetric units\n\t\t\t\t\t\t\t\t<span class="toggle-slider"><svg class="toggle-switch" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg></span>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t<li class="weather-location-edit-menu">Edit location</li>\n'+(null!=(o=t.if.call(e,null!=e?e.plusDetails:e,{name:"if",hash:{},fn:this.program(11,s,0),inverse:this.noop,data:s}))?o:"")+'\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</header>\n\n\t\t\t<div class="weather-current-temp-row">\n\t\t\t\t\x3c!-- Main temp --\x3e\n\t\t\t\t<div class="weather-current-temp-wrapper toggle-hourly">\n\t\t\t\t\t'+(null!=(o=t.if.call(e,null!=e?e.plusDetails:e,{name:"if",hash:{},fn:this.program(13,s,0),inverse:this.noop,data:s}))?o:"")+'\n\t\t\t\t\t<span class="icon icon-weather weather-current-icon" data-icon="'+l(a(null!=(o=null!=e?e.selected:e)?o.icon:o,e))+'" title="'+l(a(null!=(o=null!=e?e.selected:e)?o.condition:o,e))+'"></span>'+(null!=(o=t.if.call(e,null!=e?e.today:e,{name:"if",hash:{},fn:this.program(16,s,0),inverse:this.program(18,s,0),data:s}))?o:"")+"\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Main details --\x3e\n"+(null!=(o=t.if.call(e,null!=e?e.plusDetails:e,{name:"if",hash:{},fn:this.program(20,s,0),inverse:this.noop,data:s}))?o:"")+"\t\t\t</div>\n\n\n\t\t\t\x3c!-- Extra weather info --\x3e\n"+(null!=(o=t.if.call(e,null!=e?e.plusDetails:e,{name:"if",hash:{},fn:this.program(27,s,0),inverse:this.noop,data:s}))?o:"")+'\t\t</section>\n\n\n\t\t\x3c!-- 5-day advance forecast --\x3e\n\t\t<section class="weather-forecast weather-forecast-daily">\n'+(null!=(o=t.each.call(e,null!=e?e.days:e,{name:"each",hash:{},fn:this.program(36,s,0),inverse:this.noop,data:s}))?o:"")+"\t\t</section>\n\t</div>\n</div>\n"},useData:!0}),m.templates=m.templates||{},m.templates.widgetmanager=m.templates.widgetmanager||{},m.templates.widgetmanager.metric=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="view">\n\t<div class="primary">\n\t\t<div class="metric-stat">\n\t\t\t<span class="metric-stat-number">'+l(typeof(o=null!=(o=t.metricValue||(null!=e?e.metricValue:e))?o:n)===a?o.call(e,{name:"metricValue",hash:{},data:s}):o)+'</span><span class="metric-stat-unit">'+l(typeof(o=null!=(o=t.metricUnit||(null!=e?e.metricUnit:e))?o:n)===a?o.call(e,{name:"metricUnit",hash:{},data:s}):o)+'</span>\n\t\t</div>\n\t\t<span class="metric-label">'+l(typeof(o=null!=(o=t.metricLabel||(null!=e?e.metricLabel:e))?o:n)===a?o.call(e,{name:"metricLabel",hash:{},data:s}):o)+'</span>\n\t</div>\n\t<span class="metric-message"></span>\n</div>'},useData:!0}),m.templates.widgetmanager.pane=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,s){var o,n=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="app-wrapper app-placeholder">\n\t<div class="app">\n\t\t<div class="app-placeholder-loading">\n\t\t\t<i class="loading-icon"></i>Loading...\n\t\t</div>\n\t</div>\n</div>\n<span class="app-dash toggle '+l(typeof(o=null!=(o=t.label||(null!=e?e.label:e))?o:n)===a?o.call(e,{name:"label",hash:{},data:s}):o)+'-toggle">'+l(typeof(o=null!=(o=t.label||(null!=e?e.label:e))?o:n)===a?o.call(e,{name:"label",hash:{},data:s}):o)+"</span>\n"},useData:!0});var momoConstants={classInputLengthError:"invalid-length",dateHoursPerDay:24,dateMinsPerDay:1440,dateMinsPerHour:60,dateMsPerDay:864e5,dateMsPerHour:36e5,dateMsPerMin:6e4,dateMsPerSec:1e3,dateRolloverHour:4,dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],keyEscape:27,keyReturn:13,minMarginSmoothScroll:50,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],timeContentItemAnimation:200,timeSettingsFade:150,timeSmoothScroll:500,timeToggleClassTwice:100},endPunctChars=[33,34,39,40,41,46,63,91,93,96,123,125,8216,8217,8220,8221,8230];function mConst(e){var t=momoConstants[e];return void 0===t&&console.warn("constant not found:",e),t}function momoInit(){return!0}function validateEmail(e){return/[^@]+@[^@]+\.[^@]+/.test(e)}function getQueryParameter(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function toggleLocalStorageBool(e){localStorage[e]="true"===localStorage[e]?"false":"true"}function getLocalStorageBool(e){return"true"===localStorage[e]}function getActiveDateString(){return activeDateStringForDate(new Date)}function activeDateStringForDate(e){var t=new Date(e);return t.getHours()<mConst("dateRolloverHour")&&(t=new Date(t.getTime()-mConst("dateMsPerDay"))),t.getFullYear().toString()+"-"+m.utils.twoDigit(t.getMonth()+1)+"-"+m.utils.twoDigit(t.getDate())}function getDayName(e,t){return mConst("dayNames"+(t?"Short":""))[e.getDay()]}function getMonthName(e,t){return mConst("monthNames"+(t?"Short":""))[e.getMonth()]}function getDaysInMonth(e,t){return new Date(e,parseInt(t)+1,0).getDate()}function dateDiffIntegerDays(e,t){var i=new Date(e.valueOf());return(new Date(t.valueOf()).setHours(0,0,0,0)-i.setHours(0,0,0,0))/mConst("dateMsPerDay")}function dateIsYesterday(e){return-1===m.utils.dateDiffIntegerDays(new Date,e)}function dateIsToday(e){return 0===m.utils.dateDiffIntegerDays(new Date,e)}function dateIsTomorrow(e){return 1===m.utils.dateDiffIntegerDays(new Date,e)}function dateIsInLast7d(e){var t=m.utils.dateDiffIntegerDays(new Date,e);return-7<t&&t<=0}function getFriendlyDate(e){var t,i,s=new Date;return i=(t=e instanceof Date?e:parseIsoDatetime(e)).getFullYear()===s.getFullYear()?"":", "+t.getFullYear(),mConst("monthNamesShort")[t.getMonth()]+" "+t.getDate()+i}function formatYearRelative(e){var t=new Date,i=e.getFullYear();return i===t.getFullYear()?"":", "+i}function formatMonthDayRelative(e,t){return m.utils.dateIsTomorrow(e)?"Tomorrow":m.utils.dateIsToday(e)?"Today":m.utils.dateIsYesterday(e)?"Yesterday":m.utils.getMonthName(e,t)+" "+e.getDate()}function getHoursMinsStr(e,t){void 0===t&&(t=m.models.customization.get("hour12clock"));var i,s,o=e.getHours();return t?(s=" "+(o<12?"AM":"PM"),12<o&&(o-=12),0===o&&(o=12),i=o):(s="",i=m.utils.twoDigit(o)),i+":"+m.utils.twoDigit(e.getMinutes())+s}function parseIsoDatetime(e){var t=e.split(/[: T-]/).map(parseFloat);return new Date(t[0],t[1]-1,t[2],t[3]||0,t[4]||0,t[5]||0,0)}function toUTC(e){return new Date(e.getTime()-e.getTimezoneOffset()*mConst("dateMsPerMin"))}function toLocalTime(e){var t=new Date(e);return new Date(t.getTime()+t.getTimezoneOffset()*mConst("dateMsPerMin"))}function nightsBetween(e,t,i){var s=e,o=t,n=e.valueOf()>=t.valueOf();n&&(s=t,o=e);var a=o.valueOf()-s.valueOf(),l=calcDayMs(s,i)+a,r=Math.floor(l/mConst("dateMsPerDay"));return 0!==r&&n&&(r*=-1),r}function calcDayMs(e,t){var i=e-new Date(e).setHours(0,0,0,0)-t*mConst("dateMsPerHour");return i<0&&(i+=mConst("dateMsPerDay")),i}function dateAdd(e,t,i){var s=new Date(e),o=function(){s.getDate()!==e.getDate()&&s.setDate(0)};switch(t.toLowerCase()){case"year":s.setFullYear(s.getFullYear()+i),o();break;case"quarter":s.setMonth(s.getMonth()+3*i),o();break;case"month":s.setMonth(s.getMonth()+i),o();break;case"week":s.setDate(s.getDate()+7*i);break;case"day":s.setDate(s.getDate()+i);break;case"hour":s.setTime(s.getTime()+36e5*i);break;case"minute":s.setTime(s.getTime()+6e4*i);break;case"second":s.setTime(s.getTime()+1e3*i);break;default:s=void 0}return s}function replaceLastOccurrence(e,t,i){var s=e.lastIndexOf(t);return s?e.slice(0,s)+e.slice(s).replace(t,i):e}function endsWithEndPunct(e){return _.contains(endPunctChars,e.charCodeAt(e.length-1))}function capitalizeFirstLetter(e){return e.slice(0,1).toUpperCase()+e.slice(1)}function twoDigit(e){var t=parseInt(e);return(10<=t?t:"0"+t.toString()).toString()}function getRandomBool(){return getRandomBoolByFrequency(.5)}function getRandomBoolByFrequency(e){return Math.random()<e}function getNextIndex(e,t){return t===e.length-1?0:t+1}function getPrevIndex(e,t){return 0===t?e.length-1:t-1}function getRandomIntInclusive(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function getRandomItem(e){return e[Math.floor(Math.random()*e.length)]}function betweenInclusive(e,t,i){return t<=e&&e<=i}function topPosition(e){return e.offset().top}function rightPosition(e){return e.offset().left+e.outerWidth()}function bottomPosition(e){return e.offset().top+e.outerHeight()}function leftPosition(e){return e.offset().left}function distanceBelow(e,t,i){var s=bottomPosition(e)-bottomPosition(t);return i&&(s+=i),s}function smoothScrollToElement(e,t,i,s,o,n,a){void 0===n&&(n=mConst("timeSmoothScroll")),void 0===a&&(a=mConst("minMarginSmoothScroll")),void 0===s&&(s=0);var l=distanceBelow(e,t,a);setTimeout(function(){0<l?t.animate({scrollTop:l},{duration:n,complete:function(){smoothScrollHelper(e,i,o)}}):smoothScrollHelper(e,i,o)},s)}function smoothScrollHelper(e,t,i){t&&e.addClass("pulse"),i&&i()}function removePulseClass(e){"pulse"!==e.originalEvent.animationName&&"pulselight"!==e.originalEvent.animationName||$(e.target).removeClass("pulse")}function scrollToBottom(e){var t=e[0];t.scrollTop=t.scrollHeight}function toggleClassTwice(e,t){e.toggleClass(t),setTimeout(function(){e.toggleClass(t)},mConst("timeToggleClassTwice"))}function isChrome(){return null==m.globals.isChrome&&(m.globals.isChrome=/chrom(e|ium)/.test(navigator.userAgent.toLowerCase())),m.globals.isChrome}function getBrowserName(){return isChrome()?"Chrome":"Firefox"}function getBrowserVersion(){return parseInt(navigator.userAgent.match(new RegExp("rv:([0-9]+)"))[1])}function getBrowser(){return isChrome()?chrome:browser}function getFavIcon(e){var t=document.createElement("a");t.href=e;var i=t.hostname;if(!i.startsWith("www.")){var s=i.split(".");(s.length<3||3==s.length&&s[1].length<4)&&(i="www."+i)}return"https://icons.duckduckgo.com/ip2/"+i+".ico"}function uuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function capitalizeWords(e){var i=e.split(" ");return i.forEach(function(e,t){i[t]=e.charAt(0).toUpperCase()+e.slice(1)}),i.join(" ")}function submitStats(e){}function setMomentumAuthHeader(e){if(localStorage.token&&e.setRequestHeader("Authorization","Bearer "+localStorage.token),localStorage.client_uuid&&e.setRequestHeader("X-Momentum-ClientId",localStorage.client_uuid),e.setRequestHeader("X-Momentum-Version",m.globals.version),e.setRequestHeader("X-Momentum-ClientDate",getActiveDateString()),m.conditionalFeatures.featureEnabled("allowoptions")){var t=localStorage.getItem("X-Momentum-Options");t&&e.setRequestHeader("X-Momentum-Options",t)}localStorage.activeTags&&e.setRequestHeader("X-Momentum-Tags",localStorage.activeTags)}function handleDblclickFromDashboard(e){e.manager.dblclickFromDashboard&&(e.manager.dblclickFromDashboard=!1,setTimeout(function(){e.dblclickFromDashboardCb()},0))}function flashInputLengthError(e){toggleClassTwice(e,mConst("classInputLengthError"))}function checkForInputMaxLengthError(e){e.is("input")&&e.val().length>=e.attr("maxlength")&&flashInputLengthError(e)}function updateCharCount(e,t,i,s){var o=$(e.currentTarget.form);s=s||o.find("input");var n=o.find(".char-count"),a=s.val().length,l=t.inputLengthMaxDatabase-a;n.text(l).removeClass("warn over"),n.toggle(a>=t.inputLengthShow),s.removeClass("over"),a>t.inputLengthMaxDatabase?(n.addClass("over"),s.addClass("over")):a>=t.inputLengthWarn&&n.addClass("warn"),i&&i(o,a,l)}function updateListAddFormBorder(e,t){e.toggleClass("no-top-border",t)}function moveCursorToEndOfInput(e){var t=e[0];t.selectionStart=t.selectionEnd=t.value.length}function scrollToEndOfInput(e,t){void 0===t&&(t=0);var i=e[0];i.scrollWidth>i.clientWidth&&(0!==e.scrollLeft()&&e.scrollLeft(0),e.animate({scrollLeft:i.scrollWidth-i.clientWidth},t))}function toggleAdvanced(e){var t=e.$(".button-advanced"),i=e.$(".wrapper-advanced");t.toggleClass("active"),i.is(":visible")?(i.slideUp(300,function(){handleStickySubnav(e)}),setTimeout(function(){i.css("opacity",0)},100)):(i.css("opacity",0).slideDown(300,function(){handleStickySubnav(e)}),setTimeout(function(){i.css("opacity",1)},100))}function sendEventToggleFeed(e,t,i){m.sendEvent(e,t,"turned "+(i?"on":"off"))}function getInitialFeedSettings(e){var t=!0,i=!1;return"false"===localStorage.getItem(e.feedMomentumName)&&(t=!1),"true"===localStorage.getItem(e.feedCustomName)&&(i=!0),{feedMomentumClass:t?"on":"",feedCustomClass:i?"on":""}}function setFeedVars(e){e.$feedMomentumSlider=e.$("#feed-momentum-slider"),e.$feedCustomSlider=e.$("#feed-custom-slider")}function updateFeedSettings(e){var t=e.settings.get(e.manager.feedMomentumName),i=e.settings.get(e.manager.feedCustomName);e.$("#feed-momentum-slider").toggleClass("on",t),e.$("#feed-custom-slider").toggleClass("on",i),localStorage.setItem(e.manager.feedMomentumName,t),localStorage.setItem(e.manager.feedCustomName,i)}function handleStickySubnav(e){if(void 0!==e.subnav){var t=e.$(".settings-subnav"),i=e.$(".settings-subnav-placeholder"),s=(t.hasClass("sticky")?i.position().top:t.position().top)<0,o=m.models.customization.get("themeColour"),n={dark:"rgba(0,0,0,0.85)",light:"rgba(255,255,255,0.95)",custom:m.models.themeManager.getThemeColourRGBA()};i.outerHeight()!==t.outerHeight()&&i.css("height",t.outerHeight()),isChrome()||0===e.$(".subpanel-header").width()||t.css("width",e.$(".subpanel-header").width()),m.conditionalFeatures.featureEnabled("plus")&&t.css("background-color",s?n[o]:{dark:"rgba(0,0,0,0)",light:"rgba(255,255,255,1)",custom:"rgba(0,0,0,0)"}[o]),t.toggleClass("sticky",s),i.toggle(s)}}function scrollToTopStickySubnav(e){e.$(".settings-subnav").hasClass("sticky")&&e.$el.scrollTop(e.$(".settings-subnav-placeholder").position().top+e.$el.scrollTop())}function handleSelectStickySubnav(e){handleStickySubnav(e),scrollToTopStickySubnav(e)}function subnavAddAll(t,i,e,s,o){var n=t.main||t;_.each(t.subViews,function(e){e.destroy()}),t.subViews=[],t.collection.each(function(e){t.addOne(e,i)}),setTimeout(function(){handleStickySubnav(n)},0),t.$empty.removeClass("loading"),t.handleCollectionUpdate(),void 0!==s&&s(t),e.show(),void 0!==o&&o()}function subnavAddOne(e,t,i,s,o){var n=t.render().$el;e.subViews.push(t),s?i.prepend(n):i.append(n),o&&n.hide().slideDown(mConst("timeContentItemAnimation"))}function renderSubnav(e,t,i){e.$(".list-body").hide(),t.render(),e.$(".subnav-titles").find("h4").removeClass("active").siblings("."+i).addClass("active"),t.$el.show(),e.subnav=i}function updateEmptyState(e){e.$empty.toggle(0===e.collection.length)}function subnavHistoryLoadMore(e,t,i){e.stopPropagation(),i.LoadMoreHistory(),subnavHistoryUpdateLoadMore(t)}function subnavHistoryUpdateLoadMore(e){void 0===e&&(e=this),e.$(".load-more").toggle(!!e.collection.load_more)}function handleCollectionUpdateCustom(e,t,i){e.deletingFinalItem?setTimeout(function(){e.deletingFinalItem=!1,e.cancelListAdd(),displayEmptyStateAndAddForm(e,t,i)},mConst("timeContentItemAnimation")):displayEmptyStateAndAddForm(e,t,i)}function displayEmptyStateAndAddForm(e,t,i){t.toggle(i),updateListAddFormBorder(e.$listAddForm,i),handleStickySubnav(e)}function cancelListAdd(e){e.$listAddForm.is(":visible")&&(e.resetListAdd(!0),e.toggleListAddForm())}function changeToEditMode(e,t){triggerItemEditing(e),e.$el.addClass("editing"),t.focus(),moveCursorToEndOfInput(t),scrollToEndOfInput(t,mConst("timeSmoothScroll"))}function handleKeypressEnter(e,t,i){13===e.keyCode?(e.preventDefault(),e.shiftKey||e.ctrlKey||e.metaKey||e.altKey||t()):void 0!==i&&checkForInputMaxLengthError(i)}function handleKeyupEsc(e,t){27===e.keyCode&&(e.stopPropagation(),t())}function triggerItemEditing(e){e.main.itemEditingId=e.model.id,e.manager.trigger("item-editing")}function preventMultipleEdits(e){void 0===e&&(e=this),e.model.id!==e.main.itemEditingId&&returnToViewMode(e)}function getOutOfEditMode(e){e.$el.removeClass("editing"),e.updateTooltip&&e.updateTooltip()}function returnToViewMode(e){void 0===e&&(e=this),e.$el.hasClass("editing")&&e.processEditForm(),e.$(".delete-group").is(":visible")&&e.toggleDeleteConf()}function onDestroyModel(){1===this.main.collection.length&&(this.main.deletingFinalItem=!0),this.$el.slideUp(mConst("timeContentItemAnimation"),_.bind(this.destroy,this))}function toggleDeleteConf(e){var t=e.$(".controls"),i=e.$(".controls > .control"),s=e.$(".delete-group");s.css("display",s.is(":visible")?"none":"flex"),s.is(":visible")&&triggerItemEditing(e),t.toggleClass("delete-clicked"),i.toggle()}function processEditFormBasic(e){var t=e.$input.val().trim();betweenInclusive(t.length,1,e.main.inputLengthMaxDatabase)?(e.model.save({body:t},{wait:!0,success:function(){getOutOfEditMode(e),e.manager.handleItemEdit(e.model)},error:function(){console.error("edit content item error for view:",e)}}),m.sendEvent(e.main.gaTitle,"Edit")):flashInputLengthError(e.$input)}function abortEditBasic(e){e.$input.val(e.model.get("body")),getOutOfEditMode(e)}function deleteItemBasic(e){e.model.destroy({wait:!0,success:function(){e.manager.handleItemDelete(e.model,mConst("timeContentItemAnimation"))},error:function(){console.error("delete content item error for view:",e)}}),m.sendEvent(e.main.gaTitle,"Delete")}function isDateInFuture(e){return Date.parse(e)>Date.parse(new Date)}function setEndOfContenteditable(e){var t,i;document.createRange&&((t=document.createRange()).selectNodeContents(e),t.collapse(!1),(i=window.getSelection()).removeAllRanges(),i.addRange(t))}m.globals.version="1.1.3",m.globals.platform="chrome",m.globals.gaCode="UA-44319322-10",m.globals.gaCodePlus="UA-44319322-13",m.globals.urlRoot="https://api.momentumdash.com/",m.globals.urlRootApi="https://api.momentumdash.com/",m.globals.urlRootLogin="https://login.momentumdash.com/",m.globals.urlRootStats="https://stats.momentumdash.com/",m.globals.urlRootIntegration="https://integration.momentumdash.com/",Handlebars.registerHelper("lower",function(e){return e.toLowerCase()}),m.sendEvent=function(e,t,i,s){m.devTools&&m.devTools.getFeatureDebug("googleAnalytics")&&console.log("GA:",e,"•",t,"•",i,"•",s);var o=m.conditionalFeatures&&m.conditionalFeatures.featureEnabled("plus"),n=o?m.globals.gaCodePlus:m.globals.gaCode;s||(s="event");var a=100;if(isChrome()&&!o&&(a=1),!(100*Math.random()>a))try{var l=sessionStorage?sessionStorage.getItem("ga_sess"):uuidv4();l||(l=uuidv4(),sessionStorage.setItem("ga_sess",l));var r=window.navigator.userLanguage||window.navigator.language,d=window.screen.availWidth+"x"+window.screen.availHeight,c=window.screen.colorDepth,h=window.innerWidth+"x"+window.innerHeight,u=new XMLHttpRequest,g="v=1&tid="+n+"&cid="+l+"&t="+s+"&sf="+a+"&ul="+r+"&sr="+d+"&vp="+h+"&de="+document.characterSet+"&sd="+c+"&aip=1";e&&(g+="pageview"==s?"&dp="+e:"&ec="+e),t&&(g+="&ea="+t),i&&(g+="&el="+i),u.open("POST","https://www.google-analytics.com/collect",!0),u.send(g)}catch(e){}},m.models.Manager=Backbone.Model.extend({}),m.collect.Manager=Backbone.Collection.extend({}),m.models.Addin=Backbone.Model.extend({defaults:{evaluated:!1,processed:!1,lazy:!1}}),m.collect.AddinCollection=Backbone.Collection.extend({model:m.models.Addin}),m.models.AddinManager=Backbone.Model.extend({initialize:function(){var e=this;this.addinCollection=new m.collect.AddinCollection,this.listenTo(this.addinCollection,"add change",this.processPending),setTimeout(function(){e.loadFromAddinObject(!0)},50)},loadEvaluatedAddin:function(e,t){this.addinCollection.add({id:e,evaluated:!0,addInCode:t})},loadPersonalCss:function(){var e=document.createElement("link"),t=$(e);t.attr("rel","stylesheet"),t.attr("href","/css/personal.css"),document.head.appendChild(e)},loadAddin:function(e){this.addinCollection.add({rawCode:e})},loadFromAddinObject:function(e){var i=this,s=!1;_.each(m.addins,function(e,t){s=!0,i.addinCollection.findWhere({id:t})||i.loadEvaluatedAddin(t,e)}),s&&e&&this.processPending()},registerAddinLocalSource:function(e,t){this.addinCollection.findWhere({id:e})||this.addinCollection.add({id:e,path:t})},registerAddinFn:function(e,t){var i=this.addinCollection.findWhere({id:e});i?i.set({evaluated:!0,addInCode:t}):this.addinCollection.add({id:e,evaluated:!0,addInCode:t})},ensureAddinLoaded:function(i,s,o,n){var a=this;if(i=i.toLowerCase(),s&&this.listenToOnce(this,"addin:loaded:"+i,function(){s()}),this.localAddins||this.localLoadFailed){var e=this.addinCollection.get(i),t=null;if(this.localAddins){var l=i.toUpperCase(),r=this.localAddins.map[l];if(r)0<=_.indexOf(this.localAddins.addins,r)&&(t="app/addins/"+r+"/addin.js")}if(e&&e.get("loaded"))s&&s(e);else{if(o)try{o()}catch(e){}if(e||(e=this.addinCollection.add({id:i,evaluated:!1,processed:!1,lazy:!1})),!e.get("loading")){e.set("loading",!0);var d=t||m.globals.urlRootApi+"scripts/"+i,c=document.createElement("script");return c.setAttribute("type","text/javascript"),c.setAttribute("src",d),void document.body.appendChild(c)}}}else $.ajax("app/addins/addins.json",{beforeSend:function(e){e.overrideMimeType&&e.overrideMimeType("application/json")}}).done(function(t){$.ajax("app/addins/map.json",{beforeSend:function(e){e.overrideMimeType&&e.overrideMimeType("application/json")}}).done(function(e){a.localAddins={addins:t.addins,map:e},a.ensureAddinLoaded(i,s,o,n)}).fail(function(){a.localLoadFailed=!0,a.ensureAddinLoaded(i,s,o,n)})}).fail(function(){a.localLoadFailed=!0,a.ensureAddinLoaded(i,s,o,n)})},refresh:function(){this.loadFromAddinObject(!0)},processPending:function(){var i=this;this.evaluatePending(),_.each(this.addinCollection.where({evaluated:!0,processed:!1,lazy:!1}),function(e){try{var t=e.get("addInCode");t&&(e.set({processed:!0}),t(m,$),e.set({evaluated:!0,loading:!1,loaded:!0}),i.trigger("addin:loaded:"+e.id))}catch(e){console.log(e)}})},evaluatePending:function(){}}),m.models.Command=Backbone.Model.extend({defaults:{id:null},getId:function(){return this.id},execute:function(){},canExecute:function(){return!0}}),m.CommandManager=m.collect.Manager.extend({model:m.models.Command,initialize:function(){var t=this;this.commandSources=new Backbone.Collection,m.commands&&_.mapObject(m.commands,function(e){t.registerCommandModel(e,!1)})},registerCommandModel:function(e,t){var i=new e;if(i&&i.id&&(t||!this.get(i.id))){var s=this.get(i.id);s&&this.remove(s),this.add(i)}},registerCommandSources:function(e){e&&0<e.length&&_.each(e,this.registerCommandSource,this)},registerCommandSource:function(e){if(!e.id)throw new Error("An id property is required in cmdSrc");if(!e.addin)throw new Error("An addin property is required in cmdSrc");this.commandSources.findWhere({id:e.id})||this.commandSources.add({id:e.id,addin:e.addin})},registerCommand:function(e,t,i,s){var o={defaults:{id:e},execute:t};i&&(o.canExecute=i);var n=m.models.Command.extend(o);this.registerCommandModel(n,s)},getCommand:function(e){return e?this.get(e):null},ensureCommandLoaded:function(t,i,s,o){var n=this,a=this.get(t);if(a)i&&i(a);else{if(s)try{s()}catch(e){}var l=this.commandSources.get(t);l?l.get("loading")||(l.set("loading",!0),m.addinManager.ensureAddinLoaded(l.get("addin"),function(){l.set("loading",!1),l.set("loaded",!0),i&&i(a)},s,function(e){l.set("loading",!1),o&&o(e)})):(url=m.globals.urlRootApi+"commands/"+encodeURIComponent(t),$.ajax({url:url,beforeSend:m.utils.setMomentumAuthHeader,success:function(e){e&&(n.registerCommandSource(e),(l=n.commandSources.get(t))?l.get("loading")||(l.set("loading",!0),m.addinManager.ensureAddinLoaded(l.get("addin"),function(){l.set("loading",!1),l.set("loaded",!0),i&&i(a)},s,function(e){l.set("loading",!1),o&&o(e)})):o&&o("no command with that id is registered"))},error:function(e){o&&o("no command with that id is registered")}}))}},execute:function(e){var t=this.getCommand(e);if(t)return t.execute.apply(t,[].slice.call(arguments,1))},canExecute:function(e){var t=this.getCommand(e);return!t||t.canExecute.apply(t,[].slice.call(arguments,1))},getProperties:function(e){var t=this.getCommand(e);return!t||!t.getProperties||t.getProperties.apply(t,[].slice.call(arguments,1))}}),m.models.SettingsManager=Backbone.Model.extend({initialize:function(){this.listenTo(m,"settings:register:nav",this.registerNavItem),this.listenTo(m,"settings:register:subnav",this.registerSubNavItem),this.listenTo(m,"settings:register:panel",this.registerPanel),window.addEventListener("storage",function(e){"loggedOut"!=e.key&&"loggedIn"!=e.key||window.location.reload()}),this.registerStockCommandSources()},stockNavItems:null,navItems:[],secondaryNavItems:[],panelItems:[],registerNavItem:function(e){return this.stockNavItems||this.populateStockNavItems(),!this.addOrReplaceIfOverride(this.navItems,e)&&(!this.addOrReplaceIfOverride(this.stockNavItems.navItems,e)&&(this.navItems.push(e),!0))},registerPanel:function(e){return!this.addOrReplaceIfOverride(this.panelItems,e)&&(this.panelItems.push(e),!0)},registerSubNavItem:function(e){return this.stockNavItems||this.populateStockNavItems(),!this.addOrReplaceIfOverride(this.secondaryNavItems,e)&&(!this.addOrReplaceIfOverride(this.stockNavItems.secondaryNavItems,e)&&(this.secondaryNavItems.push(e),!0))},addOrReplaceIfOverride:function(e,t,i){var s=i||{id:t.id},o=_.findWhere(e,s);return!!o&&(t.override&&(e.splice(e.indexOf(o),1),e.push(t)),!0)},registerNavItems:function(e){var t=this,i=!1;e&&(e.nav&&_.each(e.nav,function(e){t.registerNavItem(e)&&(i=!0)}),e.subNav&&_.each(e.subNav,function(e){t.registerSubNavItem(e)&&(i=!0)}),e.panels&&_.each(e.panels,function(e){t.registerPanel(e)}),i&&this.trigger("navItemsChanged"))},getNavItems:function(){return this.populateStockNavItems(),{navItems:_.chain(this.stockNavItems.navItems).union(this.navItems).sortBy("position").value(),secondaryNavItems:_.chain(this.stockNavItems.secondaryNavItems).union(this.secondaryNavItems).sortBy("position").value()}},getPanelItems:function(){return this.panelItems},registerStockCommandSources:function(){m.commandManager.registerCommandSources([{id:"settings.panels.quotes",addin:"DD106F35-669C-4079-A9E3-82DDC5244D0B"},{id:"settings.panels.backgrounds",addin:"D52F5584-5033-4A16-866F-E97C7D7AC826"},{id:"settings.panels.todo",addin:"270AAED6-337F-433F-9D02-A471B435EADA"},{id:"settings.panels.balance",addin:"1E373FA7-A454-4652-8D77-1A4FCC88C069"},{id:"settings.panels.metrics",addin:"DB0B33AA-8ED6-4FFC-B0E0-732A9FF3391D"},{id:"background.custom.uploadfiles",addin:"D52F5584-5033-4A16-866F-E97C7D7AC826"},{id:"tour.plus.show",addin:"E38E9785-27CE-4CAB-8497-8B34AB56B6A1"},{id:"settings.panels.trello.config",addin:"C61B7775-7AB8-443A-A6B7-C8C8DE6FC755"},{id:"todo.zenhub.config",addin:"B81CC20D-5C5A-4163-8FC8-BB0CEEF2882E"},{id:"settings.panels.bookmarks",addin:"E464EB61-05CA-4A56-9C17-6A02673AA136"}]),this.registerPanel({id:"trello",section:"todo",cmd:"settings.panels.trello.config"})},populateStockNavItems:function(){if(!this.stockNavItems){var e=[],t=[];m.conditionalFeatures.featureEnabled("plus")?(e=[{id:"general",title:"General",position:10},{id:"todo",title:"Todo",cmd:"settings.panels.todo",position:20},{id:"background-settings",title:"Photos",cmd:"settings.panels.backgrounds",position:30},{id:"quote-settings",title:"Quotes",cmd:"settings.panels.quotes",position:40},{id:"metrics",title:"Metrics",cmd:"settings.panels.metrics",position:60},{id:"bookmark-settings",title:"Links",cmd:"settings.panels.bookmarks",position:70},{id:"balance",title:"Balance",cmd:"settings.panels.balance",position:80}],t=[{id:"help",title:"Help",position:10},{id:"whatsnew",title:"What’s New",position:20},{id:"about",title:"About",position:30}]):(e=[{id:"general",title:"General",position:10},{id:"todo",title:"Todo",cmd:"settings.panels.todo",position:20},{id:"background-settings",title:"Photos",cmd:"settings.panels.backgrounds",position:30},{id:"quote-settings",title:"Quotes",cmd:"settings.panels.quotes",position:40},{id:"bookmark-settings",title:"Links",cmd:"settings.panels.bookmarks",position:70},{id:"balance",title:"Balance",cmd:"settings.panels.balance",position:80}],t=[{id:"help",title:"Help",position:10},{id:"whatsnew",title:"What’s New",position:20},{id:"about",title:"About",position:30},{id:"upgrade",title:"Upgrade to Plus",cmd:"upsell.website",cmdonly:!0,options:{source:"nav-upgrade-plus"},position:40}]),this.stockNavItems={navItems:e,secondaryNavItems:t}}},infinispin:function(){var e=localStorage.getItem("infinispin");return e=!!e&&JSON.parse(e)},toggleInfinispin:function(){var e=!this.infinispin();return localStorage.setItem("infinispin",e),e}}),m.models.ThemeManager=Backbone.Model.extend({initialize:function(){},defaultFontFamily:'-apple-system, BlinkMacSystemFont, "Neue Haas Grotesk Text Pro", "Helvetica Neue", Helvetica, Arial, sans-serif',initializeThemes:function(){this.listenTo(m.models.customization,"change:themeColour",this.setThemeColour),this.listenTo(m.models.customization,"change:themeFont",this.setThemeFont),this.listenTo(m,"user:successfulLogin user:successfulLogout",this.onLoginEvent),this.loadAllThemeValues()},loadAllThemeValues:function(){this.loadThemeColour(),this.setThemeColour(),this.setThemeFont()},setColorValues:function(e,t){this.colors=t,this.setThemeColour()},saveThemeColour:function(){this.colors&&m.models.customization.set("themeColourCustom",this.toRgbA(this.colors))},loadThemeColour:function(){try{if(m.models.customization.has("themeColourCustom")){var e=m.models.customization.get("themeColourCustom");e&&(this.colors=new Colors({color:e}).colors)}}catch(e){}},getThemeColour:function(){return this.colors},getThemeColourRGBA:function(){return this.colors?this.toRgbA(this.colors):null},setThemeColour:function(){var e,t=$("body"),i=$("head");if(t.removeClass("light"),m.conditionalFeatures.featureEnabled("plus")){var s=m.models.customization.get("themeColour");"light"==s?(t.addClass("light"),e=".dropdown, .u--bg { background-color: #fff; }"):"dark"==s?e=".dropdown, .u--bg { background-color: #000; }":"custom"==s&&this.colors&&(e=(e=(e=(e=".app { background-color: "+this.toRgbA(this.colors)+" !important; }")+".dropdown, .u--bg { background-color: #"+this.colors.HEX+" !important; }")+".nipple-bottom-left:before, .nipple-bottom-right:before { border-top-color: "+this.toRgbA(this.colors)+" !important}")+".nipple-top-left:before, .nipple-top-right:before { border-bottom-color: "+this.toRgbA(this.colors)+" !important}",t.toggleClass("light",.5<this.colors.RGBLuminance)),this.$themeColourCustom?this.$themeColourCustom.html(e):(i.append('<style type="text/css" id="themeColourCustom">'+e+"</style>"),this.$themeColourCustom=i.find("#themeColourCustom").first())}else this.$themeColourCustom&&(this.$themeColourCustom.remove(),this.$themeColourCustom=null)},toRgbA:function(e){return"rgba("+Math.round(255*e.rgb.r)+","+Math.round(255*e.rgb.g)+","+Math.round(255*e.rgb.b)+","+e.alpha+")"},getAvailableFonts:function(){return[{label:"Classic",value:"default"},{label:"Modern",value:"modern"},{label:"Startup",value:"startup",breakafter:!0},{label:"Retro",value:"retro"},{label:"Warehouse",value:"warehouse"},{label:"Quirky",value:"quirky"}]},setThemeFont:function(){var t=this,i=m.models.customization.get("themeFont")||"default";if(m.conditionalFeatures.featureEnabled("plus")){var s=this.defaultFontFamily;if(i&&"default"!=i){var e=null,o=localStorage.getItem("font-"+i);if(o)e=JSON.parse(o),s=this.setFontFromInfo(e)||this.defaultFontFamily,this.setActiveFont(s,i);else try{$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"fonts/"+i}).done(function(e){e&&(localStorage.setItem("font-"+i,JSON.stringify(e)),s=t.setFontFromInfo(e)||t.defaultFontFamily)}).fail(function(e,t){}).always(function(){t.setActiveFont(s,i)})}catch(e){}}else this.setActiveFont(s,i)}else this.setActiveFont(this.defaultFontFamily,i)},setFontFromInfo:function(e){var t=null;if(e){if(!e.builtin){var i=$("head"),s=i.find("#font-"+e.font).first();if(!s||0==s.length){var o=null;e.fontInline?(o=$('<style type="text/css"></style>')).html(e.fontInline):e.fontUrl&&(o=$('<link rel="stylesheet" type="text/css">')).attr("href",e.fontUrl),o&&(o.attr("id","font-"+e.font),i.append(o))}}t=e.exclude_default?e.fontFamily:e.fontFamily+","+this.defaultFontFamily}return t},setActiveFont:function(e,t){var i="body, input, select, textarea, button {font-family: "+e+"; !important}",s=document.createElement("style"),o=$(s);o.attr("type","text/css"),document.head.appendChild(s),s.sheet.insertRule(i,0),o.attr("id","font-override");var n=$("body");_.each(this.getAvailableFonts(),function(e){e.value==t?n.addClass("f--"+e.value):n.removeClass("f--"+e.value)}),$user=$(".user"),$user.hasClass("open")||$user.css("transform","translateY("+$("user-hidden").height()+"px)")},onLoginEvent:function(){this.listenToOnce(m,"sync:settings:complete",this.loadAllThemeValues)}}),m.models.SyncCoordinator=Backbone.Model.extend({initialize:function(){this.syncSettingsInProgress=!1,this.listenTo(m,"sync:download",this.doDownload),this.listenTo(m,"client:id_created",this.onClientIdCreated),this.listenTo(m,"user:successfulLogin",this.onUserLogin),this.listenTo(m,"user:successfulLogout",this.syncSettings),this.listenTo(m,"sync:downloadIfNeeded",this.doDownloadIfNeeded),this.listenTo(m.models.customization,"change",this.customizationChange),this.listenTo(m,"sync:customization",this.customizationChange),m.models.customization.get("etag")||this.customizationChange()},onUserLogin:function(e){this.doDownload(),this.syncSettings(e)},doDownload:function(e){try{var o=this;if(!localStorage.client_uuid)return;var t=m.globals.urlRootApi+"feed/bulk?syncTypes=";if(e){var i=[];-1<e.indexOf("quote")&&(i[i.length]="quote",localStorage.removeItem(o.ddlQuoteString())),-1<e.indexOf("background")&&(i[i.length]="background",localStorage.removeItem(o.ddlBackgroundString())),0<i.length?t+=i.join(","):t+="all"}else t+="all",localStorage.removeItem(o.ddlBackgroundString()),localStorage.removeItem(o.ddlQuoteString());if(t=t+"&localDate="+getActiveDateString(),!localStorage.firstSynchronized){var s=m.models.activeBackground.activeBackgroundUuid();if(!s){var n=m.collect.legacyBackgrounds.getCurrentLocalBackground();n&&(s=n.backgroundUuid())}s&&(t=t+"&legacyBackground="+s)}$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:t}).done(function(e){e.quotes&&0<e.quotes.length&&(m.collect.quotes.reset(e.quotes),m.collect.quotes.invoke("save"),localStorage.shortquote&&localStorage.removeItem("shortquote"),localStorage.setItem(o.ddlQuoteString(),Date.now()),e.ts_quotes&&localStorage.setItem("ts_quotes",JSON.stringify(e.ts_quotes))),e.backgrounds&&0<e.backgrounds.length&&(m.collect.backgrounds.reset(e.backgrounds),m.collect.backgrounds.invoke("save"),localStorage.background&&(localStorage.removeItem("background"),localStorage.removeItem("backgrounds")),localStorage.setItem(o.ddlBackgroundString(),Date.now()),e.ts_backgrounds&&localStorage.setItem("ts_backgrounds",JSON.stringify(e.ts_backgrounds))),localStorage.setItem("firstSynchronized",Date.now())}).fail(function(e,t){if(0<e.status){var i=m.models.backgroundManager.latestBackgroundDate();i&&i>Date.parse(getActiveDateString())&&localStorage.setItem(o.ddlBackgroundString(),Date.now());var s=m.models.quoteManager.latestQuoteDate();s&&s>Date.parse(getActiveDateString())&&localStorage.setItem(o.ddlQuoteString(),Date.now())}else m.trigger("sync:error")})}catch(e){}},doDownloadIfNeeded:function(e){var t=!1,i=!1;if(e){if(e.ts_backgrounds){var s=localStorage.getItem("ts_backgrounds");s?e.ts_backgrounds>JSON.parse(s)&&(t=!0):t=!0}if(e.ts_quotes){var o=localStorage.getItem("ts_quotes");o?e.ts_quotes>JSON.parse(o)&&(i=!0):i=!0}}t||localStorage[this.ddlBackgroundString()]||(t=!0),i||localStorage[this.ddlQuoteString()]||(i=!0),t&&i?this.doDownload():t?this.doDownload("background"):i&&this.doDownload("quote")},pingApi:function(t,i){$.ajax({type:"GET",contentType:"application/json",url:m.globals.urlRootApi}).done(function(e){t&&t()}).fail(function(e,t){i&&i()})},ddlBackgroundString:function(){return"ddl-bg-"+getActiveDateString()},ddlQuoteString:function(){return"ddl-qt-"+getActiveDateString()},onClientIdCreated:function(){this.doDownload(),this.syncSettings()},setSyncSettingsHeaders:function(e){m.utils.setMomentumAuthHeader(e);var t=m.models.customization.get("etag");t&&e.setRequestHeader("X-Momentum-Settings-ETag",t)},customizationChange:function(e){if(!this.syncSettingsInProgress&&!m.models.customization.fetching&&m.conditionalFeatures.featureEnabled("serversettings")){if(e){var t=e.changedAttributes();if(1===Object.keys(t).length&&_.contains(Object.keys(t),"etag"))return}else if(m.models.customization.get("etag"))return;$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(m.models.customization.getPersistentSettings()),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"settings"}).done(function(e){e.etag&&m.models.customization.save({etag:e.etag})}).fail(function(e,t){}).always(function(){})}},submitFeatureAccessRequest:function(e,t,i){var s={feature:e};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(s),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/featurerequest"}).done(function(e){t&&t()}).fail(function(e,t){i&&i()})},syncSettings:function(e){if(localStorage.client_uuid){this.syncSettingsInProgress=!0;var t=this;$.ajax({type:"GET",contentType:"application/json",beforeSend:this.setSyncSettingsHeaders,url:m.globals.urlRootApi+"settings"}).done(function(e){if(e){e.greetings&&(localStorage.greetings=e.greetings),e.features&&m.conditionalFeatures.setFeatures(e.features,!0),e.customization&&m.models.customization.save(e.customization),e.lists&&0<e.lists.length&&m.models.todoListManager&&m.models.todoListManager.mergeLists(e.lists),m.commandManager.execute("addins.load",e.addIns),m.commandManager.registerCommandSources(e.cmd),m.settingsManager.registerNavItems(e.nav),e.download&&m.trigger("sync:download",e.download),e.ts_notifications&&m.trigger("notifications:timestamp",e.ts_notifications);var t=null;e.ts_backgrounds&&((t=t||{}).ts_backgrounds=e.ts_backgrounds),e.ts_quotes&&((t=t||{}).ts_quotes=e.ts_quotes),t&&m.trigger("sync:downloadIfNeeded",t)}}).fail(function(e,t){}).always(function(){t.syncSettingsInProgress=!1,m.trigger("sync:settings:complete"),e&&e()})}}}),m.models.ConditionalFeatures=Backbone.Model.extend({initialize:function(e){this.customization=e.customization||m.models.customization;try{localStorage.f3t6b23d?this.featureList=JSON.parse(atob(localStorage.f3t6b23d)):this.featureList=[]}catch(e){this.featureList=[]}},featureEnabled:function(e){return _.contains(this.featureList,e)},setFeatures:function(e,t){var i=_.contains(this.featureList,"servertodos");localStorage.f3t6b23d!==e&&(localStorage.f3t6b23d=e,this.featureList=JSON.parse(atob(e)),t&&!i&&_.contains(this.featureList,"servertodos")?window.location.reload():m.trigger("feature:changed"))},clearFeatures:function(){this.featureList=[],localStorage.removeItem("f3t6b23d")},checkFeatureAndMigrateData:function(e,o,n,a,i,t){var s=null,l=this;if(this.featureEnabled(e)){for(var r=!1,d=0;d<localStorage.length;d++)if(keyName=localStorage.key(d),0===keyName.indexOf(n+"-")){r=!0;break}if(r)try{var c=new Date,h=c.getFullYear().toString()+"-"+twoDigit(c.getMonth()+1)+"-"+twoDigit(c.getDate())+"-"+twoDigit(c.getHours())+":"+twoDigit(c.getMinutes())+":"+twoDigit(c.getSeconds()),u="migrated-"+n+"-"+h,g=[],p=[];for(d=0;d<localStorage.length;d++)if(keyName=localStorage.key(d),0===keyName.indexOf(n+"-")){p.push(keyName);var f=localStorage.getItem(keyName);if(f){var v=JSON.parse(f);g.push(v)}}var w={items:g},b=JSON.stringify(w);$.ajax({type:"POST",contentType:"application/json",data:b,beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"migrate/"+n}).done(function(e,t,i){for(var s in localStorage.setItem(u,b),p)localStorage.removeItem(p[s]);localStorage.removeItem(n),m.trigger("sync:customization"),o&&!l.customization.getComputedSetting(o)||a()}).fail(function(e,t){o&&!l.customization.getComputedSetting(o)||i()})}catch(e){console.log(e)}else s=a}else s=i;s&&(!o||this.customization.getComputedSetting(o)?s():t?t(s):this.setPreferenceChangeListener(o,s))},setPreferenceChangeListener:function(e,t){var i=this;m.listenToOnce(this.customization,"change:"+e,function(){i.customization.getComputedSetting(e)?t():i.setPreferenceChangeListener(e,t)})},checkPreferenceForRender:function(e,t,i){t&&(!e||this.customization.getComputedSetting(e)?t():i&&i(t))}}),m.models.Widget=Backbone.Model.extend({}),m.collect.Widgets=Backbone.Collection.extend({model:m.models.Widget}),m.views.BasePlaceholder=Backbone.View.extend({initialize:function(){this.render()},render:function(){var e=this.model.get("region"),t=(this.model.get("order")||"append")+"To";return this.$el[t]("."+e).mFadeIn().html(this.template(model.toJSON())),this},attributes:function(){return{id:this.model.get("id"),class:this.model.get("class")}},detach:function(){this.unbind(),this.stopListening(),this.undelegateEvents()}}),m.views.PanePlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.pane,open:!1,events:{"click .toggle":"toggleShow"},initialize:function(){var t=this;this.region=this.model.get("region"),this.visibleStateKey=this.model.get("visibleState"),this.render(),this.model.get("closeOnEsc")&&this.listenTo(m,"globalEvent:esc",this.handleGlobalEsc),this.model.get("toggleEvent")&&this.listenTo(m,this.model.get("toggleEvent"),this.toggleShow),this.model.get("hideEvents")&&_.each(this.model.get("hideEvents"),function(e){t.listenTo(m,e,t.onHideEvent)});var e=this.model.get("visibleSetting");e&&this.listenTo(m.models.customization,"change:"+e,this.visibleChanged),this.shouldShowPane()&&this.showPane()},attributes:function(){return{id:this.model.get("id"),class:"app-container "+this.model.get("id")}},render:function(){var e=this.model.get("label"),t=(this.model.get("order")||"append")+"To";if(!this.renderedOnce){this.$el[t]("."+this.region).mFadeIn().html(this.template({label:e})),this.$app=this.$(".app");var i=this.model.get("width")+"px",s="200px";if(this.model.has("height"))s=this.model.get("height")+"px";else{var o=this.storedPaneHeight();o&&(s=o+"px")}this.$app.css({height:s,width:i}),this.$(".app-wrapper").addClass("nipple-"+this.region),this.renderedOnce=!0}return this},storedPaneHeight:function(){if(this.model.has("storedHeight")){var e=this.model.get("storedHeight"),t=localStorage[e];if(t)return JSON.parse(t)}return null},toggleShow:function(e){e&&e.stopPropagation&&e.stopPropagation(),e&&e.preventDefault&&e.preventDefault(),this.open?this.hidePane():this.showPane()},showPane:function(){if(!this.open){if(this.open=!0,localStorage.setItem(this.visibleStateKey,this.open),this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in"),this.realView)this.realView.onShowPane&&this.realView.onShowPane();else{if(this.loading)return;if(!this.model.has("addin"))return;this.loading=!0,m.addinManager.ensureAddinLoaded(this.model.get("addin"))}m.trigger("globalEvent:toggle:"+this.region,this),m.trigger("globalEvent:toggle",this)}},hidePane:function(){var t=this;this.open&&(this.open=!1,localStorage.setItem(this.visibleStateKey,this.open),this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")}),this.realView&&this.realView.onHidePane&&this.realView.onHidePane())},shouldShowPane:function(){if(this.model.has("visibleState")){var e=localStorage[this.visibleStateKey];if(e)return JSON.parse(e)}return!1},addRealView:function(e){this.realView=e,this.open&&this.realView.onShowPane&&this.realView.onShowPane()},handleGlobalEsc:function(e){!this.open||this.realView&&this.realView.preventCloseOnEsc&&this.realView.preventCloseOnEsc()||this.toggleShow(e)},onHideEvent:function(e){e!=this&&this.hidePane()},visibleChanged:function(e){var t=this.model.get("visibleSetting"),i=m.models.customization.getComputedSetting(t),s=this;i?this.renderedOnce?(this.$el.stop(),setTimeout(function(){s.$el.mFadeIn()},1)):this.render():(this.realView&&this.realView.tearDown&&this.realView.tearDown(),this.$el.stop(),setTimeout(function(){s.$el.mFadeOut()},1))}}),m.views.MetricPlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.metric,initialize:function(){var e=this;this.render(),setTimeout(function(){m.addinManager.ensureAddinLoaded(e.model.get("addin"))},25)},render:function(){if(!this.renderedOnce){this.renderedOnce=!0;var e={},t=this.model.get("cachedKey");t&&(e=JSON.parse(localStorage.getItem(t)));var i=this.model.get("region"),s=(this.model.get("order")||"append")+"To";this.$el[s]("."+i).mFadeIn().html(this.template(e))}return this},addRealView:function(e){this.realView=e}}),m.models.WidgetManager=m.models.Manager.extend({skippedPlaceholders:[],initialize:function(){this.regions={},this.regions["top-right"]={widgets:[{el:"app-metric",view:"metric"},{el:"weather-app",view:"weather"}],overlappingRegion:"bottom-right"},this.regions["bottom-right"]={widgets:[{el:"todo-app",view:"todoPane"},{el:"notes-app",view:"notes"}],overlappingRegion:"top-right"},this.regions.bottom={widgets:[{el:"quote",view:"quote"}],overlappingRegion:"top-right"};var e=this;m.models.customization.initialized?e.setup():this.listenToOnce(m.models.customization,"initialized",function(){e.setup()})},setup:function(){this.widgets=m.collect.widgets=new m.collect.Widgets,this.listenTo(this.widgets,"add",this.onAdd),this.listenTo(m,"user:successfulLogin",this.onSuccessfulLogin),this.populatePlaceholders()},populatePlaceholders:function(){this.widgets.add({id:"notes",label:"Notes",type:"pane",region:"bottom-right",order:"prepend",storedHeight:"notes-pane-height",visibleState:"showNotes",width:550,height:520,addin:"23c67761-9831-415e-b358-c6844eb6c244",requiredFeature:"notes",toggleEvent:"globalEvent:key:N",hideEvents:["globalEvent:toggle:bottom-left","globalEvent:toggle:bottom-right","globalEvent:toggle:top-right"],closeOnEsc:!0,visibleSetting:"notesVisible"}),this.widgets.add({type:"metric",id:"countdown",class:"app-container base-metric metric countdown add-shadow",region:"top-right",order:"append",addin:"fb230b62-96ce-44b5-87c5-4a563553038b",requiredFeature:"countdown",visibleSetting:"countdownVisible"}),this.widgets.add({type:"metric",id:"multiclock",class:"app-container base-metric metric multiclock add-shadow",region:"top-right",order:"append",addin:"DD91D97E-FC83-4FCA-B5CB-D89EB2E1DD0D",requiredFeature:"countdown",visibleSetting:"multiClockVisible"})},onAdd:function(e){this.addWidget(e)},onSuccessfulLogin:function(){var t=this,e=this.skippedPlaceholders;this.skippedPlaceholders=[],_.each(e,function(e){t.addWidget(e)})},addWidget:function(t,e){var i=this;if(e=e||!1,!t.has("requiredFeature")||m.conditionalFeatures.featureEnabled(t.get("requiredFeature"))){if(!e&&t.has("visibleSetting")){var s=t.get("visibleSetting");if(!m.models.customization.getComputedSetting(s))return void this.listenToOnce(m.models.customization,"change:"+s,function(){var e=!!m.models.customization.getComputedSetting(s);i.addWidget(t,e)})}var o=null;o="metric"==t.get("type")?new m.views.MetricPlaceholder({model:t}):new m.views.PanePlaceholder({model:t}),t.placeholder=o}else this.skippedPlaceholders.push(t)},handover:function(e,t,i){i=i||{};var s=this.widgets.find({id:e});if(s){var o=s.placeholder;if(!o)return void console.log("error: no placeholder");var n=s.get("type");"pane"==n?i.el=o.$app:"metric"==n&&(i.el=o.el);var a=new t(i);return $(i.el&&i.el[0]).closest(".app-placeholder").removeClass("app-placeholder"),o.addRealView(a),s.realview=a}return new t(i)},refocusOverlap:function(e){$("."+this.regions[e].overlappingRegion).removeClass("unfocus")},unfocusOverlap:function(e,t){var i=this.regions[e].overlappingRegion,s=this.regions[i],o=$("."+i),n=[];s.widgets.forEach(function(e){var t=0,i=m.views[e.view];if(!i&&window.addin&&(i=addin.views[e.view]),i&&i.getCurrentHeight)t=i.getCurrentHeight();else{var s=$("."+e.el);t=0<s.length&&s.is(":visible")?s.height():0}n.push(t)});var a=$("."+e).outerHeight(!0)+o.outerHeight(!0)+Math.max.apply(null,n),l=$(".bookmarks-wrapper"),r=0;l.css("transform")&&(r=parseInt(l.css("height"))-parseInt(l.css("transform").split(",")[5])),$("body").height()-(a+r+4)<t&&o.addClass("unfocus")},hideAppsExcept:function(e,t){var i=$(".app-container"),s=$(".apps");this.timeout&&clearTimeout(this.timeout),$.each(i,function(){$(this).css({opacity:""})}),e&&!e.includes("background-info")&&s.addClass("bg-info-fullscreen");var o=$(e);o.length&&$.each(o,function(){$(this).addClass("show-anyway")}),s.addClass("hide-apps"),t?(s.addClass("hide-apps-visibility"),this.appsHidden=!0):this.timeout=setTimeout(function(){s.addClass("hide-apps-visibility")},550)},showApps:function(e){this.timeout&&clearTimeout(this.timeout);var t=$(".apps");e&&(t.addClass("u--no-transition"),t.removeClass("show-apps"),setTimeout(function(){t.removeClass("u--no-transition"),t.addClass("show-apps")},10)),t.removeClass("hide-apps hide-apps-visibility");var i=$(".apps .show-anyway");i.length&&$.each(i,function(){$(this).removeClass("show-anyway")}),this.timeout=setTimeout(function(){t.removeClass("bg-info-fullscreen")},500)}}),window.m.usageDB=function(){var i=null,d={READY:"ready",UPLOADING:"uploading",UPLOADED:"uploaded"};function s(){try{window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,dbVersion=1;var t=indexedDB.open("momo-db",1);t.onsuccess=function(){i=t.result},t.onerror=function(e){},t.onupgradeneeded=function(e){!function(e,t){try{e.oncomplete=function(e){i=t},t.createObjectStore("usage",{keyPath:"key"}).createIndex("ready",["forDate","itemUuid","status"])}catch(e){}}(e.target.transaction,t.result)}}catch(e){}}function c(){return new Promise(function(t,e){try{i?t(i):(s(),setTimeout(function(){c().then(function(e){t(e)})},10))}catch(e){}})}return{status:d,increment:function(o,n,a,l){var r=null;c().then(function(e){try{var t=e.transaction(["usage"],"readwrite");t.oncomplete=function(){},t.onerror=function(e){};var i=getActiveDateString(),s=t.objectStore("usage").index("ready").get([i,o,d.READY]);s.onsuccess=function(e){try{r=void 0===e.target.result?m.usage.create(o,n):e.target.result,Array.isArray(a)||(a=[a]),a.forEach(function(e){r[e]++}),t.objectStore("usage").put(r),l&&l(e.target.result)}catch(e){}},s.onerror=function(e){}}catch(e){}})},prepareUnsynced:function(a){c().then(function(e){try{var t=e.transaction(["usage"],"readwrite");t.oncomplete=function(){a&&a(n)};var s=(new Date).getTime(),o=s-6e4,i=t.objectStore("usage"),n=[];i.openCursor().onsuccess=function(e){try{var t=e.target.result;if(t){if(t.value.status===d.READY||t.value.uploadDate<o){var i=t.value;i.status=d.UPLOADING,i.uploadDate=s,t.update(i).onsuccess=function(){n.push(i)}}t.continue()}}catch(e){}}}catch(e){}})},cleanSynced:function(i,s){c().then(function(e){try{var t=e.transaction(["usage"],"readwrite");t.oncomplete=function(){s&&s()},t.objectStore("usage").openCursor().onsuccess=function(e){try{var t=e.target.result;t&&(i.map(function(e){t.value.key===e&&t.delete()}),t.continue())}catch(e){}}}catch(e){}})}}}(),window.m.usage=function(){try{var t={PHOTO:"Photo",QUOTE:"Quote",MANTRA:"Mantra"},i={IMPRESSION_COUNT:"impressionCount",HOVER_COUNT:"hoverCount",LOAD_COUNT:"loadCount",CLICK_COUNT:"clickCount",SECONDARY_CLICK_COUNT:"secondaryClickCount",ADMIRE_COUNT:"admireCount",STICKY_CLICK_COUNT:"stickyClickCount",STICKY_SECONDARY_CLICK_COUNT:"stickySecondaryClickCount",STICKY_HOVER_COUNT:"stickyHoverCount"},s={};s[t.PHOTO]=[i.IMPRESSION_COUNT,i.HOVER_COUNT,i.LOAD_COUNT,i.ADMIRE_COUNT,i.CLICK_COUNT,i.STICKY_CLICK_COUNT,i.SECONDARY_CLICK_COUNT,i.STICKY_SECONDARY_CLICK_COUNT,i.STICKY_HOVER_COUNT],s[t.QUOTE]=[i.IMPRESSION_COUNT,i.HOVER_COUNT,i.LOAD_COUNT,i.CLICK_COUNT];var o="usage-retry-after",n={timeThreshold:1e3,timeThresholdPassed:!1};function a(e){return e&&e.get?e.get("_id")||e.get("id"):null}return n["loaded"+t.PHOTO]=null,n["loaded"+t.QUOTE]=null,n["trackedLoaded"+t.PHOTO]=null,n["trackedLoaded"+t.QUOTE]=null,setTimeout(function(){n.timeThresholdPassed=!0},n.timeThreshold),document.addEventListener("visibilitychange",function(){!document.hidden&&n.timeThresholdPassed&&Object.values(t).forEach(function(e){var t=n["loaded"+e];t&&(n["trackedLoaded"+e]===t?m.usage.recordImpression(t,e):(n["trackedLoaded"+e]=t,m.usage.recordLoadAndImpression(t,e)))})}),{properties:i,types:t,create:function(e,t){var i={itemUuid:e,forDate:getActiveDateString(),status:m.usageDB.status.READY,uploadDate:0,type:t,key:uuidv4()};return s[t].forEach(function(e){i[e]=0}),i},itemLoaded:function(e,t){try{function i(e,t){document.hidden||(n["trackedLoaded"+t]=e,m.usage.recordLoadAndImpression(e,t))}n["loaded"+t]=e,n["trackedLoaded"+t]=null,n.timeThresholdPassed&&!document.hidden?i(e,t):setTimeout(function(){document.hidden||i(e,t)},n.timeThreshold)}catch(e){}},increment:function(e,t,i,s){var o=this;try{m.usageDB.increment(e,t,i,function(){s&&o.sendStats()})}catch(e){}},recordLoadAndImpression:function(e,t){try{this.increment(a(e),t,[i.LOAD_COUNT,i.IMPRESSION_COUNT],this.shouldSendNow(e))}catch(e){}},recordStickyHover:function(e,t){try{this.increment(a(e),t,[i.HOVER_COUNT,i.STICKY_HOVER_COUNT])}catch(e){}},recordHover:function(e,t){try{this.increment(a(e),t,i.HOVER_COUNT)}catch(e){}},recordClick:function(e,t){try{this.increment(a(e),t,i.CLICK_COUNT,this.shouldSendNow(e))}catch(e){}},recordStickyClick:function(e,t){try{this.increment(a(e),t,[i.CLICK_COUNT,i.STICKY_CLICK_COUNT],this.shouldSendNow(e))}catch(e){}},recordSecondaryClick:function(e,t){try{this.increment(a(e),t,i.SECONDARY_CLICK_COUNT,this.shouldSendNow(e))}catch(e){}},recordStickySecondaryClick:function(e,t){try{this.increment(a(e),t,[i.SECONDARY_CLICK_COUNT,i.STICKY_SECONDARY_CLICK_COUNT],this.shouldSendNow(e))}catch(e){}},recordImpression:function(e,t){try{this.increment(a(e),t,i.IMPRESSION_COUNT)}catch(e){}},recordAdmire:function(e){try{this.increment(a(e),t.PHOTO,i.ADMIRE_COUNT)}catch(e){}},shouldSendNow:function(e){return e&&(e.get("sticky")||e.get("now"))},sendStats:function(){function e(e){try{if(!e||0===e.length||!localStorage.getItem("client_uuid")||!navigator.onLine)return;var t=localStorage.getItem(o);if(t){if((new Date).getTime()<parseInt(t))return;localStorage.removeItem(t)}e.forEach(function(t){s[t.type].forEach(function(e){0===t[e]&&delete t[e]}),t.type=t.type===m.usage.types.PHOTO?1:2,delete t.status,delete t.uploadDate}),$.ajax({type:"post",contentType:"application/json",beforeSend:m.utils.setMomentumAuthHeader,url:m.globals.urlRootApi+"usage/feeds",data:JSON.stringify(e)}).done(function(e){e&&m.usageDB.cleanSynced(e)}).error(function(e){if(503===e.status){var t=e.getResponseHeader("Retry-After");t&&(t=parseInt(t),localStorage.setItem(o,(new Date).getTime()+1e3*t))}})}catch(e){}}n.sending?setTimeout(this.sendStats,5e3):setTimeout(function(){m.usageDB.prepareUnsynced(e),setTimeout(function(){n.sending=!1},1e3)},1e3)}}}catch(e){}}(),m.models.BackgroundBase=Backbone.Model.extend({backgroundUuid:function(){var e=this.get("_id");if(e)return e;var t,i=this.get("filename");return 0===i.indexOf("http")?null:2==(t=i.split("/")).length&&2==(t=t[1].split(".")).length?t[0]:null}}),m.models.Background=m.models.BackgroundBase.extend({idAttribute:"forDate"}),m.models.ActiveBackground=Backbone.Model.extend({initialize:function(e,t){this.displayLogged=!1,this.backgrounds=t.backgrounds,this.legacyBackgrounds=t.legacyBackgrounds,this.listenTo(this.backgrounds,"reset",this.collectionReady),this.listenTo(this.legacyBackgrounds,"reset",this.legacyCollectionReady),this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(m,"waitForPhotoActivation",this.waitForPhotoActivation,this),this.listenTo(this,"background:fallback",this.handleFallback,this)},handleNewDay:function(){var e=this;try{m.usage.sendStats()}catch(e){}e.intervalId=setInterval(function(){0<e.backgrounds.length&&(e.checkActiveBackground(),clearInterval(e.intervalId))},50)},handleFallback:function(){var t=this.fallbackKey(),e=localStorage.getItem(t),i=null,s=this;e?this.legacyBackgrounds.getBackground(e,function(e){e||(e=s.legacyBackgrounds.getCurrentLocalBackground())&&localStorage.setItem(t,e.backgroundUuid()),e&&(s.usingFallback=!0,s.setActiveBackground(e))}):i||(i=s.legacyBackgrounds.getCurrentLocalBackground())&&(localStorage.setItem(t,i.backgroundUuid()),s.usingFallback=!0,s.setActiveBackground(i))},waitForPhotoActivation:function(e){this.isWaitingForPhotoActivation=e},collectionReady:function(){this.usingFallback&&!this.isWaitingForPhotoActivation||(this.checkActiveBackground(),this.isWaitingForPhotoActivation=!1)},fallbackKey:function(){return"fallback-"+getActiveDateString()},legacyCollectionReady:function(){0<this.backgrounds.length?this.backgrounds.get(getActiveDateString())||this.checkActiveBackground():this.checkActiveBackground()},activeBackgroundUuid:function(){return this.backgroundItem?this.backgroundItem.backgroundUuid():null},checkActiveBackground:function(){var e=null;this.backgrounds&&0<this.backgrounds.length&&(e=this.backgrounds.getActiveBackground())?this.setActiveBackground(e):this.trigger("background:fallback")},successfullyLoaded:function(e){this.backgroundItem.backgroundUuid()==e&&this.trigger("background:successfullyLoaded",this.backgroundItem),this.preCacheFutureBackgroundImages()},setActiveBackground:function(e){e&&(e.has("_id")&&this.lastBgId==e.get("_id")||(this.lastBgId=e.get("_id"),this.backgroundItem&&this.backgroundItem.cid==e.cid||(this.displayLogged=!1,this.backgroundItem=e,this.trigger("background:activechanged",e))))},generateUUID:function(){var i=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(i+16*Math.random())%16|0;return i=Math.floor(i/16),("x"==e?t:3&t|8).toString(16)})},preCacheFutureBackgroundImages:function(){var i=this,s=Date.parse(getActiveDateString());this.backgrounds&&0<this.backgrounds.length&&this.backgrounds.map(function(e){var t=Date.parse(e.get("forDate"));s<t&&i.preCacheBackgroundImage(e)})},preCacheBackgroundImage:function(e){if(e){var t=e.get("filename");if(t&&0===t.indexOf("http"))try{var i=new Image;i.addEventListener("load",function(e){i.removeEventListener("load",arguments.callee,!1)},!1),i.src=t}catch(e){}}}}),m.models.LegacyBackground=m.models.BackgroundBase.extend({parse:function(e){var t,i=e.id;i||2==(t=e.filename.split("/")).length&&2==(t=t[1].split(".")).length&&(i=t[0]);this.set({id:i,filename:e.filename,title:e.title,source:e.source,sourceUrl:e.sourceUrl})}}),m.collect.Fallbacks=Backbone.Collection.extend({model:Backbone.Model,beforeDate:function(t){return filtered=this.filter(function(e){return e.get("fallbackDate")<t}),new m.collect.Fallbacks(filtered)}}),m.collect.Backgrounds=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-background"),model:m.models.Background,getActiveBackground:function(){if(0<this.length){var e=getActiveDateString();return this.get(e)}}}),m.collect.LegacyBackgrounds=Backbone.Collection.extend({model:m.models.LegacyBackground,url:"app/backgrounds.json",parse:function(e){return e.backgrounds},initialize:function(){this.initialized=!1,this.listenTo(this,"reset",function(){this.initialized=!0}),localStorage.firstSynchronized||this.listenTo(this,"reset",this.initializeBackground)},initializeBackground:function(){this.getCurrentLocalBackground(),m.trigger("sync:downloadIfNeeded")},getBackground:function(e,t){if(this.initialized)t(this.get(e));else{var i=this;setTimeout(function(){i.getBackground(e,t)},10)}},getCurrentLocalBackground:function(){if(0===this.models.length)return null;var e=null,t=m.models.activeBackground.fallbackKey(),i=localStorage.getItem(t);if(i&&(e=this.get(i)),!e){if(!this.parseRecentFallbacks())return null;var s=Math.floor(.75*this.models.length),o=this.fallbacks.sortBy(function(e){return-e.get("fallbackDate")}),n=_.first(o,s),a=_.map(n,function(e){return e.get("backgroundGuid")}),l=this.pluck("id");if(m.collect.backgrounds){var r=m.collect.backgrounds.sortBy(function(e){return-Date.parse(e.get("forDate"))});s=Math.floor(.25*this.models.length);var d=_.first(r,s),c=_.map(d,function(e){return e.get("_id")});a=_.union(a,c)}var h=_.difference(l,a);if(0<h.length){var u=_.sample(h);e=this.get(u)}else e=this.sample()}return e},parseRecentFallbacks:function(){if(this.fallbacks)return!0;this.fallbacks=new m.collect.Fallbacks;var n=this;return $.each(localStorage,function(e,t){if(0===e.indexOf("fallback-")){var i=e.slice(9),s=Date.parse(i),o=new Backbone.Model({fallbackDate:s,backgroundGuid:t});n.fallbacks.add(o)}}),!0}}),m.models.BackgroundManager=Backbone.Model.extend({initialize:function(e,t){m.collect.backgrounds=new m.collect.Backgrounds,m.collect.legacyBackgrounds=new m.collect.LegacyBackgrounds,m.models.activeBackground=new m.models.ActiveBackground({},{backgrounds:m.collect.backgrounds,legacyBackgrounds:m.collect.legacyBackgrounds})},firstFetch:function(){m.collect.backgrounds.fetch({reset:!0}),m.collect.legacyBackgrounds.fetch({reset:!0})},skipErrorMessage:{message:"Oops! We weren't able to get a new background. Please check your connection and try again.",viewLimit:1},favouriteErrorMessage:{message:"Oops! We weren't able to save the favorite. Please check your connection and try again.",viewLimit:1},skipBackground:function(i){var s=this,e=m.globals.urlRootApi+"backgrounds",t={operation:"skip",active_uuid:m.models.activeBackground.activeBackgroundUuid()};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(t),url:e}).done(function(e){if(e&&e.success&&m.trigger("sync:download","background"),e&&e.notification){if("max_skips"==e.notification.type){if(localStorage.displayedMaxSkips)return;localStorage.displayedMaxSkips=!0}e.notification.display_time||(e.notification.display_time=5e3),m.commandManager.execute("notification.show.enhanced",e.notification)}}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",s.skipErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",s.skipErrorMessage),i&&i()}},toggleFavorite:function(e,i,t){var s=this,o=m.globals.urlRootApi+"backgrounds/favorites",n={operation:"favorite",active_uuid:m.models.activeBackground.activeBackgroundUuid(),is_favorite:e};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(n),url:o}).done(function(e){e&&e.success&&(m.trigger("sync:download","background"),m.trigger("background:favorite",{id:n.active_uuid,is_favorite:n.is_favorite}),t&&t())}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",s.favouriteErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",s.favouriteErrorMessage),i&&i()}},latestBackgroundDate:function(){var i=null;return m.collect.backgrounds.models.forEach(function(e){var t=Date.parse(e.id);(!i||i<t)&&(i=t)}),i}}),m.views.Background=Backbone.View.extend({tagName:"li",attributes:{},events:{click:"closeTrays"},isBackgroundLoaded:!1,initialize:function(){this.model=m.models.backgroundManager,this.listenTo(m.models.activeBackground,"background:activechanged",this.setBackground)},render:function(){this.model&&this.model.backgroundItem&&this.setBackground(this.model.backgroundItem)},setBackground:function(o){var n=this,e=!1;n.isBackgroundLoaded&&(e=!0);var a=o.get("filename"),l=o.backgroundUuid(),r=(this.options.order||"append")+"To";$(".background").css("background-image",$(".background").find("li").css("background-image")),this.lastId=l,this.loadCompleted=!1,"true"==localStorage.getItem("failed:"+a)&&(n.loadCompleted=!0,m.models.activeBackground.trigger("background:fallback")),$("<img/>").on("load",function(){var e=!1,t=o.get("height"),i=o.get("width");t&&i?this.height==t&&this.width==i||(e=!0):o.get("skip_check")||(this.height<750||this.width<1e3)&&(e=!0);if(e)return m.models.activeBackground.trigger("background:fallback"),localStorage.setItem("failed:"+a,"true"),void(n.loadCompleted=!0);var s="fadein";n.isBackgroundLoaded&&(s="fadein-slow"),n.loadCompleted=!0,m.models.activeBackground.successfullyLoaded(l);try{m.usage.itemLoaded(o,m.usage.types.PHOTO)}catch(e){}n.isBackgroundLoaded=!0,l===n.lastId&&(n.$el[r]("."+n.options.region).css("background-image","url("+a+")").addClass(s),$(this).remove(),$(".apps").addClass("show-apps"),setTimeout(function(){$(".background-overlay").addClass("show")},5)),setTimeout(function(){m.trigger("background:loadSuccessful",l)},200)}).on("error",function(e){n.loadCompleted=!0,n.isBackgroundLoaded?m.trigger("background:error",l):m.models.activeBackground.trigger("background:fallback")}).attr("src",a),e||window.setTimeout(function(){n.loadCompleted||(n.loadCompleted=!0,m.models.activeBackground.trigger("background:fallback"))},4e3)},closeTrays:function(e){$(".show").each(function(){removeClass("show")})}}),m.views.BackgroundInfo=Backbone.View.extend({tagName:"div",attributes:{class:"app-container background-info"},template:m.templates.background["background-info"],timeAdmireDelay:4e3,timeoutIdAdmire:null,events:{mouseenter:"handleHoverOn",mouseleave:"handleHoverOff","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff","click .background-info-title":"clickTitle","click .background-info-source-link":"clickSource","click .source-url":"trackClick","click .control-heart":"toggleFavorite","click .control-refresh":"skipBackground"},initialize:function(){this.listenTo(m.models.activeBackground,"background:successfullyLoaded",this.activeBackgroundReady),this.listenTo(m.models.activeBackground,"background:error",this.skipFailed),this.listenTo(m,"sync:error",this.skipFailed),this.listenTo(m,"globalEvent:windowBlur",this.unfocusBg)},parentReady:function(e){this.isParentReady=!0,(this.isBackgroundReady||e)&&this.render()},activeBackgroundReady:function(){this.isBackgroundReady=!0,this.isParentReady&&this.render()},render:function(){m.models.activeBackground&&m.models.activeBackground.backgroundItem&&this.setBackground(m.models.activeBackground.backgroundItem),this.$bgOverlay=$(".background-overlay"),this.$apps=$(".apps").first(),!document.hidden&&this.activeBackground.get("sticky")&&this.stick()},setBackground:function(e){var t=this,i="",s=null,o="",n="",a="",l="",r=!1,d=!1,c=null;if(e){if(i=e.get("title"),n=e.get("sourceUrl"),a=e.get("detailUrl"),s=e.get("attribution"),o=e.get("source"),c=e.get("templateId")){var h=m.templates.background["background-template-"+c];h&&(this.template=h)}s||(s="Photo by "+o),e.get("is_favorite")&&(r=!0,l="active")}this.activeBackground?this.activeBackground.backgroundUuid()!=e.backgroundUuid()?d=!0:i==this.activeBackground.get("title")&&s==this.activeBackground.get("attribution")||(d=!0):d=!0,d&&(this.activeBackground=e),a&&0<a.length?(this.detailUrl=a,this.$el.addClass("has-link")):(this.detailUrl=null,this.$el.removeClass("has-link"));var u={title:i,source:o,sourceUrl:n,attribution:s,fav_class:l,hasDetailUrl:Boolean(this.detailUrl),sticky:this.activeBackground.get("sticky")};if(this.renderedOnce)d&&(this.$el.addClass("u--no-opacity"),setTimeout(function(){t.$background_info_title.html(i+'<i class="icon-angle-right"></i>'),t.$background_info_source_link.text(s),t.$el.removeClass("u--no-opacity")},500));else{var g=(this.options.order||"append")+"To";this.$el[g]("."+this.options.region).html(this.template(u)),this.$background_info_source_link=this.$el.find(".background-info-source-link").first(),this.$background_info_title=this.$el.find(".background-info-title").first(),this.$control_heart=this.$el.find(".control-heart").first(),this.$control_refresh=this.$el.find(".control-refresh").first(),this.renderedOnce=!0}return n&&0<n.length?(this.$background_info_source_link.data("url",n),this.$background_info_source_link.removeClass("no-link")):(this.$background_info_source_link.data("url",null),this.$background_info_source_link.addClass("no-link")),this.skipInProgress&&(this.$control_refresh.removeClass("active"),this.skipInProgress=!1),m.conditionalFeatures.featureEnabled("skip-bg")?this.$control_refresh.show():this.$control_refresh.hide(),this.$control_heart.show(),r?this.$control_heart.addClass("active"):this.$control_heart.removeClass("active"),this},stick:function(){var e=this.activeBackground.get("_id")||this.activeBackground.get("id"),t=this.activeBackground.get("sticky"),i="triggered-"+this.activeBackground.get("forDate")+"-"+e,s=localStorage.getItem(i);(s=s?Number.parseInt(s):0)<t&&(localStorage.setItem(i,s+1),this.$el.addClass("sticky"),this.stickySession=!0)},handleHoverOn:function(){var e=this;e.hover=!0,setTimeout(function(){if($(e.$el).find(".background-info-title").css({"z-index":1}),e.hover)try{e.stickySession?m.usage.recordStickyHover(e.activeBackground,m.usage.types.PHOTO):m.usage.recordHover(e.activeBackground,m.usage.types.PHOTO)}catch(e){}},300),this.clearTimeoutAdmire(),this.timeoutIdAdmire=setTimeout(function(){e.focusOnBg()},this.timeAdmireDelay)},clearTimeoutAdmire:function(){null!==this.timeoutIdAdmire&&(clearTimeout(this.timeoutIdAdmire),this.timeoutIdAdmire=null)},handleHoverOff:function(){this.clearTimeoutAdmire(),this.$el.removeClass("sticky"),this.hover=!1;var e=this;setTimeout(function(){$(e.$el).find(".background-info-title").css({"z-index":""}),e.unfocusBg()},300)},focusOnBg:function(){if(!$(".apps").hasClass("hide-apps")&&!(this.focusing||this.unfocusing||this.focused)){try{m.usage.recordAdmire(this.activeBackground)}catch(e){}this.focusing=!0,this.focused=!0;var e=this;setTimeout(function(){e.focusing=!1},1e3),m.widgetManager.hideAppsExcept(".apps .background-info"),$(this.$el).addClass("add-shadow show-shadow"),this.$bgOverlay.addClass("slow"),setTimeout(function(){e.$bgOverlay.removeClass("show")},5)}},unfocusBg:function(){if(this.focused){this.unfocusing=!0,this.focused=!1;var e=this;$(e.$el).removeClass("show-shadow"),m.widgetManager.showApps(),this.$bgOverlay.addClass("show"),setTimeout(function(){$(this.$el).removeClass("add-shadow"),e.$bgOverlay.removeClass("slow"),e.unfocusing=!1},1e3)}},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detailUrl&&0<this.detailUrl.length&&$(this.$el).addClass("has-link")},clickTitle:function(e){e.stopPropagation(),e.preventDefault(),this.detailUrl&&0<this.detailUrl.length&&this.trackClickAndGo(this.detailUrl)},clickSource:function(e){e.stopPropagation(),e.preventDefault();var t=$(e.currentTarget).data("url");this.trackClickAndGo(t,!0)},trackClickAndGo:function(e,t){try{this.stickySession?m.usage[t?"recordStickySecondaryClick":"recordStickyClick"](this.activeBackground,m.usage.types.PHOTO):m.usage[t?"recordSecondaryClick":"recordClick"](this.activeBackground,m.usage.types.PHOTO)}catch(e){}e&&(this.clearTimeoutAdmire(),this.hover=!1,window.open(e,"_blank"))},toggleFavorite:function(e){e.stopPropagation(),$(e.currentTarget).toggleClass("active");var t=$(e.currentTarget).hasClass("active");m.models.backgroundManager.toggleFavorite(t,function(){$(e.currentTarget).toggleClass("active")}),m.sendEvent("Background",t?"Favourite":"Unfavourite")},skipFailed:function(){this.skipInProgress&&(this.$control_refresh.removeClass("active"),this.skipInProgress=!1)},skipBackground:function(e){var t=this;e.stopPropagation(),this.skipInProgress||(this.skipInProgress=!0,$(e.currentTarget).addClass("active"),m.models.backgroundManager.skipBackground(function(){t.skipFailed()}),m.sendEvent("Background","Skip"))}}),m.views.Search=Backbone.View.extend({className:"app-container search",events:{"focusin .search-input":"handleFocusIn","focusout .search-input":"handleFocusOut","keyup .search-input":"checkForEscape","submit .search-form":"doSearch"},initialize:function(){this.renderedOnce=!1,this.listenTo(m,"globalEvent:click",this.hideResults),this.listenTo(m,"globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleSearch",this.toggleShow),this.listenTo(m.models.customization,"change:searchVisible",this.visibleChanged),this.render()},render:function(){var e=(this.options.order||"append")+"To";return this.$el[e]("."+this.options.region).mFadeIn().html($.trim('<form class="search-form"><span class="search-underline"></span><i class="icon-search"></i><input type="text" id="search-input" class="search-input" autocomplete="off"></form>')),this.$input=this.$el.find("input"),this.renderedOnce=!0,this},visibleChanged:function(e){m.models.customization.get("searchVisible")?this.renderedOnce?this.$el.mFadeIn():this.render():this.$el.mFadeOut(500,!1)},doSearch:function(e){e.preventDefault();var o=this.$el.find(".search-input")[0].value;if(0<o.length){var t=m.globals.urlRootApi+"search";if(!localStorage.token){var i=m.models.customization.get("searchProvider");i||(i="google"),t=t+"?provider="+i}$.ajax({type:"GET",beforeSend:m.utils.setMomentumAuthHeader,url:t}).done(function(e,t,i){if(e&&e.searchUrl){var s=e.searchUrl+encodeURIComponent(o);e.searchOutput&&"redirect"==e.searchOutput?window.location.href=s:$(".search-results").attr("src",s).attr("target","_top").addClass("fadein").css("display","block")}}).fail(function(e,t){var i="https://search.momentumdash.com/?q="+encodeURIComponent(o);$(".search-results").attr("src",i).attr("target","_top").addClass("fadein").css("display","block")}),m.sendEvent("Search","Searched")}},handleFocusIn:function(){$(".search").addClass("active"),m.sendEvent("Search","Focused")},handleFocusOut:function(){$(".search").removeClass("active")},hideResults:function(e){(!$.contains(this.el,e.target)&&$(".search-results").hasClass("fadein")||1==e.hide)&&$(".search-results").removeClass("fadein").css("display","none")},checkForEscape:function(e){27==e.keyCode&&this.hideResults({hide:"true"})},toggleShow:function(e){this.$input.is(":focus")?this.$input.blur():this.$input.focus()},hide:function(){this.$input.is(":focus")&&this.$input.blur()}}),m.bootstrappers.RenderSearch=function(t,e){t.conditionalFeatures.checkPreferenceForRender("searchVisible",function(){t.models.customization.get("searchVisible")&&(t.views.search=new t.views.Search({region:"top-left",order:"append"}),t.widgets.push(t.views.search),t.stopListening(t.models.customization,"change:searchVisible"))},function(e){t.listenTo(t.models.customization,"change:searchVisible",e)})},m.collect.SyncedCollection=Backbone.Collection.extend({initialize:function(e){this.model=e.model,this.idAttribute="csid",this.version=2,this.name=e.name,localStorage.getItem("syncedCollectionVersion-"+this.name)||(this.migrate(),localStorage.setItem("syncedCollectionVersion-"+this.name,this.version)),this.serverIdAttribute=e.idAttribute||"id",this.localStorage=new Backbone.LocalStorage(e.name),this.apiUrl=e.apiUrl||m.globals.urlRootApi+e.name,this.listenTo(this,"add",this.onAdd),this.listenTo(this,"remove",this.onRemove),this.listenTo(this,"change",this.onChange),this.listenTo(this,"reset",this.onReset),this.includeArchived=!1,this.transientProps=e.transientProps||[],this.sorted=e.sorted},create:function(e,t){t=t||{},e[this.idAttribute]||(e[this.idAttribute]=uuidv4());var i=this.add(e,t);return i.id=i.get(this.idAttribute),i.save(),i},migrate:function(){var s=this,e=localStorage.getItem(this.name);e&&0!==(e=e.split(",")).length&&e.map(function(e){var t=s.name+"-"+e,i=localStorage.getItem(t);i&&((i=JSON.parse(i))[s.idAttribute]||(i[s.idAttribute]=i.id,i=JSON.stringify(i),localStorage.setItem(t,i)))})},activeItems:function(){return this.filter(function(e){return!e.get("deleted")})},archivedItems:function(){return this.filter(function(e){return!e.get("deleted")&&e.get("archived")})},onRemove:function(i,e){if(!e||!e.ignoreSave){var s=this;$.ajax({url:this.apiUrl+"/"+i[this.serverIdAttribute],contentType:"application/json",type:"DELETE",beforeSend:m.utils.setMomentumAuthHeader}).done(function(){}).fail(function(e,t){s.add(i,{silent:!0})})}},onReset:function(){this.fetchedOnce=!0;var e=this;this.models.forEach(function(t){e.transientProps&&e.transientProps.forEach(function(e){t.attributes[e]=!1})}),this.syncToServer(function(){e.fetchFromServer()})},findHavingAttribute:function(t){return this.filter(function(e){return e.has(t)})},hasAttribute:function(t){return!!this.find(function(e){return e.has(t)})},onAdd:function(t,e,i,s){if(!i||!i.ignoreSave){var o=t.toJSON();this.transientProps&&this.transientProps.forEach(function(e){delete o[e]});var n=this;this.syncInProgress=!0,delete o[n.idAttribute],$.ajax({url:this.apiUrl,contentType:"application/json",type:"POST",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify(o)}).done(function(e){e&&e.success&&((o=t.toJSON()).changed_props=null,o.serverSetId=!0,o[n.serverIdAttribute]=e[n.serverIdAttribute],t.save(o,{silent:!0}))}).fail(function(e,t){}).always(function(){n.syncInProgress=!1,n.missedSync&&(n.missedSync=!1,n.syncToServer()),s&&s()})}},onChange:function(e,t){var i=this;if(!t.ignoreSave){var s=e.changedAttributes();if(s&&!s[this.idAttribute]&&!t.createdNow){var o,n=null,a=!1;for(o in this.transientProps&&this.transientProps.forEach(function(e){delete s[e]}),s)s.hasOwnProperty(o)&&"changed_props"!==o&&(n||(n=e.get("changed_props")||[]),_.contains(n,o)||(o!==i.idAttribute&&e.get("serverSetId")&&n.push(o),a=!0));a&&n&&e.save({changed_props:n},{silent:!0,ignoreSave:!0,ignoreRender:!0,success:function(){setTimeout(function(){i.syncToServer()},50)}})}}},syncToServer:function(e){if(this.syncInProgress)this.missedSync=!0;else{this.syncInProgress=!0;var n=this,t=0,i=this.findHavingAttribute("changed_props"),s=this.where({serverSetId:!1});if(s?Array.isArray(s)||(s=[s]):s=[],s.forEach(function(e){n.onAdd(e,null,null,function(){a()})}),!i||0==i.length)return e&&e(),void(0===s.length&&(this.syncInProgress=!1));nimble.each(i,function(t){var e=t.get("changed_props"),i=e.toString();if(e&&0!==e.length){t.syncing=!0;var s={};_.each(e,function(e){"changed_props"!==e&&e!==n.idAttribute&&(s[e]=t.get(e))});var o=n.apiUrl+"/"+encodeURIComponent(t.get(n.serverIdAttribute));$.ajax({url:o,contentType:"application/json",type:"PATCH",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify(s)}).done(function(e){e&&e.success&&(t.get("deleted")?t.destroy({silent:!0}):t.get("changed_props")&&t.get("changed_props").toString()===i&&t.collection&&t.save({changed_props:null},{silent:!0}))}).fail(function(e,t){}).always(function(){a()})}else a()})}function a(){++t===i.length+s.length&&(n.syncInProgress=!1,t=0,n.missedSync&&(n.missedSync=!1,n.syncToServer()),e&&e())}},fetchFromServer:function(e,t){var n=this;$.ajax({url:this.apiUrl+(this.includeArchived?"?includeArchived=true":""),contentType:"application/json",type:"GET",beforeSend:m.utils.setMomentumAuthHeader}).done(function(e){var s=!1;if(e&&Array.isArray(e)){var o=[];_.each(e,function(e){o.push(e[n.serverIdAttribute]);var t={};t[n.serverIdAttribute]=e[n.serverIdAttribute]+"";var i=n.findWhere(t);e.serverSetId=!0,i?(e[n.idAttribute]||(e[n.idAttribute]=i.get(n.idAttribute)),i.save(e,{ignoreSave:!0,ignoreRender:!0})):(e[n.idAttribute]||(e[n.idAttribute]=e[n.serverIdAttribute]),n.create(e,{ignoreSave:!0,ignoreRender:!0}),e.archived||(s=!0))}),n.trigger("change",null,{ignoreSave:!0}),n.models.slice().forEach(function(e){o.indexOf(e.get(n.serverIdAttribute))<0&&(e.destroy({silent:!0}),s=!0)}),s&&n.trigger("refresh")}}).fail(function(){t&&t()}).always(function(){e&&e()})}}),m.models.GenericMetric=Backbone.Model.extend({defaults:{id:null,label:"",value:"",link:null},initialize:function(){this.listenTo(this,"change:metric",this.metricChanged),this.loadData()},loadData:function(){var c=this;this.set("label","");var e=m.globals.urlRootIntegration+"services/random";try{$.ajax({type:"GET",contentType:"application/json",beforeSend:m.utils.setMomentumAuthHeader,url:e}).done(function(e,t,i){if(e.metricInfo)c.set("id",e.metricInfo.metricId),c.set("value",e.metricInfo.metricValue),c.set("label",e.metricInfo.metricLabel),e.metricInfo.metricLink?c.set("link",e.metricInfo.metricLink):c.set("link",null);else if(e.status&&"authRequired"==e.status&&e.authorizationUrl&&c.authAttempts<2){c.authAttempts++;var s=e.winWidth?e.winWidth:600,o=e.winHeight?e.winHeight:510,n=e.windowFeatures?e.windowFeatures:"titlebar,resizable,toolbar,status",a=window.screen.width/2-s/2,l=window.screen.height/2-o/2,r=window.open(e.authorizationUrl,"MomentumAuthWindow",n+",left="+a+",top="+l+",width="+s+",height="+o),d=setInterval(function(){r.closed&&(clearInterval(d),c.metricChanged())},250)}}).fail(function(e,t){console.log("failed")})}catch(e){}},clickMetric:function(){this.get("link")}}),m.views.GenericMetric=Backbone.View.extend({attributes:{id:"generic-stats",class:"generic-stats metric metric-item app-container app-dash add-shadow"},template:m.templates.metric.widget,events:{click:"clickMetric",mouseenter:"mouseEnter",mouseleave:"mouseLeave"},initialize:function(){this.renderedOnce=!1,this.render(),this.listenTo(this.model,"change:value",this.render),this.listenTo(this.model,"change:label",this.render)},render:function(){var e=this.model.get("label"),t=this.model.get("value");if(t){var i={statvalue:t,statlabel:e};if(this.renderedOnce)this.$el.html(this.template(i)),this.$time=this.$(".time"),this.$format=this.$(".format");else{var s=(this.options.order||"append")+"To";this.$el[s]("."+this.options.region).mFadeIn().html(this.template(i)),this.$time=this.$(".time"),this.$format=this.$(".format"),this.renderedOnce=!0}}},clickMetric:function(e){this.model.clickMetric()}}),m.views.BaseMetric=Backbone.View.extend({attributes:{class:"app-container base-metric add-shadow metric hide-scroll"},template:m.templates.baseMetric.baseMetric,events:{"click .metric-dash-empty":"addMetricFromDashboard","click .add":"toggleAdding","click .more-toggle":"toggleDropdown","click .show-archived":"showArchived","click .toggle-random":"toggleRandom","click .back":"hideDetail","click .delete":"deleteMetric","click .archive":"toggleArchive","click .add-integration":"addIntegration"},initialize:function(e){if(this.desiredTop=0,this.desiredRight=0,this.isOpen=!1,this.renderedOnce=!1,this.leaveRandomMetricIconActive=!1,this.listenTo(m,"globalEvent:esc globalEvent:click",this.hide),this.listenTo(m,"globalEvent:window:resize "+e.metricType.toLowerCase()+":resize",this.handleResize),this.listenTo(m.models.customization,"change:themeFont",this.render),this.collection=e.collection,this.metricTitle=e.metricTitle,this.metricType=e.metricType,this.visibleSetting=e.visibleSetting,this.metricDescription=e.metricDescription,this.instanceTemplate=e.instanceTemplate,this.detalViewClass=e.detailView,this.updateInterval=e.updateInterval,this.listenTo(m.models.customization,"change:"+this.visibleSetting,this.visibleChanged),void 0===m.models.customization.get(this.getShowRandomKey())){m.models.customization.set(this.getShowRandomKey(),e.defaultShowRandomState||!1);var t=m.models.customization.get("hideRandomMetric");"undefined"!==t&&"Countdown"===this.metricType&&m.models.customization.get(this.getShowRandomKey(),!t)}this.heightLimit=0,this.currentSubview="second";var o=this;this.listenTo(this.collection,"replace",this.replaceModel),this.listenTo(this.collection,"refresh",function(){o.render()}),this.listenTo(this.collection,"reset",function(e,t,i){o.ready=!0,o.render(i,e)}),this.listenTo(this.collection,"add",function(e,t,i){e.get(e.idAttribute)&&!e.get("archived")&&o.addMetricView(e,i&&i.ignoreRender,!0)}),this.listenTo(this.collection,"remove",function(e,t){o.removeViewsOf(e)}),this.listenTo(this.collection,"change",function(e,t){if(e&&e.get("deleted")&&o.removeViewsOf(e),e){var i=Object.keys(e.changed);if(0<=i.indexOf("selected")&&(e.get("selected")&&o.selectModel(e),e.get("pinned")?e.set({selected:!1},{silent:!0}):this.selectedMetric!==e||this.selectedMetric.get("selected")||(this.selectedMetric.get("pinned")||this.removeFromDash(this.selectedMetric),this.selectedMetric=null,this.selectedMetricId=null)),0<=i.indexOf("pinned"))if(e.get("pinned")){o.renderRandomModel();var s=o.getDashView(e);s||(s=o.addToDash(e)),s.pulse()}else this.selectedMetric!==e&&setTimeout(function(){o.removeFromDash(e)});0<=i.indexOf("archived")&&(e.get("archived")?(e.get("random")&&this.resetCurrentRandom(),o.removeViewsOf(e),o.collection.includeArchived&&o.addOne(e)):(o.removeViewsOf(e),setTimeout(function(){o.addMetricView(e)})))}}),this.collection.fetchedOnce&&(this.ready=!0),this.render(),this.updateInterval&&("onWholeMinute"===this.updateInterval?this.listenTo(m.models.date,"change:date",this.updateViews):setInterval(this.updateViews.bind(this),this.updateInterval))},getCustomizationKey:function(){return this.metricType.toLowerCase()+"Visible"},removeFromDash:function(e,t){if(e){var i=this.getDashView(e);if(i){i.destroy(),delete this.dashViews[e.get(e.idAttribute)],t||!this.emptyDash()&&!this.showingRandom()||this.renderRandomModel();var s=this;setTimeout(function(){e.get(e.idAttribute)===s.lastTargetId&&s.show()},50)}}},removeFromList:function(e){if(e){var t=this.getListView(e);t&&(t.destroy(),delete this.listViews[e.get(e.idAttribute)],this.setHeight(),this.isOpen&&this.unfocusOverlap(),this.checkEmptyState())}},checkEmptyState:function(){this.$el.toggleClass("app-empty",this.isListEmpty()),this.setHeight()},isListEmpty:function(t){return 0===this.collection.filter(function(e){return(t?e.get("archived"):!e.get("archived"))&&!e.get("deleted")}).length},removeViewsOf:function(e){this.removeFromDash(e),this.removeFromList(e)},updateViews:function(){function e(e){e.render()}this.dashViews&&this.listViews&&(Object.values(this.dashViews).forEach(e),Object.values(this.listViews).forEach(e))},visibleChanged:function(e){m.models.customization.get(this.visibleSetting)?this.renderedOnce?this.$el.mFadeIn():this.render():this.$el.mFadeOut()},showingRandom:function(){return m.models.customization.get(this.getShowRandomKey())},updateDetails:function(){this.$el.find(".toggle-random .toggle-slider").toggleClass("on",this.showingRandom())},setRandomMetric:function(){this.resetCurrentRandom(!0);var e=this.getCollectionItems(),t=this.getPinned(),i=0===t.length;if(this.selectedMetric&&!this.selectedMetric.get("pinned"))this.cleanRandomFlag();else if(!this.randomModel||0<=t.indexOf(this.randomModel)||e.indexOf(this.randomModel)<0){var s=[];e.forEach(function(e){t.indexOf(e)<0&&!e.get("archived")&&s.push(e)}),(i||this.showingRandom())&&0<s.length?this.randomModel=s[Math.floor(Math.random()*s.length)]:this.cleanRandomFlag()}this.randomModel&&this.randomModel.set("random",!0)},getCollectionItems:function(){var e=this.collection.activeItems?this.collection.activeItems():this.collection.models;return this.collection.sorted||(e=this.sort(e)),e},render:function(e,t,i){if(this.ready){var s=this;if(this.currentHeight=this.$subviews&&this.$subviews.innerHeight(),e&&(e.ignoreRender||e.silent||this.$subviews&&this.$subviews.hasClass("third")))this.$subviews&&this.$subviews.hasClass("third")&&(this.missedRender=!0);else if(this.switching)setTimeout(function(){s.render(e,t,i)},50);else{this.dropdownOpen=!1,this.dashViews={},this.listViews={};var o=this.getCollectionItems(),n={metrics:o,showArchive:this.collection.includeArchived,metricType:this.metricType,metricTitle:this.metricTitle,metricDescription:this.metricDescription},a=o[0]&&o[0].getDetailViewVariables()||{};if(this.selectedMetric&&this.getPinned().indexOf(this.selectedMetric)<0&&(n.selectedMetric=this.selectedMetric),this.setRandomMetric(),n.randomMetric=this.randomModel,n.empty=0===o.length,this.$el.removeClass("show show-fade-in"),this.renderedOnce)this.$el.html(this.template(n));else{var l=(this.options.order||"append")+"To";this.$el[l]("."+this.options.region),this.$el.mFadeIn().html(this.template(n)),this.renderedOnce=!0}this.$appDash=this.$el.find(".metric-dash.has-multiple"),this.$metricHomeList=this.$el.find(".metric-home .metric-list"),this.$metricArchiveList=this.$el.find(".metric-archive .metric-list"),this.addAll(n),this.checkEmptyState(),this.detailView&&this.detailView.remove(),this.detailView=new this.detalViewClass({el:this.$el.find(".metric-detail .body"),collection:this.collection,parentView:this}),this.detailView.render(a),this.$popup=this.$(".app-wrapper"),this.$app=this.$(".app"),this.isOpen?this.show(t,!0,i):this.lastMetric=this.selectedMetric,this.$subviews=this.$el.find(".subviews").first(),this.$el.addClass(this.metricType.toLowerCase()),this.handleResize(),this.$el.find(".toggle-archived .toggle-slider").toggleClass("on",this.collection.includeArchived),this.updateDetails()}}},sort:function(e){var t=e;try{t=e.sort(function(e,t){if(e.get("pinned")&&!t.get("pinned"))return-1;if(t.get("pinned")&&!e.get("pinned"))return 1;return 0})}catch(e){}return t},addToDash:function(e,t){if(e){if(this.dashViews[e.get(e.idAttribute)])return this.dashViews[e.get(e.idAttribute)];var i=new(this.instanceView||m.views.MetricInstance)({model:e,class:"metric-item "+(t||""),template:this.instanceTemplate,type:"dash",parent:this}),s=i.render().$el;if(this.emptyDash())this.$appDash.append(s);else{var o,n,a=!1,l=this.getCollectionItems(),r=l.indexOf(e);for(o=0;o<l.length;o++){n=l[o];var d=this.getDashView(n);if(r<o&&d){a=!0,d.$el.before(s);break}}a||this.$appDash.append(s)}return this.dashViews[e.get(e.idAttribute)]=i}},getDashView:function(e){return e?this.dashViews[e.get(e.idAttribute)]:null},getListView:function(e){return e?this.listViews[e.get(e.idAttribute)]:null},resetCurrentRandom:function(e){if(this.randomModel){var t=this.randomModel;this.cleanRandomFlag();var i=this.getListView(t);i&&i.render(),this.removeFromDash(t,e)}},cleanRandomFlag:function(){this.randomModel&&(this.randomModel.set("random",!1),this.randomModel=null)},selectModel:function(e){e.get("pinned")||(this.resetCurrentRandom(!0),this.selectedMetric&&e!==this.selectedMetric&&this.selectedMetric.set("selected",!1),this.selectedMetric=e,this.selectedMetricId=e.get(e.idAttribute));var t=this.getDashView(e);t?t.pulse():this.addToDash(e,"selected-metric"),this.show(e,!0)},addOne:function(e,t){if(!this.listViews[e.get(e.idAttribute)]){t=t||"";var i=new(this.instanceView||m.views.MetricInstance)({model:e,class:"list-item metric-list-item metric-option "+t,template:this.instanceTemplate,type:"listItem",parent:this});return this.listViews[e.get(e.idAttribute)]=i,this.checkEmptyState(),(e.get("archived")?this.$metricArchiveList:this.$metricHomeList).append(i.render().$el),this.setHeight(),this.isOpen&&this.unfocusOverlap(),i}},addAll:function(e){e.randomMetric?this.addToDash(e.randomMetric,"random-metric"):e.selectedMetric&&this.addToDash(e.selectedMetric,"selected-metric");var t=this,i="";e.metrics.map(function(e){!e.get("pinned")&&e.get("active")&&(i="active"),t.addOne(e,i),e.get("pinned")&&!e.get("archived")&&t.addToDash(e,"pinned-metric")})},createMetric:function(e){var t=this.collection.create(e,{createdNow:!0,ignoreRender:!0});this.addMetricView(t,!1,!0),t.set("selected",!0)},addMetricView:function(e,t,i){if(!this.getListView(e)){if(this.addOne(e,!0),this.switchToListView(),i&&this.resetCurrentRandom(!0),e.get("pinned"))this.addToDash(e,"selected-metric").pulse();this.emptyDash()&&this.renderRandomModel()}},emptyDash:function(){return 0===Object.keys(this.dashViews).length},deleteMetric:function(e){e&&(e.stopPropagation(),e.preventDefault()),this.switchToListView(),this.randomModel===this.activeMetric&&this.cleanRandomFlag(),this.selectedMetric===this.activeMetric&&(this.selectedMetric=null,this.selectedMetricId=null),this.activeMetric.delete(),this.activeMetric=null,this.toggleDropdown()},toggleArchive:function(e){e&&(e.stopPropagation(),e.preventDefault()),this.toggleDropdown(),this.activeMetric.toggleArchive(),this.switchToListView()},addIntegration:function(e){e.stopPropagation(),e.preventDefault(),m.commandManager.execute("settings.toggle",null,{section:"metrics"}),this.hide()},toggleAdding:function(e){this.detailView.startAdding(),this.showDetail(e),this.$el.find(".edit-mode").removeClass("visible")},togglePopup:function(e){this.lastTarget&&this.lastTarget===e?this.hide():this.show(e.model)},show:function(e,t,i){this.dropdownOpen&&this.toggleDropdown();var s,o,n,a,l,r=this;this.$popup.removeClass("animated"),this.isOpen=!0;(o=e?this.getDashView(e):this.lastTargetId?this.dashViews[this.lastTargetId]:this.dashViews[Object.keys(this.dashViews)[0]])&&(this.lastTarget=o,this.lastTargetId=o.model.get(o.model.idAttribute),s=o.$el),s&&0!==s.length?(n=s[0].getBoundingClientRect(),a=this.$el[0].getBoundingClientRect(),l=this.desiredRight,this.desiredRight=a.left-n.left+a.width-n.width-3,this.desiredTop=n.height):(this.desiredRight=-3,this.desiredTop=this.$el.find(".app-dash:visible").first().outerHeight(!0));var d=i||this.currentSubview;if(this.highlightSelectedMetric(e),t)return this.$subviews=this.$el.find(".subviews"),this.$popup.css({right:l||this.desiredRight}),this.$el.addClass("show show-fade-in"),this.$subviews.addClass("u--no-transition"),this.currentHeight&&this.$subviews.css("max-height",this.currentHeight+"px"),this.$subviews.removeClass("u--no-transition"),this.switchTo(d),this.$popup.addClass("animated"),setTimeout(function(){r.$popup.css({right:r.desiredRight,top:r.desiredTop})},1),this.switchTo(this.currentSubview,!0),this.$subviews.addClass("animated"),!0;this.$popup.css({right:this.desiredRight,top:this.desiredTop}),this.$el.addClass("show"),this.$subviews.addClass("u--no-transition"),this.switchTo(d),setTimeout(function(){r.$el.addClass("show-fade-in"),r.$subviews.addClass("animated")},40),this.updateDetails(),this.$subviews.removeClass("u--no-transition")},highlightSelectedMetric:function(e){(e=e||this.selectedMetric||this.randomModel)&&(this.$el.find(".metric-option").removeClass("selected selected-metric"),this.getListView(e).$el.addClass("selected selected-metric"))},unfocusOverlap:function(){var i=0;$(this.activeViewElement).children().each(function(e,t){i+=t.clientHeight}),m.widgetManager.unfocusOverlap(this.options.region,i)},switchTo:function(e){var t=this;switch(this.switching=!0,this.currentSubview!==e?(this.$el.addClass("hide-scroll"),setTimeout(function(){t.switching=!1,t.$el.removeClass("hide-scroll")},400)):this.switching=!1,this.$subviews.removeClass("second third"),this.$subviews.addClass(e),this.currentSubview=e){case"second":this.activeViewElement=this.$subviews.children()[1];break;case"third":this.activeViewElement=this.$subviews.children()[2];break;default:this.activeViewElement=this.$subviews.children()[0]}this.isOpen&&this.setHeightLimit(),this.setHeight(),this.unfocusOverlap()},switchToListView:function(){this.switchTo("second")},switchToArchiveView:function(){this.switchTo("")},switchToDetailView:function(){this.switchTo("third")},hide:function(e){var t=this.$el.find(".more-dropdown")[0];if(!t||e&&$.contains(t,e.target)||this.dropdownOpen&&this.toggleDropdown(),!e||!$.contains(this.$el[0],e.target)&&this.isOpen){this.isOpen=!1,this.lastTarget=null,m.widgetManager.refocusOverlap(this.options.region),this.$el.removeClass("show-fade-in"),this.$el.removeClass("immediate-show");var i=this;setTimeout(function(){i.$el.removeClass("show"),i.switchToListView(),i.missedRender&&i.render()},200)}},showDetail:function(e){this.switchToDetailView();var t=this;setTimeout(function(){t.detailView.focus&&t.detailView.focus()},300)},hideDetail:function(e){this.activeMetric&&this.disableBack&&"third"===this.currentSubview?this.detailView&&this.detailView.focus&&this.detailView.focus():(this.switchToListView(),this.activeMetric=null,this.$el.find(".edit-mode").removeClass("visible"))},editDetail:function(e){this.activeMetric=e,this.$el.find(".edit-mode").addClass("visible"),this.detailView.editDetail(e),this.showDetail(),this.$el.find(".more-dropdown .archive").html(e.get("archived")?"Unarchive":"Archive")},getPinned:function(){var e=this.collection.findPinned();return e?Array.isArray(e)||(e=[e]):e=[],e},addMetricFromDashboard:function(){this.isOpen?this.hide():this.show()},setHeight:function(){if(this.$subviews){var e=this.$subviews.hasClass("third")?2:this.$subviews.hasClass("second")?1:0,t=$(this.$subviews.children()[e]),i=t.find(".body");i.css("max-height","none");var s=i.outerHeight(!0)+t.find(".header").outerHeight(!0);i.css("max-height",""),s=s>this.heightLimit?this.heightLimit:s,this.$subviews.css("max-height",s+"px"),this.$el.find(".subview").css("height",this.heightLimit+"px")}},setHeightLimit:function(e){var t=$(".top-row").outerHeight(!0)+$(".bottom").outerHeight(!0),i=$(".bookmarks-wrapper"),s=0;i.css("transform")&&(s=parseInt(i.css("height"))-parseInt(i.css("transform").split(",")[5])),this.heightLimit=document.body.getBoundingClientRect().height-(t+s+4)},handleResize:function(e){this.isOpen&&(this.setHeightLimit(),this.setHeight())},toggleDropdown:function(e){var t;e?(e.stopPropagation(),(t=$(e.currentTarget).parent()).toggleClass("active",!this.dropdownOpen)):t=this.$el,t.find(".more").toggleClass("active",!this.dropdownOpen),this.dropdownOpen=!this.dropdownOpen},showArchived:function(e){e&&e.stopPropagation(),this.$el.find(".metric-archive .error-icon").addClass("hidden"),this.$el.find(".metric-archive .message").addClass("hidden"),this.toggleDropdown();var t=this;t.collection.includeArchived&&t.fetchedArchived||(t.$el.find(".metric-archive .loading").removeClass("hidden"),t.$el.find(".metric-archive .message").removeClass("hidden"),t.$el.find(".metric-archive .loading-placeholder").addClass("loading-icon"),t.collection.includeArchived=!0),t.switchToArchiveView(),t.fetchedArchived?(t.$metricArchiveList.toggleClass("is-empty",this.isListEmpty(!0)),t.$el.find(".metric-archive .metric-list").addClass("active")):(this.$el.find(".metric-archive .metric-list").removeClass("active"),setTimeout(function(){t.collection.fetchFromServer(function(){t.$el.find(".metric-archive .loading").addClass("hidden"),t.$el.find(".metric-archive .message").addClass("hidden"),t.fetchedArchived=!0,t.$el.find(".metric-archive .metric-list").addClass("active");var e=t.collection.where({archived:!0});e.forEach(function(e){e.attributes.random=!1,e.attributes.selected=!1,t.addOne(e)}),t.$metricArchiveList.toggleClass("is-empty",0===e.length),t.setHeight()},function(){t.$el.find(".metric-archive .error").removeClass("hidden"),t.$el.find(".metric-archive .loading").addClass("hidden"),t.fetchedArchived=!0,t.setHeight()})},300)),t.setHeight()},toggleRandom:function(e){e&&e.stopPropagation(),m.models.customization.set(this.getShowRandomKey(),!m.models.customization.get(this.getShowRandomKey())),this.$el.find(".toggle-random .toggle-slider").toggleClass("on"),this.selectedMetric&&this.selectedMetric.set("selected",!1),this.selectedMetric=null,this.selectedMetricId=null,this.renderRandomModel()},getShowRandomKey:function(){return"showRandomMetric-"+this.metricType},renderRandomModel:function(){if(this.setRandomMetric(),this.randomModel){var e=this.getListView(this.randomModel);e&&(e.render(),this.addToDash(this.randomModel,"random-metric"))}this.highlightSelectedMetric()},nudgeHeight:function(e,t){var i=this,s=this.$el.find(".subviews"),o=s.innerHeight();t&&this.$subviews.addClass("u--no-transition"),s.css("max-height",o+e+"px"),t&&setTimeout(function(){i.$subviews.removeClass("u--no-transition")},10)},setHeightInAnimation:function(){var e=this;this.setHeight(),setTimeout(function(){e.setHeight()},1),setTimeout(function(){e.setHeight()},100)}}),m.views.MetricInstance=Backbone.View.extend({tagName:function(){return"listItem"===this.options.type?"li":"div"},events:{click:"selectMetric","webkitAnimationEnd .metric-instance":"onAnimationEnd","click .list-edit":"editDetail",dblclick:"editDetail","mouseenter .list-random":"enterRandomMetricIcon","mouseleave .list-random":"leaveRandomMetricIcon","click .list-pin":"pinMetric","click .list-unarchive":"unarchive"},initialize:function(e){this.lastClick=0,this.parent=e.parent,this.model=e.model,this.model&&(this.collection=this.model.collection),this.template=e.template||m.templates.baseMetric.defaultInstance,this.class=e.class,this.type=e.type,this.listenTo(this.model,"change",this.onChange),this.listenTo(this.model,"replace",this.onReplace)},editDetail:function(e){e.stopPropagation(),"dash"!==this.type&&this.parent.editDetail(this.model)},onChange:function(){this.model.get("deleted")?this.destroy():this.render()},onReplace:function(e){var t=this.collection||this.model.collection;this.model=t.findWhere({id:e.replacedBy}),this.listenTo(this.model,"change",this.onChange),this.render()},destroy:function(){this.$el.remove(),this.remove()},render:function(){var e=this,t=this.model.getViewData();(t.pinned||this.model.get("selected")||this.model.get("random"))&&(t.active=!0),this.model.get("random")&&(t.random=!0),this.$el.html(this.template(t)),this.$el.addClass(this.class),this.$el.toggleClass("pinned-metric",this.model.get("pinned")),this.$el.toggleClass("random random-metric",this.model.get("random")),this.$el.find(".list-random").toggleClass("active",this.model.get("random"));var i=e.$el.find(".metric-label"),s=e.$el.find(".metric-stat");if("dash"===this.type)if(e.labelWidth&&e.lastLabel===t.nameOrPlaceholder)i.width(e.labelWidth);else{var o,n,a=c(i),l=c(s),r=2.75*l.width();a.width(r),o=n=a.height();for(var d=0;o===n&&0<o&&d<20;)d++,a.width(a.width()-3),o=a.height();e.lastLabel=t.nameOrPlaceholder,e.labelWidth=a.width()+4,a.remove(),l.remove(),i.width(e.labelWidth)}return this;function c(e){var t=e.clone();return t.css("opacity",0),t.css("position","absolute"),t.appendTo("body"),t}},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$el.removeClass("pulse")},pulse:function(e){this.$el.addClass("pulse")},selectMetric:function(e){var t=(new Date).getTime();if(!(t-this.lastClick<500))if(this.lastClick=t,"dash"===this.type)this.parent.togglePopup(this);else{if(e.stopPropagation(),this.model.get("archived"))return;this.model.set({selected:!1},{silent:!0}),this.model.set("selected",!0)}},pinMetric:function(e){e.stopPropagation(),this.model.togglePinned()},unarchive:function(e){e.stopPropagation(),this.model.toggleArchive()}}),m.models.Quote=Backbone.Model.extend({idAttribute:"forDate"}),m.collect.Quotes=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-quote"),model:m.models.Quote,getActiveQuote:function(){if(0<this.length){var e=getActiveDateString();return this.get(e)}}}),m.models.QuoteManager=Backbone.Model.extend({initialize:function(e,t){m.collect.quotes=new m.collect.Quotes},firstFetch:function(){m.collect.quotes.fetch({reset:!0})},skipErrorMessage:{message:"Oops! We weren't able to get a new quote. Please check your connection and try again.",viewLimit:1},favouriteErrorMessage:{message:"Oops! We weren't able to save the favorite. Please check your connection and try again.",viewLimit:1},getActiveQuote:function(){var e=this;if(m.collect.quotes){var t=m.collect.quotes.getActiveQuote();if(!t)return null;var i=!1;if(this.currentQuote&&this.currentQuote.get("_id")==t.get("_id")){var s=this.currentQuote;s.get("body")==t.get("body")&&s.get("source")==t.get("source")&&s.get("twitter")==t.get("twitter")&&s.get("twitterIntentUrl")==t.get("twitterIntentUrl")||(this.currentQuote=t,i=!0)}else this.currentQuote=t,i=!0;return i&&setTimeout(function(){m.trigger("quote:active_changed",e.currentQuote.get("_id"))},50),t}return null},skipQuote:function(i){var s=this,e=m.globals.urlRootApi+"quotes",t=this.getActiveQuote(),o={operation:"skip",active_uuid:t.get("_id"),is_custom:t.get("is_custom")};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(o),url:e}).done(function(e){if(e&&e.success&&m.trigger("sync:download","quote"),e&&e.notification){if("max_skips"==e.notification.type){if(localStorage.getItem("maxQuoteSkips"))return;localStorage.setItem("maxQuoteSkips",!0)}e.notification.display_time||(e.notification.display_time=5e3),m.commandManager.execute("notification.show.enhanced",e.notification)}}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",s.skipErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",s.skipErrorMessage),i&&i()}},toggleFavorite:function(e,i){var s=this,t=m.globals.urlRootApi+"quotes/favorites",o=this.getActiveQuote(),n={operation:"favorite",active_uuid:o.get("_id"),is_favorite:e,is_custom:o.get("is_custom")};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(n),url:t}).done(function(e){e&&e.success&&(m.trigger("sync:download","quote"),m.trigger("quote:favorite",{id:n.active_uuid,is_favorite:n.is_favorite}))}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",s.favouriteErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",s.favouriteErrorMessage),i&&i()}},latestQuoteDate:function(){var i=null;return m.collect.quotes.models.forEach(function(e){var t=Date.parse(e.id);(!i||i<t)&&(i=t)}),i}}),m.views.Quote=Backbone.View.extend({attributes:{class:"app-container quote"},template:m.templates.quote.quote,events:{click:"handleClick","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff",mouseenter:"hoverOn",mouseleave:"hoverOff","click .control-twitter":"shareTwitter","click .control-heart":"toggleFavorite","click .control-refresh":"skipQuote"},currentlyActiveQuote:null,initialize:function(){this.renderedOnce=!1;var o=this;this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(this.collection,"reset",this.collectionReady),this.listenTo(m.models.customization,"change:quoteVisible",this.visibleChanged),$(window).on("resize",function(){if(o.$quoteBody){var e=o.$quoteBody.css("lineHeight"),t=parseInt(e.substring(0,e.length-2)),i=(o.$quoteBody.height(),o.$quoteBody.clone());i.html("&ldquo;"+m.models.quoteManager.getActiveQuote().get("body")+"&rdquo;"),i.css("position","absolute"),i.css("width","100%"),i.css("top","0"),i.css("left","0"),i.css("margin","0"),i.css("padding","0"),i.appendTo(o.$quoteBody);var s=i.height();(s<1.75*t||2.75*t<s)&&o.$quoteBody.html("&ldquo;"+m.models.quoteManager.getActiveQuote().get("body")+"&rdquo;"),o.render(),i.remove()}})},handleNewDay:function(){var e=this;e.intervalId=setInterval(function(){0<e.collection.length&&(e.render(),clearInterval(e.intervalId))},50)},parentReady:function(e){if(this.isParentReady=!0,this.isCollectionReady||e){this.render();try{m.usage.itemLoaded(m.models.quoteManager.getActiveQuote(),m.usage.types.QUOTE)}catch(e){}}},collectionReady:function(){if(m.trigger("quote:downloaded"),this.isCollectionReady=!0,this.isParentReady){this.render();try{m.usage.itemLoaded(m.models.quoteManager.getActiveQuote(),m.usage.types.QUOTE)}catch(e){}}},visibleChanged:function(e){m.models.customization.get("quoteVisible")?this.renderedOnce?this.$el.mFadeIn():this.render():this.$el.mFadeOut()},render:function(){if(0!==this.collection.length){var e=m.models.quoteManager.getActiveQuote();if(e){var t=!1;if(this.currentlyActiveQuote&&this.currentlyActiveQuote.get("_id")==e.get("_id")){var i=this.currentlyActiveQuote;i.get("body")==e.get("body")&&i.get("source")==e.get("source")&&i.get("twitter")==e.get("twitter")&&i.get("twitterIntentUrl")==e.get("twitterIntentUrl")||(this.currentlyActiveQuote=e,t=!0)}else this.currentlyActiveQuote=e,t=!0;var l=this,r=e.get("body"),s=e.get("source"),o=e.get("detail_url"),n=e.get("twitter"),a=e.get("twitterIntentUrl"),d=!1,c="";if(e.get("is_favorite")&&(d=!0,c="active"),!a){var h="";h=n?'"'+r+'" —@'+n:'"'+r+'" —'+s,a="https://twitter.com/intent/tweet?text="+encodeURIComponent(h)+"&via=momentumdash&related=momentumdash,levibucsis,jaywaterman"}var u=0;if(t&&this.renderedOnce&&(u=650),this.renderedOnce)t&&(this.$el.addClass("u--no-opacity"),setTimeout(function(){l.$quoteBody.html("&ldquo;"+r+"&rdquo;"),l.$quoteSource.html(s),l.$control_twitter.data("url",a),l.$el.removeClass("u--no-opacity")},500));else{var g={body:r,source:s,twitterIntentUrl:a,fav_class:c},p=(this.options.order||"append")+"To";this.$el[p]("."+l.options.region).mFadeIn().html(l.template(g)),this.$quoteBody=this.$(".quote-body-text").first(),this.$quoteSource=this.$el.find(".quote-source-text").first(),this.$control_heart=this.$el.find(".control-heart").first(),this.$control_refresh=this.$el.find(".control-refresh").first(),this.$control_twitter=this.$el.find(".control-twitter").first(),this.renderedOnce=!0}o&&0<o.length?(this.detail_url=o,this.$el.addClass("has-link")):(this.detail_url=null,this.$el.removeClass("has-link")),this.$control_refresh.removeClass("active"),m.conditionalFeatures.featureEnabled("skip-qt")?this.$el.find(".control-refresh").show():this.$el.find(".control-refresh").hide(),this.$control_heart.show(),d?this.$control_heart.addClass("active"):this.$control_heart.removeClass("active"),setTimeout(function(){var e=l.$quoteBody.css("lineHeight"),t=parseInt(e.substring(0,e.length-2)),i=l.$quoteBody.height(),s=!1;if(1.75*t<i&&i<2.75*t){var o,n="",a=r.split(" ");for(o=0;o<a.length;o++)n+=a[o],!s&&n.length>(r.length+5)/2?(n+="<br>",s=!0):o!=a.length-1&&(n+=" ");l.$quoteBody.html("&ldquo;"+n+"&rdquo;"),2.75*t<(i=l.$quoteBody.height())&&l.$quoteBody.html("&ldquo;"+r+"&rdquo;")}},u)}else m.trigger("sync:downloadIfNeeded")}else m.trigger("sync:downloadIfNeeded")},handleClick:function(e){this.detail_url&&0<this.detail_url.length&&(e.preventDefault(),e.stopPropagation(),window.open(this.detail_url,"_blank"))},hoverOn:function(){try{var e=this;e.hover=!0,setTimeout(function(){e.hover&&m.usage.recordHover(m.models.quoteManager.getActiveQuote(),m.usage.types.QUOTE)},500)}catch(e){}},hoverOff:function(){this.hover=!1},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detail_url&&0<this.detail_url.length&&$(this.$el).addClass("has-link")},shareTwitter:function(e){e.stopPropagation();var t=screen.width/2-272.5,i=screen.height/2-210;window.open($(e.currentTarget).data("url"),"share","left="+t+",top="+i+",width=545,height=420,resizeable=0")},toggleFavorite:function(e){e.stopPropagation(),$(e.currentTarget).toggleClass("active");var t=$(e.currentTarget).hasClass("active");m.models.quoteManager.toggleFavorite(t,function(){$(e.currentTarget).toggleClass("active")}),m.sendEvent("Quote",t?"Favourite":"Unfavourite")},skipQuote:function(e){e.stopPropagation(),this.$control_refresh.hasClass("active")||($(e.currentTarget).addClass("active"),m.models.quoteManager.skipQuote(function(){$(e.currentTarget).removeClass("active")}),m.sendEvent("Quote","Skip"))}}),m.bootstrappers.InitializeQuote=function(e,t){e.models.quoteManager=new e.models.QuoteManager},m.bootstrappers.RenderQuote=function(t,e,i){t.conditionalFeatures.checkPreferenceForRender("quoteVisible",function(){t.models.customization.get("quoteVisible")&&(t.views.quote=new t.views.Quote({collection:t.collect.quotes,model:t.models.date,region:"bottom"}),t.models.quoteManager.firstFetch(),t.views.quote.parentReady(i),t.widgets.push(t.views.quote),t.stopListening(t.models.customization,"change:quoteVisible"))},function(e){t.listenTo(t.models.customization,"change:quoteVisible",e)})},m.models.FocusBase=Backbone.Model.extend({defaults:{focus:"",day:"",forDate:null,archived:!1,createdDate:new Date,archivedDate:null,completed:!1,completedDate:null,cached:!1},saveOptions:function(){return this.collection&&this.collection.saveOptions?this.collection.saveOptions:{}},archive:function(){var e=new Date;this.save({archived:!0,archivedDate:e},this.saveOptions())},toggleCompleted:function(){var e=this.saveOptions(),t=!this.get("completed");return this.save({completed:t,completedDate:this.get("completed")?null:new Date},e),t}}),m.models.Focus=m.models.FocusBase.extend({urlRoot:function(){return this.collection?null:m.globals.urlRoot+"focus"},toggleCompleted:function(){var s=this,e=this.saveOptions(),o=!this.get("completed");if(m.conditionalFeatures.featureEnabled("pinfocus")){var n=s.get("todoId");e.success=function(){m.trigger("focus:toggled",o),s.get("refreshTodo")&&n&&m.trigger("todo:refresh",n)},e.error=function(e,t,i){200==t.status&&(m.trigger("focus:toggled",o),s.get("refreshTodo")&&n&&m.trigger("todo:refresh",n))};var t={completed:o,completedDate:this.get("completed")?new Date:null};this.id.startsWith("todo-")&&(t.todoId=this.get("todoId"),t.projectId=this.get("projectId"),t.providerId=this.get("providerId"),t.listId=this.get("listId"),t.focus=this.get("focus")),this.save(t,e),m.trigger("todo:set:done",n,o)}else this.save({completed:o,completedDate:this.get("completed")?null:new Date},e);return o},archive:function(){if(!this.id.startsWith("todo-")){var e=new Date;this.save({archived:!0,archivedDate:e},this.saveOptions())}m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.getComputedSetting("autoFocus")&&m.models.customization.set("autoFocus",!1)},saveOptions:function(){return this.collection&&this.collection.saveOptions?this.collection.saveOptions:{patch:!0}}}),m.collect.FocusesBase=Backbone.Collection.extend({saveOptions:{},attributes:{},successfulLoad:!1,loadingFromServer:!0,fetchedOnce:!1,initialize:function(){this.on("reset",this.onReset,this),this.on("add",this.onAdd,this),this.on("change",this.onModelChanged,this)},fetch:function(e){this.fetchedOnce=!0;return e=_.extend(e||{},{}),Backbone.Collection.prototype.fetch.call(this,e)},onReset:function(){this.successfulLoad=!0,this.loadingFromServer=!1,this.trigger("loadingFromServerChanged")},onModelChanged:function(e){var t=e.changedAttributes(),i=_.keys(t);0<_.without(i,"archived","archivedDate").length&&this.saveCachedFocus(e)},comparator:function(e){var t=e.get("completedDate");return t||(t=e.get("createdDate"))?-Date.parse(t):0},activeFocus:function(){return this.activeFocusBase()},activeFocusBase:function(){if(this.loadingFromServer)return this.fetchedOnce||this.fetch({reset:!0}),this.cachedFocus();if(0===this.length)return localStorage.removeItem("cachedFocus"),null;var i=null,e=getActiveDateString(),t=this.where({completed:!1,archived:!1,forDate:e});if(1===t.length)i=t[0];else if(0===t.length)if(1===(t=this.where({completed:!0,archived:!1,forDate:e})).length)i=t[0];else if(0===t.length)return localStorage.removeItem("cachedFocus"),null;return null==i&&_.each(t,function(e){if(null==i)i=e;else{var t=e.get("completedDate");i.get("completedDate")<t&&(i=e)}}),i?this.saveCachedFocus(i):localStorage.removeItem("cachedFocus"),i},saveCachedFocus:function(e){localStorage.cachedFocus=JSON.stringify(e)},cachedFocus:function(){if(localStorage.cachedFocus){var e=JSON.parse(localStorage.cachedFocus),t=getActiveDateString();if(e&&e.forDate===t)return e.cached=!0,new this.model(e)}return null}}),m.collect.Focuses=m.collect.FocusesBase.extend({model:m.models.Focus,url:m.globals.urlRoot+"focus",saveOptions:{patch:!0},activeFocus:function(){if(!m.conditionalFeatures.featureEnabled("pinfocus")||!m.models.customization.getComputedSetting("autoFocus"))return this.activeFocusBase();if(m.models.todoListManager&&m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectedList){var e=m.models.todoListManager.activeProvider.selectedList();if(e&&e.itemCollection&&(0<e.itemCollection.length||!e.itemCollection.loadingFromServer)){var t=null;if(m.views.todoPane&&m.views.todoPane.todoList&&m.views.todoPane.todoList.reordered){var i=m.views.todoPane.todoList.getTopActiveTodoId();i&&(t=e.itemCollection.get(i))}else{var s=_(e.itemCollection.activeToday()).chain().filter(function(e){var t=!1;if(e.get("viewSection")){var i="collapsed-"+e.get("listId")+":"+e.get("viewSection");t=m.models.customization.get(i)}return!e.get("done")&&"subsection"!=e.get("viewType")&&!t}).value();s&&0<s.length&&(t=s[0])}if(t){var o={};o.id="todo-"+t.id,o.focus=t.get("title"),o.day="today",o.todoId=t.id;var n=t.collection.parentList.project;o.listId=t.get("listId"),o.projectId=t.get("projectId")||n.id,o.providerId=n.provider.id,o.forDate=getActiveDateString();var a=new m.models.Focus(o);return this.saveCachedFocus(a),a}return this.fetchedOnce?this.successfulLoad?this.activeFocusBase():this.cachedFocus():(this.fetch({reset:!0}),this.cachedFocus())}return e&&e.itemCollection&&e.itemCollection.doFetchIfNeeded(),this.cachedFocus()}return this.cachedFocus()},triggerCollectionReset:function(){this.trigger("reset")},selectedListCacheKey:function(){return localStorage.activeTodoProvider?"activeTodoListId-"+localStorage.activeTodoProvider:null}}),m.collect.FocusesLegacy=m.collect.FocusesBase.extend({model:m.models.FocusBase,localStorage:new Backbone.LocalStorage("momentum-focus"),saveOptions:{},onReset:function(){this.loadingFromServer=!1,this.fixNullForDate(),this.trigger("loadingFromServerChanged")},fixNullForDate:function(){var e=this.where({archived:!1,forDate:null});e&&0<e.length&&_.each(e,function(e){var t=e.get("createdDate");t?activeDateStringForDate(Date.parse(t))!=getActiveDateString()&&e.archive():e.archive()},focus)}}),m.views.Focus=Backbone.View.extend({tagName:"li",attributes:{class:"focus"},template:m.templates.focus["focus-template"],events:{"click .delete":"destroy","click .checkbox":"toggleCompleted"},initialize:function(e){e&&e.skipRender||this.render(),this.listenTo(this.model,"change",this.render),m.conditionalFeatures.featureEnabled("pinfocus")&&(this.listenTo(m,"todo:changed",this.todoChanged),this.listenTo(m,"todo:changing",this.todoChanging),this.listenTo(m,"focus:toggled",this.focusToggled),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged))},todoChanged:function(e,t){e==this.model.get("todoId")&&m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.getComputedSetting("autoFocus")&&m.collect.focuses&&t.hasOwnProperty("done")&&m.collect.focuses.fetch({reset:!0})},todoChanging:function(e,t){e==this.model.get("todoId")&&(t.hasOwnProperty("done")&&this.model.set("completed",t.done),t.hasOwnProperty("title")&&this.model.set("focus",t.title),t.hasOwnProperty("done")&&this.displayAutoPinMessage(t.done))},render:function(){var e={focus:m.utils.captionFormatter(this.model.get("focus")),day:"Today"};return this.$el.html(this.template(e)),this.model.changed.hasOwnProperty("completed")?this.$el.toggleClass("complete",this.model.changed.completed):this.$el.toggleClass("complete",this.model.get("completed")),this.$el.toggleClass("cached",this.model.get("cached")),this},displayAutoPinMessage:function(e){m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.getComputedSetting("autoFocus")&&m.views.focuses.displayLoadingMessage(e)},focusToggled:function(e){e&&m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.getComputedSetting("autoFocus")&&(this.displayAutoPinMessage(e),m.collect.focuses&&m.collect.focuses.fetch({reset:!0}))},destroy:function(){if(this.$el.hasClass("complete"))m.sendEvent("Focus","Add New"),m.trigger("setNewFocus");else{m.sendEvent("Focus","Delete");var e=this;this.$el.fadeTo(500,0,function(){e.destroyed=!0,e.model.archive(),e.remove(),m.trigger("deleteFocus")})}},autoFocusChanged:function(){this.destroyed&&m.conditionalFeatures.featureEnabled("pinfocus")&&!m.models.customization.getComputedSetting("autoFocus")&&m.trigger("setNewFocus")},removeView:function(){this.remove(),this.unbind()},toggleCompleted:function(){m.views.focuses.randomizeCongratsMessage();var e=this.model.toggleCompleted();m.views.focuses.displayLoadingMessage(e),m.conditionalFeatures.featureEnabled("serverfocus")||setTimeout(function(){m.views.focuses.dismissConnectionMessage()},3e3),this.$el.toggleClass("complete",e),m.sendEvent("Focus","Done")}}),m.views.FocusPrompt=Backbone.View.extend({attributes:{class:"prompt"},template:m.templates.focus["focus-prompt-template"],events:{click:"focusInput","focus input":"handleFocus","keypress input":"handleInput","keyup input":"handleKeyup","blur input":"handleBlur"},initialize:function(){this.focusedOnce=!1,this.listenTo(m,"globalEvent:toggleFocus",this.toggleShow),this.listenTo(m,"globalEvent:esc",this.hide),this.render()},render:function(){return this.$el.html(this.template()),this.$input=this.$el.find("input"),this.collection.loadingFromServer||this.$input.focus(),this},focusInput:function(){this.$input.focus()},handleFocus:function(e){this.focusedOnce=!0,m.views.focuses.promptFocused()},handleBlur:function(){this.focusedOnce=!1,this.$el.removeClass("loading")},handleInput:function(e){this.collection.loadingFromServer&&e.preventDefault(),this.clearHelpTimeout(),13==e.keyCode?this.save():this.startHelpTimeout()},handleKeyup:function(){0==this.getInput().length&&m.views.focuses.dismissConnectionMessage()},getInput:function(){return this.$input.val().trim()},inputTimeout:"",startHelpTimeout:function(){var e=this;this.inputTimeout=setTimeout(function(){e.displayHelpMessage()},5e3)},clearHelpTimeout:function(){0<this.inputTimeout&&clearTimeout(this.inputTimeout)},displayHelpMessage:function(){0<this.getInput().length&&m.views.focuses.displayConnectingText("Press enter to set your focus",!0)},save:function(){var e=this.getInput();if(e){var s=this;m.views.focuses.displayConnectingText('<i class="loading-icon"></i>Saving...',!0);var t=getActiveDateString();m.collect.focuses.create({focus:e,day:"today",forDate:t},{wait:!0,success:function(){m.views.focuses.successfulConnection(),m.views.focuses.successfullyCreatedNewFocus()},error:function(e,t,i){s.$input.addClass("pulse"),m.views.focuses.failedConnection(!0)}})}},toggleShow:function(){this.$input.is(":focus")?this.$input.blur():this.$input.focus()},hide:function(){this.$input.is(":focus")&&this.$input.blur()}}),m.views.Focuses=Backbone.View.extend({attributes:{id:"focuses",class:"app-container focuses"},template:m.templates.focus["focuses-template"],events:{"mouseover .todays-focus":"onMouseOver","click .todays-focus":"onClickFocus","click .prompt":"onClickFocus","click .retry":"retryConnection"},offline:!0,loading:!1,clickedOnce:!1,retrying:!0,congratsMessageActive:!1,initialize:function(){this.congratsList=["Great work!","Good job!","Nice.","Way to go!"],this.listenTo(m,"newDay",this.changeDay,this),this.listenTo(m,"setNewFocus",this.setNewFocus,this),this.listenTo(m,"deleteFocus",this.setNewFocus,this),this.listenTo(m,"todo:loadingStateChange",this.todoLoadingStateChanged),this.listenTo(m,"todo:managerReady",this.todoLoadingStateChanged),this.listenTo(m,"todo:globalChange",this.todoLoadingStateChanged),this.listenTo(m.collect.focuses,"change:archived",this.todayArchived),this.listenTo(m.collect.focuses,"reset",this.collectionReady),this.listenTo(m.collect.focuses,"sync",this.successfulConnection),this.listenTo(this.collection,"request",this.collectionRequest),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:focusVisible",this.visibleChanged),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged),this.listenTo(m,"todo:showAssignedTodosOnlyChanged",this.onShowAssignedTodosOnlyChanged),this.listenTo(m,"todo:sectionExpansion",this.onSectionExpansion),this.renderedOnce=!1,this.lastStateFocused=!1,this.focusStateChanged=!0,this.randomizeCongratsMessage(),this.render()},onMouseOver:function(){this.loading&&this.displayConnectingText(null,!0)},onClickFocus:function(){this.offline&&this.displayConnectingText(null,!0),this.clickedOnce=!0},visibleChanged:function(e){m.models.customization.getComputedSetting("focusVisible")?this.renderedOnce?this.$el.mFadeIn():this.render():this.$el.mFadeOut()},collectionRequest:function(){this.loading=!0,this.clickedOnce||this.connectingTextOverride},promptFocused:function(){this.loadedOnce||this.displayConnectingText()},displayConnectingText:function(e,t){e&&(this.connectingTextOverride=e),this.$message.html(this.connectingTextOverride?this.connectingTextOverride:'<i class="loading-icon"></i>Loading...'),this.$message.addClass("loading"),this.$message.is(":visible")||this.$message.fadeIn(500)},randomizeCongratsMessage:function(){this.loadingMessage=this.congratsList[Math.floor(Math.random()*this.congratsList.length)]},displayLoadingMessage:function(e){var t=this;e?(this.displayConnectingText('<i class="loading-icon"></i>'+this.loadingMessage,!0),this.congratsMessageActive=!0):this.displayConnectingText('<i class="loading-icon"></i> Loading...',!0),setTimeout(function(){t.dismissConnectionMessage(!1,function(){t.congratsMessageActive=!1})},4e3)},todoLoadingStateChanged:function(e){e&&"Selected"===e||this.render()},onShowAssignedTodosOnlyChanged:function(){this.render()},onSectionExpansion:function(){this.render()},collectionError:function(e,t,i){200!==t.status?this.failedConnection():this.successfulConnection()},retryConnection:function(e){e.preventDefault(),e.stopPropagation(),this.displayConnectingText('<i class="loading-icon"></i>Loading...',!0),this.retrying=!0;var t=this;m.views.focusPrompt?m.syncCoordinator.pingApi(function(){t.successfulConnection(),m.views.focusPrompt&&m.views.focusPrompt.focusInput()},function(){t.failedConnection(!0)}):this.collection.fetch({reset:!0})},successfulConnection:function(){this.congratsMessageActive||this.dismissConnectionMessage(!0),this.loading=!1,this.offline=!1,this.retrying=!1,this.loadedOnce=!0},failedConnection:function(e){this.loading=!1,this.offline=!0,this.render(),this.displayConnectingText('Trouble connecting… <span class="retry">Retry</span>',e||this.clickedOnce)},dismissConnectionMessage:function(e,t){this.$message&&this.$message.is(":visible")&&this.$message.fadeOut(e?0:300,t)},parentReady:function(e){this.isParentReady=!0,(this.isCollectionReady||e)&&this.render()},collectionReady:function(){this.isCollectionReady=!0,this.isParentReady&&this.render(),this.successfulConnection()},setNewFocus:function(){this.render(!0),m.views.focusPrompt&&m.views.focusPrompt.focusInput(),this.dismissConnectionMessage()},autoFocusChanged:function(){this.render()},setFocusState:function(e){this.lastStateFocused==e?this.focusStateChanged=!1:this.focusStateChanged=!0,this.lastStateFocused=e},render:function(e){var t=!1;m.views.focusPrompt&&(t=m.views.focusPrompt.controlFocusedOnce);var i=this;if(!this.renderedOnce){var s=(this.options.order||"append")+"To";this.$el[s]("."+this.options.region).mFadeIn().html(this.template()),this.$message=this.$(".message")}var o=this.renderedOnce;this.renderedOnce=!0;var n=null;if(e||(n=this.collection.activeFocus()),n&&m.views.todayFocus&&m.views.todayFocus.model.id==n.id&&!m.views.todayFocus.model.get("cached"))return this;if(n){this.setFocusState(!0);var a=!1,l=null;if(m.views.todayFocus?m.views.todayFocus.model.id!=n.id?m.views.todayFocus.model.id.startsWith("todo-")?m.views.todayFocus.model.get("todoId")!=n.get("todoId")&&(a=!0,l=m.views.todayFocus):(a=!0,l=m.views.todayFocus):m.views.todayFocus.model.collection||(a=!0,l=m.views.todayFocus,o=!1):a=!0,o=o&&(a&&!l||l&&!l.model.get("cached")),a){this.dismissConnectionMessage(),i.$el.find(".prompt").fadeTo(500,0),o&&l&&l.$el.fadeTo(500,0),m.views.focusPrompt=null,m.views.todayFocus=new m.views.Focus({model:n,skipRender:!0});var r=0<i.$el.find(".prompt").length;setTimeout(function(){if(r&&i.$el.find(".prompt").remove(),l&&l.removeView(),m.views.todayFocus){var e=m.views.todayFocus.render().$el.fadeTo(o?500:0,1),t=i.$el.find("ol li");0<t.length?t.replaceWith(e):i.$el.find("ol").append(e)}},l?500:0)}}else this.setFocusState(!1),m.views.todayFocus&&(i.$el.find("li").fadeTo(0,0).remove(),m.views.todayFocus=null),m.views.focusPrompt||(m.views.focusPrompt=new m.views.FocusPrompt({collection:this.collection}),this.$el.prepend(m.views.focusPrompt.render().$el.fadeIn(this.focusStateChanged?500:0))),t&&m.views.focusPrompt.focusInput();return this},addToday:function(e){m.sendEvent("Focus","Save"),m.views.todayFocus=new m.views.Focus({model:e}),this.$el.find("ol").append(m.views.todayFocus.render().$el.fadeTo(500,1))},successfullyCreatedNewFocus:function(){m.views.focuses.successfulConnection(),this.render()},changeDay:function(){m.collect.focuses.fetch({reset:!0})},todayArchived:function(){this.render()}}),m.bootstrappers.InitializeFocus=function(e,t){},m.bootstrappers.RenderFocus=function(e,t,i){e.conditionalFeatures.checkFeatureAndMigrateData("serverfocus","focusVisible","momentum-focus",function(){e.collect.focuses=new e.collect.Focuses,e.views.focuses=new e.views.Focuses({collection:e.collect.focuses,model:e.models.date,region:"center-below",order:"append"}),e.conditionalFeatures.featureEnabled("pinfocus")&&e.models.customization.getComputedSetting("autoFocus")||e.collect.focuses.fetch({reset:!0}),e.views.focuses.parentReady(i),e.widgets.push(e.views.focuses)},function(){e.collect.focuses=new e.collect.FocusesLegacy,e.views.focuses=new e.views.Focuses({collection:e.collect.focuses,model:e.models.date,region:"center-below",order:"append"}),e.collect.focuses.fetch({reset:!0}),e.views.focuses.parentReady(i),e.widgets.push(e.views.focuses)})},m.models.legacy=m.models.legacy||{},m.collect.legacy=m.collect.legacy||{},m.views.legacy=m.views.legacy||{},m.models.legacy.TodoBase=Backbone.Model.extend({isTrue:function(e){var t=this.get(e);return void 0!==t&&1==t},saveOptions:function(){return this.collection.saveOptions},getValue:function(e){var t=null;return this.attemptedSaveValues&&this.attemptedSaveValues.hasOwnProperty(e)&&(t=this.attemptedSaveValues[e]),t||(t=this.get(e)),t}}),m.models.legacy.Todo=m.models.legacy.TodoBase.extend({defaults:function(){return{title:"empty todo...",done:!1,archive:!1,order:0,createdDate:new Date,archivedDate:null,completedDate:null,deleted:!1,deletedDate:null}},archive:function(){this.save({archive:!0,archivedDate:new Date},this.saveOptions())},comparator:"order"}),m.models.legacy.TodoProxy=m.models.legacy.TodoBase.extend({defaults:function(){return{done:!1,isProxy:!0,isLoading:!0,saveFailed:!1,proxyValid:!0}}}),m.collect.legacy.TodosBase=Backbone.Collection.extend({model:m.models.legacy.Todo,saveOptions:{},initialize:function(){this.loadingFromServer=!0,localStorage.showTodoList||(localStorage.showTodoList=!1),this.listenTo(m,"newDay",this.onNewDay),this.listenTo(this,"reset",this.onReset),this.listenTo(this,"add remove change",this.collectionChanged),this.listenTo(this,"reorder",this.reorderItem)},onReset:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onNewDay:function(){this.loadingFromServer=!0,this.fetch({reset:!0})},onLoadingFromServerChanged:function(){},clearCompleted:function(){},collectionChanged:function(e){localStorage.setItem("todos-updated",new Date),this.onCollectionChanged(e)},onCollectionChanged:function(e){},completeToday:function(){return this.where({done:!0,archive:!1,deleted:!1})},completedCount:function(){return this.completeToday().length},activeToday:function(){return this.where({archive:!1,deleted:!1})},done:function(){return this.where({done:!0})},deleted:function(){return this.where({deleted:!0})},remaining:function(){return this.where({archive:!1,deleted:!1,done:!1})},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",create:function(e,t){return null==e.order&&(e.order=this.nextOrder()),Backbone.Collection.prototype.create.call(this,e,t)},reorderItem:function(e){},hasValidCachedCompletedCount:function(){return!0}}),m.collect.legacy.Todos=m.collect.legacy.TodosBase.extend({url:m.globals.urlRoot+"todos",previousCount:-1,saveOptions:{patch:!0},reorderItem:function(e){var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){}).fail(function(e,t){})},onLoadingFromServerChanged:function(){this.saveCachedCompletedCount()},onCollectionChanged:function(e){this.saveCachedCompletedCount()},completedCount:function(){return this.loadingFromServer?this.cachedCompletedCount():this.completeToday().length},saveCachedCompletedCount:function(){if(!this.loadingFromServer){var e=this.completeToday().length,t=getActiveDateString();localStorage.cachedCompletedCount=JSON.stringify({count:e,forDate:t}),e!=this.previousCount&&(this.previousCount=e,this.trigger("completedCountChanged"))}},cachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var e=JSON.parse(localStorage.cachedCompletedCount),t=getActiveDateString();if(e&&e.forDate===t)return e.count}return 0},hasValidCachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var e=JSON.parse(localStorage.cachedCompletedCount),t=getActiveDateString();if(e&&e.forDate===t)return!0}return!1},parse:function(e){return e.items?e.items:e}}),m.collect.legacy.TodosLegacy=m.collect.legacy.TodosBase.extend({localStorage:new Backbone.LocalStorage("momentum-todo"),isLegacy:!0,createOrderGaps:function(){var t=100;this.each(function(e){e.save({order:t},{silent:!0}),t+=100})},clearCompleted:function(){var i=!1,e=this.completeToday();_.each(e,function(e){var t=e.get("completedDate");t&&(activeDateStringForDate(Date.parse(t))!=getActiveDateString()&&(e.archive(),i=!0))}),i&&this.trigger("reset")},reorderItem:function(e){var t=this.get(e.move_id),i=this.get(e.move_target_id),s=0<e.move_offset?1:-1,o=this.indexOf(i),n=1;if(0<=o+s&&o+s<this.length){var a=this.at(o+s);(n=Math.abs(a.get("order")-i.get("order")))<=20&&(this.createOrderGaps(),n=Math.abs(a.get("order")-i.get("order")))}var l=i.get("order")+Math.ceil(n/2)*s;t.save({order:l},{silent:!0})}}),m.views.legacy.Todos=Backbone.View.extend({attributes:{id:"todo",class:"app-container todo"},template:m.templates.todos["legacy-todo"],offline:!0,initialFetchStarted:!1,renderedOnce:!1,loadedOnce:!1,events:{"click .todo-list-active":"openList","click .todo-list-chooser-dropdown":"chooseList","click .todo-toggle":"toggleShow","click .show-completed":"showCompleted","click .retry":"onClickRetry","click #clear-completed":"clearCompleted","click .new-toggle":"showInput","keyup #todo-new":"handleInput",dragover:"dragover",dragend:"dragend",drop:"drop"},initialize:function(){this.subViews=[],(m.views.todoPane=this).proxyCollection=new Backbone.Collection({model:m.models.legacy.TodoProxy}),this.show_completed=!1,_.bindAll(this,"addOne","addAll","dragover","dragend","li_index"),this.render(),this.listenTo(m,"globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(m,"globalEvent:window:resize",this.setMaxWidgetHeight),this.listenTo(this,"connectionOnline",this.connectionOnline),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.proxyCollection,"add",this.addOne),this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(this.collection,"request",this.collectionRequest),this.listenTo(this.collection,"change",this.collectionModelChanged),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:todoVisible",this.visibleChanged),this.listenTo(m,"todolist:updateHeight",this.updateHeight),this.collection.isLegacy||m.conditionalFeatures.featureEnabled("prefetchtodos")?this.doFetchIfNeeded():this.collection.hasValidCachedCompletedCount()||this.doFetchIfNeeded(),1==JSON.parse(localStorage.showTodoList)&&(this.showPopup(),this.doFetchIfNeeded()),setTimeout(function(){try{if(m.conditionalFeatures.featureEnabled("plus")&&!localStorage.plus_first_load&&(localStorage.plus_first_load=!0,m.views.legacy.todos))try{m.views.legacy.todos.$el.hide(),m.views.legacy.todos.undelegateEvents(),m.views.legacy.todos.$el.removeData().unbind(),m.views.legacy.todos.remove(),Backbone.View.prototype.remove.call(m.views.legacy.todos),m.bootstrappers.RenderTodos(m,$)}catch(e){}}catch(e){}},500)},render:function(){if(!this.renderedOnce){var e=(this.options.order||"append")+"To";this.$el[e]("."+this.options.region).mFadeIn().html(this.template()),this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.updateTodoCount(),this.renderedOnce=!0;var t=[];t.push({checkStateCmd:"todo.list.check.state.autofocus",commandId:"todo.toggle.autofocus",captionText:"Autofocus",todoIcon:'<span class="todo-action"><svg class="icon icon-autofocus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124.512 124.512" class="icon icon-autofocus"><path d="M113.956 57.006l-97.4-56.2c-4-2.3-9 .6-9 5.2v112.5c0 4.6 5 7.5 9 5.2l97.4-56.2c4-2.401 4-8.2 0-10.5z"/></svg></span>',toolTip:"Automatically set top todo as focus"}),t.push({css_class:"line"}),t.push({commandId:"todo.switch.feed",captionText:"Switch to...",css_class:"no-icon"}),t.push({commandId:"todo.show.settings",captionText:"Settings",css_class:"no-icon"});var i=$(this.$el.find("#todo-top-menu")[0]);this.topMenuDropdownView&&this.lastProvider==this.model.activeProvider?this.topMenuDropdownView.attachMenuItems(i,t):(this.topMenuDropdownView&&(this.topMenuDropdownView.unbind(),this.topMenuDropdownView.remove()),this.topMenuDropdownView=new m.views.TodoDropdownMenu({el:i,iClassName:"icon-cog",dropdownClassName:"todo-actions-dropdown",menuItems:new Backbone.Collection(t),model:null,parentContext:null})),this.topMenuDropdownView.render(),this.setMaxWidgetHeight(),this.visibleChanged()}return this},showUpsell:function(e){if(this.upsellView)this.upsellView.options=e,this.upsellView.render();else{e.template=m.templates.upsell.appupsell,this.upsellView=new m.views.upsell.message(e);var t=this.upsellView.render().$el;this.$el.find(".app").append(t)}this.upsellView.show()},visibleChanged:function(){m.models.customization.getComputedSetting("todoVisible")?this.renderedOnce?this.$el.mFadeIn():this.render():this.$el.mFadeOut()},setMaxWidgetHeight:function(){var e=$(window).height()-125,t=$(".todo-app");if(t.css("max-height",e),t){var i=t.find(".todo-header").outerHeight(),s=t.find(".todo-message").outerHeight(!0),o=t.find(".todo-new").outerHeight();0==i&&(i=34),null==s&&(s=0),0==o&&(o=39),t.find(".todo-list").css("max-height",e-(i+s+o))}return e},connectionOnline:function(){this.retryConnection()},doFetch:function(){this.initialFetchStarted=!0,this.collection.fetch({reset:!0})},doFetchIfNeeded:function(){if(!this.initialFetchStarted&&(this.doFetch(),m.conditionalFeatures.featureEnabled("localtodonotify"))){var t=this;window.addEventListener("storage",function(e){if(e.key&&0===e.key.indexOf("todos-updated")){if(t.fetching)return;t.fetching=!0,t.collection.fetch({success:function(){t.fetching=!1},error:function(){t.fetching=!1},reset:!0})}},!1)}},initializeGreetings:function(e){localStorage.greetings&&((e=JSON.parse(atob(localStorage.greetings)).todo)&&(e.none&&(this.emptyTodoGreetings=e.none),e.completed&&(this.completedTodoGreetings=e.completed)));this.emptyTodoGreetings||(this.emptyTodoGreetings=[{caption:"Nothing to do",message:"Add a todo to get started, "}])},randomEmptyTodoGreetings:function(){if(this.initializeGreetings(),!this.emptyTodoGreeting){var e=Math.floor(Math.random()*this.emptyTodoGreetings.length);this.emptyTodoGreeting=this.emptyTodoGreetings.splice(e,1)[0]}return this.emptyTodoGreeting},addOne:function(e){var t=new m.views.legacy.Todo({model:e,parent:this});this.subViews.push(t),this.$(".todo-list").append(t.render().el),this.$el.find("#todo-new")[0].scrollIntoView(!1)},addAll:function(){_.each(this.subViews,function(e){e&&e.destroy()}),this.subViews=[],this.$(".todo-list").html(""),_.each(this.collection.activeToday(),this.addOne),_.each(this.proxyCollection.where({proxyValid:!0}),this.addOne),this.successfulConnection(),this.setMaxWidgetHeight()},displayConnectingText:function(e,t){e&&(this.connectingTextOverride=e),this.$el.find(".todo-count").html(this.connectingTextOverride?this.connectingTextOverride:'<i class="loading-icon"></i>Loading...'),this.$el.find(".todo-count").fadeIn(500)},collectionReset:function(){this.loadedOnce=!0,this.render(),this.addAll()},collectionRequest:function(e){this.loadedOnce||this.displayConnectingText('<i class="loading-icon"></i>Loading...')},collectionError:function(e,t,i){200!==t.status?this.failedConnection():this.successfulConnection()},successfulConnection:function(){var e=this.offline;this.offline=!1,this.dismissConnectionError(),this.checkEmptyPaneState(),e&&this.trigger("connectionOnline")},failedConnection:function(e){this.offline=!0,this.displayConnectingText(e||'Trouble connecting… <span class="retry">Retry</span>'),this.checkEmptyPaneState()},handleInput:function(e){13==e.keyCode&&this.createOnEnter(),27==e.keyCode&&(e.stopPropagation(),this.$el.find("input").blur())},onClickRetry:function(e){e.preventDefault(),e.stopPropagation(),this.retryConnection()},doFirstFetch:function(){this.loadedOnce||this.collection.fetch({reset:!0})},retryConnection:function(){var t=this;this.loadedOnce?(_.each(this.proxyCollection.where({proxyValid:!0,saveFailed:!0,isLoading:!1}),function(e){t.createNewModel(e,!0)}),_.each(this.collection.where({saveFailed:!0,isLoading:!1}),function(e){t.saveToModel(e)})):this.collection.fetch({reset:!0})},createNewModel:function(s,e){var o=this;e?o.displayConnectingText('<i class="loading-icon"></i>Retrying...'):o.displayConnectingText('<i class="loading-icon"></i>Saving...'),s.set({saveFailed:!1,isLoading:!0}),o.collection.create({title:s.get("title")},{wait:!0,success:function(){o.successfulConnection(),s.set("proxyValid",!1),m.sendEvent("Todo","Add")},error:function(e,t,i){o.failedConnection('Error saving… <span class="retry">Retry</span>'),s.set({saveFailed:!0,isLoading:!1})}})},saveToModel:function(o,e){var n=this;n.displayConnectingText('<i class="loading-icon"></i>Saving...');var t=o.saveOptions();t.wait=!0,t.success=function(){var e={};jQuery.extend(e,o.attemptedSaveValues),o.attemptedSaveValues=null,jQuery.extend(e,{saveFailed:!1,isLoading:!1}),setTimeout(function(){o.set(e),n.successfulConnection()},50)},t.error=function(e,t,i){if(200==t.status){var s={};jQuery.extend(s,o.attemptedSaveValues),o.attemptedSaveValues=null,jQuery.extend(s,{saveFailed:!1,isLoading:!1}),setTimeout(function(){o.set(s),n.successfulConnection()},50)}else o.set({saveFailed:!0,isLoading:!1}),n.failedConnection('Error saving… <span class="retry">Retry</span>')},e?(o.attemptedSaveValues?jQuery.extend(o.attemptedSaveValues,e):o.attemptedSaveValues=e,o.save(e,t)):o.attemptedSaveValues&&(e=o.attemptedSaveValues,o.save(o.attemptedSaveValues,t)),jQuery.extend(e,{saveFailed:!1,isLoading:!0}),o.set(e)},createOnEnter:function(e){var t=this.$el.find("#todo-new")[0].value.trim();if(t){var i=new m.models.legacy.TodoProxy({title:t});this.proxyCollection.add(i),this.$el.find("#todo-new")[0].value="",this.createNewModel(i)}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),!(e.originalEvent.dataTransfer.dropEffect="move")},dragend:function(e){return e.originalEvent.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation(),"todo"==this.dragmode&&(this.dragging.$el.show(),this.$placeholder.hide(),this.collection.trigger("reorder",{move_id:this.dragging.model.id,move_target_id:this.move_target_id,move_offset:this.move_offset})),!1},drop:function(e){e.preventDefault(),e.stopPropagation()},li_index:function(e){return this.$("li").index(e)},updateHeight:function(e){if(!this.$(".app").hasClass("is-empty")){var t=this.$(".todo-list");0===e?t.css("min-height",""):t.outerHeight()<=e&&t.css("min-height",e)}},toggleShow:function(e){e&&e.preventDefault(),this.doFetchIfNeeded(),this.setMaxWidgetHeight(),this.$el.hasClass("show")?this.hidePopup(e):this.showPopup(),localStorage.showTodoList=!JSON.parse(localStorage.showTodoList)},showPopup:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in").find(".pane").css("height","auto"),this.$el.find("#todo-new").focus()},hidePopup:function(){if(this.$el.hasClass("show")){var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show").find(".pane").css("height","auto")})}},showCompleted:function(e){e.preventDefault(),e.stopPropagation(),this.show_completed=!0,this.addAll()},hide:function(e){var i=!1;$(".todo-item-title").each(function(e,t){"true"==$(this).attr("contentEditable")&&(i=!0)}),!i&&this.$el.hasClass("show")&&this.toggleShow()},openList:function(e){this.$el.find(".todo-list-chooser-dropdown").show()},chooseList:function(e){this.$el.find(".todo-list-chooser-dropdown").hide()},revealConnectionError:function(){"none"===$(".error-message").css("display")&&$(".error-message").slideDown("slow")},dismissConnectionError:function(){"none"!=$(".error-message").css("display")&&$(".error-message").slideUp("slow")},collectionModelChanged:function(e){this.checkEmptyPaneState()},showInput:function(e){e&&(e.preventDefault(),e.stopPropagation()),this.$el.find("#todo-new").css({visibility:"visible"}).focus(),this.$el.find(".new-toggle").css({opacity:0})},hideInput:function(e){e&&(e.preventDefault(),e.stopPropagation()),this.$el.find("#todo-new").css({visibility:""}),this.$el.find(".new-toggle").css({opacity:1})},checkEmptyPaneState:function(){if(this.subViews){var e=_.every(this.subViews,function(e){return!e.$el.is(":visible")});0!=this.collection.activeToday().length&&(e=!1),this.$el.find(".todo-app").toggleClass("is-empty",e),e&&this.hideInput(),this.offline||this.showcompleted||!e?this.$el.find(".todo-app").css("min-height",""):this.$el.find(".todo-app").css("min-height",200),this.updateTodoCount()}},updateTodoCount:function(){if(!this.offline){var e=this.collection.remaining().length;switch(e){case 0:break;case 1:break;default:}this.$(".todo-count").html(e+" to do"),this.$(".todo-count").removeClass("pulsetext")}}}),m.views.legacy.Todo=Backbone.View.extend({tagName:"li",className:"todo-item todo-item-legacy",template:m.templates.todos["legacy-todo-item"],events:{"click .todo-item-checkbox":"toggleDone",dblclick:"edit","click .destroy":"clear","keypress .editing":"handleInput","keypress .todo-item-title":"handleInput","blur .todo-item-title":"saveEdit","click .error-icon":"retrySave",dragstart:"dragstart",dragenter:"dragenter",dragleave:"dragleave"},editing:!1,initialize:function(e){_.bindAll(this,"dragstart","dragenter","dragleave"),this.parent=e.parent,this.listenTo(this.model,"change",this.render),this.listenTo(m,"globalEvent:esc",this.abortEdit)},render:function(){var e="",t=m.utils.captionFormatter(this.model.getValue("title"));if(done=this.model.getValue("done"),done)e="checked";var i={title:t,checked:e};return this.$el.html(this.template(i)),this.$el.find(".todo-item-checkbox").prop("checked",this.model.isTrue("done")),this.$el.toggleClass("done",done),this.$el.toggleClass("loading",this.model.isTrue("isLoading")),this.$el.toggleClass("failed",this.model.isTrue("saveFailed")),this.model.isTrue("isProxy")?(this.$el.toggle(this.model.isTrue("proxyValid")),this.$el.addClass("isproxy"),this.$el.data("cid",this.model.cid)):this.$el.prop("draggable","true"),this.$title=this.$el.find(".todo-item-title").first(),this.$title.text(t),this},destroy:function(){this.remove(),this.unbind()},clear:function(){m.sendEvent("Todo","Delete"),this.$el.hide(),m.views.legacy.todos.saveToModel(this.model,{deleted:!0,deletedDate:new Date})},abortEdit:function(){this.editing&&(this.$el.addClass("viewing"),this.$el.removeClass("editing"),this.$title.text(this.originalText),this.setEditable(this.$title,!1),el.attr("contentEditable",!1),el.closest(".todo-item").attr("draggable",!0),this.editing=!1)},setEditable:function(e,t){e.attr("contentEditable",t),e.closest(".todo-item").attr("draggable",!t)},saveEdit:function(){if(this.editing){this.$el.addClass("viewing"),this.$el.removeClass("editing"),this.editing=!1;var e=this.$title.text();this.setEditable(this.$title,!1),e?m.views.legacy.todos.saveToModel(this.model,{title:e}):this.clear()}},retrySave:function(){this.model.isTrue("isProxy")?m.views.legacy.todos.createNewModel(this.model,!0):this.model.attemptedSaveValues&&m.views.legacy.todos.saveToModel(this.model)},edit:function(e){this.editing||(this.originalText=this.$title.text(),this.$el.hasClass("isproxy")||this.$el.hasClass("loading")||this.$el.hasClass("failed")||(this.editing=!0,this.$el.addClass("editing"),this.$el.removeClass("viewing"),this.setEditable(this.$title,!0),this.$title.get(0).focus(),setEndOfContenteditable(this.$title.get(0)),m.sendEvent("Todo","Activate Edit")))},dragstart:function(e){if(this.editing)return!1;e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text","dummy"),this.parent.dragmode="todo",this.parent.dragging=this,m.sendEvent("Todo","Reorder")},dragenter:function(e){if("todo"==this.parent.dragmode){this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;this.parent.$placeholder.css("display","list-item"),t.height(this.$el.height()),t.after(this.parent.dragging.$el)}},dragleave:function(e){},toggleDone:function(){m.sendEvent("Todo","Done");var e=!this.model.get("done");m.views.legacy.todos.saveToModel(this.model,{done:e,completedDate:e?new Date:null})},handleInput:function(e){this.editing&&(13==e.keyCode&&(this.saveEdit(),m.sendEvent("Todo","Edit"),e.preventDefault(),e.stopPropagation()),27==e.keyCode&&(e.stopPropagation(),this.abortEdit()))}}),m.views.legacy.TodosComplete=Backbone.View.extend({attributes:{id:"todo-complete",class:"metric"},template:m.templates.todos["legacy-todo-complete"],initialize:function(){this.listenTo(this.collection,"completedCountChanged",this.render),this.render()},render:function(){var e=this.collection.completedCount(),t="todos";1==e&&(t="todo");var i={done:e,item:t},s=(this.options.order||"append")+"To";return this.$el[s]("."+this.options.region).html(this.template(i)).fadeTo(500,1),e?this.$el.show():this.$el.hide(),this}}),m.bootstrappers.RenderTodos=function(e,t){e.conditionalFeatures.featureEnabled("enhancedtodo")?e.conditionalFeatures.checkFeatureAndMigrateData("servertodos","todoVisible","momentum-todo",function(){e.views.todoPane=new e.views.TodoPane({region:"bottom-right",order:"append"}),e.widgets.push(e.views.todoPane)},function(){e.collect.legacy.todos=new e.collect.legacy.TodosLegacy,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)}):e.conditionalFeatures.checkFeatureAndMigrateData("servertodos","todoVisible","momentum-todo",function(){e.collect.legacy.todos=new e.collect.legacy.Todos,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)},function(){e.collect.legacy.todos=new e.collect.legacy.TodosLegacy,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)})},m.views.Weather=Backbone.View.extend({attributes:{id:"weather",class:"app-container weather"},template:m.templates.weather.weather,events:{"paste .weather-location-name":"handlePaste","dblclick .weather-current-location":"editLocation","mousedown .weather-location-reset":"resetLocation","click .weather-location-edit":"editLocation","click .weather-location-edit-menu":"editLocation","click .ready-to-set":"setLocation","click .app-dash":"togglePopup","click .weather-forecast-day":"switchDay","click .toggle-details":"toggleDetails","click .toggle-hourly":"toggleHourly","click .toggle-metric":"toggleUnit","keypress .weather-current-location":"onKeypress","keydown .weather-current-location":"onKeydown","keyup .weather-current-location":"onKeyup","blur .weather-current-location":"saveLocation","webkitAnimationEnd .weather-current-location":"onAnimationEnd","click .more-toggle":"toggleMore"},initialize:function(){var t=this;this.loadingMessage="Loading...",this.today=!0,this.setBaseCodes(),this.setYahooCodes(),this.renderedOnce=!1,this.detailVisible=!1,this.hourlyVisible=!1,this.listenTo(m.models.customization,"change:hour12clock",this.render),this.listenTo(m.models.customization,"change:temperatureUnit",this.render),this.listenTo(m.models.customization,"change:weatherDetail",this.updateDetails),this.listenTo(m.models.customization,"change:weatherHourly",this.updateHourly),this.listenTo(this.model,"change:error",this.render),this.listenTo(this.model,"change:now",this.render),this.listenTo(this.model,"change:location",this.render),this.listenTo(this.model,"change:hours",this.render),this.listenTo(this.model,"change:loading",this.setLoading),this.render(this.options.unitClass="hide"),this.listenTo(m.models.customization,"change:weatherVisible",this.visibleChanged),this.listenTo(this.model,"change:location",function(){var e=t.model.get("location");e&&e.countryCode&&t.setUnit(e.countryCode)}),this.listenTo(m,"globalEvent:esc globalEvent:click",this.hide)},handlePaste:function(e){e.preventDefault(),$(e.currentTarget).html("")},updateDetails:function(){var e=this,t=this.detailVisible;function i(){e.$el.find(".weather-detail").toggleClass("active",t),e.$el.find(".toggle-details .toggle-slider").toggleClass("on",t),e.$el.find(".weather-current-details").toggleClass("active",t),e.detailVisible=t}i(),(t=1==m.models.customization.get("weatherDetail")&&null!=this.model.get("hours")&&m.conditionalFeatures.featureEnabled("plus")&&this.today)!=this.detailVisible?setTimeout(function(){i()},10):i()},updateHourly:function(){var e=this,t=this.hourlyVisible;function i(){e.$el.find(".weather-hourly").toggleClass("active",t),e.$el.find(".toggle-hourly .toggle-slider").toggleClass("on",t),e.$el.find(".weather-current-temp-wrapper").toggleClass("active",t),e.hourlyVisible=t}i(),(t=1==m.models.customization.get("weatherHourly")&&null!=this.model.get("hours")&&m.conditionalFeatures.featureEnabled("plus")&&this.today)!=this.hourlyVisible?setTimeout(function(){i()},10):i()},updateDaily:function(){this.$el.find(".weather-forecast-daily").toggleClass("active",this.model.get("daily"))},updateCurrentInfo:function(){this.$el.find(".weather-current-details").toggleClass("active",null!=this.model.get("now").apparentTemperature)},setBaseCodes:function(){var e=this.baseCodes={};e.tornado="F",e.tropicalStorm="F",e.hurricane="F",e.severeThunderstorm="O",e.thunderstorm="P",e.mixedRainAndSnow="X",e.drizzle="Q",e.rain="R",e.freezingRain="X",e.showers="Q",e.sunnyShowers="Q",e.snowFlurries="U",e.snow="W",e.hail="X",e.sleet="X",e.dust="J",e.foggy="M",e.haze="J",e.smoky="M",e.blustery="F",e.windy="F",e.cold="G",e.cloudy="Y",e.mostlyCloudyNight="I",e.mostlyCloudyDay="H",e.partlyCloudyNight="E",e.partlyCloudyDay="H",e.clearNight="C",e.clearDay="B",e.scatteredThunderstorm="O",e.scatteredShowers="Q",e.heavySnow="W",e.thundershowers="O",e.snowShowers="W",e.unknown=")"},setYahooCodes:function(){var e=this.yahooCodes={},t=this.baseCodes;e[0]=t.tornado,e[1]=t.tropicalStorm,e[2]=t.hurricane,e[3]=t.severeThunderstorm,e[4]=t.thunderstorm,e[5]=t.mixedRainAndSnow,e[6]=t.mixedRainAndSnow,e[7]=t.mixedRainAndSnow,e[8]=t.mixedRainAndSnow,e[9]=t.drizzle,e[10]=t.freezingRain,e[11]=t.rain,e[12]=t.rain,e[13]=t.snowFlurries,e[14]=t.snowFlurries,e[15]=t.snowFlurries,e[16]=t.snow,e[17]=t.hail,e[18]=t.sleet,e[19]=t.dust,e[20]=t.foggy,e[21]=t.haze,e[22]=t.smoky,e[23]=t.blustery,e[24]=t.windy,e[25]=t.cold,e[26]=t.cloudy,e[27]=t.mostlyCloudyNight,e[28]=t.mostlyCloudyDay,e[29]=t.partlyCloudyNight,e[30]=t.partlyCloudyDay,e[31]=t.clearNight,e[32]=t.clearDay,e[33]=t.clearNight,e[34]=t.clearDay,e[35]=t.mixedRainAndSnow,e[36]=t.clearDay,e[37]=t.scatteredThunderstorm,e[38]=t.scatteredThunderstorm,e[39]=t.scatteredShowers,e[40]=t.scatteredShowers,e[41]=t.heavySnow,e[42]=t.mixedRainAndSnow,e[43]=t.heavySnow,e[44]=t.partlyCloudyDay,e[45]=t.thundershowers,e[46]=t.snowShowers,e[47]=t.scatteredThunderstorm,e[3200]=t.unknown},show:function(){this.model.updateWeather(!0),this.$el.addClass("show"),this.updateDetails(),this.updateHourly(),this.open=!0;var e=this;m.widgetManager.unfocusOverlap(this.options.region,this.$app.height()),setTimeout(function(){e.$el.addClass("show-fade-in")},5)},hide:function(e){if(!(0<this.$el.find(".upsell-overlay.active").length)&&this.open){if(e&&27===e.keyCode&&this.$el.hasClass("editing"))return this.$location.html(this.model.get("location").locationName),void this.doneEditingLocation();if(e&&$.contains(this.$el.find(".more")[0],e.target)||this.dropdownOpen&&this.toggleMore(),!e||!$.contains(this.$el[0],e.target)){this.$el.removeClass("show-fade-in"),this.open=!1;var t=this;m.widgetManager.refocusOverlap(this.options.region),setTimeout(function(){t.$el.removeClass("show")},250)}}},togglePopup:function(e){this.$el.hasClass("show")?this.hide():this.show()},toggleDetails:function(e){if(e&&e.stopPropagation(),this.today)if(m.conditionalFeatures.featureEnabled("plus"))m.models.customization.set("weatherDetail",!m.models.customization.get("weatherDetail"));else{m.commandManager.execute("upsell.message",{targetRegion:"weather",sourceEvent:"weather-detail",buttonText:"Learn more",title:"Weather Details",description:"Wind, rain, hourly forecast, more accurate feed, and more!"})}},toggleHourly:function(e){if(e&&e.stopPropagation(),this.today)if(m.conditionalFeatures.featureEnabled("plus"))m.models.customization.set("weatherHourly",!m.models.customization.get("weatherHourly"));else{if($(e.currentTarget).hasClass("weather-current-temp-wrapper"))return;m.commandManager.execute("upsell.message",{targetRegion:"weather",sourceEvent:"weather-hourly",buttonText:"Learn more",title:"Hourly Forecast",description:"See the hour-by-hour forecast for the day"})}},switchDay:function(e){e.stopPropagation(),this.$el.find(".weather-forecast-day").removeClass("selected");var t=e.currentTarget.dataset.day;t!=this.selectedDayName&&(this.selectedDayName=t,this.today=this.model.get("days")[0].day==t,this.daySelectionActive=!0,$(e.currentTarget).addClass("selected"),this.render())},getLastWeatherLocation:function(){var e=localStorage.getItem("last-weather-location");return e?JSON.parse(e):null},render:function(){if(!this.$location||!this.$location.hasClass("editing")){var e="Set Location",t=this.model.get("location")&&this.model.get("location").locationName,i=this.model.get("location")&&this.model.get("location").locationExact,h=this;this.model.get("firstLoad")&&(t+=", "+this.model.get("location").countryCode,setTimeout(function(){h.model.set("firstLoad",!1)},5e3)),t&&0!=t.length||this.model.get("loading")||(t=e);var s,o,n,a,l,r=[],d=[],c=this.model;this.today&&(n=c.get("now")),c.get("days")&&(this.selectedDayName||(this.selectedDayName=c.get("days")[0].day,this.today=!0),this.today?this.selectedDayName=c.get("days")[0].day:a=this.selectedDayName,c.get("days").forEach(function(e){n||e.day!=h.selectedDayName||(n=e),r.push({high:h.calculateDisplayTemperature(e.high),low:h.calculateDisplayTemperature(e.low),condition:e.condition,icon:h.getIconFromCode(e.code,c.get("provider")),unitClass:h.options.unitClass,dayShort:e.day.substr(0,3),day:e.day})})),c.get("hours")&&c.get("hours").forEach(function(e){l=k(e);var t=e.hour.substr(e.hour.indexOf("T")+1,2);d.push({temperature:h.calculateDisplayTemperature(e.temperature),condition:e.condition,icon:h.getIconFromCode(e.code,c.get("provider")),unitClass:h.options.unitClass,hour:m.models.customization.get("hour12clock")?h.convertTo12H(parseInt(t)):t,precipChance:l.chance,precipType:l.type,windSpeed:h.calculateDisplaySpeed(e.windSpeed),windGust:h.calculateDisplaySpeed(e.windGust)})});var u,g=this.model.get("now");if(g){l=k(g);var p=g.sunset?g.sunset.substr(g.sunset.indexOf("T")+1,5):null,f=g.sunrise?g.sunrise.substr(g.sunrise.indexOf("T")+1,5):null,v=m.models.customization.get("hour12clock"),w=0,b=!0;"Falling"==g.pressureTendency?w=180:"Steady"==g.pressureTendency&&(b=!1),o={condition:g.condition,cloudCover:g.cloudCover,windDirection:g.windDirection+180,windSpeed:h.calculateDisplaySpeed(g.windSpeed),windGust:h.calculateDisplaySpeed(g.windGust),temperature:h.calculateDisplayTemperature(c.get("now").temperature),apparentHigh:h.calculateDisplayTemperature(g.apparentHigh),apparentLow:h.calculateDisplayTemperature(g.apparentLow),apparentTemperature:h.calculateDisplayTemperature(g.apparentTemperature),uvIndex:g.uvIndex,uvIndexText:g.uvIndexText,icon:h.getIconFromCode(g.code,c.get("provider")),humidity:g.humidity,dewPoint:h.calculateDisplayTemperature(g.dewPoint),pressure:h.calculateDisplayPressure(g.pressure),pressureTendency:g.pressureTendency,pressureDirection:w,pressureDirectionVisible:b,high:h.calculateDisplayTemperature(g.high),low:h.calculateDisplayTemperature(g.low),sunset:p?v?h.convertTo12H(p.substr(0,2),p.substr(3,2)):p:null,sunrise:f?v?h.convertTo12H(f.substr(0,2),f.substr(3,2)):f:null,moonPhase:g.moonPhase,precipChance:l.chance,precipType:l.type,precipAmount:h.calculateDisplayLength(g.precipAmount),visibility:h.calculateDisplayLongLength(g.visibility),visibilityText:g.visibilityText,precipitationExpected:h.calculateDisplayLength(n.precipitationExpected),hoursOfSun:Math.round(g.hoursOfSun)}}n==g?u=o:n&&(l=k(n),u={condition:n.condition,cloudCover:n.cloudCover,windDirection:n.windDirection+180,windSpeed:h.calculateDisplaySpeed(n.windSpeed),windGust:h.calculateDisplaySpeed(n.windGust),temperature:h.calculateDisplayTemperature(c.get("now").temperature),apparentHigh:h.calculateDisplayTemperature(n.apparentHigh),apparentLow:h.calculateDisplayTemperature(n.apparentLow),apparentTemperature:h.calculateDisplayTemperature(n.apparentTemperature),uvIndex:n.uvIndex,uvIndexText:n.uvIndexText,icon:h.getIconFromCode(n.code,c.get("provider")),humidity:n.humidity,dewPoint:h.calculateDisplayTemperature(n.dewPoint),pressure:h.calculateDisplayPressure(n.pressure),pressureTendency:n.pressureTendency,pressureDirection:w,pressureDirectionVisible:b,high:h.calculateDisplayTemperature(n.high),low:h.calculateDisplayTemperature(n.low),precipChance:l.chance,precipType:l.type,precipAmount:h.calculateDisplayLength(n.precipAmount),visibility:h.calculateDisplayLongLength(n.visibility),visibilityText:n.visibilityText,precipitationExpected:h.calculateDisplayLength(n.precipitationExpected),hoursOfSun:Math.round(n.hoursOfSun)}),s={location:t,locationExact:i,unit:this.displayUnit(),now:o,selected:u,unitClass:this.options.unitClass,message:this.model.get("error"),days:r,hours:d,plusDetails:0!=this.model.get("providerId"),detailVisible:m.models.customization.get("weatherDetail"),hourlyVisible:m.models.customization.get("weatherHourly"),loading:this.model.get("loading"),today:this.today,displayDay:a},this.$el.removeClass("show show-fade-in");var y=(this.options.order||"prepend")+"To";return this.renderedOnce?this.$el[y]("."+this.options.region).html(this.template(s)):this.$el[y]("."+this.options.region).mFadeIn().html(this.template(s)),this.$location=this.$(".weather-current-location .weather-location-name"),t==e?this.$location.addClass("ready-to-set"):this.$location.removeClass("ready-to-set"),this.renderedOnce=!0,this.$popup=this.$(".app-wrapper"),this.$app=this.$(".app"),this.open&&this.$el.addClass("show show-fade-in"),this.dropdownOpen&&this.toggleMore(),this.$el.find(".toggle-metric .toggle-slider").toggleClass("on","c"===this.displayUnit()),this.daySelectionActive&&this.$el.find(".weather-forecast-day[data-day='"+this.selectedDayName+"']").first().addClass("selected"),this.updateDetails(),this.updateHourly(),this.updateCurrentInfo(),this.updateDaily(),this.open&&m.widgetManager.unfocusOverlap(this.options.region,this.$app.height()),this}function k(e){var t=null==e.high?e.temperature:e.high,i=null==e.low?e.temperature:e.low,s=e.rainProbability,o=e.snowProbability,n=e.iceProbability,a=15<s,l=15<o,r=15<n,d="precip.",c=e.precipitationProbability;return a||l||r?!a||l||r?a||!l||r?a||l||!r||(d="ice",c=n):(d="snow",c=o):(c=s,d="rain"):h.calculateDisplayTemperature(t,!0)<0?(c=o,d="snow"):0<h.calculateDisplayTemperature(i,!0)&&(c=s,d="rain"),{type:d,chance:c}}},setLoading:function(){this.$el.find(".weather-current-location").toggleClass("loading",this.model.get("loading"))},convertTo12H:function(e,t){var i="AM",s=e=parseInt(e);return 12<=s&&(s=e-12,i="PM"),0==s&&(s=12),s+(null==t?"":":"+t)+i},visibleChanged:function(e){m.models.customization.get("weatherVisible")?this.renderedOnce?this.$el.mFadeIn():this.render():this.$el.mFadeOut()},calculateDisplayTemperature:function(e,t){var i=this.model.get("fetchUnit"),s=e;return s||0==s?"c"===this.displayUnit()||t?"c"===i?s:Math.round(5*(s-32)/9):"c"===i?Math.round(9*s/5+32):s:null},calculateDisplaySpeed:function(e){var t=this.model.get("fetchUnit");return e||0==e?"mph"===this.displaySpeedUnit()?("c"===t?Math.round(.62137*e):Math.round(e))+" mph":("c"===t?Math.round(e):Math.round(1.60934*e))+" km/h":null},calculateDisplayPressure:function(e){var t=this.model.get("fetchUnit");return e||0==e?"inHg"===this.displayPressureUnit()?("c"===t?Math.round(.02953*e):e)+" inHg":("c"===t?Math.round(e):Math.round(33.8639*e))+" hPa":null},calculateDisplayLength:function(e){var t=this.model.get("fetchUnit");return e||0==e?"in"===this.displayLengthUnit()?("c"===t?Math.round(.03937*e):e)+" in":("c"===t?Math.round(e):Math.round(25.4*e))+"mm":null},calculateDisplayLongLength:function(e){var t=this.model.get("fetchUnit");return e||0==e?"in"===this.displayLengthUnit()?("c"===t?Math.round(.62137*e):Math.round(e))+" mi":("c"===t?Math.round(e):Math.round(1.60934*e))+" km":null},displayPressureUnit:function(){return"f"==this.displayUnit()?"inHg":"kPa"},displaySpeedUnit:function(){return"f"==this.displayUnit()?"mph":"km/h"},displayLengthUnit:function(){return"f"==this.displayUnit()?"in":"mm"},displayLongLengthUnit:function(){return"f"==this.displayUnit()?"mi":"km"},displayUnit:function(){var e=m.models.customization.get("temperatureUnit");return e||(this.defaultUnit?this.defaultUnit:"c")},setLocation:function(){this.$location.html(""),this.editLocation()},editLocation:function(){this.dropdownOpen&&this.toggleMore(),this.$el.hasClass("editing")||(this.$el.addClass("editing"),this.$location.html()==this.loadingMessage&&this.$location.html(""),this.$location.attr("contenteditable",!0).addClass("editing pulse"),this.selectElementContents(this.$location[0]),this.$location.parent().addClass("editing"))},selectElementContents:function(e){var t=document.createRange();t.selectNodeContents(e);var i=window.getSelection();i.removeAllRanges(),i.addRange(t)},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$location.removeClass("pulse")},onKeypress:function(e){13===e.keyCode&&(e.preventDefault(),this.saveLocation())},resetLocation:function(e){e&&(e.preventDefault(),e.stopPropagation()),this.doneEditingLocation(),localStorage.removeItem("weather-manual"),this.model.set({error:null,firstLoad:!1}),this.model.set({location:null},{silent:!0}),this.model.trigger("change:location");var t=this;setTimeout(function(){t.$el.find(".weather-location-name").html(t.loadingMessage)},50)},saveLocation:function(){if(this.$el.hasClass("editing")){this.doneEditingLocation();var e=this.$location.text().trim();if(this.model.get("location")&&this.model.get("location").locationName&&this.model.get("location").locationName.toLowerCase()==e.toLowerCase())return this.doneEditingLocation(),!0;e&&0<e.length?this.model.getManualLocation(e):this.resetLocation()}},doneEditingLocation:function(){this.$el.removeClass("editing"),this.$location.parent().removeClass("editing"),this.$location.attr("contenteditable",!1).removeClass("editing").addClass("pulse")},toggleUnit:function(e){e&&e.stopPropagation(),this.options.unitClass="","c"===this.displayUnit()?m.models.customization.save("temperatureUnit","f"):m.models.customization.save("temperatureUnit","c")},setUnit:function(e){this.defaultUnit=0<=["US","BM","BZ","JM","PW"].indexOf(e)?"f":"c"},getIconFromCode:function(e,t){return"yahoo"!=t&&t?this.baseCodes[e]:this.yahooCodes[e]},toggleMore:function(){var e=this.$(".more");e.toggleClass("active"),this.dropdownOpen=e.hasClass("active")},showUpsell:function(e){this.upsellView&&this.upsellView.remove(),e.template=m.templates.upsell.appupsell,this.upsellView=new m.views.upsell.message(e);var t=this.upsellView.render().$el;this.$el.find(".app").append(t),this.upsellView.show()}}),m.bootstrappers.RenderWeather=function(t,e){t.conditionalFeatures.checkPreferenceForRender("weatherVisible",function(){t.models.customization.get("weatherVisible")&&(t.models.weather=new t.models.Weather,t.views.weather=new t.views.Weather({model:t.models.weather,region:"top-right",order:"prepend"}),t.widgets.push(t.views.weather),t.stopListening(t.models.customization,"change:weatherVisible"))},function(e){t.listenTo(t.models.customization,"change:weatherVisible",e)})},m.models.Weather=Backbone.Model.extend({defaults:{location:{},now:{},fetchUnit:"c"},initialize:function(){var e,t=this,i=localStorage.getItem("manual-weather-location");(i=JSON.parse(i))&&(this.findPositionByYahooLocationId(i.woeid),e={enteredLocation:i.enteredLocation,locationId:i.woeid,latitude:1,longitude:1,locationName:i.location_name},localStorage.setItem("weather-manual",JSON.stringify(e)),localStorage.removeItem("manual-weather-location"));var s=localStorage.getItem("momentum-weather-1");s=JSON.parse(s);var o=localStorage.getItem("last-weather-location");if(o=JSON.parse(o),s){var n;n=e?{locationId:e.locationId,locationName:e.locationName,latitude:e.latitude,longitude:e.longitude,countryCode:localStorage.getItem("country")}:{locationId:s.woeid,locationName:s.location,latitude:o.latitude,longitude:o.longitude,countryCode:localStorage.getItem("country")};var a={temperature:s.fetchTemperature,condition:s.location,code:s.code};localStorage.setItem("weather",JSON.stringify({location:n,now:a,fetchUnit:s.fetchUnit,providerId:0,provider:"yahoo"})),localStorage.removeItem("momentum-weather-1"),localStorage.removeItem("momentum-weather"),localStorage.removeItem("last-weather-location")}this.loadFromLocalStorage(),(this.get("firstLoad")||this.get("loading"))&&(this.set({firstLoad:!1,loading:!1}),this.store()),setInterval(function(){t.updateWeather()},6e5);var l=this.getSavedManualWeatherLocation();setInterval(function(){t.getSavedManualWeatherLocation()||t.updateCoords()},6e6),this.listenTo(this,"change:providerId",function(){t.store(),t.get("location").locationId=null,t.set({updatedForecast:null,updated:null}),t.store(),t.trigger("change:location")}),this.listenTo(this,"change:location",function(){var e=t.get("location");e&&e.countryCode&&localStorage.setItem("country",e.countryCode),t.updateWeather(!0)}),m.conditionalFeatures.featureEnabled("weatherapi")?this.set("providerId",1):this.set("providerId",0),setTimeout(function(){t.updateWeather(),l||t.updateCoords()},100),window.addEventListener("focus",function(e){t.missedUpdate&&t.updateWeather()})},updateCoords:function(){var t=this;this.getCoordinates(function(e){e.changed&&(t.get("location")||t.set("location",{}),t.get("location").latitude=e.latitude,t.get("location").longitude=e.longitude,t.get("location").locationId=null,t.set({updatedForecast:null,updated:null,error:null}),t.updateWeather())})},store:function(){localStorage.setItem("weather",JSON.stringify(this.attributes))},loadFromLocalStorage:function(){var e=localStorage.getItem("weather");e&&(this.attributes=JSON.parse(e))},updateWeather:function(t,e){if(this.missedUpdate=!document.hasFocus(),!this.missedUpdate){var i=this,s=(new Date).getTime();if(this.get("location")&&this.get("location").latitude){if((!(t&&s-this.get("updatedForecast")<18e5)||e)&&(t||!(s-this.get("updated")<6e5)||e)){var o,n=this.get("location");if(o=t?"forecast":"current",0==this.get("providerId"))this.collectFromYahoo();else{if(this.url=m.globals.urlRoot+"weather/"+o+"?",n.locationId&&0<n.locationId.length)this.url+="locationId="+n.locationId;else{if(1==n.latitude&&1==n.longitude)return void this.updateCoords();this.url+="lat="+n.latitude+"&lon="+n.longitude}this.set("loading",!0),this.fetch({error:function(){i.set("loading",!1)},success:function(){if(t)i.set({loading:!1,updated:s,updatedForecast:s});else{var e=JSON.parse(JSON.stringify(i.attributes));i.loadFromLocalStorage(),Object.assign(i.get("now"),e.now),Object.assign(i.get("location"),e.location),i.set({provider:e.provider,fetchUnit:e.fetchUnit,loading:!1,updated:s})}i.trigger("change:now"),i.trigger("change:loading"),i.store()}})}}}else this.updateCoords()}},findPositionByYahooLocationId:function(e){var o=this,t="https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent("select * from weather.forecast where woeid="+e+' and u="f"')+"&format=json";$.getJSON(t,function(e){if(e&&e.query&&1==e.query.count){var t=e.query.results.channel.item,i=o.getSavedManualWeatherLocation();i.latitude=t.lat,i.longitude=t.long;var s=o.get("location");s.latitude=t.lat,s.longitude=t.long,s.locationId=null,o.updateWeather(!1,!0)}})},collectFromYahoo:function(){if(this.get("location").locationId){var a=this,l=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];this.set("loading",!0);var e="https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent("select * from weather.forecast where woeid="+this.get("location").locationId+' and u="f"')+"&format=json";$.getJSON(e,function(e){if(a.set("loading",!1),e&&e.query&&1==e.query.count){var t=e.query.results.channel.item.condition,i=[],s=0;if(e.query.results.channel.item.forecast.forEach(function(e){var t=new Date;t.setDate(t.getDate()+s),++s<6&&i.push({high:e.high,low:e.low,code:e.code,condition:e.text,day:l[t.getDay()],error:null})}),t){var o={high:i[0].high,low:i[0].low,temperature:t.temp,code:t.code,condition:t.text},n=e.query.results.channel.units;a.set({fetchUnit:n.temperature.toLowerCase(),updated:(new Date).getTime(),updatedForecast:(new Date).getTime(),error:null,now:o,days:i,provider:"yahoo",providerId:0}),a.store()}}}).fail(function(e){a.set("loading",!1),console.log("Error getting weather data: "+e)})}else this.getLocationFromYahoo("("+this.get("location").latitude+","+this.get("location").longitude+")")},getManualLocation:function(e){var t=this;0==this.get("providerId")?this.getLocationFromYahoo(e,!0):(this.url=m.globals.urlRoot+"weather/location?location="+e,this.set("loading",!0),this.fetch({error:function(){t.set({loading:!1,error:e+" not found"}),setTimeout(function(){t.set({error:null})},5e3)},success:function(){t.set({loading:!1,error:null});var e=JSON.parse(JSON.stringify(t.attributes.location));t.loadFromLocalStorage(),t.foundLocation(e,!0)}}))},getLocationFromYahoo:function(e,s){this.set("loading",!0);var o=this,t="https://query.yahooapis.com/v1/public/yql?q=SELECT%20*%20FROM%20geo.places%20WHERE%20text%3D%22"+encodeURIComponent(e)+"%22&format=json";function n(e){var t={yahooLocationId:e.woeid};return e.locality1&&e.locality1.content?t.city=e.locality1.content:t.city=e.name,e.country&&(t.countryCode=e.country.code),t.latitude=e.centroid.latitude,t.longitude=e.centroid.longitude,t}$.getJSON(t,function(e){o.set("loading",!1);var t=e.query.count,i=null;1<t?i=n(e.query.results.place[0]):1==t?e.query.results.place&&(i=n(e.query.results.place)):o.set("error","not found"),i&&o.foundLocation({locationName:i.city,latitude:s?i.latitude:o.get("location").latitude,longitude:s?i.longitude:o.get("location").longitude,countryCode:i.countryCode,locationId:i.yahooLocationId},s)}).fail(function(e){console.log("Error getting yahooLocationId"),o.set("loading",!1)})},foundLocation:function(e,t){t&&localStorage.setItem("weather-manual",JSON.stringify(e)),this.set({location:e,updated:null,updatedForecast:null,error:null,manual:1==t,firstLoad:1==t,loading:!1}),this.store(),e.countryCode&&(localStorage.country=e.countryCode)},getSavedManualWeatherLocation:function(){var e=localStorage.getItem("weather-manual");return e?JSON.parse(e):null},getCoordinates:function(i){var s=this;function t(e){if(s.waitingForLocation){s.waitingForLocation=!1,s.set("loading",!1),s.trigger("change:loading"),e&&console.log("Error getting location: "+e.code+", msg: "+e.message);var t=s.getSavedManualWeatherLocation();t?i({latitude:t.latitude,longitude:t.longitude,changed:!1}):s.lastPosition&&(s.lastPosition.changed=o(s.lastPosition),i(s.lastPosition)),s.set("error","")}}function o(e){var t=!0,i=s.get("location");return i&&(+i.latitude).toFixed(2)==(+e.latitude).toFixed(2)&&(+i.longitude).toFixed(2)==(+e.longitude).toFixed(2)&&(t=!1),t}this.get("location")&&this.get("location").latitude||(this.set("loading",!0),this.trigger("change:loading")),this.waitingForLocation=!0,navigator.geolocation.getCurrentPosition(function(e){s.lastPosition={latitude:e.coords.latitude,longitude:e.coords.longitude,changed:o(e.coords)},s.waitingForLocation=!1,s.set("loading",!1),s.trigger("change:loading");try{i(s.lastPosition)}catch(e){console.log(e),t(e)}},t),setTimeout(function(){t()},8e3)}}),m.models.Message=Backbone.Model.extend({defaults:function(){return{title:null,message:"",priority:5,views:0,viewLimit:3,deleted:!1,createdDate:Date.now(),visible:!1,loginOnClick:!1,fromServer:!1}},showMessage:function(e,t,i,s){m.commandManager.execute("notification.show.enhanced",{title:e,message:t,views:0,viewLimit:i,visible:!0,loginOnClick:s})},showMessageNow:function(e,t,i,s){m.commandManager.execute("notification.show.enhanced",{title:e,message:t,views:0,viewLimit:i,visible:!0,loginOnClick:s})},dismissMessage:function(){m.commandManager.execute("notification.dismiss")},save:function(e,t){if(t||(t={}),e||(e=_.clone(this.attributes)),e.hasOwnProperty("dismissed")&&e.dismissed&&(e.deleted=!0),!t.download_save&&this.get("fromServer"))try{var i=null;for(prop in e)e.hasOwnProperty(prop)&&"changed_props"!=prop&&"sync_success"!=prop&&(i||(i=this.get("changed_props")||[]),_.contains(i,prop)||i.push(prop));i&&(e.changed_props=i,e.sync_success=!1,t.silent=!1)}catch(e){}return Backbone.Model.prototype.save.call(this,e,t)}}),m.collect.Messages=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-messages"),model:m.models.Message,cleaned:!1,initialize:function(){this.listenTo(this,"reset",this.cleanupMessagesIfRequired)},cleanupMessagesIfRequired:function(){if(!this.cleaned){this.cleaned=!0;var i=[];this.each(function(e){if(e.get("deleted"))e.get("fromServer")&&e.get("sync_success")&&!e.get("changed_props")&&i.push(e);else{var t=e.get("filter");t&&m.conditionalFeatures.featureEnabled(t)?e.save({deleted:!0,filtered:!0}):5==e.get("priority")?e.get("fromServer")?e.save({deleted:!0}):i.push(e):e.get("visible")||e.save({deleted:!0})}}),0<i.length&&_.each(i,function(e){e.destroy()})}}}),m.models.NotificationSync=Backbone.Model.extend({baseUrl:m.globals.urlRootApi+"notifications",initialize:function(e){this.collection=e.collection,this.listenTo(this.collection,"change:changed_props",this.onChange),this.listenTo(this.collection,"reset",this.onReset)},findHavingAttribute:function(e,t){return e.filter(function(e){return e.has(t)})},hasAttribute:function(e,t){return!!e.find(function(e){return e.has(t)})},onReset:function(){this.syncToServer()},onChange:function(e,t){if(!t.ignoreSave){var i=e.changedAttributes();i&&i.hasOwnProperty("changed_props")&&i.changed_props&&this.syncToServer()}},syncToServer:function(e){var n=this,t=this.findHavingAttribute(this.collection,"changed_props");t&&0!=t.length?nimble.each(t,function(i,e){if(i.get("fromServer")){var t=i.get("changed_props");if(t&&0!=t.length){var s={};if(_.each(t,function(e){"changed_props"!=e&&"sync_success"!=e&&(s[e]=i.get(e))}),1==Object.keys(s).length&&s.hasOwnProperty("views"))e();else{var o=n.baseUrl+"/"+encodeURIComponent(i.id);$.ajax({url:o,contentType:"application/json",type:"PATCH",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify(s)}).done(function(e){e&&e.success&&i.save({changed_props:null,sync_success:!0},{silent:!0})}).fail(function(e,t){i.save({sync_success:!1},{silent:!0})}).always(function(){e()})}}else e()}},function(){e&&e()}):e&&e()}}),m.models.NotificationManager=Backbone.Model.extend({backgroundLoaded:!1,_notificationView:null,_parent:null,settingsVisible:!1,initialize:function(){this.displayed=[],this.collection=new m.collect.Messages,m.models.message=new m.models.Message,this.listenTo(this.collection,"add reset",this.displayPendingMessages),this.listenToOnce(m,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(m,"settings:hidden",this.settingsHidden),this.listenTo(m,"settings:visible",this.onSettingsVisible),this.listenTo(m,"notifications:timestamp",this.onAvailableTimestamp),m.conditionalFeatures.featureEnabled("notifySyncOff")||(this.notifySync=new m.models.NotificationSync({collection:this.collection})),this.collection.fetch({reset:!0})},onBackgroundLoaded:function(){this.backgroundLoaded||(this.backgroundLoaded=!0,this.displayPendingMessages(),m.commandManager.execute("clean.localstorage"))},displayPendingMessages:function(){var i=this;if(this.collection.cleanupMessagesIfRequired(),this._parent&&this.backgroundLoaded&&!this.settingsVisible){var e=this.notificationView();if(e&&!e.notifying){var t=_.chain(this.collection.where({deleted:!1,visible:!0})).reject(function(e){var t=e.get("filter");return!(!t||!m.conditionalFeatures.featureEnabled(t))||_.contains(i.displayed,e)}).sortBy("priority").sortBy("createdDate").value();if(t&&0!=t.length){var s=t[0];this.displayed.push(s),e.showMessage(s)}}}},setParent:function(e){e&&(this._parent=e,this.displayPendingMessages())},onAvailableTimestamp:function(e){if(e){var t=localStorage.getItem("ts_notifications");(!t||t<e)&&this.downloadNotifications()}},downloadNotifications:function(){var t=this,e=localStorage.getItem("ts_notifications"),i=m.globals.urlRootApi+"notifications";e&&(e=parseInt(e,10),Number.isInteger(e)&&(i=i+"?ts="+e));try{$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:i}).done(function(e){e&&e.timestamp&&(e.notifications&&0<e.notifications.length&&(t.collection.reset(e.notifications),t.collection.invoke("save",null,{download_save:!0})),localStorage.setItem("ts_notifications",e.timestamp))}).fail(function(e,t){})}catch(e){}},showMessage:function(e,t,i,s){var o={title:e,message:t,visible:!0};null!=i&&(o.viewLimit=i),null!=s&&(o.loginOnClick=s),this.collection.create(o)},showMessageEnhanced:function(e,t,i){e.hasOwnProperty("visible")||(e.visible=!0);var s={};t&&(s.success=t),i&&(s.silent=!0),this.collection.create(e,s)},dismissMessage:function(){this._notificationView&&this.notificationView().hideNotification()},settingsHidden:function(){this.settingsVisible=!1,this.displayPendingMessages()},onSettingsVisible:function(){this.settingsVisible=!0},notificationView:function(){return this._notificationView||(this._notificationView=new m.views.Notification({_parent:this._parent})),this._notificationView}}),m.views.Notification=Backbone.View.extend({attributes:{class:"notification"},template:m.templates.notification.notification,notifying:!1,timeoutId:null,events:{"click .notification-hide":"hideNotificationClicked","click .notification-button":"ctaButtonClicked","click .secondary-text":"secondaryTextClicked"},initialize:function(e){this._parent=e._parent,this.renderedOnce=!1,this.listenTo(m,"settings:visible",this.settingsVisible)},showMessage:function(e){this.model&&this.model.cid==e.cid||(this.model=e,this.render())},render:function(){var e=this;this.notifying=!0,this.incrementViews(),this.$el.html(this.template(this.model.toJSON())),this.$el.toggleClass("no-title",null===this.model.get("title")),this._parent.$el.prepend(this.$el),this.showNotification(),this.$message=this.$(".notification-description"),this.model.has("message_html")&&this.$message.html(this.model.get("message_html"));var t=this.model.get("display_time");!t||null==t||void 0===t||t<=0||(this.timeoutId=setTimeout(function(){e.hideNotification()},t))},incrementViews:function(){var e=this.model.get("views")+1;e>=this.model.get("viewLimit")?this.model.save({visible:!1,views:e}):this.model.save({views:e},{silent:!0})},settingsVisible:function(){this.hideNotification(!0,!0)},showNotification:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in")},hideNotification:function(t,e){clearTimeout(this.timeoutId);var i=this;this.$el.hasClass("show")&&this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){i.$el.removeClass("show"),t||m.models.notificationManager.displayPendingMessages()}),this.notifying&&(this.notifying=!1)},hideNotificationClicked:function(e){e.stopPropagation(),this.hideNotification(),this.model.save({dismissed:!0,visible:!1},{silent:!0})},ctaButtonClicked:function(e){e.stopPropagation(),this.hideNotification(!0,!0),this.notifying=!1;var t=this.model.get("cta_cmd"),i=this.model.get("cta_options");t&&0<t.length&&(this.model.save({ctaClicked:Date.now(),visible:!1},{silent:!0}),m.commandManager.execute(t,null,i))},secondaryTextClicked:function(e){e.stopPropagation(),this.model.get("secondary_hide")&&(this.hideNotification(!0,!0),this.notifying=!1);var t=this.model.get("secondary_cmd"),i=this.model.get("secondary_options");t&&0<t.length&&(this.model.save({secondaryClicked:Date.now()},{silent:!0}),m.commandManager.execute(t,null,i))}}),m.commands.NotificationShow=m.models.Command.extend({defaults:{id:"notification.show"},execute:function(e,t){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessage(e,t)},10)}}),m.commands.NotificationShowEnhanced=m.models.Command.extend({defaults:{id:"notification.show.enhanced"},execute:function(e,t,i){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessageEnhanced(e,t,i)},10)}}),m.commands.NotificationDismiss=m.models.Command.extend({defaults:{id:"notification.dismiss"},execute:function(){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.dismissMessage()},5)}}),m.views.BookmarksPrimer=Backbone.View.extend({template:m.templates.bookmarks.primer,attributes:{class:"overlay overlay-permissions"},events:{"click a":"handleClick"},initialize:function(e){this.callback=e.callback,this.permissions=e.permissions},render:function(){var t=m.models.bookmarksSettings;this.browser=getBrowserName(),this.$el.html(this.template(this));var i=$("body");i.addClass("blur"),this.$el.remove(),this.$el.appendTo("body").addClass("show");var s=this;return setTimeout(function(){s.$el.addClass("show-animate")},2),getBrowser().permissions.request(s.permissions,function(e){i.removeClass("blur"),s.$el.removeClass("show-animate"),setTimeout(function(){s.$el.removeClass("show")},500),e?(t.set("allowed",!0),s.callback()):(t.set("allowed",!1),t.optionsChanged())}),this}}),m.views.Bookmarks=Backbone.View.extend({attributes:{id:"bookmarks",class:"bookmarks"},template:m.templates.bookmarks.bookmarks,offline:!0,initialFetchStarted:!1,events:{mousedown:"mouseDown","mousedown .bookmarks-guide":"guided"},initialize:function(e){this.time=(new Date).getTime(),this.listToggle=!0,this.bookmarkViews=[],this.permissions=m.models.bookmarksSettings.permissions,this.renderedOnce=!1,this.mostVisited=[],e.lateInit?this.render("late"):e.tempInit?this.render("late",!0):this.render();var t=this;this.listenTo(m.models.customization,"change:bookmarksVisible",this.visibleChanged),this.listenTo(m.models.bookmarksSettings,"change",this.optionsChanged),this.listenTo(m,"bookmarks:toggle",this.handleHotKey);var i=$(window);i.on("mouseup",function(e){t.mouseUp(e)}),i.on("mousemove",function(e){t.mouseMove(e)})},render:function(e,t){var i=(this.options.order||"append")+"To";this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.$el[i]("."+this.options.region).html(this.template());var s=this;return(t||m.models.customization.get("bookmarksVisible"))&&(null==getBrowser().topSites?(m.models.customization.save("bookmarksVisible",!1),localStorage.setItem("bookmarksEnabled",!1)):e&&"late"==e?(s.$el.addClass("animating"),this.showPopup(!0,!0)):($("body").addClass("has-bookmarks"),this.showPopup(!0,!1),setTimeout(function(){s.$el.addClass("animating")},500))),this.renderedOnce=!0,this},destroy:function(){this.remove(),this.unbind()},optionsChanged:function(e){this.resetView=!0,e&&null!=e.changed.defaultMostVisited&&this.doFetchIfNeeded()},visibleChanged:function(e){this.toggleShow(m.models.customization.get("bookmarksVisible"))},doFetchIfNeeded:function(){this.initialFetchStarted?this.resetView&&(this.resetView=!1,this.loadBookmarks(0,!0,!0)):this.doFetch()},doFetch:function(){this.initialFetchStarted=!0,this.bookmarkViews&&_.each(this.bookmarkViews,function(e){e&&e.destroy()}),this.bookmarkViews=[];this.bookmarksAccess=!0,this.getBookmarks()},getBookmarks:function(e){this.loaded=!1,this.loadBookmarks(0,!0,!0,e)},guided:function(){this.$el.find(".bookmarks-guide").removeClass("active")},loadBookmarks:function(i,s,o,e){var n=this,a=function(e){n.bookmarks=e[0].children[0].children,n.otherBookmarks=e[0].children[1].children};if(!this.bookmarks||s){n.mostVisited.length=0;var t=localStorage.getItem("bookmarks_mostVisited");null!=t&&0<t.length&&n.mostVisited.push.apply(n.mostVisited,JSON.parse(t));var l=localStorage.getItem("bookmarks_tree");null!=l&&0<l.length&&(a(JSON.parse(l)),n.showChildren(i,s,o)),getBrowser().topSites.get(function(e){var t=JSON.stringify(e);t!=localStorage.getItem("bookmarks_mostVisited")&&(n.mostVisited.length=0,n.mostVisited.push.apply(n.mostVisited,e),localStorage.setItem("bookmarks_mostVisited",t))}),getBrowser().bookmarks.getTree(function(e){var t=JSON.stringify(e);t!=localStorage.getItem("bookmarks_tree")&&(localStorage.setItem("bookmarks_tree",t),a(e),n.showChildren(i,s,o))})}else n.showChildren(i,!1,o)},getNewList:function(e){var t;(new Date).getTime();return this.listToggle=!this.listToggle,this.listToggle?(this.currentList=t=this.$el.find("#active-bookmarks"),this.oldList=this.$el.find("#active-bookmarks-alt")):(this.currentList=t=this.$el.find("#active-bookmarks-alt"),this.oldList=this.$el.find("#active-bookmarks")),t.html(""),t.css({"z-index":100,left:e+"px",opacity:1}),t},listLoaded:function(e){var t=this;this.oldList.addClass("bookmarks-hide-transition"),setTimeout(function(){t.oldList.css({"z-index":90,opacity:0}),t.currentList.css({transform:"translateX("+-1*e+"px)"})},5),setTimeout(function(){t.oldList.removeClass("bookmarks-hide-transition"),t.oldList.css({transform:"none"})},105),setTimeout(function(){var i=0;t.currentList.children().each(function(e,t){i+=$(t).width()}),i>t.$el.find(".bookmarks-wrapper").width()&&!m.models.bookmarksSettings.get("guided")&&setTimeout(function(){t.$el.find(".bookmarks-guide").addClass("active"),m.models.bookmarksSettings.set("guided",!0),m.models.bookmarksSettings.optionsChanged()},5)},400)},showChildren:function(e,t,i){var s=this,o=this.getNewList(e);if(!s.loaded||t){s.bookmarkViews=[];var n=s.addFolder({title:"Most Visited",momo_id:"mostVisited",children:s.mostVisited});if(m.models.bookmarksSettings.get("defaultMostVisited")&&i)return n.handleClick(null,!0),void(s.loaded=!1);isChrome()&&(s.addOne({url:"chrome-search://local-ntp/local-ntp.html",local:!0,title:"Chrome Tab",momo_id:"chromeTab",img:"img/icon-chrome.svg"}),s.addOne({url:"chrome://apps",local:!0,title:"Apps",momo_id:"apps"}),s.addOne({url:"chrome://bookmarks",local:!0,title:"Bookmarks",momo_id:"bookmarks"})),s.bookmarks.forEach(function(e){e.children?s.addFolder(e):s.addOne(e)}),s.addFolder({title:"Other",momo_id:"other",children:s.otherBookmarks}),s.loaded=!0}setTimeout(function(){s.bookmarkViews.forEach(function(e){o.append(e.render().$el),e.delegateEvents()})},1),s.listLoaded(e)},showAdd:function(e){e.preventDefault(),e.stopPropagation(),this.$el.find("#bookmarks-new-title").val(""),this.$el.find("#bookmarks-new-url").val(""),this.$el.find(".add").addClass("active"),this.$el.find(".bookmarks-new").toggle().find("#bookmarks-new-title").focus()},inputsClicked:function(e){e.stopPropagation()},addOne:function(e){var t=new m.views.Bookmark({model:new m.models.Bookmark(e),parent:this,bookmarksView:this});this.bookmarkViews.push(t)},addFolder:function(e){var t=new m.views.BookmarkFolder({model:new m.models.BookmarkFolder(e),parent:this,bookmarksView:this,root:this,zIndex:21});return this.bookmarkViews.push(t),t},toggleShow:function(e){0==e||!e&&this.$el.hasClass("show")?this.hidePopup():this.showPopup(!0,!0),setTimeout(function(){m.trigger("todolist:updateHeight")},20)},showPopup:function(e,t){this.showing=!0;var i=$("body");t&&i.addClass("has-bookmarks-animating");var s=this;setTimeout(function(){s.$el.addClass("show"),i.addClass("has-bookmarks"),setTimeout(function(){i.removeClass("has-bookmarks-animating")},500)},3),e&&this.doFetchIfNeeded()},hidePopup:function(e){if(this.showing=!1,this.$el.hasClass("show")){var t=this,i=$("body");i.addClass("has-bookmarks-animating"),setTimeout(function(){t.$el.removeClass("show"),i.removeClass("has-bookmarks"),setTimeout(function(){i.removeClass("has-bookmarks-animating")},500)},3)}},mouseUp:function(e){if(!this.isDragging(e))return this.dragStarted=!1,void(this.dragging=!1);e.preventDefault(),e.stopPropagation();var t=this;setTimeout(function(){t.dragging=!1,t.dragStarted=!1},20)},mouseDown:function(e){var t=this.currentList;this.lastMouseX=e.originalEvent.pageX,this.originalScroll=t.scrollLeft(),this.dragStarted=!0},mouseMove:function(e){if(this.dragStarted){document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),this.dragging=!0;var t=this.currentList,i=this.originalScroll+(this.lastMouseX-e.originalEvent.pageX);t.scrollLeft(i)}else this.dragging=!1},isDragging:function(e){return this.dragging&&10<Math.abs(this.lastMouseX-e.originalEvent.pageX)},handleHotKey:function(){var t=this;getBrowser().permissions.contains(this.permissions,function(e){e&&t.toggleShow(!t.showing)})}}),m.bootstrappers.RenderBookmarks=function(i,e){i.conditionalFeatures.checkFeatureAndMigrateData("serverlinks","bookmarksVisible","momentum-bookmarks",function(e){if(i.stopListening(i.models.customization,"change:bookmarksVisible"),!i.views.bookmarks&&i.models.customization.get("bookmarksVisible")){var t={region:"top-bar",order:"prepend"};e&&(t.lateInit=!0),i.collect.quicklinks=new i.collect.QuickLinks,i.views.bookmarks=new i.views.Bookmarks(t),i.widgets.push(i.views.bookmarks)}},function(e){if(i.stopListening(i.models.customization,"change:bookmarksVisible"),!i.views.bookmarks){var t={region:"top-bar",order:"prepend"};e&&(t.lateInit=!0),i.collect.quicklinks=new i.collect.QuickLinks,i.views.bookmarks=new i.views.Bookmarks(t),i.widgets.push(i.views.bookmarks)}},function(e){i.listenToOnce(i,"bookmarks:toggle",function(){i.stopListening(i.models.customization,"change:bookmarksVisible"),i.views.bookmarks||(i.views.bookmarks=new i.views.Bookmarks({region:"top-bar",order:"prepend",tempInit:!0}),i.widgets.push(i.views.bookmarks))}),i.listenTo(i.models.customization,"change:bookmarksVisible",e)})},m.views.Bookmark=Backbone.View.extend({tagName:"li",template:m.templates.bookmarks.bookmark,events:{"click a":"handleClick"},destroy:function(){this.remove(),this.unbind()},initialize:function(e){var t=this;this.parent=e.parent,this.bookmarksView=e.bookmarksView,setTimeout(function(){t.listenTo(t.model,"change",t.render),t.listenTo(t.model,"change:archive destroy",t.remove),t.listenTo(m.models.bookmarksSettings,"change:iconsOnly",t.render),t.listenTo(m.models.bookmarksSettings,"change:appsLocation",t.checkInclusion),t.listenTo(m.models.bookmarksSettings,"change:chromeTabLocation",t.checkInclusion),t.listenTo(m.models.bookmarksSettings,"change:includeBookmarks",t.checkInclusion)},1)},checkInclusion:function(){var e=m.models.bookmarksSettings;"apps"==this.model.get("momo_id")?this.$el.toggleClass("hidden","bookmarks"!=e.get("appsLocation")):"chromeTab"==this.model.get("momo_id")?this.$el.toggleClass("hidden","bookmarks"!=e.get("chromeTabLocation")):"bookmarks"==this.model.get("momo_id")&&this.$el.toggleClass("hidden",!e.get("includeBookmarks"))},render:function(){var e=this,t=m.utils.captionFormatter(this.model.get("title")),i=t;m.models.bookmarksSettings.get("iconsOnly")&&(i="");var s=this.model.get("url"),o=this.model.get("local"),n=new Image;this.model.get("img")?(n.src=this.model.get("img"),this.model.get("class")&&this.$el.addClass(this.model.get("class"))):isChrome()?n.src="chrome://favicon/size/16@2x/"+s:n.src=getFavIcon(s);var a={tooltip:t,title:i,url:s,local:o};return e.$el.html(e.template(a)),n.onload=function(){a.favicon_url=n.src,e.$el.html(e.template(a))},this.checkInclusion(),e},handleClick:function(e){return e.preventDefault(),this.bookmarksView.isDragging(e)||(m.models.bookmarksSettings.get("openInNewTab")||e.metaKey?getBrowser().tabs.create({url:e.currentTarget.href}):getBrowser().tabs.update({url:e.currentTarget.href})),!1},updateOnEnter:function(e){13==e.keyCode&&this.close($(e.currentTarget).data("field"))}}),m.views.BookmarkFolder=Backbone.View.extend({tagName:"li",template:m.templates.bookmarks.bookmarkfolder,events:{"keypress .todo-input":"updateOnEnter"},destroy:function(){this.remove(),this.unbind()},initialize:function(e){var t=this;this.bookmarkViews=[],this.parent=e.parent,this.bookmarksView=e.bookmarksView,this.root=e.root,this.zIndex=e.zIndex,this.parentFolder=e.parentFolder,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change:archive destroy",this.remove),this.mainClickHandler=function(e){t.handleClick(e)},this.backClickHandler=function(e){t.handleBack(e)},this.listenTo(m.models.bookmarksSettings,"change:iconsOnly",this.render),this.listenTo(m.models.bookmarksSettings,"change:includeMostVisited",this.checkInclusion),this.listenTo(m.models.bookmarksSettings,"change:includeOtherBookmarks",this.checkInclusion)},render:function(){var e=this,t=m.utils.captionFormatter(this.model.get("title")),i=t,s=i.substring(0,1);m.models.bookmarksSettings.get("iconsOnly")&&(i=""),this.$el.css({zIndex:this.zIndex});var o={tooltip:t,title:i,label:s};return e.$el.html(e.template(o)),$(e.$el.find(".main-button")[0]).on("mouseup",e.mainClickHandler),this.checkInclusion(),e},checkInclusion:function(){var e=m.models.bookmarksSettings;"mostVisited"==this.model.get("momo_id")?this.$el.toggleClass("hidden",!e.get("includeMostVisited")):"other"==this.model.get("momo_id")&&this.$el.toggleClass("hidden",!e.get("includeOtherBookmarks"))},addFolder:function(e){var t=new m.views.BookmarkFolder({model:new m.models.BookmarkFolder(e),parent:this,bookmarksView:this.bookmarksView,root:this.root,zIndex:this.zIndex+1});this.bookmarkViews.push(t)},addOne:function(e){var t=new m.views.Bookmark({model:new m.models.Bookmark(e),bookmarksView:this.bookmarksView,parent:this});this.bookmarkViews.push(t)},handleBack:function(e){if(!this.isOpen)return!0;e.preventDefault(),e.stopPropagation(),this.isOpen=!1;return this.parent.loadBookmarks(-1*this.offset),!1},handleClick:function(e,t){if(this.isOpen||this.bookmarksView.isDragging(e))return!0;e&&2==e.which?this.model.get("children").forEach(function(e){e.url&&getBrowser().tabs.create({url:e.url,active:!1})}):(this.isOpen=!0,$(this.$el.find(".main-button")[0]).off("click",this.mainClickHandler),this.offset=this.$el.offset().left,this.loadBookmarks(t?0:this.offset))},loadBookmarks:function(e){var t=this;this.loaded||(this.bookmarkViews=[],this.model.get("children").forEach(function(e){e.children?t.addFolder(e):t.addOne(e)}),this.loaded=!0);var i=this.bookmarksView.getNewList(e);setTimeout(function(){i.append('<li><a href="#" class="bookmark bookmark-back-button active"><i class="icon icon-left"></i><span class="bookmark-label">'+t.model.get("title")+'</span>\x3c!--<span class="bookmark-icon bookmark-icon-hide">✕</span>--\x3e</a></li>'),$(".bookmark-back-button").on("click",t.backClickHandler),t.bookmarkViews.forEach(function(e){i.append(e.render().$el)}),t.bookmarksView.listLoaded(e)},5)}}),m.models.Bookmark=Backbone.Model.extend({defaults:function(){return{title:"New Link",url:"",id:0,parentId:0,index:0,local:!1}},saveOptions:function(){return this.collection.saveOptions},saveNewOrder:function(e){this.save({index:e},this.saveOptions())},comparator:"index"}),m.models.BookmarkFolder=Backbone.Model.extend({defaults:function(){return{title:"New Folder",id:0,parentId:0,children:[],index:0}},saveOptions:function(){return this.collection.saveOptions},saveNewOrder:function(e){this.save({index:e},this.saveOptions())},comparator:"index"}),m.models.QuickLinks=Backbone.Model.extend({defaults:function(){return{title:"New Link",url:"",local:!1,order:0}},saveOptions:function(){return this.collection.saveOptions},saveNewOrder:function(e){this.save({order:e},this.saveOptions())},comparator:"order"}),m.collect.QuickLinksBase=Backbone.Collection.extend({model:m.models.QuickLinks,initialize:function(){this.listenTo(this,"reorder",this.reorderItem)},saveOptions:{},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",reorderItem:function(e){}}),m.collect.QuickLinks=m.collect.QuickLinksBase.extend({url:m.globals.urlRoot+"links",saveOptions:{patch:!0},reorderItem:function(e){var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"links"}).done(function(e){}).fail(function(e,t){})}}),m.collect.QuickLinksLegacy=m.collect.QuickLinksBase.extend({localStorage:new Backbone.LocalStorage("momentum-quicklinks"),isLegacy:!0,fetch:function(e){return Backbone.Collection.prototype.fetch.call(this,e)},createOrderGaps:function(){var t=100;this.each(function(e){e.save({order:t},{silent:!0}),t+=100})},reorderItem:function(e){var t=this.get(e.move_id),i=this.get(e.move_target_id),s=0<e.move_offset?1:-1,o=this.indexOf(i),n=1;if(0<=o+s&&o+s<this.length){var a=this.at(o+s);(n=Math.abs(a.get("order")-i.get("order")))<=20&&(this.createOrderGaps(),n=Math.abs(a.get("order")-i.get("order")))}var l=i.get("order")+Math.ceil(n/2)*s;t.save({order:l},{silent:!0})}}),m.views.QuickLinks=Backbone.View.extend({attributes:{id:"quicklinks",class:"app-container links"},template:m.templates.quicklinks["quicklinks-template"],offline:!0,initialFetchStarted:!1,events:{"click .toggle":"toggleShow","click a":"handleClick","keypress #new-title":"createLink","keypress #new-url":"createLink","click .new-toggle":"showAdd","click .new-hide":"hideAdd","click .retry":"retryConnection","click .retry-add":"retryAdd","click .new":"inputsClicked",dragover:"dragover",dragend:"dragend",drop:"drop"},initialize:function(){this.subViews=[],_.bindAll(this,"addOne","addAll","dragover","dragend","li_index"),this.renderedOnce=!1,this.render(),this.listenTo(m,"globalEvent:click globalEvent:esc",this.hidePopup),this.listenTo(m,"globalEvent:toggleQuickLinks",this.toggleShow),this.listenTo(this.collection,"remove",this.checkOptionalLinks),this.listenTo(this.collection,"add",this.added),this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:linksVisible",this.visibleChanged),this.listenTo(m.models.bookmarksSettings,"change:linksKeepOpen",this.keepOpenChanged),this.listenTo(m.models.bookmarksSettings,"change:appsLocation",this.checkOptionalLinks),this.listenTo(m.models.bookmarksSettings,"change:chromeTabLocation",this.checkOptionalLinks),(this.collection.isLegacy||m.conditionalFeatures.featureEnabled("prefetchlinks"))&&this.doFetchIfNeeded(),m.models.bookmarksSettings.get("linksKeepOpen")&&"false"!=localStorage.getItem("linksOpen")&&this.toggleShow();var t=this;null!=getBrowser().topSites?$.ajax({url:"chrome://favicon/size/16@2x/http://notfoundurl.com"}).done(function(e){t.notFoundIcon=e}):this.notFoundIcon=""},checkOptionalLinks:function(){var i=this;this.$el.find("li").removeClass("first-link"),this.$el.find(".optional-link").each(function(e,t){i.checkInclusion(t)}),this.$el.find(".optional-link.show").first().addClass("first-link"),0==this.$el.find(".first-link").length&&this.$el.find("li").not(".optional-link").not(".placeholder").first().addClass("first-link"),i.toggleEmptyState(i.checkEmpty())},checkEmpty:function(){return 0==this.$el.find(".optional-link.show").length&&0==this.collection.size()},toggleEmptyState:function(e){this.$el.toggleClass("is-empty",e),this.hideAdd()},checkInclusion:function(e){var t=m.models.bookmarksSettings,i=$(e);i.toggleClass("show",t.get(i.attr("data-momo-id")+"Location")==i.attr("data-place"))},render:function(){var e=(this.options.order||"append")+"To";this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.isChrome=isChrome(),this.$el[e]("."+this.options.region).mFadeIn().html(this.template(this)),this.$linkList=this.$(".links-list"),this.$connectionMessage=this.$(".message"),this.renderedOnce=!0;return this},destroy:function(){this.remove(),this.unbind()},keepOpenChanged:function(e){this.hidePopup()},visibleChanged:function(e){m.models.customization.get("linksVisible")?this.renderedOnce?this.$el.mFadeIn():this.render():this.$el.mFadeOut()},doFetch:function(){this.initialFetchStarted=!0,this.collection.fetch({reset:!0})},doFetchIfNeeded:function(){this.initialFetchStarted||this.doFetch()},collectionError:function(e,t,i){200!==t.status?this.failedConnection():this.successfulConnection()},showAdd:function(e){e.preventDefault(),e.stopPropagation();var t=this.$el.find(".new");t.is(":visible")||t.show(),$(e.target).hasClass("empty-toggle")&&$(e.target).css({opacity:0}),t.is(".open")||t.addClass("open"),this.$el.find(".new-title").attr("placeholder","Name").focus()},hideAdd:function(){this.$el.find(".new").removeClass("open"),this.$el.find(".new-title").val("").attr("placeholder","New Link"),this.$el.find(".new-url").val(""),this.checkEmpty()&&this.$el.find(".empty-toggle").css({opacity:1})},inputsClicked:function(e){e.stopPropagation()},retryConnection:function(e){e.preventDefault(),e.stopPropagation(),this.collection.fetch({reset:!0})},collectionReset:function(){this.addAll()},revealConnectionError:function(){this.$connectionMessage.mShow(),this.$el.addClass("show-message")},dismissConnectionError:function(){this.$connectionMessage.mHide(),this.$el.removeClass("show-message")},added:function(e){this.addOne(e),this.checkOptionalLinks()},addOne:function(e){var t=new m.views.QuickLink({model:e,parent:this,notFoundIcon:this.notFoundIcon});this.subViews.push(t),this.$linkList.append(t.render().$el)},addAll:function(){this.offline=!1,_.each(this.subViews,function(e){e&&e.destroy&&e.destroy()}),this.subViews=[],this.collection.each(this.addOne),this.successfulConnection(),this.checkOptionalLinks()},successfulConnection:function(){this.$el.find(".new").show(),this.dismissConnectionError()},failedConnection:function(e){var t=e?"retry-add":"retry";this.$connectionMessage.html('<span class="title">Trouble connecting…</span><span class="action '+t+'">Retry</span>'),this.revealConnectionError()},retryAdd:function(e){this.addLink()},createLink:function(e){13==e.keyCode&&this.addLink()},addLink:function(e){var t=this.$el.find("#new-title")[0].value,i=this.$el.find("#new-url")[0].value,s=this;if(!t)return this.$el.find("#new-title").addClass("pulse"),void _.delay(function(){s.$el.find("#new-title").removeClass("pulse")},1e3);if(!i)return this.$el.find("#new-url").addClass("pulse"),void _.delay(function(){s.$el.find("#new-url").removeClass("pulse")},1e3);if(this.offline)this.failedConnection(!0);else{var o=!1;/^chrome|chrome-extension|chrome-search:\/\//i.test(i)&&(o=!0),i=ensureUrlScheme(i),m.sendEvent("Quick Links","Add");var n=0;if(0<this.collection.length)n=this.collection.max(function(e){return e.get("order")}).get("order")+100;this.collection.create({title:t,url:i,local:o,order:n},{wait:!0,success:function(){s.successfulConnection(),s.$el.find(".new").addClass("open"),s.$el.find(".new input").val(""),s.$el.find(".new-title").attr("placeholder","Name").focus()},error:function(e,t,i){s.failedConnection(!0)}})}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),!(e.originalEvent.dataTransfer.dropEffect="move")},drop:function(e){e.preventDefault(),e.stopPropagation()},dragend:function(e){return e.originalEvent.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation(),"quicklink"==this.dragmode&&(this.dragging.$el.show(),this.$placeholder.hide(),this.collection.trigger("reorder",{move_id:this.dragging.model.id,move_target_id:this.move_target_id,move_offset:this.move_offset})),this.checkOptionalLinks(),!1},toggleShow:function(e){this.$el.hasClass("show")?this.forceHidePopup():this.showPopup(),this.doFetchIfNeeded(),this.setMaxWidgetHeight()},showPopup:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in"),localStorage.setItem("linksOpen",!0)},forceHidePopup:function(){var t=this;this.hideAdd(),this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")}),localStorage.setItem("linksOpen",!1)},hidePopup:function(e){e!=this&&(e&&e.originalEvent&&"click"==e.type&&e.target&&$.contains(this.$el[0],e.target)||(this.$el.find(".new").is(".open")?this.hideAdd():this.$el.hasClass("show")&&!m.models.bookmarksSettings.get("linksKeepOpen")&&this.forceHidePopup()))},handleClick:function(e){e.stopPropagation(),e.preventDefault();var t=e.currentTarget.href;m.models.bookmarksSettings.get("openInNewTab")||e.metaKey?getBrowser().tabs.create({url:t}):getBrowser().tabs.update({url:t})},li_index:function(e){return this.$("li").index(e)},urlInvalid:function(){var e=this;this.$el.find("#new-url").addClass("pulse"),_.delay(function(){e.$el.find("#new-url").removeClass("pulse")},1e3)},setMaxWidgetHeight:function(){var e=$(window).height()-125;this.$(".app").css("max-height",e)}}),m.views.QuickLink=Backbone.View.extend({tagName:"li",template:m.templates.quicklinks["quicklinks-item-template"],events:{"keypress .todo-input":"updateOnEnter","click .destroy":"delete",dragstart:"dragstart",dragenter:"dragenter","click a":"handleClick"},initialize:function(e){_.bindAll(this,"dragstart","dragenter"),this.parent=e.parent,this.notFoundIcon=e.notFoundIcon,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change:archive destroy",this.remove)},render:function(){var i=this,s=this.model.get("url"),o=new Image,n=getFavIcon(s);return this.loadLink(!1),isChrome()?getBrowser().permissions.contains(m.models.bookmarksSettings.permissions,function(e){if(e){var t="chrome://favicon/size/16@2x/"+s;$.ajax({url:t}).done(function(e){e==i.notFoundIcon?o.src=n:i.loadLink(t)})}else o.src=n}):o.src=n,o.onload=function(){i.loadLink(n)},i},loadLink:function(e){var t={title:m.utils.captionFormatter(this.model.get("title")),url:this.model.get("url"),local:this.model.get("local"),favicon_url:e};this.$el.html(this.template(t)),this.$el.prop("draggable","true")},delete:function(e){e.stopPropagation(),m.sendEvent("Quick Links","Delete"),this.model.destroy()},destroy:function(){this.remove(),this.unbind()},dragstart:function(e){e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text","dummy"),this.parent.dragmode="quicklink",this.parent.dragging=this},dragenter:function(e){if("quicklink"==this.parent.dragmode){this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;this.parent.$placeholder.css("display","list-item"),t.height(this.$el.height()),t.after(this.parent.dragging.$el)}},handleClick:function(e){e.stopPropagation(),e.preventDefault(),m.models.bookmarksSettings.get("openInNewTab")||e.metaKey?getBrowser().tabs.create({url:e.currentTarget.href}):getBrowser().tabs.update({url:e.currentTarget.href})},updateOnEnter:function(e){13==e.keyCode&&this.close($(e.currentTarget).data("field"))}}),m.bootstrappers.RenderQuickLinks=function(t,e){t.conditionalFeatures.checkFeatureAndMigrateData("serverlinks","linksVisible","momentum-quicklinks",function(){t.models.customization.get("linksVisible")&&(t.collect.quicklinks=new t.collect.QuickLinks,t.views.quicklinks=new t.views.QuickLinks({collection:t.collect.quicklinks,region:"top-left",order:"prepend"}),t.widgets.push(t.views.quicklinks),t.stopListening(t.models.customization,"change:linksVisible"))},function(){t.models.customization.get("linksVisible")&&(t.collect.quicklinks=new t.collect.QuickLinksLegacy,t.views.quicklinks=new t.views.QuickLinks({collection:t.collect.quicklinks,region:"top-left",order:"prepend"}),t.widgets.push(t.views.quicklinks),t.stopListening(t.models.customization,"change:linksVisible"))},function(e){t.listenTo(t.models.customization,"change:linksVisible",e)})},m.views.DashLinks=Backbone.View.extend({attributes:{id:"dashlinks",class:"app-container links dashlinks"},template:m.templates.quicklinks.dashlinks,events:{"click .toggle-icon":"handleClick"},initialize:function(){this.listenTo(m.models.bookmarksSettings,"change:appsLocation",this.checkOptionalLinks),this.listenTo(m.models.bookmarksSettings,"change:chromeTabLocation",this.checkOptionalLinks),this.render()},checkInclusion:function(e){var t=m.models.bookmarksSettings,i=$(e);i.toggleClass("show",t.get(i.attr("data-momo-id")+"Location")==i.attr("data-place"))},checkOptionalLinks:function(){var i=this;this.$(".optional-link").each(function(e,t){i.checkInclusion(t)})},render:function(){if(!isChrome())return this;var i=this,e=(this.options.order||"append")+"To";return this.$el[e]("."+this.options.region).html(this.template()).fadeTo(500,1),this.$(".optional-link").each(function(e,t){i.checkInclusion(t)}),this},handleClick:function(e){e.stopPropagation(),e.preventDefault();var t=e.currentTarget.dataset.url||e.currentTarget.href;m.models.bookmarksSettings.get("openInNewTab")||e.metaKey?getBrowser().tabs.create({url:t}):getBrowser().tabs.update({url:t})}}),m.bootstrappers.RenderDashLinks=function(e,t){e.views.dashlinks=new e.views.DashLinks({region:"top-left",order:"prepend"}),e.widgets.push(e.views.dashlinks)},m.models.PersistentSettings=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("momentum-customization"),defaults:{bookmarksVisible:!1,linksVisible:!0,focusVisible:!0,todoVisible:!0,weatherVisible:!0,quoteVisible:!0,searchVisible:!1,requestSync:!1,keepTodoState:!0,countdownVisible:!1,notesVisible:!1,percentClock:!1,multiClockVisible:!0,themeColour:"dark",autoFocus:!1,balanceModeStr:"",bookmarksSettingsStr:""},initialize:function(){var t=this;t.fetching=!1,window.addEventListener("storage",function(e){e.key&&0===e.key.indexOf("momentum-customization-1")&&(t.fetching=!0,t.fetch({success:function(){t.fetching=!1},error:function(){t.fetching=!1},reset:!0}))})}}),m.models.Settings=Backbone.Model.extend({defaults:{},initialize:function(){}}),m.models.GenericSettings=Backbone.Model.extend({initialize:function(e){this.url=m.globals.urlRoot+e},save:function(e,t){(t=t||{}).patch=!0,Backbone.Model.prototype.save.call(this,e,t)},toggle:function(e){var t={};this.has(e)?t[e]=!this.get(e):t[e]=!0,this.save(t)}}),m.models.BalanceMode=Backbone.Model.extend({defaults:{enabled:!1,active:!1,balanceClock:!1,balanceTodo:!1,balanceFocus:!0,balanceNotes:!1,customTime:!1,customDays:!1,start:{hour:9,minute:"00",noon:"AM"},end:{hour:5,minute:"00",noon:"PM"},startCustom:{hour:9,minute:"00",noon:"AM"},endCustom:{hour:5,minute:"00",noon:"PM"},days:[!1,!0,!0,!0,!0,!0,!1],daysCustom:[!1,!0,!0,!0,!0,!0,!1]},initialize:function(e,t){this.customization=t.customization||m.models.customization,this.listenTo(this.customization,"change:balanceModeStr",this.customizationChanged),this.listenTo(this,"change:enabled",this.balanceChanged),this.listenTo(m.models.date,"change:date",this.checkBalance)},checkBalance:function(){var e=new Date,t=this.getStart(),i=this.getEnd(),s=this.getDays(),o=t.hour+":"+t.minute+t.noon,n=i.hour+":"+i.minute+i.noon,a=this.get("active"),l=m.utils.toTodaysTime(n),r=m.utils.toTodaysTime(o),d=new Date(r.getTime());d.setDate(r.getDate()-1);var c=new Date(l.getTime());c.setDate(l.getDate()+1),this.set("active",this.get("enabled")&&(!s[e.getDay()]||l.getTime()>r.getTime()&&(r.getTime()>e.getTime()||e.getTime()>l.getTime())||l.getTime()<r.getTime()&&!(d.getTime()<e.getTime()&&e.getTime()<l.getTime()||r.getTime()<e.getTime()&&e.getTime()<c.getTime()))),a!=this.get("active")&&this.balanceChanged()},customizationChanged:function(e,t){var i=this.customization.get("balanceModeStr");i&&i!=this.balanceModeStr&&0<i.length&&this.resetBalanceMode()},resetBalanceMode:function(){if(this.balanceModeStr=this.customization.get("balanceModeStr"),this.balanceModeStr&&0<this.balanceModeStr.length){var e=JSON.parse(this.balanceModeStr);this.set("enabled",void 0===e.enabled?this.defaults.enabled:e.enabled),this.set("start",e.start||this.defaults.start),this.set("end",e.end||this.defaults.end),this.set("days",e.days||this.defaults.days),this.set("customDays",void 0===e.customDays?this.defaults.customDays:e.customDays),this.set("customTime",void 0===e.customTime?this.defaults.customTime:e.customTime),this.set("startCustom",e.startCustom||this.defaults.startCustom),this.set("endCustom",e.endCustom||this.defaults.endCustom),this.set("daysCustom",e.daysCustom||this.defaults.daysCustom),this.set("balanceClock",void 0===e.balanceClock?this.defaults.balanceClock:e.balanceClock),this.set("balanceFocus",void 0===e.balanceFocus?this.defaults.balanceFocus:e.balanceFocus),this.set("balanceTodo",void 0===e.balanceTodo?this.defaults.balanceTodo:e.balanceTodo),this.set("balanceNotes",void 0===e.balanceNotes?this.defaults.balanceNotes:e.balanceNotes),this.initCompleted=!0,this.checkBalance()}},getDays:function(){return this.get("customDays")?this.get("daysCustom"):this.get("days")},getStart:function(){return this.get("customTime")?this.get("startCustom"):this.get("start")},getEnd:function(){return this.get("customTime")?this.get("endCustom"):this.get("end")},get:function(e){return!!("customDays"!=e&&"customTime"!=e||m.conditionalFeatures.featureEnabled("plus"))&&Backbone.Model.prototype.get.call(this,e)},balanceChanged:function(){this.initCompleted&&this.customization.save({balanceModeStr:JSON.stringify(this.attributes)})}}),m.models.BookmarksSettings=Backbone.Model.extend({defaults:{guided:!1,linksKeepOpen:!1,iconsOnly:!1,openInNewTab:!1,appsLocation:"links",includeBookmarks:!1,includeOtherBookmarks:!1,defaultMostVisited:!1,includeMostVisited:!0,chromeTabLocation:"links"},initialize:function(){this.listenTo(m.models.customization,"change:bookmarksSettingsStr",this.customizationChanged),this.permissions={permissions:["bookmarks","topSites"]},isChrome()&&(this.permissions.origins=["chrome://favicon/"])},customizationChanged:function(e,t){var i=m.models.customization.get("bookmarksSettingsStr");i&&i!=this.bookmarksSettingsStr&&0<i.length&&this.reset()},reset:function(){this.bookmarksSettingsStr=m.models.customization.get("bookmarksSettingsStr");if(this.bookmarksSettingsStr&&0<this.bookmarksSettingsStr.length){var t=JSON.parse(this.bookmarksSettingsStr),i=this;["linksKeepOpen","iconsOnly","openInNewTab","appsLocation","includeBookmarks","includeOtherBookmarks","defaultMostVisited","includeMostVisited","chromeTabLocation","guided"].forEach(function(e){i.set(e,null==t[e]?i.defaults[e]:t[e])}),localStorage.setItem("bookmarksEnabled",m.models.customization.get("bookmarksVisible")),setTimeout(function(){initializeBookmarksPlaceHolder()},500)}},optionsChanged:function(){m.models.customization.save({bookmarksSettingsStr:JSON.stringify(this.attributes)})}}),m.models.ComputedSettings=Backbone.Model.extend({defaults:{todoVisible:!1,focusVisible:!1,autoFocus:!1,clockVisible:!1,notesVisible:!1},initializeSettings:function(e){var t=this;this.persistentSettings=new m.models.PersistentSettings({id:1}),this.listenTo(this.persistentSettings,"change",this.computeProperties),this.listenTo(this.persistentSettings,"sync",function(){var e=t.persistentSettings.get("balanceModeStr");e&&0<e.length&&(m.models.balanceMode.resetBalanceMode(),t.computeProperties()),t.initialized||(t.initialized=!0,t.trigger("initialized"))}),m.conditionalFeatures=new m.models.ConditionalFeatures({customization:this}),m.models.balanceMode=this.balanceMode=new m.models.BalanceMode({id:1},{customization:this}),m.models.bookmarksSettings=new m.models.BookmarksSettings({id:1}),this.persistentSettings.fetch({error:function(e,t,i){"Record Not Found"==t&&e.save()}})},checkBalanceMode:function(e,t,i){var s=this.attributes[e],o=!!i||(!this.persistentSettings.has(e)||this.persistentSettings.get(e));this.attributes[e]=o&&!(m.models.balanceMode.get("active")&&m.models.balanceMode.get(t)),s!=this.attributes[e]&&this.trigger("change:"+e)},checkAutoFocus:function(){var e="autoFocus",t=this.attributes[e];return this.attributes[e]=this.persistentSettings.get(e)&&this.persistentSettings.get("todoVisible")&&m.conditionalFeatures.featureEnabled("plus"),this.attributes[e]=this.persistentSettings.get(e)&&this.persistentSettings.get("todoVisible")&&m.conditionalFeatures.featureEnabled("plus"),t!=this.attributes[e]},computeProperties:function(t,i,s){var o=this;this.checkBalanceMode("todoVisible","balanceTodo"),this.checkBalanceMode("clockVisible","balanceClock",!0),this.checkBalanceMode("focusVisible","balanceFocus"),this.checkBalanceMode("notesVisible","balanceNotes");var e=this.persistentSettings.changedAttributes();e||(e={}),this.checkAutoFocus()&&!e.autoFocus&&(e.autoFocus=this.attributes.autoFocus),_.keys(e).forEach(function(e){o.trigger("change:"+e,t,i,s)}),this.trigger("change",t,i,s)},get:function(e){return this.persistentSettings.get(e)},getPersistentSettings:function(){return this.persistentSettings},getComputedSetting:function(e){return null!=this.attributes[e]?Backbone.Model.prototype.get.call(this,e):this.persistentSettings.get(e)},set:function(){arguments[0].id?Backbone.Model.prototype.set.apply(this,arguments):this.persistentSettings.set.apply(this.persistentSettings,arguments)},save:function(){this.persistentSettings.save.apply(this.persistentSettings,arguments)},fetch:function(){this.persistentSettings.fetch.apply(this.persistentSettings,arguments)},toggle:function(e){if(e){var t=!this.get(e),i={};i[e]=t,this.save(i)}}}),m.collect.Settings=Backbone.Collection.extend({model:m.models.Settings,saveOptions:{patch:!0},initialize:function(){}}),m.collect.TodoSettings=m.collect.Settings.extend({model:m.models.Settings,allowReorder:!1,saveOptions:{patch:!0},url:m.globals.urlRoot+"settings/todo/providers/1/lists",comparator:"order",initialize:function(){this.listenTo(this,"reorder",this.reorderItem)},nextOrder:function(){return this.length?this.last().get("order")+100:100},parse:function(e){return e.lists?(this.allowReorder=e.allow_reorder,e.lists):e},reorderItem:function(e){console.log(e);var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRoot+"settings/todo/providers/1/lists"}).done(function(e){m.trigger("globalEvent:resetLists")}).fail(function(e,t){console.log("failed"),m.trigger("globalEvent:resetLists")})}}),m.views.settings=m.views.settings||{},m.views.settings.panels=m.views.settings.panels||{},m.views.settings.SettingsPanel=Backbone.View.extend({initialize:function(){},render:function(){return this.$el.html(this.template({})),this},close:function(){this.remove(),this.unbind()}}),m.views.settings=m.views.settings||{},m.views.settings.MainSettings=Backbone.View.extend({attributes:{class:"app-wrapper nipple-bottom-left"},template:m.templates.settings.main,events:{"click .hide":"hideSettings"},detailsShown:!1,initialize:function(){this.subViews=[],this.renderedOnce=!1,this.visible=!1},render:function(){if(!this.visible)return this;if(this.paneRendered||(this.$el.html(this.template()),this.$popup=this.$(".app-wrapper"),this.$container=this.$(".settings-view-container"),this.paneRendered=!0),!this.cssLoaded)return this;this.renderedOnce||(this.navMenu=new m.views.settings.NavMenu({el:this.$("#nav-menu")}),this.listenTo(this.navMenu,"navItemClicked",this.navItemClicked),this.renderedOnce=!0,this.visible||this.$el.hide());var e=this;return $(".settings-view-container").on("scroll",function(){e.handleScroll()}),this.renderActivePanel(),this},handleScroll:function(){handleStickySubnav(this.activePanel)},renderActivePanel:function(e){this.activePanel&&this.cssLoaded&&this.renderedOnce&&(this.activePanel.render(e).$el.detach().appendTo(this.$container),m.trigger("settings:panel:visible"))},navItemClicked:function(e){if(this.upsellView&&this.upsellView.hideUpsell(),e!=this.activePanelId){var t=this.getNavItem(e);t&&t.cmd&&t.cmdonly?(this.setActiveNavItem(e),m.commandManager.ensureCommandLoaded(t.cmd,function(){t.hide&&m.commandManager.execute("settings.hide"),m.commandManager.execute(t.cmd,t.options)},function(){},function(e){})):this.activateSection(e,{source:"nav-"+e})}},toggleVisible:function(){this.visible?this.hideSettings():this.showSettings()},showSettings:function(e){var t=this;if(!this.cssLoaded&&!this.cssLoading){this.cssLoading=!0;var i=$('<link type="text/css" href="css/settings.css" rel="stylesheet" />');i.load(function(){t.cssLoaded=!0,t.render(),t.showSection(e)}),$("head").append(i)}this.visible=!0,m.trigger("globalEvent:toggle:bottom-left",this),this.paneRendered&&this.renderedOnce||this.render(),m.trigger("settings:visible"),this.cssLoaded&&this.showSection(e),this.$el.show()},hideSettings:function(e){if(this.$el.is(":visible")){e&&e.preventDefault(),this.visible=!1,m.trigger("settings:hidden"),this.$popup.removeClass("show-fade-in");var t=this;setTimeout(function(){t.$popup.removeClass("show"),this.activePanel&&this.activePanel.close(),this.navMenu&&this.navMenu.closeUser()},200)}},showSection:function(e){e&&e.section?this.activateSection(e.section,e):this.activateSection(this.activePanelId&&"loading"!=this.activePanelId?this.activePanelId:"general")},getNavItem:function(e){var t=m.settingsManager.getNavItems(),i=_.findWhere(t.navItems,{id:e});return i||(i=_.findWhere(t.secondaryNavItems,{id:e})),i},getPanel:function(e){var t=m.settingsManager.getPanelItems();return _.findWhere(t,{id:e})},showLoadingPanel:function(e){this.loadingPanel||(this.loadingPanel=new m.views.settings.panels.Loading),"loading"!=this.activePanelId&&this.setActivePanel(this.loadingPanel,"loading",null),this.loadingPanel.setDisplayOptions(e),this.renderActivePanel()},setActivePanel:function(e,t,i){e&&(this.activePanel&&this.activePanel.close(),this.activePanel=e,this.activePanelId=t,this.activePanelOptions=i,this.$container.scrollTop(0))},setActiveNavItem:function(e){$(".main-nav-item").removeClass("active");var t=this.getNavItem(e);t||(t=this.getPanel(e)),t&&t.section?$('li[data-navitem="'+t.section+'"]').addClass("active"):$('li[data-navitem="'+e+'"]').addClass("active")},activateSection:function(t,i){var s=this;if(t){i&&i.nav?this.setActiveNavItem(i.nav):this.setActiveNavItem(t);var e=this.getNavItem(t);e||(e=this.getPanel(t));var o=null,n=!1,a=!1,l=!1;if(e&&e.cmd)m.commandManager.ensureCommandLoaded(e.cmd,function(){n=!0,o=m.commandManager.execute(e.cmd,i),s.setActivePanel(o,t,i),s.renderActivePanel(i)},function(){a||n||(a=!0,setTimeout(function(){l||n||s.showLoadingPanel()},400))},function(e){l=a=!0,s.showLoadingPanel({error:"We were unable to load settings.",retryInfo:{id:t,options:i}})});else{if(!(o=_.findWhere(this.subViews,{panelid:t}))){var r=t.charAt(0).toUpperCase()+t.slice(1),d=m.views.settings.panels[r];d&&(o=new d(i))}this.setActivePanel(o,t,i),this.renderActivePanel()}}},showUpsell:function(e){this.upsellView?(this.upsellView.options=e,this.upsellView.render()):(e.template=m.templates.settings.upsell,this.upsellView=new m.views.upsell.message(e),this.$el.find(".settings-view-container").prepend(this.upsellView.render().$el)),this.upsellView.show()}}),m.views.settings=m.views.settings||{},m.views.settings.ColorPicker=Backbone.View.extend({template:m.templates.settings["color-picker"],active:!1,attributes:{class:"color-picker"},events:{"click .swatch":"handleClick"},initialize:function(e,t,i){this.listenTo(m,"globalEvent:settingsclick",this.settingsClick),this.listenTo(m,"globalEvent:esc globalEvent:click globalEvent:toggle",this.dismiss),this.settingName=e,this.optionValue=t,this.options=i,this.options.ignoreClick&&delete this.events["click .swatch"]},render:function(){this.$el.html(this.template()),this.delegateEvents(),this.$swatch=this.$el.find(".swatch").first();var e=m.models.themeManager.getThemeColourRGBA(this.settingName);return this.$swatch.css({backgroundColor:e}),this.picker&&(this.$picker=this.picker.render().$el,this.$el.append(this.$picker)),this},scrollIntoViewElement:function(){return!!(this.$picker&&this.$picker.is(":visible")&&this.active)&&this.$picker.find(".cp-color-picker").first()[0]},settingsClick:function(e){if(!(0<$(e.target).closest(".cp-color-picker").length)){var t=$(e.currentTarget).data("option-value");t&&t==this.optionValue||this.dismiss()}},setActive:function(){this.active=!0},setInactive:function(){this.active=!1},dismiss:function(e){this.$picker&&(e&&e.target&&!$.contains(this.$picker[0],e.target)&&(this.$picker.hide(),this.$el.closest(".toggle-option").removeClass("color-picker-active")),this.$picker.is(":visible")&&m.models.themeManager.saveThemeColour())},ignoreClickEvent:function(e){return"swatch"!=e.className&&"color-picker"!=e.className},handleClick:function(e,t){if(this.active||t){e.stopPropagation();var s=this;if(this.picker)this.$picker&&(this.$picker.toggle(),this.$el.closest(".toggle-option").toggleClass("color-picker-active"),this.$picker.is(":visible")?(this.picker.setSizes(),this.picker.preRender(!0)):m.models.themeManager.saveThemeColour());else{var i={light:"#fff",dark:"#fff",renderCallback:function(e){if(e){var t=e.colors,i=m.models.themeManager.toRgbA(t);s.$swatch.css({backgroundColor:i,color:.22<t.RGBLuminance?"#222":"#ddd"}),m.models.themeManager.setColorValues(s.settingName,t)}}},o=m.models.themeManager.getThemeColourRGBA(this.settingName);o&&(i.color=o),this.picker=new m.views.settings.ColorPickerPopup(i),this.$picker=this.picker.render().$el,this.$el.closest(".toggle-option").toggleClass("color-picker-active"),this.$el.append(this.$picker),this.picker.setSizes(),this.picker.preRender(!0)}}},close:function(){m.models.themeManager.saveThemeColour(),this.dismiss()}}),m.views.settings=m.views.settings||{},m.views.settings.SettingsPane=Backbone.View.extend({attributes:{id:"settings",class:"app-container settings"},renderedOnce:!1,events:{"click .toggle":"toggleShow"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenTo(m,"globalEvent:esc globalEvent:click globalEvent:toggle",this.hideSettings),this.listenTo(m,"globalEvent:toggleSettings",this.toggleShow),this.listenTo(m,"settings:visible",this.settingsVisible),this.listenTo(m,"settings:hidden",this.settingsHidden)},render:function(){var e=this;if(!this.renderedOnce){var t=(this.options.order||"append")+"To";this.$el[t]("."+this.options.region).html('<span class="app-dash toggle"><svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340.274 340.274"><path d="M293.629 127.806l-5.795-13.739c19.846-44.856 18.53-46.189 14.676-50.08l-25.353-24.77-2.516-2.12h-2.937c-1.549 0-6.173 0-44.712 17.48l-14.184-5.719c-18.332-45.444-20.212-45.444-25.58-45.444h-35.765c-5.362 0-7.446-.006-24.448 45.606l-14.123 5.734C86.848 43.757 71.574 38.19 67.452 38.19l-3.381.105-27.27 26.737c-4.138 3.891-5.582 5.263 15.402 49.425l-5.774 13.691C0 146.097 0 147.838 0 153.33v35.068c0 5.501 0 7.44 46.585 24.127l5.773 13.667c-19.843 44.832-18.51 46.178-14.655 50.032l25.353 24.8 2.522 2.168h2.951c1.525 0 6.092 0 44.685-17.516l14.159 5.758c18.335 45.438 20.218 45.427 25.598 45.427h35.771c5.47 0 7.41 0 24.463-45.589l14.195-5.74c26.014 11 41.253 16.585 45.349 16.585l3.404-.096 27.479-26.901c3.909-3.945 5.278-5.309-15.589-49.288l5.734-13.702c46.496-17.967 46.496-19.853 46.496-25.221V151.88c-.005-5.519-.005-7.446-46.644-24.074zM170.128 228.474c-32.798 0-59.504-26.187-59.504-58.364 0-32.153 26.707-58.315 59.504-58.315 32.78 0 59.43 26.168 59.43 58.315-.006 32.177-26.656 58.364-59.43 58.364z" fill="#FFF"/></svg></span>'),this.renderedOnce=!0,m.views.settings.mainSettings=new m.views.settings.MainSettings,setTimeout(function(){e.$el.prepend(m.views.settings.mainSettings.$el)},100),this.$el.toggleClass("infinispin",m.settingsManager.infinispin())}return this},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),m.commandManager.execute("settings.toggle")},hideSettings:function(e){e!=this&&(e.originalEvent&&"click"==e.type&&e.target&&$.contains(m.views.settings.mainSettings.el,e.target)||m.commandManager.execute("settings.hide"))},settingsVisible:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in")},settingsHidden:function(e){if(e&&e.preventDefault(),this.$el.hasClass("show")){var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")})}}}),m.views.Gravatar=Backbone.View.extend({className:"avatar",tagName:"img",render:function(){var e=this.options.email,t=this.options.size,i=this.$el.attr({src:"https://www.gravatar.com/avatar/"+md5(e)+"?s="+t+"&d=mm"});return this.$el.html(i),this}}),m.views.settings.panels.About=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-about",class:"settings-view settings-about"},template:m.templates.settings.about,panelid:"about",events:{"dblclick #momo-version":"revealUuid","dblclick .about-logo":"logoDblClicked"},render:function(){var e={version:m.globals.version};return this.$el.html(this.template(e)),this},revealUuid:function(e){e.preventDefault(),e.stopPropagation(),this.$el.find(".made").html(localStorage.client_uuid)},logoDblClicked:function(e){e.stopPropagation(),$(".settings").first().toggleClass("infinispin",m.settingsManager.toggleInfinispin())}}),m.views.settings=m.views.settings||{},m.views.settings.ColorPicker=Backbone.View.extend({template:m.templates.settings["color-picker"],active:!1,attributes:{class:"color-picker"},events:{"click .swatch":"handleClick"},initialize:function(e,t,i){this.listenTo(m,"globalEvent:settingsclick",this.settingsClick),this.listenTo(m,"globalEvent:esc globalEvent:click globalEvent:toggle",this.dismiss),this.settingName=e,this.optionValue=t,this.options=i,this.options.ignoreClick&&delete this.events["click .swatch"]},render:function(){this.$el.html(this.template()),this.delegateEvents(),this.$swatch=this.$el.find(".swatch").first();var e=m.models.themeManager.getThemeColourRGBA(this.settingName);return this.$swatch.css({backgroundColor:e}),this.picker&&(this.$picker=this.picker.render().$el,this.$el.append(this.$picker)),this},scrollIntoViewElement:function(){return!!(this.$picker&&this.$picker.is(":visible")&&this.active)&&this.$picker.find(".cp-color-picker").first()[0]},settingsClick:function(e){if(!(0<$(e.target).closest(".cp-color-picker").length)){var t=$(e.currentTarget).data("option-value");t&&t==this.optionValue||this.dismiss()}},setActive:function(){this.active=!0},setInactive:function(){this.active=!1},dismiss:function(e){this.$picker&&(e&&e.target&&!$.contains(this.$picker[0],e.target)&&(this.$picker.hide(),this.$el.closest(".toggle-option").removeClass("color-picker-active")),this.$picker.is(":visible")&&m.models.themeManager.saveThemeColour())},ignoreClickEvent:function(e){return"swatch"!=e.className&&"color-picker"!=e.className},handleClick:function(e,t){if(this.active||t){e.stopPropagation();var s=this;if(this.picker)this.$picker&&(this.$picker.toggle(),this.$el.closest(".toggle-option").toggleClass("color-picker-active"),this.$picker.is(":visible")?(this.picker.setSizes(),this.picker.preRender(!0)):m.models.themeManager.saveThemeColour());else{var i={light:"#fff",dark:"#fff",renderCallback:function(e){if(e){var t=e.colors,i=m.models.themeManager.toRgbA(t);s.$swatch.css({backgroundColor:i,color:.22<t.RGBLuminance?"#222":"#ddd"}),m.models.themeManager.setColorValues(s.settingName,t)}}},o=m.models.themeManager.getThemeColourRGBA(this.settingName);o&&(i.color=o),this.picker=new m.views.settings.ColorPickerPopup(i),this.$picker=this.picker.render().$el,this.$el.closest(".toggle-option").toggleClass("color-picker-active"),this.$el.append(this.$picker),this.picker.setSizes(),this.picker.preRender(!0)}}},close:function(){m.models.themeManager.saveThemeColour(),this.dismiss()}}),m.views.settings=m.views.settings||{},m.views.settings.ColorPickerPopup=Backbone.View.extend({template:m.templates.settings["color-picker-popup"],events:{"mousedown .cp-xy-slider,.cp-z-slider,.cp-alpha":"mouseDown"},initialize:function(e){this._color=this.color=new Colors(e),this._options=this._color.options,this._GPU=!1,this._css="",this._pointermove="touchmove.tcp mousemove.tcp pointermove.tcp",this._pointerup="touchend.tcp mouseup.tcp pointerup.tcp"},render:function(){return this.$el.html(this.template()),this.delegateEvents(),this._$z_slider=this.$el.find(".cp-z-slider").first(),this._$xy_slider=this.$el.find(".cp-xy-slider").first(),this._$xy_cursor=this.$el.find(".cp-xy-cursor").first(),this._$z_cursor=this.$el.find(".cp-z-cursor").first(),this._$alpha=this.$el.find(".cp-alpha").first(),this._$alpha_cursor=this.$el.find(".cp-alpha-cursor").first(),this.setSizes(),this.preRender(),this.renderedOnce=!0,this},setSizes:function(){this._$alpha._width=this._$alpha.width(),this._$xy_slider._width=this._$xy_slider.width(),this._$xy_slider._height=this._$xy_slider.height(),this._$z_slider._height=this._$z_slider.height()},resolveEventType:function(e){return(e=e.originalEvent&&e.originalEvent.touches?e.originalEvent.touches[0]:e).originalEvent?e.originalEvent:e},findElement:function(e){return $(e.find(this._options.doRender)[0]||e[0])},mouseDown:function(e){var t=this;e.stopPropagation(),this._$trigger=$(e.currentTarget),this.setSizes();var i=e.currentTarget.className.replace(/cp-(.*?)(?:\s*|$)/,"$1").replace("-","_");1<(e.button||e.which)||(e.preventDefault&&e.preventDefault(),e.returnValue=!1,this._$trigger._offset=this._$trigger.offset(),(i="xy_slider"===i?this.xy_slider:"z_slider"===i?this.z_slider:this.alpha).call(this,e),this.preRender(),this.$el.on(this._pointerup,function(e){t.$el.off(".tcp")}).on("mouseleave.tcp",function(e){i.call(t,e),t.preRender(),t.$el.off(".tcp")}).on(this._pointermove,function(e){i.call(t,e),t.preRender()}))},xy_slider:function(e){var t=this.resolveEventType(e),i=t.pageX-this._$trigger._offset.left,s=t.pageY-this._$trigger._offset.top;this._color.setColor({s:i/this._$xy_slider._width*100,v:100-s/this._$xy_slider._height*100},"hsv")},z_slider:function(e){var t=this.resolveEventType(e).pageY-this._$trigger._offset.top;this._color.setColor({h:360-t/this._$z_slider._height*360},"hsv")},alpha:function(e){var t=(this.resolveEventType(e).pageX-this._$trigger._offset.left)/this._$alpha._width;this._color.setColor({},"rgb",t)},preRender:function(e){colors=this._color.colors,hueRGB=colors.hueRGB,RGB=colors.RND.rgb,HSL=colors.RND.hsl,dark=this._options.dark,light=this._options.light,colorText=this._color.toString(this._color._colorMode,this._options.forceAlpha),HUEContrast=.22<colors.HUELuminance?dark:light,alphaContrast=.22<colors.rgbaMixBlack.luminance?dark:light,h=(1-colors.hsv.h)*this._$z_slider._height,s=colors.hsv.s*this._$xy_slider._width,v=(1-colors.hsv.v)*this._$xy_slider._height,a=colors.alpha*this._$alpha._width,translate3d=this._GPU?"translate3d":"",this._$trigger?(triggerValue=this._$trigger[0].value,hasNoValue=this._$trigger[0].hasAttribute("value")&&""===triggerValue&&void 0!==e):(triggerValue=null,hasNoValue=!0),this._$xy_slider._css={backgroundColor:"rgb("+hueRGB.r+","+hueRGB.g+","+hueRGB.b+")"},this._$xy_cursor._css={transform:translate3d+"("+s+"px, "+v+"px, 0)",left:this._GPU?"":s,top:this._GPU?"":v,borderColor:.22<colors.RGBLuminance?dark:light},this._$z_cursor._css={transform:translate3d+"(0, "+h+"px, 0)",top:this._GPU?"":h,borderColor:"transparent "+HUEContrast},this._$alpha._css={background:"linear-gradient(to left,#"+colors.HEX+",rgba(0,0,0,0))"},this._$alpha_cursor._css={transform:translate3d+"("+a+"px, 0, 0)",left:this._GPU?"":a,borderColor:alphaContrast+" transparent"},this.renderInternal(e)},renderInternal:function(e){this._$xy_slider.css(this._$xy_slider._css),this._$xy_cursor.css(this._$xy_cursor._css),this._$z_cursor.css(this._$z_cursor._css),this._$alpha.css(this._$alpha._css),this._$alpha_cursor.css(this._$alpha_cursor._css),this._options.doRender&&this._$trigger.css(this._$trigger._css),this._options.renderCallback.call(null,this._color,this._$trigger,"boolean"==typeof e?e:void 0)}}),m.views.settings.panels.General=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-general",class:"settings-view settings-general"},template:m.templates.settings.general,panelid:"general",events:{"click .slide-toggle":"toggleSlider","dblclick .slide-toggle":"eatDblClick","click .config-button":"configWidget","click .sync-option":"toggleSyncSlider","click .balanced-message":"switchToBalanceSettings","click .toggle-option":"toggleOption"},initialize:function(){this.model=m.models.customization,this.initializeCustomizeItems(),this.listenTo(this.model,"change",this.customizationModelChanged)},initializeCustomizeItems:function(){var e=m.models.themeManager.getAvailableFonts();this.customizeItems=[{name:"Theme",field:"themeColour",widget:"themeColour",options:[{label:"Dark",value:"dark"},{label:"Light",value:"light"},{label:"Custom",value:"custom",view_cmd:"settings.color.picker",view_opt:{settingName:"themeColour",ignoreClick:!0},show_always:!0}],default:"dark",plusOnly:!0,section:"customize"},{name:"Font",field:"themeFont",widget:"themeFont",options:e,default:"default",plusOnly:!0,section:"customize"},{name:"Links",widget:"linksVisible",field:"linksVisible",section:"widgets"},{name:"Bookmarks Bar",widget:"bookmarksVisible",field:"bookmarksVisible",section:"widgets"},{name:"Search",widget:"searchVisible",field:"searchVisible",section:"widgets"},{name:"Weather",widget:"weatherVisible",field:"weatherVisible",section:"widgets"},{name:"Focus",widget:"focusVisible",field:"focusVisible",section:"widgets"},{name:"Quote",widget:"quoteVisible",field:"quoteVisible",section:"widgets"},{name:"Todo",widget:"todoVisible",field:"todoVisible",section:"widgets"},{name:"Countdown",widget:"countdownVisible",field:"countdownVisible",plusOnly:!0,message:"Count down to important dates",section:"widgets"},{name:"Notes",widget:"notesVisible",field:"notesVisible",plusOnly:!0,message:"Take quick notes and store wisdom to review",section:"widgets"},{name:"Multi Clock",widget:"multiClockVisible",field:"multiClockVisible",plusOnly:!0,message:"Keep track of time anywhere on Earth",section:"widgets",beta:!0},{name:"Clock Format",field:"hour12clock",widget:"clock-format",boolean:!0,options:[{label:"12 hour",value:!0},{label:"24 hour",value:!1}],section:"misc"},{name:"Percent Clock",widget:"percentClock",field:"percentClock",message:"Visualize your progression through the work day",section:"misc",configLabel:"Customize",configCommand:"settings.display",configOptions:{section:"balance",scheduleVisible:!0}},{name:"Search Provider",field:"searchProvider",widget:"search-provider",options:[{label:"Google",value:"google"},{label:"Bing",value:"bing"}],section:"misc"}]},render:function(){m.models.customization.get("displayname"),localStorage.email;var e=!!localStorage.token;this.$el.html(this.template({loggedIn:e}));var t={customize:this.$el.find("#customize-list"),widgets:this.$el.find("#apps-list"),misc:this.$el.find("#misc-list")};return _.each(t,function(e){e.empty()}),_.each(this.customizeItems,function(e){e.feature&&!m.conditionalFeatures.featureEnabled(e.feature)||(e.options?t[e.section].append(m.templates.settings["general-toggle-options"](e)):t[e.section].append(m.templates.settings["general-toggle-slider"](e)))}),this.updateControlStates(_.pluck(this.customizeItems,"field")),this},customizationModelChanged:function(e){if(e){var t=e.changedAttributes(),i=_.keys(t);this.updateControlStates(i)}},updateControlStates:function(e){var l=this,r=m.conditionalFeatures.featureEnabled("plus");_.each(e,function(e){var i=_.findWhere(l.customizeItems,{field:e});if(i){var s=l.model.get(e);if(i.options){i.plusOnly&&!r&&(s=i.default),l.$el.find("."+i.widget).removeClass("active");var o=l.$el.find("."+i.widget+"[data-option-value='"+s+"']").first();o.addClass("active"),_.each(i.options,function(e){if(e.view_cmd){var t=(o=l.$el.find("."+i.widget+"[data-option-value='"+e.value+"']").first()).find(".sub-view").first();if(!e.view&&e.show_always&&(e.view=m.commandManager.execute(e.view_cmd,e.value,e.view_opt)),0==t.children().length&&(t.html(e.view.render().$el),t.css("display","inline-block")),e.value!=s)return e.show_always||t.hide(),!e.view||!e.view.dismiss||e.view.dismiss(),void(!e.view||!e.view.setInactive||e.view.setInactive());!e.view||!e.view.setActive||e.view.setActive()}})}else{var t=l.model.getComputedSetting(e);s=!(i.plusOnly&&!r)&&!!s;var n=l.$el.find("[data-related-widget='"+i.widget+"']");if(n&&1===n.length){var a=n.first();a.toggleClass("on",s),s!=t&&(i.plusOnly&&r||!i.plusOnly)&&!a.hasClass("balanced")&&(a.append('<span class="option-message balanced-message"> &nbsp; &nbsp;Currently hidden by Balance mode (Customize here)</span>'),a.addClass("balanced"))}}}})},setOption:function(e){var t=e.attr("data-related-widget"),i=e.attr("data-option-value"),s=_.findWhere(this.customizeItems,{widget:t});if(!s)return null;if(!s.plusOnly||m.conditionalFeatures.featureEnabled("plus")){this.$el.find("."+t).removeClass("active"),e.addClass("active");var o={};return s.boolean?o[s.field]=JSON.parse(i):o[s.field]=i,this.model.save(o),s}var n={targetRegion:"settings",sourceEvent:t,buttonText:"Learn more",title:"Custom Themes",description:"Make Momentum your own"};m.commandManager.execute("upsell.message",n)},toggleOption:function(e){var t=$(e.currentTarget),i=$(e.currentTarget).attr("data-option-value"),s=this.setOption(t);if(s){var o=_.findWhere(s.options,{value:i});if(o&&o.view&&o.view.handleClick){if(0<$(e.target).closest(".sub-view").length&&o.view.ignoreClickEvent&&o.view.ignoreClickEvent(e.target))return;if(o.view.handleClick(e,!0),o.view.scrollIntoViewElement){var n=o.view.scrollIntoViewElement();n&&this.scrollIntoView(n)}}}m.trigger("globalEvent:settingsclick",e)},scrollIntoView:function(e){var t=$(e),i=t.closest(".settings-view"),s=t.offset().top,o=i.offset().top;s-o-12<0&&i.animate({scrollTop:i[0].scrollTop+s-o-12})},configWidget:function(e){e.stopPropagation();var t=$(e.currentTarget).closest(".slide-toggle").attr("data-related-widget");if(t){var i=_.findWhere(this.customizeItems,{widget:t});m.commandManager.execute(i.configCommand,null,i.configOptions)}},toggleSlider:function(e){if(!this.eatClicks){this.eatClicks=!0;var t,i=this;setTimeout(function(){i.eatClicks=!1},250);var s=$(".cp-color-picker");if(!($(e.target).attr("data-option-value")||0<s.length&&$.contains(s[0],e.target)||$(e.currentTarget).hasClass("balanced"))){var o=$(e.currentTarget).attr("data-related-widget");if("bookmarksVisible"!=o){if(o){var n,a=_.findWhere(this.customizeItems,{widget:o}),l=this.model.get(a.field);if(a.options){for(t=0;t<a.options.length;t++)if(a.options[t].value==l){t==a.options.length-1&&(t=-1),n=a.options[t+1].value;break}var r=$(e.currentTarget).find("."+a.widget+"[data-option-value='"+n+"']").first();this.setOption(r)}else{var d;if(n=!this.model.get(o),this.model.toggle(o),a.plusOnly&&!m.conditionalFeatures.featureEnabled("plus"))return a.plusOnly&&!m.conditionalFeatures.featureEnabled("plus")&&("Countdown"==a.name?d={targetRegion:"settings",sourceEvent:o,buttonText:"Learn more",title:"Countdown",description:"Track your upcoming milestones"}:"Notes"==a.name?d={targetRegion:"settings",sourceEvent:o,buttonText:"Learn more",title:"Notes",description:"Take longer form notes"}:"Multi Clock"===a.name&&(d={targetRegion:"settings",sourceEvent:o,buttonText:"Learn more",title:"Clocks",description:"Keep tabs on time anywhere on earth"})),void m.commandManager.execute("upsell.message",d);var c={};c[o]=n,this.model.save(c)}}m.trigger("globalEvent:settingsclick",e)}else this.enableBookmarks(e)}}},loginClicked:function(e){e.preventDefault(),e.stopPropagation(),m.sendEvent("Settings","Login","Clicked"),m.commandManager.execute("settings.hide"),m.commandManager.execute("account.login")},logoutClicked:function(e){e.preventDefault(),e.stopPropagation(),$(".action-logout").addClass("action-logout-disabled").text("Logging out..."),m.sendEvent("Settings","Logout","Clicked"),m.commandManager.execute("logout")},accountClicked:function(e){e.preventDefault(),e.stopPropagation(),$(e.currentTarget).html("Launching..."),$.ajax({type:"POST",beforeSend:setMomentumAuthHeader,data:JSON.stringify({medium:"account"}),url:m.globals.urlRootApi+"login/onetime"}).done(function(e){e&&e.otp&&e.email&&(window.location.href="http://localdev:8995/onetime?email="+encodeURIComponent(e.email)+"&otp="+encodeURIComponent(e.otp))}).fail(function(e,t){}).always(function(){})},panelClosing:function(){_.each(this.customizeItems,function(e){_.each(e.options,function(e){e.view_cmd&&(!e.view||!e.view.close||e.view.close())})})},switchToBalanceSettings:function(e){e&&(e.stopPropagation(),e.preventDefault()),m.commandManager.execute("settings.display",null,{section:"balance",showAdvanced:!0})},enableBookmarks:function(e){e&&(e.stopPropagation(),e.preventDefault()),m.commandManager.execute("settings.enableBookmarks",{callback:function(){$(e.currentTarget).toggleClass("on",m.models.customization.get("bookmarksVisible"))}})}}),m.views.Gravatar=Backbone.View.extend({className:"avatar",tagName:"img",render:function(){var e=this.options.email,t=this.options.size,i=this.$el.attr({src:"https://www.gravatar.com/avatar/"+md5(e)+"?s="+t+"&d=mm"});return this.$el.html(i),this}}),m.views.settings.panels.Help=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-help",class:"settings-view settings-help"},template:m.templates.settings.help,panelid:"help",initialize:function(){},render:function(){return this.$el.html(this.template({isChrome:isChrome()})),this}}),m.views.settings.panels.Loading=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-loading",class:"settings-view settings-loading"},template:m.templates.settings.loading,panelid:"loading",events:{"click .button-retry":"retryClicked"},render:function(){if(!this.renderedOnce){this.renderedOnce=!0;this.$el.html(this.template({})),this.$errorMessage=this.$(".settings-loading-error-message"),this.$retryButton=this.$(".button-retry"),this.$loading=this.$(".settings-loading-loading-message")}return this.renderDisplayState(),this},renderDisplayState:function(){if(this.displayOptions){var e=this.displayOptions;if(e.error)return this.$errorMessage.text(e.error),this.$errorMessage.show(),this.$retryButton.show(),void this.$loading.hide()}this.$loading.show(),this.$errorMessage.hide(),this.$retryButton.hide()},setDisplayOptions:function(e){this.displayOptions=e||null},retryClicked:function(e){if(e.stopPropagation(),this.displayOptions&&this.displayOptions.retryInfo){var t=this.displayOptions.retryInfo,i=t.options||{};i.section=t.id,m.commandManager.execute("settings.display",null,i)}}}),m.views.settings=m.views.settings||{},m.views.settings.MainSettings=Backbone.View.extend({attributes:{class:"app-wrapper nipple-bottom-left"},template:m.templates.settings.main,events:{"click .hide":"hideSettings"},detailsShown:!1,initialize:function(){this.subViews=[],this.renderedOnce=!1,this.visible=!1},render:function(){if(!this.visible)return this;if(this.paneRendered||(this.$el.html(this.template()),this.$popup=this.$(".app-wrapper"),this.$container=this.$(".settings-view-container"),this.paneRendered=!0),!this.cssLoaded)return this;this.renderedOnce||(this.navMenu=new m.views.settings.NavMenu({el:this.$("#nav-menu")}),this.listenTo(this.navMenu,"navItemClicked",this.navItemClicked),this.renderedOnce=!0,this.visible||this.$el.hide());var e=this;return $(".settings-view-container").on("scroll",function(){e.handleScroll()}),this.renderActivePanel(),this},handleScroll:function(){handleStickySubnav(this.activePanel)},renderActivePanel:function(e){this.activePanel&&this.cssLoaded&&this.renderedOnce&&(this.activePanel.render(e).$el.detach().appendTo(this.$container),m.trigger("settings:panel:visible"))},navItemClicked:function(e){if(this.upsellView&&this.upsellView.hideUpsell(),e!=this.activePanelId){var t=this.getNavItem(e);t&&t.cmd&&t.cmdonly?(this.setActiveNavItem(e),m.commandManager.ensureCommandLoaded(t.cmd,function(){t.hide&&m.commandManager.execute("settings.hide"),m.commandManager.execute(t.cmd,t.options)},function(){},function(e){})):this.activateSection(e,{source:"nav-"+e})}},toggleVisible:function(){this.visible?this.hideSettings():this.showSettings()},showSettings:function(e){var t=this;if(!this.cssLoaded&&!this.cssLoading){this.cssLoading=!0;var i=$('<link type="text/css" href="css/settings.css" rel="stylesheet" />');i.load(function(){t.cssLoaded=!0,t.render(),t.showSection(e)}),$("head").append(i)}this.visible=!0,m.trigger("globalEvent:toggle:bottom-left",this),this.paneRendered&&this.renderedOnce||this.render(),m.trigger("settings:visible"),this.cssLoaded&&this.showSection(e),this.$el.show()},hideSettings:function(e){if(this.$el.is(":visible")){e&&e.preventDefault(),this.visible=!1,m.trigger("settings:hidden"),this.$popup.removeClass("show-fade-in");var t=this;setTimeout(function(){t.$popup.removeClass("show"),this.activePanel&&this.activePanel.close(),this.navMenu&&this.navMenu.closeUser()},200)}},showSection:function(e){e&&e.section?this.activateSection(e.section,e):this.activateSection(this.activePanelId&&"loading"!=this.activePanelId?this.activePanelId:"general")},getNavItem:function(e){var t=m.settingsManager.getNavItems(),i=_.findWhere(t.navItems,{id:e});return i||(i=_.findWhere(t.secondaryNavItems,{id:e})),i},getPanel:function(e){var t=m.settingsManager.getPanelItems();return _.findWhere(t,{id:e})},showLoadingPanel:function(e){this.loadingPanel||(this.loadingPanel=new m.views.settings.panels.Loading),"loading"!=this.activePanelId&&this.setActivePanel(this.loadingPanel,"loading",null),this.loadingPanel.setDisplayOptions(e),this.renderActivePanel()},setActivePanel:function(e,t,i){e&&(this.activePanel&&this.activePanel.close(),this.activePanel=e,this.activePanelId=t,this.activePanelOptions=i,this.$container.scrollTop(0))},setActiveNavItem:function(e){$(".main-nav-item").removeClass("active");var t=this.getNavItem(e);t||(t=this.getPanel(e)),t&&t.section?$('li[data-navitem="'+t.section+'"]').addClass("active"):$('li[data-navitem="'+e+'"]').addClass("active")},activateSection:function(t,i){var s=this;if(t){i&&i.nav?this.setActiveNavItem(i.nav):this.setActiveNavItem(t);var e=this.getNavItem(t);e||(e=this.getPanel(t));var o=null,n=!1,a=!1,l=!1;if(e&&e.cmd)m.commandManager.ensureCommandLoaded(e.cmd,function(){n=!0,o=m.commandManager.execute(e.cmd,i),s.setActivePanel(o,t,i),s.renderActivePanel(i)},function(){a||n||(a=!0,setTimeout(function(){l||n||s.showLoadingPanel()},400))},function(e){l=a=!0,s.showLoadingPanel({error:"We were unable to load settings.",retryInfo:{id:t,options:i}})});else{if(!(o=_.findWhere(this.subViews,{panelid:t}))){var r=t.charAt(0).toUpperCase()+t.slice(1),d=m.views.settings.panels[r];d&&(o=new d(i))}this.setActivePanel(o,t,i),this.renderActivePanel()}}},showUpsell:function(e){this.upsellView?(this.upsellView.options=e,this.upsellView.render()):(e.template=m.templates.settings.upsell,this.upsellView=new m.views.upsell.message(e),this.$el.find(".settings-view-container").prepend(this.upsellView.render().$el)),this.upsellView.show()}}),m.views.settings.NavMenu=Backbone.View.extend({syncState:!1,template:m.templates.settings.navmenu,events:{"click .main-nav-item":"onClickNavItem","click .user-info":"toggleUserPanel","click .sync-option":"toggleSyncSlider","click .action-profile":"accountClicked","click .action-logout":"logoutClicked","click .user-close":"closeUser","click .login-button":"loginClicked"},initialize:function(){var t=this;this.listenTo(m.settingsManager,"navItemsChanged",this.render),this.listenTo(m.models.customization,"change:displayname",this.onChangeDisplayname),this.listenTo(m,"settings:hidden",this.closeUser),this.render(),this.$el.closest(".app").on("click",function(e){$.contains(t.$user[0],e.target)||e.target===t.$user[0]||t.closeUser()})},render:function(){var e=localStorage.getItem("email"),t=!!localStorage.token;this.syncMessage||(m.conditionalFeatures.featureEnabled("serverfocus")||m.conditionalFeatures.featureEnabled("servertodos")||m.conditionalFeatures.featureEnabled("serverlinks")?(this.syncMessage="Your account data is available anywhere you log in",this.syncState=!0):(this.syncMessage="Access your Momentum account from any computer",this.syncState=!1));var i={displayName:m.models.customization.get("displayname"),email:e,loggedIn:t,menu:m.settingsManager.getNavItems(),syncMessage:this.syncMessage};this.$el.html(this.template(i)),this.$user=this.$(".user"),this.$userInfoName=this.$(".user-info-name"),this.$userHidden=this.$(".user-hidden"),this.$synclist=this.$(".sync-option"),t&&this.renderGravatar(e),m.conditionalFeatures.featureEnabled("plus")&&this.$user.addClass("has-plus"),this.syncState&&this.$user.addClass("hide-sync");var s=this;return _.defer(_.bind(function(){s.$user.css("transform","translateY("+s.$userHidden.height()+"px)")},this)),this},onChangeDisplayname:function(){this.$userInfoName.text(m.models.customization.get("displayname"))},renderGravatar:function(e){this.$userAvatarImg=this.$(".user-avatar img"),this.$userAvatarHidden=this.$(".user-avatar-hidden");var t=new m.views.Gravatar({email:e,size:50});this.$userAvatarHidden.html(t.render().$el);var i=this;setTimeout(function(){i.$(".user-avatar-hidden img").one("load",function(){i.$userAvatarImg.attr("src",$(this).attr("src"))}).each(function(){this.complete&&$(this).load()})},0)},onClickNavItem:function(e){var t=$(e.currentTarget).data("navitem");this.trigger("navItemClicked",t)},toggleUserPanel:function(){this.updateSyncToggleState(),this.$user.removeClass("u--no-transition"),this.$(".anim-caret").removeClass("u--no-transition"),this.$user.hasClass("open")?this.$user.css("transform","translateY("+this.$userHidden.height()+"px)"):this.$user.css("transform","translateY(0)"),this.$user.toggleClass("u--bg open")},toggleSyncSlider:function(e){e.preventDefault(),e.stopPropagation();var t=this;this.syncState||(localStorage.token?m.syncCoordinator.submitFeatureAccessRequest("sync-early-access",function(){t.updateSyncCaption("Account Sync Activated"),t.updateSyncMessage("Refresh or load a new tab to use your synced account"),t.syncState=!0,t.updateSyncToggleState()},function(){t.syncState=!1,t.updateSyncToggleState(),t.updateSyncCaption("Account Sync Access Request Failed"),t.updateSyncMessage("Please check that you are online and try again"),t.syncState=!1,t.updateSyncToggleState()}):(t.updateSyncCaption("Login required for Account Sync"),t.updateSyncMessage("Click Log In to log in or create an account, and try again"),t.syncState=!1,t.updateSyncToggleState()))},updateSyncToggleState:function(){this.$synclist&&this.$synclist.toggleClass("fixed on",this.syncState)},updateSyncMessage:function(e){if(this.$synclist){var t=this.$synclist.find(".option-message");t.fadeTo(0,0,function(){t.html(e).fadeTo(500,1)})}},updateSyncCaption:function(e){if(this.$synclist){var t=this.$synclist.find(".sync-caption");t.fadeTo(0,0,function(){t.html(e).fadeTo(500,1)})}},accountClicked:function(e){e.preventDefault(),e.stopPropagation(),$(e.currentTarget).html("Launching…"),$.ajax({type:"POST",beforeSend:setMomentumAuthHeader,data:JSON.stringify({medium:"account"}),url:m.globals.urlRootApi+"login/onetime"}).done(function(e){e&&e.otp&&e.email&&(window.location.href="https://account.momentumdash.com/onetime?email="+encodeURIComponent(e.email)+"&otp="+encodeURIComponent(e.otp))}).fail(function(e,t){}).always(function(){})},logoutClicked:function(e){e.preventDefault(),e.stopPropagation(),$(".action-logout").addClass("action-logout-disabled").text("Logging out…"),m.sendEvent("Settings","Logout","Clicked"),m.commandManager.execute("logout")},closeUser:function(){this.$user.css("transform","translateY("+this.$userHidden.height()+"px)").removeClass("u--bg open")},loginClicked:function(e){e.preventDefault(),e.stopPropagation(),m.sendEvent("Settings","Login","Clicked"),m.commandManager.execute("settings.hide"),m.commandManager.execute("account.login")},onChangeDisplayname:function(){this.$userInfoName.text(m.models.customization.get("displayname"))}}),m.views.settings=m.views.settings||{},m.views.settings.SettingsPane=Backbone.View.extend({attributes:{id:"settings",class:"app-container settings"},renderedOnce:!1,events:{"click .toggle":"toggleShow"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenTo(m,"globalEvent:esc globalEvent:click globalEvent:toggle",this.hideSettings),this.listenTo(m,"globalEvent:toggleSettings",this.toggleShow),this.listenTo(m,"settings:visible",this.settingsVisible),this.listenTo(m,"settings:hidden",this.settingsHidden)},render:function(){var e=this;if(!this.renderedOnce){var t=(this.options.order||"append")+"To";this.$el[t]("."+this.options.region).html('<span class="app-dash toggle"><svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340.274 340.274"><path d="M293.629 127.806l-5.795-13.739c19.846-44.856 18.53-46.189 14.676-50.08l-25.353-24.77-2.516-2.12h-2.937c-1.549 0-6.173 0-44.712 17.48l-14.184-5.719c-18.332-45.444-20.212-45.444-25.58-45.444h-35.765c-5.362 0-7.446-.006-24.448 45.606l-14.123 5.734C86.848 43.757 71.574 38.19 67.452 38.19l-3.381.105-27.27 26.737c-4.138 3.891-5.582 5.263 15.402 49.425l-5.774 13.691C0 146.097 0 147.838 0 153.33v35.068c0 5.501 0 7.44 46.585 24.127l5.773 13.667c-19.843 44.832-18.51 46.178-14.655 50.032l25.353 24.8 2.522 2.168h2.951c1.525 0 6.092 0 44.685-17.516l14.159 5.758c18.335 45.438 20.218 45.427 25.598 45.427h35.771c5.47 0 7.41 0 24.463-45.589l14.195-5.74c26.014 11 41.253 16.585 45.349 16.585l3.404-.096 27.479-26.901c3.909-3.945 5.278-5.309-15.589-49.288l5.734-13.702c46.496-17.967 46.496-19.853 46.496-25.221V151.88c-.005-5.519-.005-7.446-46.644-24.074zM170.128 228.474c-32.798 0-59.504-26.187-59.504-58.364 0-32.153 26.707-58.315 59.504-58.315 32.78 0 59.43 26.168 59.43 58.315-.006 32.177-26.656 58.364-59.43 58.364z" fill="#FFF"/></svg></span>'),this.renderedOnce=!0,m.views.settings.mainSettings=new m.views.settings.MainSettings,setTimeout(function(){e.$el.prepend(m.views.settings.mainSettings.$el)},100),this.$el.toggleClass("infinispin",m.settingsManager.infinispin())}return this},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),m.commandManager.execute("settings.toggle")},hideSettings:function(e){e!=this&&(e.originalEvent&&"click"==e.type&&e.target&&$.contains(m.views.settings.mainSettings.el,e.target)||m.commandManager.execute("settings.hide"))},settingsVisible:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in")},settingsHidden:function(e){if(e&&e.preventDefault(),this.$el.hasClass("show")){var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")})}}}),m.views.settings=m.views.settings||{},m.views.settings.panels=m.views.settings.panels||{},m.views.settings.SettingsPanel=Backbone.View.extend({initialize:function(){},render:function(){return this.$el.html(this.template({})),this},close:function(){this.remove(),this.unbind()}}),m.views.settings.panels.Whatsnew=m.views.settings.SettingsPanel.extend({attributes:{id:"whats-new",class:"settings-view whats-new"},template:m.templates.settings.whatsnew,panelid:"whatsnew",events:{"click .action-back":"clickBack"},initialize:function(){m.sendEvent("Whats New","Show Whats New Panel")},render:function(){return this.$el.html(this.template({})),this.$whatsnew=$(this.$el.find(".whatsnew-body")[0]),this.$whatsnew.html('<span class="loading"><i class="loading-icon"></i>Loading...</span>'),this.fetchLatestWhatsNew(),this},fetchLatestWhatsNew:function(){var i=this;$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"settings/whatsnew"}).done(function(e){e.html&&i.$whatsnew.html(e.html)}).fail(function(e,t){i.$el.html(i.template({}))})}}),m.views.Introduction=Backbone.View.extend({attributes:{id:"introduction",class:"intro"},template:m.templates.introduction["introduction-template"],initialize:function(){this.activeView=null,localStorage.removeItem("doLoginOnNextLoad"),this.render()},render:function(){var e=(this.options.order||"append")+"To";this.$el[e]("."+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(1e3,1),m.models.customization.get("displayname")?this.promptForEmail():this.promptForName()},promptForName:function(){m.sendEvent("Introduction","Name","Show"),m.views.namePrompt=new m.views.NamePrompt,this.activeView=m.views.namePrompt,this.$el.find(".content").append(m.views.namePrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForEmail:function(){m.views.emailPrompt=new m.views.EmailPrompt,this.activeView=m.views.emailPrompt,this.$el.find(".content").append(m.views.emailPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPasswordLogin:function(){m.sendEvent("Introduction","Password For Login","Show"),m.views.loginPasswordPrompt=new m.views.LoginPasswordPrompt,this.activeView=m.views.loginPasswordPrompt,this.$el.find(".content").append(m.views.loginPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPasswordCreate:function(){m.sendEvent("Introduction","Password For Create","Show"),m.views.createPasswordPrompt=new m.views.CreatePasswordPrompt,this.activeView=m.views.createPasswordPrompt,this.$el.find(".content").append(m.views.createPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPasswordReset:function(){m.sendEvent("Introduction","Password For Reset","Show"),m.views.resetPasswordPrompt=new m.views.ResetPasswordPrompt,this.activeView=m.views.resetPasswordPrompt,this.$el.find(".content").append(m.views.resetPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},doneIntroductionWithMessage:function(){var e=this;this.handledDone||(this.handledDone=!0,localStorage.removeItem("doLoginOnNextLoad"),this.$el.fadeTo(1e3,0,function(){m.bootstrappers.InitializeFocus(m,$),m.appView.render(!0,function(){m.widgetManager.showApps(!0)}),e.destroy()}))},showLoading:function(){var e=this.$el.find(".tip"),t=0;e.html()&&(t=500),e.fadeTo(t,0,function(){e.html('<div class="loading"><span class="loading-icon"></span>Loading...</div>').css("opacity","0").fadeTo(500,1)})},hideLoading:function(){},destroy:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.remove()}}),m.views.NamePrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keydown input":"updateOnEnter"},render:function(){var e={message:"Hello, what's your name?"};this.$el.html(this.template(e));var t=new m.views.ExpandableInput;this.$(".question").after(t.render().$el),t.$el.attr("id","introduction-input");var i=this;return setTimeout(function(){var e=i.$el.find(".question-title").outerWidth();i.$el.find(".input").css({"min-width":e}).focus()},10),this},updateOnEnter:function(e){13!=e.keyCode&&9!=e.keyCode||(e.preventDefault(),this.save())},save:function(){m.sendEvent("Introduction","Name","Submit");var e=this,t=this.$el.find("input")[0].value.trim();t.length<1||(m.models.customization.save({displayname:t}),this.$el.fadeTo(1e3,0,function(){e.remove(),m.views.introduction.promptForEmail()}))}}),m.views.EmailPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keydown .input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t={message:"What's your email, "+m.models.customization.get("displayname")+"?"},i=new m.views.IntroductionButton({value:"Stay logged out",clicked:function(){return e.stayOffline()}});this.$el.html(this.template(t)),this.$el.find(".buttons").append("Or would you rather stay logged out?").append(i.render().$el);var s=new m.views.ExpandableInput;this.$el.find(".question").after(s.render().$el),s.$el.attr("id","introduction-input");var o=this;return setTimeout(function(){var e=o.$el.find(".question-title").outerWidth();o.$el.find(".input").css({"min-width":e}).focus()},10),this},handleBack:function(e){m.sendEvent("Introduction","Email","Escape Pressed"),this.stayOffline()},updateOnEnter:function(e){13!==e.keyCode&&9!==e.keyCode||(e.preventDefault(),this.checkEmail())},stayOffline:function(){m.widgetManager.hideAppsExcept(".apps .full",!0),m.sendEvent("Introduction","Email","Stay Offline Clicked"),localStorage.stayOffline=!0,m.views.introduction.doneIntroductionWithMessage()},checkEmail:function(){m.sendEvent("Introduction","Email","Submit");var i=this,e=this.$el.find(".input").val().trim();if(e&&!(e.length<1))if(validateEmail(e))i.loading||(i.loading=!0,localStorage.email=e,m.views.introduction.showLoading(),$.ajax({type:"GET",beforeSend:function(e){e.overrideMimeType("application/text")},url:m.globals.urlRootApi+"user-search?email="+encodeURIComponent(e)}).done(function(e){i.$el.fadeTo(1e3,0,function(){i.remove(),m.views.introduction.promptForPasswordLogin()}),m.views.introduction.hideLoading(),i.loading=!1}).fail(function(e,t){404===e.status?(i.$el.fadeTo(1e3,0,function(){i.remove(),m.views.introduction.promptForPasswordCreate()}),i.loading=!1,m.views.introduction.hideLoading()):(i.loading=!1,i.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1))}));else{var t=new m.views.IntroductionTip({value:"Sorry, "+e+" doesn't seem to be a valid email address. Please try again."});this.$el.find(".tip").html(t.render().$el.fadeTo(500,1))}}}),m.views.LoginPasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keydown input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t={message:"What's your password?"},i=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}}),s=new m.views.IntroductionButton({value:"Change your password",clicked:function(){return e.resetPassword()}});this.$el.html(this.template(t)),this.$el.find(".buttons").append(i.render().$el),this.$el.find(".buttons").append(s.render().$el);var o=new m.views.ExpandableInput;this.$el.find(".question").after(o.render().$el),o.$el.attr("id","introduction-input"),this.$el.find(".input").attr("type","password").focus();var n=this;return setTimeout(function(){var e=n.$el.find(".question-title").outerWidth();n.$el.find(".input").css({"min-width":e}).focus()},10),this},handleBack:function(e){m.sendEvent("Introduction","Password For Login","Escape Pressed"),this.changeEmail(e)},updateOnEnter:function(e){13!=e.keyCode&&9!=e.keyCode||this.login()},changeEmail:function(e){m.sendEvent("Introduction","Password For Login","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},resetPassword:function(e){m.sendEvent("Introduction","Password For Login","Reset Password Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForPasswordReset()})},login:function(){m.sendEvent("Introduction","Password For Login","Submit");var s=this,e=localStorage.email,t=this.$el.find("input")[0].value;if(t.length<6){var i=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});s.$el.find(".tip").html(i.render().$el.fadeTo(500,1))}else s.loading||(s.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({username:e,password:t}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/authenticate"}).done(function(e){s.loading=!1,e.token&&(m.commandManager.execute("notification.dismiss"),localStorage.token=e.token,e.token_uuid&&(localStorage.token_uuid=e.token_uuid),e.features&&m.conditionalFeatures.setFeatures(e.features),m.widgetManager.hideAppsExcept(".apps .full",!0),m.trigger("user:successfulLogin",function(){localStorage.setItem("loggedIn",Date.now()),m.views.introduction.doneIntroductionWithMessage()}),m.views.introduction.hideLoading())}).fail(function(e,t){if(400===e.status||401===e.status){var i=new m.views.IntroductionTip({value:"The password you entered for the email "+localStorage.email+" isn't right."});s.$el.find(".tip").html(i.render().$el.fadeTo(500,1)),s.loading=!1,m.views.introduction.hideLoading()}else s.loading=!1,s.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1)}))}}),m.views.CreatePasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keydown input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t={message:"Please choose a password."},i=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}});this.$el.html(this.template(t));var s=new m.views.ExpandableInput;this.$el.find(".question").after(s.render().$el),s.$el.attr("id","introduction-input"),this.$el.find("input").attr("type","password").focus(),this.$el.find(".buttons").append(i.render().$el),this.$(".tip").html('Your privacy is important. Learn more about how we&lsquo;re protecting you in our <a href="https://momentumdash.com/terms" target="_blank">Terms</a> and <a href="https://momentumdash.com/privacy" target="_blank">Privacy</a> policies.');var o=this;return setTimeout(function(){var e=o.$el.find(".question-title").outerWidth();o.$el.find(".input").css({"min-width":e}).focus()},10),this},updateOnEnter:function(e){13!=e.keyCode&&9!=e.keyCode||this.create()},handleBack:function(e){m.sendEvent("Introduction","Password For Create","Escape Pressed"),this.changeEmail(e)},changeEmail:function(e){m.sendEvent("Introduction","Password For Create","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},create:function(){m.sendEvent("Introduction","Password For Create","Submit");var o=this,e=localStorage.email,t=this.$el.find("input")[0].value;if(t.length<6){var i=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});o.$el.find(".tip").html(i.render().$el.fadeTo(500,1))}else o.loading||(o.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify({name:m.models.customization.get("displayname"),email:e,password:t,version:m.globals.version}),url:m.globals.urlRootLogin+"user/register"}).done(function(e){e.token?(localStorage.token=e.token,e.token_uuid&&(localStorage.token_uuid=e.token_uuid),e.features&&m.conditionalFeatures.setFeatures(e.features)):e.first_time_key&&(localStorage.first_time_key=e.first_time_key,localStorage.next_login_attempt=Date.now(),e.token_uuid&&(localStorage.token_uuid=e.token_uuid)),m.widgetManager.hideAppsExcept(".apps .full",!0),m.views.introduction.doneIntroductionWithMessage()}).fail(function(e,t){var i="An error occurred during registration - please try again shortly.";e.responseJSON&&e.responseJSON.msg&&(i=e.responseJSON.msg);var s=new m.views.IntroductionTip({value:i});o.$el.find(".tip").html(s.render().$el.fadeTo(500,1))}).always(function(){m.views.introduction.hideLoading(),o.loading=!1}))}}),m.views.ResetPasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keydown input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(e){var t=this,i={message:"What would you like your new password to be?"},s=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return t.changeEmail()}});this.$el.html(this.template(i));var o=new m.views.ExpandableInput;this.$el.find(".question").after(o.render().$el),o.$el.attr("id","introduction-input"),this.$el.find(".buttons").append("Changing password for "+localStorage.email).append(s.render().$el),this.$el.find("input").attr("type","password").focus();var n=this;return setTimeout(function(){var e=n.$el.find(".question-title").outerWidth();n.$el.find(".input").css({"min-width":e}).focus()},10),this},handleBack:function(e){m.sendEvent("Introduction","Password For Reset","Escape Pressed"),this.changeEmail(e)},changeEmail:function(e){m.sendEvent("Introduction","Password For Reset","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},updateOnEnter:function(e){13!=e.keyCode&&9!=e.keyCode||this.reset()},reset:function(){m.sendEvent("Introduction","Password For Reset","Submit");var i=this,e=localStorage.email,t=this.$el.find("input")[0].value;if(t.length<6){var s=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});i.$el.find(".tip").html(s.render().$el.fadeTo(500,1))}else i.loading||(i.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({name:m.models.customization.get("displayname"),email:e,password:t}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/forgot"}).done(function(e){m.commandManager.execute("notification.show","Password change started","Check your email to change your password. Your password change email may take a few moments to arrive."),m.widgetManager.hideAppsExcept(".apps .full",!0),m.views.introduction.doneIntroductionWithMessage()}).fail(function(e,t){i.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1)}).always(function(){i.loading=!1,m.views.introduction.hideLoading()}))}}),m.views.IntroductionTip=Backbone.View.extend({template:m.templates.introduction["introduction-tip-template"],render:function(){var e={value:this.options.value};return this.setElement($($.trim(this.template(e)))),this}}),m.views.IntroductionButton=Backbone.View.extend({template:m.templates.introduction["introduction-button-template"],events:{click:"clicked"},render:function(){var e={value:this.options.value};return this.setElement($($.trim(this.template(e)))),this},clicked:function(e){this.options.clicked()}}),m.views.ExpandableInput=Backbone.View.extend({attributes:{class:"width-dynamic input",spellcheck:"false"},tagName:"input",initialize:function(){},render:function(){function t(e){var t=e.val()||e.text()||e.attr("placeholder");return t||(t=""),t}this.fakeEl=$("<span>").hide().appendTo(document.body),this.fakeEl.text(t(this.$el)).css("font",this.$el.css("font"));var i=this;return this.$el.on("input",function(){i.fakeEl.text(t(i.$el)).css("font",i.$el.css("font"));var e=i.fakeEl.width();i.$el.css({width:e+20})}).trigger("input"),this}}),m.models.DropdownMenuItem=Backbone.Model.extend({}),m.collect.TopDropdownMenuItems=Backbone.Collection.extend({model:m.models.DropdownMenuItem,url:m.globals.urlRoot+"settings/todo/menu",fetchCompleted:!1,initialize:function(e,t){t&&t.listId&&(this.listId=t.listId)},parse:function(e){return e.menuoptions},fetchIfRequired:function(e){if(!this.fetchCompleted){var t={data:{},reset:this.fetchCompleted=!0,error:function(e,t,i){self.fetchCompleted=!1}};return e&&(t.data.providerId=e),this.fetch(t),!0}return!1},queueFetch:function(){this.fetchCompleted=!1},fetch:function(e){return this.listId?(additionalData={listId:this.listId},e.data=_.extend(e.data||{},additionalData),Backbone.Collection.prototype.fetch.call(this,e)):null}}),m.models.TodoBase=Backbone.Model.extend({isTrue:function(e){var t=this.get(e);return void 0!==t&&1==t},attemptSave:function(e,t){},retrySave:function(){this.get("isProxy")?this.collection.parentList&&this.collection.parentList.createNewModel&&this.collection.parentList.createNewModel(this):this.attemptedSaveValues&&this.attemptSave(this.model)},saveOptions:function(){return this.collection.saveOptions},getValue:function(e){var t=null;return this.attemptedSaveValues&&this.attemptedSaveValues.hasOwnProperty(e)&&(t=this.attemptedSaveValues[e]),t||(t=this.get(e)),t},isSibling:function(e){return e.get("parentId")==this.get("parentId")}}),m.models.Todo=m.models.TodoBase.extend({defaults:function(){return{title:"empty todo...",done:!1,archive:!1,order:0,createdDate:new Date,archivedDate:null,completedDate:null,deleted:!1,deletedDate:null,listId:"inbox"}},parse:function(e){return e&&e.done&&e.archive&&(e.listId="1-done"),e},archive:function(){this.setArchiveState(!0)},setArchiveState:function(e){var t={};t.archive=void 0===e?!this.get("archive"):e,t.archive?(t.archivedDate=new Date,this.get("done")||(t.done=!0,t.completedDate=new Date)):t.archivedDate=null,this.attemptSave(t)},toggleDoneState:function(){this.setDoneState()},setDoneState:function(e,t){var i=this.getDoneStateChanges(e,t);this.attemptSave(i),i.done&&m.sendEvent("Todo","Done"),m.trigger("todo:loadingStateChange",status)},getDoneStateChanges:function(e,t){var i={};if(i.done=void 0===e?!this.get("done"):e,i.done){var s=this.collection.parentList;if(s.has("done_disabled")){var o=s.get("done_disabled");return void(o.message&&m.trigger("todo:status",o))}i.completedDate=new Date,t&&(i.archive=!0,i.archivedDate=new Date)}else i.archive=!1,i.archivedDate=null,i.completedDate=null;return i},getTodayStateChanges:function(e){var t={};return(t.today=e)&&this.get("archive")&&(t.archive=!1,t.archivedDate=null),t},setTodayState:function(e){var t=this.getTodayStateChanges(e);this.attemptSave(t)},deleteItem:function(){this.attemptSave({deleted:!0,deletedDate:(new Date).toISOString()})},displayConnectingText:function(e){},successfulConnection:function(){},failedConnection:function(e){},attemptSave:function(e,o){var n=this;n.displayConnectingText('<i class="loading-icon"></i>Saving...');var t=n.saveOptions();t.wait=!0;var i=this.collection.parentList.project;e&&(e.projectId=this.get("projectId")||i.id,e.providerId=i.provider.id),t.success=function(){var e={};jQuery.extend(e,n.attemptedSaveValues),n.attemptedSaveValues=null,jQuery.extend(e,{saveFailed:!1,isLoading:!1}),m.trigger("todo:changed",n.id,e),setTimeout(function(){n.set(e),n.successfulConnection(),o&&o(!0)},50)},t.error=function(e,t,i){if(200==t.status){var s={};jQuery.extend(s,n.attemptedSaveValues),n.attemptedSaveValues=null,jQuery.extend(s,{saveFailed:!1,isLoading:!1}),m.trigger("todo:changed",n.id,s),setTimeout(function(){n.set(s),n.successfulConnection(),o&&o(!0)},50)}else{n.set({saveFailed:!0,isLoading:!1,deleted:!1,deletedDate:null}),m.trigger("todo:loadingStateChange"),n.failedConnection('Error saving… <span class="retry">Retry</span>'),o&&o(!1)}},e?(n.attemptedSaveValues?jQuery.extend(n.attemptedSaveValues,e):n.attemptedSaveValues=e,n.save(e,t)):n.attemptedSaveValues?(e=n.attemptedSaveValues,n.save(n.attemptedSaveValues,t)):n.pendingReorderData&&(n.set({isLoading:!0}),$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(n.pendingReorderData),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){n.set({isLoading:!1,saveFailed:!1})}).fail(function(e,t){n.set({saveFailed:!0,isLoading:!1})})),jQuery.extend(e,{saveFailed:!1,isLoading:!0}),n.set(e),m.trigger("todo:changing",n.id,e)},comparator:"order",save:function(e,t){t||(t={}),e||(e=_.clone(this.attributes));try{if(this.collection&&this.collection.parentList&&this.collection.parentList.collection&&this.collection.parentList.collection.aux_data&&jQuery.extend(e,{aux_data:this.collection.parentList.collection.aux_data}),this.collection&&this.collection.parentList&&this.collection.parentList.collection&&this.collection.parentList.collection.aux_data_cmd){var i=m.commandManager.execute(this.collection.parentList.collection.aux_data_cmd,this,this.collection.parentList.collection.aux_data);jQuery.extend(e,{aux_data:this.collection.parentList.collection.aux_data,aux_data_result:i})}}catch(e){}return Backbone.Model.prototype.save.call(this,e,t)},fetch:function(e){var t=e||{};return t.data=$.param({projectId:this.get("projectId"),providerId:this.get("providerId"),listId:this.get("listId")}),Backbone.Model.prototype.fetch.call(this,t)}}),m.models.TodoProxy=m.models.TodoBase.extend({defaults:function(){return{done:!1,isProxy:!0,isLoading:!0,saveFailed:!1,proxyValid:!0}}}),m.models.TodoList=Backbone.Model.extend({itemFetchStarted:!1,showAssignedTodosOnly:!1,defaults:{selected:!1},initialize:function(e,t){t&&(t.project&&(this.project=t.project),e.isDummy&&Object.assign(this.attributes,this.project.attributes)),this.itemCollection=new m.collect.Todos(null,{parentList:this}),this.listenTo(this.itemCollection,"add remove change reset",this.triggerChangeEvent),this.listenTo(this.itemCollection,"remainingCountChanged",this.remainingCountChanged),this.proxyCollection=new m.collect.TodoProxy(null,{parentList:this}),this.listenTo(this.proxyCollection,"add change",this.triggerChangeEvent),this.supportsFeature("assigned")&&this.refreshShowAssignedTodosOnly()},supportsFeature:function(e){return this.get("isDummy")?this.project.get(e+"_support"):this.get(e+"_support")},todoItemMenuOptions:function(){if(this.itemCollection.menuOptions&&(this._todoItemMenuOptions=new Backbone.Collection(this.itemCollection.menuOptions)),!this._todoItemMenuOptions){var e=[{captionText:"Edit",commandId:"todo.edit"},{captionText:"Set to Focus",commandId:"todo.focus.pin"},{css_class:"line"},{captionText:"Move to Today",commandId:"todo.toggle.today",options:{}},{captionText:"Move Back",commandId:"todo.undone",options:{}},{captionText:"Move to...",commandId:"todo.moveTo"},{captionText:"Archive",commandId:"todo.archive"},{css_class:"line"},{captionText:"Delete",commandId:"todo.delete"}];m.conditionalFeatures.featureEnabled("plus")||e.splice(1,1),this._todoItemMenuOptions=new Backbone.Collection(e)}return this._todoItemMenuOptions},toggleSubtasks:function(){m.models.customization.get("assigned-"+this.id)||(this.allSubtasksLoaded=!0),this.itemFetchStarted=!0,this.itemCollection.firstLoadCompleted=!1,this.itemCollection.fetch({reset:!0})},loadOldCompletedTodos:function(){this.itemFetchStarted=!0,this.itemCollection.firstLoadCompleted=!1,this.itemCollection.fetch({reset:!0})},showAssignedTodosOnlyChanged:function(){this.refreshShowAssignedTodosOnly(),this.itemCollection.checkRemainingItemCount(),this.showAssignedTodosOnly&&this.loadAssignedTodosOnly||!this.allSubtasksLoaded&&m.models.customization.get("subtask-"+this.id)||this.itemCollection.noAssigned&&!this.allFetched?(this.loadAssignedTodosOnly=this.showAssignedTodosOnly,this.itemFetchStarted=!0,this.loadAssignedTodosOnly&&(this.allFetched=!0),this.itemCollection.firstLoadCompleted=!1,this.itemCollection.fetch({reset:!0})):m.trigger("todo:showAssignedTodosOnlyChanged",this.id),!m.models.customization.get("assigned-"+this.id)&&m.models.customization.get("subtask-"+this.id)&&(this.allSubtasksLoaded=!0)},refreshShowAssignedTodosOnly:function(){this.showAssignedTodosOnly=m.models.customization.get("assigned-"+this.id)},topMenuItems:function(){return this._topMenuItems||(this._topMenuItems=new m.collect.TopDropdownMenuItems(null,{listId:this.id})),this._topMenuItems},refreshItems:function(){this.doFetchIfNeeded(!0)},doFetchIfNeeded:function(e,t){this.loadedOnce||(this.loadAssignedTodosOnly=!1,this.loadedOnce=!0),!e&&this.itemFetchStarted||(this.itemFetchStarted=!0,this.showAssignedTodosOnly&&(this.loadAssignedTodosOnly=!0)),this.itemCollection.doFetchIfNeeded(t)},triggerChangeEvent:function(e){this.trigger("change",this),m.trigger("todo:globalChange",e)},getDefaultCommands:function(){return this.collection&&1!=this.collection.project.provider.id?[]:this.isDoneList()?[{commandId:"todo.undone",options:{}}]:[{commandId:"todo.toggle.today",options:{}}]},isDoneList:function(){return"done"==this.get("type")},isTodayList:function(){return"today"==this.get("type")},listType:function(){return this.get("type")},displayConnectingText:function(e){},successfulConnection:function(){},failedConnection:function(e){},remainingTodoCount:function(){var e=this.get("count");return null!=e&&null!=e?e:""},remainingCountChanged:function(e){this.get("count")!=e&&this.set("count",e)},changeCount:function(e){if(void 0===this.get("count")){var t=this;setTimeout(function(){t.refreshItems()},500)}else this.set("count",this.get("count")+(e?1:-1)),this.collection&&this.collection.cacheLists()},supportsReordering:function(){return!!this.get("reorder")},groupingInfo:function(){return this.isDoneList()?{type:"date",field:"completedDate"}:this.itemCollection.groupingInfo?this.itemCollection.groupingInfo:null},createNewModel:function(e,t,i){var s={};this.collection&&1!=this.collection.project.provider.id&&(i=!1),(i=i||"top"==this.get("defaultTaskPosition"))&&(s={at:0}),this.addedToTop=i;var o=0;if("bottomOfIncomplete"==this.get("defaultTaskPosition")){for(;o<this.itemCollection.models.length&&!this.itemCollection.models[o].get("done");)o++;s={at:o}}var n=null;e instanceof Backbone.Model?n=e:(e.listId=this.id,this.isDoneList()&&(e.done=!0),this.isTodayList()&&(e.today=!0),e.viewSection=this.get("defaultSection"),n=new m.models.TodoProxy(e),this.proxyCollection.add(n,s)),this.showAssignedTodosOnly&&n.set("assigned",!0),n.set("viewSection",this.get("defaultSection"));var a=this;t?a.displayConnectingText('<i class="loading-icon"></i>Retrying...'):a.displayConnectingText('<i class="loading-icon"></i>Saving...'),n.set({saveFailed:!1,isLoading:!0});var l=this.collection?this.collection.project.getDefaultList():this,r=l?l.get("id"):null,d=a.isDoneList()&&r?r:n.get("listId"),c=null;Object.assign(s,{wait:!0,success:function(e){a.successfulConnection(),i&&1==a.project.provider.id&&c?(c.move_id=e.get("id"),a.waitForReorder=!0,a.itemCollection.reorderItem(c,function(){n.set("proxyValid",!1),a.waitForReorder=!1})):n.set("proxyValid",!1),m.sendEvent("Todo","Add")},error:function(e,t,i){a.failedConnection('Error saving… <span class="retry">Retry</span>'),n.set({saveFailed:!0,isLoading:!1}),n.targetList=a}}),0<a.itemCollection.models.length&&(c={move_target_id:a.itemCollection.models[0].get("id"),move_offset:"-1",list_id:d}),a.itemCollection.create({title:n.get("title"),listId:n.get("listId"),today:n.get("today"),done:n.get("done"),assigned:n.get("assigned"),homeListId:d,viewSection:n.get("viewSection"),providerId:this.project.provider.id,projectId:this.project.id,completedDate:n.get("done")?new Date:null},s)}}),m.models.TodoProject=Backbone.Model.extend({itemFetchStarted:!1,defaults:{selected:!1},initialize:function(e,t){t&&t.provider?this.provider=t.provider:this.get("providerId")&&m.models.todoListManager&&(this.provider=m.models.todoListManager.todoProviderDetails(this.get("providerId"),!0)),this.listCollection=new m.collect.ProjectTodoLists(null,{project:this,prefetchTodos:this.prefetchTodos,isDummy:!(void 0===this.get("supportLists")?this.provider.get("supportLists"):this.get("supportLists"))}),this.listenTo(this,"add",this.onAdd),this.listenTo(this.listCollection,"add remove change reset selectionChanged",this.triggerChangeEvent)},todoItemMenuOptions:function(){return this.listCollection.menuOptions&&(this._todoItemMenuOptions=new Backbone.Collection(this.listCollection.menuOptions)),this._todoItemMenuOptions},topMenuItems:function(){return this._topMenuItems||(this._topMenuItems=new m.collect.TopDropdownMenuItems(null,{listId:this.id})),this._topMenuItems},resetSelection:function(){this.listCollection.selectedListId=null},refreshItems:function(){this.doFetchIfNeeded(!0)},triggerChangeEvent:function(e){this.trigger("change",this),m.trigger("todo:globalChange",e)},doFetchIfNeeded:function(e){!e&&this.fetchStarted||(this.fetchStarted=!0,this.listCollection.doFetchIfNeeded(e))},refreshTodoItems:function(){var e=this.selectedList();e?e.refreshItems():this.listCollection.doFetchIfNeeded(!0)},getDefaultList:function(){return this.getListOfType("inbox")},getDoneList:function(){return this.getListOfType("done")},getListOfType:function(e){return this.listCollection.getListOfType(e)},getListById:function(e){return this.listCollection.getListById(e)},triggerParentChangeEvent:function(){this.trigger("change",this),this.listCollection.doFetchIfNeeded(!0)},selectedList:function(){return this.listCollection?this.listCollection.selectedList():null},projectStatus:function(){if(this.listCollection.listStatus)return this.listCollection.listStatus;var e=this.selectedList();return e?e.listCollection.listStatus:null},addNewList:function(e,t,i){var s=this,o=m.globals.urlRootApi+"todos/lists",n={providerId:m.models.todoListManager.activeProvider.id,projectId:this.id,title:e};$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(n),url:o}).done(function(e){e&&e.success&&s.listCollection.fetch({success:function(){s.selectList(e.id),t&&t()}})}).fail(function(e,t){i&&i()})},selectList:function(e){this.listCollection.selectItem(e),this.provider.trigger("change",this.provider)},getNeighboringList:function(e){if(this.listCollection){var t=this.listCollection.selectedList();if(t){var i=this.listCollection.indexOf(t);if(0<e&&i<this.listCollection.length-1||e<0&&0<i)return this.listCollection.at(i+e)}}return null},selectPreviousList:function(){var e=this.getNeighboringList(-1);e&&this.selectList(e.id)},selectNextList:function(){var e=this.getNeighboringList(1);e&&this.selectList(e.id)}}),m.models.TodoProvider=Backbone.Model.extend({fetchStarted:!1,initialize:function(e){this.prefetchTodos=this.get("prefetchTodos"),void 0===e.supportLists&&(this.attributes.supportLists=!0,this.attributes.supportProjects=!1),this.projectCollection=new m.collect.ProviderTodoProjects(null,{provider:this,prefetchTodos:this.prefetchTodos,isDummy:!this.get("supportProjects")}),this.get("supportProjects")&&(this.allProjectsCollection=new m.collect.ProviderTodoProjectsAll(null,{provider:this})),this.listenTo(this.projectCollection,"reset",this.projectsAvailable),this.get("supportProjects")&&this.listenTo(this.allProjectsCollection,"sync",this.projectsAvailableSynced),this.listenTo(this,"add",this.onAdd),this.listenTo(m,"globalEvent:altUp",this.altReleased),this.listenTo(this.projectCollection,"reset selectionChanged",this.triggerChangeEvent)},isProviderModel:function(){},refreshItems:function(){this.projectCollection.fetch({reset:!0})},doFetchIfNeeded:function(e){!e&&this.fetchStarted||(this.fetchStarted=!0,this.projectCollection.doFetchIfNeeded(e))},getAllProjects:function(){if(this.allProjectsCollection&&0<this.allProjectsCollection.length)return this.allProjectsCollection;var e=localStorage.getItem("cachedTodoProjects-"+this.id);return!e||this.loadingFromCache||this.allProjectsCollection.loading?this.refreshAllProjects():(this.loadingFromCache=!0,this.allProjectsCollection.reset(JSON.parse(e)),this.loadingFromCache=!1),this.allProjectsCollection},projectsAvailableSynced:function(){var s=this;this.projectCollection.models.map(function(e,t){var i=s.allProjectsCollection.findWhere({id:e.get("id")});i?e.set("title",i.get("title")):(s.projectCollection.models.splice(t,1),s.projectCollection.length--)}),this.cacheAllProjects(),m.trigger("todo:allProjectsLoaded")},refreshAllProjects:function(e){this.allProjectsCollectionSynced||(this.allProjectsCollectionSynced=!0,this.allProjectsCollection&&this.allProjectsCollection.doFetchIfNeeded(e)&&m.trigger("todo:allProjectsLoaded"))},cacheAllProjects:function(){var e=new Date;localStorage.setItem("tsCachedTodoProjects-"+this.id,JSON.stringify(e.getTime()));var t=this.allProjectsCollection.toJSON();localStorage.setItem("cachedTodoProjects-"+this.id,JSON.stringify(t))},projectsAvailable:function(){this.selectedProject()&&this.selectedProject().doFetchIfNeeded()},refreshTodoItems:function(){var e=this.selectedProject();e?e.refreshTodoItems():this.doFetchIfNeeded(!0)},getDefaultList:function(){return this.getListOfType("inbox")},getDoneList:function(){return this.getListOfType("done")},getListOfType:function(e){return this.selectedProject().getListOfType(e)},getListById:function(e){return this.selectedProject().getListById(e)},triggerChangeEvent:function(){this.trigger("change",this)},triggerParentChangeEvent:function(){this.trigger("change",this),this.projectCollection.doFetchIfNeeded(!0)},selectedList:function(){var e=this.selectedProject();return e?e.selectedList():null},selectedProject:function(){return this.projectCollection?this.projectCollection.selectedProject():null},providerStatus:function(){if(this.projectCollection.projectStatus)return this.projectCollection.projectStatus;var e=this.selectedProject();if(e&&e.listCollection.projectStatus)return e.listCollection.projectStatus;var t=this.selectedList();return t?t.itemCollection.listStatus:null},selectList:function(e){this.selectedProject().selectList(e)},selectProject:function(e,t){var i=this.projectCollection.get(e);i?(this.projectCollection.selectItem(e),t&&i.set({last_active:(new Date).toISOString()})):this.allProjectsCollection&&(i=this.allProjectsCollection.get(e))&&(this.projectCollection.add(i),this.projectCollection.selectItem(e),t&&i.set({last_active:(new Date).toISOString()})),t&&m.trigger("todo:resetProjectList")},getNeighboringProject:function(e){var t=this.projectCollection;if(t=t.sortBy("last_active").reverse()){var i=this.selectedProject();if(i){var s=t.indexOf(i);if(0<e&&s<t.length-1||e<0&&0<s)return t[s+e]}}return null},selectPreviousProject:function(){this.altReleased=!1;var e=this.getNeighboringProject(-1);e&&(this.watchingAlt=!0,this.selectProject(e.id,!1))},selectNextProject:function(){this.altReleased=!1;var e=this.getNeighboringProject(1);e&&(this.watchingAlt=!0,this.selectProject(e.id,!1))},altReleased:function(){(this.altReleased=!0,this.watchingAlt)&&(this.selectedProject().set({last_active:(new Date).toISOString()}),m.trigger("todo:resetProjectList"))}}),m.collect.TodoProxy=Backbone.Collection.extend({model:m.models.TodoProxy,initialize:function(e,t){t&&t.parentList&&(this.parentList=t.parentList)}}),m.collect.TodosBase=Backbone.Collection.extend({model:m.models.Todo,saveOptions:{},initialize:function(e,t){t&&t.parentList&&(this.parentList=t.parentList),localStorage.showTodoList||(localStorage.showTodoList=!1),this.listenTo(m,"newDay",this.onNewDay),this.listenTo(this,"reset",this.onReset),this.listenTo(this,"sync",this.onSync),this.listenTo(this,"add remove change",this.collectionChanged),this.listenTo(this,"reorder",this.reorderItem)},onReset:function(){this.fetchedOnce=!0,this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onSync:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged"),m.trigger("todo:listSync")},onNewDay:function(){this.fetchedOnce&&(this.parentList&&m.models.todoListManager&&m.models.todoListManager.activeProvider.selectedList().id!==this.parentList.id||this.fetch({reset:!0}))},onLoadingFromServerChanged:function(){},clearCompleted:function(){},collectionChanged:function(e){localStorage.setItem("todos-updated",new Date),this.onCollectionChanged(e)},onCollectionChanged:function(e){},completeToday:function(){var o=this;return this.filter(function(e){var t=e.get("completedDate");if(t){var i="";if(t instanceof Date)i=activeDateStringForDate(t);else{var s=t.split("T");if(1<s.length)i=s[0]}if(i!=getActiveDateString())return!1}if(1==e.get("done")&&0==e.get("archive")&&0==e.get("deleted")&&e.get("listId")==o.parentList.id)return!0})},completedCount:function(){return this.completeToday().length},activeToday:function(){var i=this;return this.parentList.isDoneList()?this.where({deleted:!1,done:!0}):this.filter(function(e){if(0==e.get("archive")&&0==e.get("deleted")){var t=e.get("listId");if(t==i.parentList.id||!t)return!0;if("1-##default"==i.parentList.id)return!0}})},done:function(){return this.where({done:!0})},deleted:function(){return this.where({deleted:!0})},remaining:function(){var e=this.activeToday();return this.parentList.isDoneList()?e:_.filter(e,function(e){return!e.get("done")})},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",create:function(e,t){return null==e.order&&(e.order=this.nextOrder()),Backbone.Collection.prototype.create.call(this,e,t)},reorderItem:function(e){},hasValidCachedCompletedCount:function(){return!0}}),m.collect.ProjectTodoLists=Backbone.Collection.extend({model:m.models.TodoList,url:m.globals.urlRoot+"todos/lists",loadedFromCache:!1,listStatus:null,initialize:function(e,t){if(this.listenTo(this,"reset",this.collectionChanged),this.listenTo(this,"sync",this.collectionSync),this.listenTo(this,"change:count",this.handleCountChanged),this.listenTo(m,"globalEvent:resetLists",this.resetLists),this.project=t.project,t)if(this.project=t.project,t.isDummy)this.setAsDummy();else{t.prefetchTodos&&(this.externallyFetchedOnce=!0),t.provider&&(this.provider=t.provider);var i=this.listCacheKey(),s=localStorage[i];if(s){var o=JSON.parse(s);o&&0<o.length&&(this.loadedFromCache=!0,this.reset(o,{project:this.project}))}}},comparator:"order",resetLists:function(e){(!e||e.providerId==(this.provider||this.project.provider).id||e.listId&&this.get(e.listId))&&this.fetch()},setAsDummy:function(){this.isDummy=!0,this.models=[],this.models.push(new m.models.TodoList({id:this.project.get("id"),title:this.project.get("title"),isDummy:!0},{project:this.project}))},mergeLists:function(e){var t=e;e&&e.lists&&(t=e.lists);var i=this,s=this.selectedList();if(0==t.length?_.each(t,function(e){i.add(e,{merge:!0})}):this.set(t,{merge:!0}),!this.contains(s)){var o=this.models[0];this.selectItem(o.id)}},listCacheKey:function(){return this.project?"listCache-"+this.project.id:"listCache-default"},selectedListCacheKey:function(){return this.project?"activeTodoListId-"+this.project.id:null},cacheLists:function(){var e=JSON.stringify(this.models),t=this.listCacheKey();localStorage[t]=e},doFetchIfNeeded:function(e){this.isDummy&&(this.selectedList().doFetchIfNeeded(),this.trigger("reset")),this.forceFetch=!0,this.externallyFetchedOnce=!0,this.loadedFromCache?this.fetch():this.fetch({reset:!0})},parse:function(e){if(null!=e)return e.setAsDummy?(this.setAsDummy(),this.doFetchIfNeeded(!0),[]):(e.aux_data_cmd&&(this.aux_data_cmd=e.aux_data_cmd),e.aux_data&&(this.aux_data=e.aux_data),e.providerReset&&m.models.todoListManager.resetProvider(e.providerReset),e.lists)},handleCountChanged:function(){this.checkSelectedList(),this.cacheLists()},collectionSync:function(){this.setStatus("Done"),this.checkSelectedList(this.forceFetch),this.forceFetch=!1,this.cacheLists()},setStatus:function(e){this.listStatus=e,m.trigger("todo:loadingStateChange",e)},fetch:function(e){var s=this;if(!this.isDummy){var t=e||{};if(this.project){var i={},o=this.project.get("providerId");i.data={provider_id:o,project_id:this.project.get("id")},m.models.customization.get("archived-"+o)&&(i.data.loadArchived=!0),t=_.extend(t,i)}return t.error=function(e,t,i){this.externallyFetchedOnce=!0,403==t.status&&t.responseJSON&&t.responseJSON.status&&"authRequired"==t.responseJSON.status?s.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:t.responseJSON}):s.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},t&&null!=t.reset?this.setStatus({status:"loading",message:"Loading..."}):this.listStatus&&"loading"!=this.listStatus.status&&this.setStatus({status:"loading",message:"Loading..."}),t.project=this.project,Backbone.Collection.prototype.fetch.call(this,t)}setTimeout(function(){s.trigger("reset")})},collectionChanged:function(){this.setStatus(null),this.checkSelectedList(this.forceFetch),this.forceFetch=!1},selectedList:function(){var e;if(this.selectedListId&&this.get(this.selectedListId))e=this.get(this.selectedListId);else{if(!(e=this.findWhere({selected:!0}))&&(e=this.getListOfType("today"))){var t=this.getListOfType("inbox");t&&t.doFetchIfNeeded()}e||(e=this.getListOfType("inbox")),e?this.selectItem(e.id):this.models.length&&(e=this.models[0],this.selectItem(e.id)),!e&&this.models.length&&(e=this.models[0])}return e?(this.selectItem(e.id),e):null},getListOfType:function(e){return this.findWhere({type:e})},getListById:function(e){return this.findWhere({id:e})},unselectedLists:function(){var t=this;return this.selectedListId?this.reject(function(e){return e.id==t.selectedListId}):this.toArray()},isDoneList:function(){var e=this.selectedList();return!(!e||!e.get("done"))},checkSelectedList:function(e){if(!this.selectedListId){var t=null,i=this.selectedListCacheKey();if(i&&localStorage.getItem(i)){var s=localStorage.getItem(i);t=this.findWhere({id:s})}t||(t=this.findWhere({selected:!0})),!t&&0<this.models.length&&(t=this.models[0]),t?this.selectItem(t.id):this.selectItem(null)}},selectItem:function(e){if(e!=this.selectedListId){var t=this.selectedListCacheKey();t&&localStorage.setItem(t,e),this.selectedListId=e,this.project.triggerChangeEvent("Selected"),this.project.provider.triggerChangeEvent(),null!=e&&this.externallyFetchedOnce&&this.selectedList().doFetchIfNeeded(!1,!0)}}}),m.collect.ProviderTodoProjectsAll=Backbone.Collection.extend({model:m.models.TodoProject,url:m.globals.urlRoot+"todos/projects/all",loadedFromCache:!1,projectStatus:null,initialize:function(e,t){this.listenTo(this,"sync",this.collectionSync),this.provider=t.provider},comparator:"order",collectionSync:function(){this.loaded=!0,this.loading=!1},mergeProjects:function(e){var t=e;e&&e.projects&&(t=e.projects);var i=this,s=this.selectedProject();if(0==t.length?_.each(t,function(e){i.add(e,{merge:!0})}):this.set(t,{merge:!0}),!this.contains(s)){var o=this.models[0];this.selectItem(o.id)}},doFetchIfNeeded:function(e){return e||!this.loaded&&!this.loading?(this.fetch(),!(this.loading=!0)):!!this.loaded||void 0},parse:function(e){return e.aux_data_cmd&&(this.aux_data_cmd=e.aux_data_cmd),e.aux_data&&(this.aux_data=e.aux_data),e.projects},fetch:function(e){var t=this,i=e||{};if(i.reset=!0,this.provider){var s={};s.data={provider_id:this.provider.id},m.models.customization.get("archived-"+this.provider.id)&&(s.data.loadArchived=!0),i=_.extend(i,s)}return i.error=function(){t.loading=!1,m.trigger("todo:failedLoadingItems")},this.reset(null,{silent:!0}),Backbone.Collection.prototype.fetch.call(this,i)}}),m.collect.ProviderTodoProjects=Backbone.Collection.extend({model:m.models.TodoProject,url:m.globals.urlRoot+"todos/projects",loadedFromCache:!1,projectStatus:null,initialize:function(e,t){if(this.listenTo(this,"reset",this.collectionChanged),this.listenTo(this,"sync",this.collectionSync),this.listenTo(this,"add",this.cacheProjects),this.listenTo(this,"change:count",this.handleCountChanged),this.listenTo(m,"globalEvent:resetLists",this.fetch),this.provider=t.provider,t&&t.isDummy){this.isDummy=!0,this.models=[];var i=new m.models.TodoProject({id:this.provider.get("id"),title:this.provider.get("title"),isDummy:!this.provider.get("supportProjects"),providerId:this.provider.get("id")},{provider:this.provider});this.models.push(i)}t&&t.prefetchTodos&&(this.externallyFetchedOnce=!0),t&&t.allProjects&&(this.allProjects=!0,this.url+="/all");var s=this.projectCacheKey(),o=localStorage[s];if(o){var n=JSON.parse(o);n&&0<n.length&&(this.loadedFromCache=!0,this.reset(n,{provider:this.provider}))}},comparator:"order",mergeProjects:function(e){var t=e;e&&e.projects&&(t=e.projects);var i=this,s=this.selectedProject();if(0==t.length?_.each(t,function(e){i.add(e,{merge:!0})}):this.set(t,{merge:!0}),!this.contains(s)){var o=this.models[0];this.selectItem(o.id)}},fetchSelectedProject:function(){var e=this.selectedProject();e&&e.doFetchIfNeeded()},projectCacheKey:function(){return this.provider?"projectCache-"+this.provider.id:"projectCache-default"},selectedProjectCacheKey:function(){return this.provider?"activeTodoProjectId-"+this.provider.id:null},cacheProjects:function(){var e=JSON.stringify(this.models),t=this.projectCacheKey();localStorage[t]=e},doFetchIfNeeded:function(e){this.forceFetch=!0,this.externallyFetchedOnce=!0,this.loadedFromCache?this.fetch():this.fetch({reset:!0})},parse:function(e){return e.aux_data_cmd&&(this.aux_data_cmd=e.aux_data_cmd),e.aux_data&&(this.aux_data=e.aux_data),e.projects},handleCountChanged:function(){this.checkSelectedProject(),this.cacheProjects()},collectionSync:function(){this.setStatus(null),this.checkSelectedProject(this.forceFetch),this.forceFetch=!1,this.cacheProjects()},setStatus:function(e){this.projectStatus=e,m.trigger("todo:loadingStateChange",e)},fetch:function(e){var s=this;if(!this.isDummy){var t=e||{};if(this.provider){var i={};i.data={provider_id:this.provider.id},t=_.extend(t,i)}return t.error=function(e,t,i){this.externallyFetchedOnce=!0,403==t.status&&t.responseJSON&&t.responseJSON.status&&"authRequired"==t.responseJSON.status?s.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:t.responseJSON}):s.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},t&&null!=t.reset?this.setStatus({status:"loading",message:"Loading..."}):this.projectStatus&&"loading"!=this.projectStatus.status&&this.setStatus({status:"loading",message:"Loading..."}),Backbone.Collection.prototype.fetch.call(this,t)}setTimeout(function(){s.trigger("reset")})},collectionChanged:function(){this.setStatus(null),this.checkSelectedProject(this.forceFetch),this.forceFetch=!1},selectedProject:function(){var e;return this.selectedProjectId&&this.findWhere({id:this.selectedProjectId})?this.findWhere({id:this.selectedProjectId}):((e=this.findWhere({selected:!0}))?this.selectItem(e.id):this.models.length&&(e=this.models[0],this.selectItem(e.id)),e||null)},getProjectById:function(e){return this.findWhere({id:e})},checkSelectedProject:function(e){if(!this.selectedProjectId){var t=null,i=this.selectedProjectCacheKey();if(i&&localStorage.getItem(i)){var s=localStorage.getItem(i);t=this.findWhere({id:s})}if(t||(t=this.findWhere({selected:!0})),!t&&0<this.models.length)return t=this.models[0],void this.selectItem(t.id);t?this.selectItem(t.id):this.selectItem(null)}},selectItem:function(e){if(e!=this.selectedProjectId){var t=this.findWhere({id:this.selectedProjectId});t&&t.resetSelection();var i=this.selectedProjectCacheKey();i&&localStorage.setItem(i,e),this.selectedProjectId=e,this.trigger("selectionChanged"),null!=e&&this.externallyFetchedOnce&&this.selectedProject().doFetchIfNeeded()}}}),m.collect.Todos=m.collect.TodosBase.extend({url:m.globals.urlRoot+"todos",previousCount:-1,saveOptions:{patch:!0},listStatus:null,firstLoadCompleted:!1,reorderItem:function(e,t){var i=this,s={operations:[{REORDER:Object.assign({},e)}]},o=this.get(e.move_id);if(o){o.set({isLoading:!0});var n=o.collection.parentList.project;s.providerId=n.provider.id,s.projectId=n.id,$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(s),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){o.set({isLoading:!1}),i.fetch({success:t})}).fail(function(e,t){o.pendingReorderData=s,o.set({saveFailed:!0,isLoading:!1})})}},onLoadingFromServerChanged:function(){this.setStatus("Done"),this.checkRemainingItemCount()},onCollectionChanged:function(e){this.checkRemainingItemCount()},completedCount:function(){return this.completeToday().length},checkRemainingItemCount:function(){if(!this.loadingFromServer){this.firstLoadCompleted=!0;var e=this.remaining().length;e!=this.previousCount&&(this.previousCount=e,this.trigger("remainingCountChanged",e))}},doFetchIfNeeded:function(e){this.firstItemFetchStarted?this.fetch(this.moreLoaded?{remove:!1,listChanged:e}:{listChanged:e}):(this.firstItemFetchStarted=!0,this.fetch({reset:!0}))},loadMore:function(e){this.moreLoaded=!0,this.todoChangedListener||(this.todoChangedListener=!0,this.listenTo(m,"todo:changed",this.todoChanged)),this.fetch({endDate:e,remove:!1})},setStatus:function(e){this.listStatus=e,m.trigger("todo:loadingStateChange",e)},parse:function(e){if(null!=e)return e.items?(e.sections?this.itemSections=e.sections:this.itemSections=null,e.hasOldTodos?this.hasOldTodos=e.hasOldTodos:this.hasOldTodos=!1,e.menu_options?this.menuOptions=e.menu_options:this.menuOptions=null,e.default_commands?this.defaultCommands=e.default_commands:this.defaultCommands=null,this.noAssigned=e.noAssigned,this.groupingInfo=e.groupingInfo,e.items):e},todoChanged:function(e){if(this.moreLoaded){var t=this.get(e);t&&t.fetch()}},activeToday:function(){var i=this;if(!this.firstItemFetchStarted)return this.parentList.doFetchIfNeeded(),[];if(this.parentList.isDoneList()){if(i.parentList.showAssignedTodosOnly&&!item.get("assigned"))return;return this.where({deleted:!1,done:!0})}return this.filter(function(e){if((!i.parentList.showAssignedTodosOnly||e.get("assigned"))&&(!e.get("today")||i.parentList.isTodayList())&&(e.get("today")||!i.parentList.isTodayList())&&e.get("title")&&0!=e.get("title").length&&0==e.get("archive")&&0==e.get("deleted")){var t=e.get("listId");if(t==i.parentList.id||e.get("today")&&i.parentList.isTodayList()||!t)return!0;if("1-##default"==i.parentList.id)return!0}})},fetch:function(e){var s=this;if(!this.loadingFromServer){this.loadingFromServer=!0;var t={data:{}};return this.parentList&&(t.data.listId=this.parentList.id),this.parentList.project&&!this.parentList.project.get("isDummy")&&(t.data.projectId=this.parentList.project.get("id"),t.data.providerId=this.parentList.project.provider.get("id")),m.models.customization.get("assigned-"+this.parentList.id)&&(t.data.loadMineOnly=!0),m.models.customization.get("subtask-"+this.parentList.id)&&(t.data.loadSubtasks=!0),m.models.customization.get("showOld-"+this.parentList.id)&&(t.data.loadOldCompleted=!0),e&&e.endDate&&(t.data=t.data||{},t.data.endDate=e.endDate),t.error=function(e,t,i){s.loadingFromServer=!1,403==t.status&&t.responseJSON&&t.responseJSON.status&&"authRequired"==t.responseJSON.status?s.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:t.responseJSON}):s.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},(e=_.extend(e||{},t))&&null!=e.reset?(this.setStatus({status:"loading",message:"Loading...",listChanged:e.listChanged}),this.moreLoaded=!1):this.listStatus&&"loading"!=this.listStatus.status&&this.setStatus({status:"loading",message:"Loading...",listChanged:e.listChanged}),Backbone.Collection.prototype.fetch.call(this,e)}}}),m.collect.TodoProviders=Backbone.Collection.extend({model:m.models.TodoProvider,url:m.globals.urlRoot+"todos/providers",loadedOnce:!1,initialize:function(e,t){this.listenTo(this,"reset",this.collectionReset)},collectionReset:function(){this.loadedOnce=!0},parse:function(e){return e.connected?e.connected:null}}),m.models.TodoListManager=Backbone.Model.extend({mergeLists:function(e){},defaults:{activeTodoList:null},initialize:function(e){if(e&&e.prefetchTodos&&(this.prefetchTodos=!0),this.todoProviders=new m.collect.TodoProviders,this.listenTo(m,"globalEvent:refreshInbox",this.refreshInbox),this.listenTo(this.todoProviders,"reset",this.todoProvidersReset),localStorage.activeTodoProvider){var t=JSON.parse(localStorage.activeTodoProvider);t&&t.id?this.changeProvider(t.id,!0,t):t?this.changeProvider(t,!0):this.changeProvider(1,!0)}else this.changeProvider(1,!0)},refreshInbox:function(){this.activeProvider.selectedProject().getDefaultList()&&this.activeProvider.selectedProject().getDefaultList().refreshItems()},triggerChangeEvent:function(){this.trigger("change",this)},doFetchIfNeeded:function(e){this.externallyFetchedOnce=!0,this.activeProvider.doFetchIfNeeded(e)},changeProvider:function(e,t){var i=this.todoProviderDetails(e,!0);if(!i){var s={id:e,prefetchTodos:this.prefetchTodos};1==e&&(s.add_lists=!0,s.supportLists=!0,s.supportProjects=!1),this.todoProviders.add(s),this.todoProviders.fetch({reset:!0}),i=this.todoProviders.get(e)}null==i.get("supportProjects")&&(i.set("supportProjects",!1),i.set("supportLists",!0)),i&&this.activeProvider!=i&&(m.trigger("todo:topmenu:reset"),localStorage.activeTodoProvider=JSON.stringify(i.id),this.activeProvider&&this.stopListening(this.activeProvider),this.activeProvider=i,this.listenTo(this.activeProvider,"change",this.triggerChangeEvent),this.triggerChangeEvent(),(this.externallyFetchedOnce||this.prefetchTodos)&&this.activeProvider.refreshTodoItems(),m.trigger("todo:providerChanged",e))},switchProject:function(e){this.activeProvider.selectProject(e,!0)},todoProvidersReset:function(){this.pendingResetCallback&&(this.pendingResetCallback(),this.pendingResetCallback=null)},resetProvider:function(e){-1<(e.id+"").indexOf(this.activeProvider.id)&&this.todoProviders.remove(this.activeProvider),this.todoProviders.add(e),this.fetchAndCacheTodoProviders(),this.changeProvider(e.id)},todoProviderDetails:function(e,t){var i;if(this.todoProviders){if(0<this.todoProviders.length&&(i=this.todoProviders.get(e)))return i;if(this.cachedTodoProviders){if(!(i=this.cachedTodoProviders.findWhere({id:e+""}))){var s=e+"-";this.cachedTodoProviders.forEach(function(e){0<=e.id.indexOf(s)&&(i=e)})}if(i)return t&&!i.isProviderModel&&(this.cachedTodoProviders.remove(i),i=new m.models.TodoProvider(i.attributes),this.cachedTodoProviders.add(i)),i}if(localStorage.cachedTodoProviders){var o=JSON.parse(localStorage.cachedTodoProviders);this.cachedTodoProviders=new Backbone.Collection;if(this.cachedTodoProviders.reset(o),i=this.cachedTodoProviders.get(e+"")){if(localStorage.tsCachedTodoProviders){var n=new Date,a=JSON.parse(localStorage.tsCachedTodoProviders);new Date(a)<new Date(n.getTime()-864e5)&&this.fetchAndCacheTodoProviders()}else this.fetchAndCacheTodoProviders();return t&&(this.cachedTodoProviders.remove(i),i=new m.models.TodoProvider(i.attributes),this.cachedTodoProviders.add(i)),i}}return this.fetchAndCacheTodoProviders(),null}},fetchAndCacheTodoProviders:function(e){var t=this;this.fetchingTodoProviders||(this.fetchingTodoProviders=!0,this.pendingResetCallback=function(){t.cacheTodoProviders(),e?e():t.triggerChangeEvent()},this.todoProviders.fetch({reset:!0}))},cacheTodoProviders:function(){if(this.todoProviders&&this.todoProviders.loadedOnce){var e=new Date;localStorage.setItem("tsCachedTodoProviders",JSON.stringify(e.getTime()));var t=this.todoProviders.toJSON();localStorage.setItem("cachedTodoProviders",JSON.stringify(t))}},selectPreviousProvider:function(){var s=this,e=function(){var e=s.todoProviders.get(s.activeProvider.id);if(e){var t=s.todoProviders.indexOf(e);if(0<t){var i=s.todoProviders.at(t-1);i&&s.changeProvider(i.id,!0)}}};this.todoProviders&&(this.todoProviders.loadedOnce?e():this.fetchAndCacheTodoProviders(e))},selectNextProvider:function(){var s=this,e=function(){var e=s.todoProviders.get(s.activeProvider.id);if(e){var t=s.todoProviders.indexOf(e);if(t<s.todoProviders.length-1){var i=s.todoProviders.at(t+1);i&&s.changeProvider(i.id,!0)}}};this.todoProviders&&(this.todoProviders.loadedOnce?e():this.fetchAndCacheTodoProviders(e))}}),m.views.TodoDropdownMenu=Backbone.View.extend({template:m.templates.todos.dropdownmenu,expanded:!1,renderedOnce:!1,menuOptionsFetched:!1,events:{"click .dropdown-toggle":"toggleDropdown","dblclick .dropdown-toggle":"eatDblClick","click li":"clickMenuItem","click .show-dropdown-detail":"showDropdownDetail","click .dropdown-detail-back":"hideDropdownDetail","mouseover .project-chooser-dropdown":"removeActiveItemClass","mouseleave .project-chooser-dropdown":"addActiveItemClass","click .failed-loading":"retryLoadingItems","click .dropdown-list":"eatDblClick","dblclick .dropdown-list":"eatDblClick"},initialize:function(e){this.submenu=null,this.menuItems=e.menuItems,this.loadAllOnExpand=e.loadAllOnExpand,this.parentContext=e.parentContext,this.comparisonNode=e.comparisonNode,this.iClassName=e.iClassName,this.dropdownClassName=e.dropdownClassName,this.providerLogo=e.providerLogo,this.keepOpen=e.keepOpen,this.listenTo(this.menuItems,"add remove reset",this.renderMenuOptions),this.listenTo(m,"globalEvent:closeDropdowns",this.closeDropdown),this.listenTo(m,"globalEvent:esc globalEvent:click",this.closeDropdown),this.listenTo(m,"todo:submenuUpdate",this.showDropdownDetail),this.listenTo(this.menuItems,"failedLoadingItems",this.failedLoading),this.listenTo(m,"todo:providerChanged",this.resetMenuItems),this.subViews=[]},render:function(){var e={};e.providerLogo=this.providerLogo,this.iClassName&&(e.iClassName=this.iClassName),"icon-cog"==this.iClassName&&(e.iClassName=""),this.dropdownClassName&&(e.dropdownClassName=this.dropdownClassName);var t=this.template(e);this.$el.html(t),this.$dropdown=$(this.$el.find(".dropdown")[0]),this.$dropdownList=$(this.$el.find(".dropdown-list")[0]),this.$todoProjectDropdown=$(".project-chooser-dropdown .dropdown-list"),this.isOpen&&this.keepOpen&&(this.renderMenuOptions(),this.setExpandedState(!0));var i=this;this.dropdownClassName.includes("project-chooser-dropdown")&&this.$todoProjectDropdown.scroll(function(){i.refreshItems()})},updateModel:function(e){this.model=e},resetMenuItems:function(){this.menuOptionsFetched=!1,this.isLoading=!1,this.itemsRefreshed=!1;var e=this.expanded;delete this.expanded,e&&this.setExpandedState(e)},setExpandedState:function(e,t){if(this.expanded!=e){this.expanded=null!=e?e:!this.expanded,this.$el.toggleClass("active",this.expanded),this.$dropdown.closest(".dropdown-parent").toggleClass("dropdown-parent-active",this.expanded);var i=this;this.expanded?(this.$dropdown.show(),t?(i.$dropdown.css({opacity:1,display:"block"}),this.renderMenuOptions(),i.ensureVisible(i.$dropdown.outerHeight()),this.$dropdown.hasClass("project-chooser-dropdown")&&i.forceScrollableHeight(i.$dropdown)):(i.renderMenuOptions(),i.$dropdown.css({opacity:1,display:"block"}),i.ensureVisible(i.$dropdown.outerHeight()),i.$dropdown.hasClass("project-chooser-dropdown")&&i.forceScrollableHeight(i.$dropdown)),this.isOpen=!0):(this.$dropdown.css("opacity",0),this.hideDropdownDetail(null),this.isOpen=!1,setTimeout(function(){i.$dropdown.css("opacity")<.7&&i.$dropdown.hide()},300))}},forceScrollableHeight:function(e){if(e.find(".dropdown-list").children().length<=7){var t=e.outerHeight();e.addClass("short-list"),e.find(".dropdown-list").css("max-height",t)}else e.removeClass("short-list")},eatDblClick:function(e){e&&(e.preventDefault(),e.stopPropagation())},closeDropdown:function(e){this!=e&&!0===this.expanded&&this.setExpandedState(!1)},attachMenuItems:function(e,t){this.isLoading=!1,this.menuItems&&this.menuItems!=t&&this.stopListening(this.menuItems),this.$el[0]!=e[0]&&(this.setElement(e),this.renderedOnce=!1),this.menuItems!=t&&(this.menuItems=t,this.listenTo(this.menuItems,"add remove reset",this.renderMenuOptions),this.menuOptionsFetched=!1),this.render()},renderMenuOptions:function(){var s=this;if(this.items=this.getActiveMenuOptions(),this.items&&0<this.items.length){this.$dropdownList.html("");var e=this.items.filter(function(e){return m.commandManager.canExecute(e.get("commandId"),s.model,e.get("options"),s.parentContext)}),o=e.length;if(0<o){var n=0,a=null;_.each(e,function(e){var t,i=e.get("css_class");(!i||"line"!=i||"line"!=a&&"header"!=a)&&("line"!=i||0!=n&&n!=o-1?(t=s.buildMenuItem(e),s.$dropdownList.append(t)):n+=1,n+=1,a=i)})}}else 0==this.items&&s.$dropdownList.html('<li class="loading"><i class="loading-icon"></i> Loading...</li>');10<s.$dropdownList.outerHeight(!0)&&(m.trigger("todolist:updateHeight",s.$dropdownList.outerHeight(!0)+5),this.ensureVisible(this.$dropdown.outerHeight(!0))),this.menuOptionsFetched=!0},buildMenuItem:function(e){var t,i=m.commandManager.getProperties(e.get("commandId"),this.model,e.get("options"),this.parentContext);i&&i.captionText&&(t=i.captionText);var s=e.get("css_class"),o=$("<li/>");e.id?o.attr("data-itemid",e.id):o.attr("data-itemid",e.cid),e.get("toolTip")&&o.attr("title",e.get("toolTip"));var n=$("<span/>");if(n.addClass("dropdown-list-label"),n.text(t||e.get("captionText")),o.append(n),e.get("imageUrl")){var a=$("<img />");a.addClass("dropdown-list-icon"),e.get("captionText").includes("GitHub")&&a.addClass("GitHub"),a.attr("src",e.get("imageUrl")),o.prepend(a)}if(e.get("color")){var l=$("<span />");l.html("&nbsp;"),l.addClass("list-color menu-item-color"),l.css("background-color",e.get("color")),o.prepend(l)}if(e.get("todoIcon")&&($svg=e.get("todoIcon"),o.prepend($svg)),e.get("checkStateCmd")){var r=m.commandManager.execute(e.get("checkStateCmd"),this.model,e.get("options"),this.parentContext);e.get("todoIcon")?r?o.children().first().addClass("active"):o.children().first().removeClass("active"):r&&o.prepend('<i class="icon icon-check dropdown-list-icon"></i>')}return s&&o.addClass(s),o},getActiveMenuOptions:function(){return!(this.menuItems&&this.menuItems.fetchIfRequired&&this.menuItems.fetchIfRequired(this.model.collection.provider.id))&&this.menuItems},toggleDropdown:function(e){e&&(e.stopPropagation(),e.preventDefault()),this.expanded||m.trigger("globalEvent:closeDropdowns",this),this.loadAllOnExpand&&!this.expanded&&this.showAllAvailableItems(),this.setExpandedState(!this.expanded)},clickMenuItem:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).data("itemid");if(t&&this.items){var i=this.items.get(t);null==i&&(i=this.submenu.items.get(t));var s=i.get("commandId");if(void 0===s)return;var o=m.commandManager.getCommand(s);isOpen=this.isOpen,this.isOpen=!1;var n=o.execute(this.model,i.get("options"),this.parentContext);this.isOpen=isOpen,o.getSubmenu&&(this.submenu=o.getSubmenu()),i.get("checkStateCmd")&&this.renderMenuOptions(),n||this.closeDropdown(),o.getSubmenu&&this.submenu&&(this.listenTo(this.submenu.items,"sync",this.showDropdownDetail),this.submenu.items.fetchIfRequired&&this.submenu.items.fetchIfRequired(this.parentContext.id),this.showDropdownDetail())}},expandedHeight:function(){return this.expanded?this.$dropdown.outerHeight():0},ensureVisible:function(e){var t=$(this.comparisonNode);if(this.comparisonNode&&this.$dropdown&&this.expanded){var i,s=this.$dropdown.parentsUntil(".todo-item").parent(),o=e;o>t.outerHeight()&&(i=Math.min(o+5,document.body.getBoundingClientRect().height-150),m.trigger("todolist:updateHeight",i));var n=t.offset().top+t.outerHeight()-(s.offset().top+s.outerHeight()+o);n<2?this.$dropdown.css({top:Math.max(t.offset().top-s.offset().top,n+18)+"px",right:"40px"}):this.$dropdown.css({top:"26px"}),this.$dropdown.css({bottom:"auto"}).show()}else this.$dropdown&&!this.expanded&&m.trigger("todolist:updateHeight",0)},showDropdownDetail:function(){if(this.submenu){var s=this,o=$(this.$el.find(".dropdown-detail")[0]);if(o.html(""),this.submenu.items&&0<this.submenu.items.length){o.removeClass("todo-provider-loading"),this.$dropdown.hasClass("todo-actions-dropdown")&&this.$el.find(".dropdown").addClass("provider-submenu");var e=this.submenu.items.length,t=this.submenu.title;t?o.append($('<li class="dropdown-detail-back dropdown-title">'+t+"</li>")):o.append($('<li class="dropdown-detail-back dropdown-list-label"><i class="icon icon-left dropdown-detail-title-back"></i></li>'));if(0<e){var n=null,i=this.submenu.items.models.filter(function(e){return m.commandManager.canExecute(e.get("commandId"),s.model,e.get("options"),s.parentContext)});_.each(i,function(e){var t=e.get("css_class");if(!t||"line"!=t||"line"!=n&&"header"!=n){var i=s.buildMenuItem(e);o.append(i),1,n=t}})}var a=this.$el.find(".dropdown-detail").outerHeight(!0);m.trigger("todolist:updateHeight",a),this.$el.find(".dropdown").addClass("show-detail").height(a),setTimeout(function(){s.ensureVisible(a+20)},0)}else o.addClass("todo-provider-loading"),o.append($('<li class="loading dropdown-detail-back dropdown-title u--no-hover">Loading...</li>')),this.$el.find(".dropdown").addClass("show-detail")}},hideDropdownDetail:function(e){var t=this.$el.find(".dropdown-list").outerHeight(!0);m.trigger("todolist:updateHeight",t+20),this.$el.find(".dropdown").removeClass("show-detail").removeClass("provider-submenu").height("auto");this.ensureVisible(t+20)},removeActiveItemClass:function(){this.$el.find(".active-item").removeClass("highlighted")},addActiveItemClass:function(){this.$el.find(".active-item").addClass("highlighted")},showAllAvailableItems:function(){this.isLoading||(this.isLoading=!0,this.trigger("showAllItems"))},failedLoading:function(){this.menuItems.pop(),this.menuItems.add({captionText:"Trouble connecting... Retry",css_class:"message failed-loading no-icon"})},retryLoadingItems:function(){this.menuItems.pop(),this.menuItems.add({captionText:"Loading...",css_class:"loading-dropdown u--no-hover"}),this.showAllAvailableItems()},refreshItems:function(){this.itemsRefreshed||(this.trigger("refreshItems"),this.itemsRefreshed=!0)}}),m.views.AddTodoList=Backbone.View.extend({tagName:"li",attributes:{class:"todo-list-add-row"},template:m.templates.todos.addtodolist,events:{keyup:"handleKeyup",keydown:"handleKeydown",click:"ignoreClick","click #list-new":"handleClick","blur #list-new":"handleBlur"},initialize:function(e){this.parent=e.parent,this.listenTo(m,"todo:loadingStateChange",this.render),this.adding=!1},render:function(){this.adding=!1,this.$el.html(this.template()),this.$inputNewList=this.$("#list-new"),this.$addListIcon=this.$("#add-icon"),this.$loading=this.$(".todo-list-add-loading");var e=this.model.activeProvider.selectedList();return e&&e.get("add_hidden")?(this.$el.prop("disabled",!0),void this.$el.prop("placeholder","")):(this.$el.is(":disabled")&&(this.$el.prop("disabled",!1),this.$el.prop("placeholder","New List")),this.$loading.hide(),this.$addListIcon.show(),this)},ignoreClick:function(e){e.stopPropagation(),e.preventDefault()},handleClick:function(e){if(e.stopPropagation(),e.preventDefault(),!m.conditionalFeatures.featureEnabled("plus")){this.$inputNewList.blur();return m.commandManager.execute("upsell.message",{targetRegion:"todos",sourceEvent:"todoAddList",buttonText:"Learn more",title:"Multi-todo lists",description:"Create and customize multiple todo lists"}),void m.trigger("globalEvent:closeDropdowns")}this.adding=!0,this.$addListIcon.hide(),this.$el.addClass("input-mode"),this.$inputNewList.attr("placeholder",""),this.focusInputField()},handleBlur:function(e){this.$inputNewList.val()||(this.$inputNewList.attr("placeholder","    New List").val(""),this.$addListIcon.show(),this.$el.removeClass("input-mode"))},cancelEdit:function(e){this.adding=!1,this.$inputNewList.blur(),this.$inputNewList.attr("placeholder","    New List").val(""),this.$addListIcon.show()},createOnEnter:function(e){var t=m.utils.capitalizeFirstLetter(this.$inputNewList.val());t&&0!=t.length&&0!=t.trim().length&&this.model.activeProvider&&(this.$inputNewList.val(""),this.model.activeProvider.selectedProject().addNewList(t,function(){m.trigger("todo:listAdded")}),this.adding=!1,this.$inputNewList.val(""),this.$inputNewList.blur(),this.$loading.show())},focusInputField:function(){this.$inputNewList.focus()},handleKeyup:function(e){13==e.keyCode?this.createOnEnter():27==e.keyCode&&(e.stopPropagation(),this.cancelEdit(),this.$el.blur())},handleKeydown:function(e){}}),m.views.NewTodoInput=Backbone.View.extend({events:{keyup:"handleKeyup",keydown:"handleKeydown"},initialize:function(e){this.parent=e.parent,this.todoList=e.todoList,this.listenTo(m,"todo:loadingStateChange",this.render),this.listenTo(m,"todo:listAdded",this.focusInputField)},render:function(){var e=this.model.activeProvider.selectedList(),t=this.model.activeProvider.selectedProject();if(e){if(e.get("add_hidden"))return this.$el.prop("disabled",!0),void this.$el.prop("placeholder","");if(e.get("todo_type")||t&&t.get("todo_type")){var i="New "+(t.get("todo_type")?t.get("todo_type"):e.get("todo_type"));this.$el.prop("disabled",!1),this.$el.prop("placeholder",i)}else this.$el.prop("disabled",!1),this.$el.prop("placeholder","New Todo")}this.$el.is(":disabled")&&(this.$el.prop("disabled",!1),this.$el.prop("placeholder","New Todo"))},createOnEnter:function(e){if(!this.todoList.isLoading()){var t=this.$el.val();if(t&&0!=t.length&&0!=t.trim().length){var i=this.model.activeProvider.selectedList();if(i){i.changeCount(!0),this.$el[0].value="";var s=e&&(e.ctrlKey||e.metaKey);i.createNewModel({title:t},!1,s)}}}},focusInputField:function(){this.$el.focus()},handleKeyup:function(e){27==e.keyCode&&(e.stopPropagation(),this.$el.blur())},handleKeydown:function(e){var t=null;if(13==e.keyCode?this.createOnEnter(e):32==e.keyCode?t="globalEvent:spacebar":37==e.keyCode?t="globalEvent:arrowLeft":39==e.keyCode&&(t="globalEvent:arrowRight"),t){var i=this.$el.val();i&&0!=i.length&&0!=i.trim().length||(e.preventDefault(),e.stopPropagation(),m.trigger(t,e))}}}),m.views.TodoListHeader=Backbone.View.extend({events:{"mouseenter .active-list-container":"handleHeaderHover","mouseleave .active-list-container":"handleHeaderLeave","click .active-list-container":"handleHeaderClick","click .project-chooser":"toggleProjectDropdown","click .todo-list-choice":"chooseList","click .control-autofocus":"toggleAutoFocus","click .control-assignee":"toggleAssignee","click #status-action":"statusActionClick"},choosing:!1,initialize:function(e){this.listeningTo=null,this.parent=e.parent,this.listenTo(m,"globalEvent:closeDropdowns",this.stopChoosing),this.listenTo(this.model,"change",this.handleManagerChange),this.listenTo(m,"todo:loadingStateChange",this.handleTodoLoadingStateChange),this.listenTo(m,"todo:providerChanged",this.providerChanged),this.listenTo(m,"todo:changed",this.todoChanged),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged),this.listenTo(m.models.customization,"change:assigned-"+this.id,this.showAssignedTodosOnlyChanged),this.listenTo(m,"globalEvent:click",this.globalClick),this.listenTo(m,"todo:status",this.renderActiveItem),this.listenTo(m,"todo:topmenu:reset",this.topMenuReset),this.listenTo(m,"todo:resetProjectList",this.resetProjectList),this.listenTo(m,"todo:allProjectsLoaded",this.prepareProjectList),this.defaultColor="rgba(0,0,0,0)",this.model.activeProvider.selectedProject()&&(this.activeList=this.model.activeProvider.selectedProject().listCollection)},render:function(e){var t=this.activeList;t&&this.listeningTo!==t&&(this.listenTo(t,"change",this.handleCollectionChange),this.listeningTo&&this.stopListening(this.listeningTo,"change"),this.listeningTo=t),this.model.activeProvider.get("supportProjects")&&this.prepareProjectList(),this.renderActiveItem(e),this.$activeContainer=this.$el.closest(".header"),this.$chooserContainer=this.$(".list-chooser"),this.model.activeProvider.selectedProject()&&this.renderListChooser(this.model.activeProvider.selectedProject().listCollection,this.$chooserContainer,"todo-list-choice");var i=this.model.todoProviderDetails(this.model.activeProvider.id);if(i){if(this.$el.closest(".todo").removeClass(this.providerClass),i.get("provider_title")){var s=i.get("provider_title").indexOf("-");this.providerClass="todo-"+i.get("provider_title").substring(0,0<s?s:i.get("provider_title").length)}this.$el.closest(".todo").addClass(this.providerClass)}},handleHeaderHover:function(e){this.$(".project-chooser").addClass("hover")},handleHeaderLeave:function(e){this.$(".project-chooser").removeClass("hover")},handleHeaderClick:function(e){$(e.currentTarget.parentElement).hasClass("show-external")?(this.handleIconHoverOff(),this.visitExternal()):this.toggleChooser(e,!this.model.activeProvider.get("supportLists"))},visitExternal:function(e){var t=this.model.activeProvider.selectedList().get("url");t||(t=this.providerUrl),getBrowser().tabs.create({url:t})},toggleChooser:function(e,t){e&&(e.preventDefault(),e.stopPropagation()),1<this.model.activeProvider.selectedProject().listCollection.length&&(m.trigger("globalEvent:closeDropdowns",this),this.setChoosingState(!this.choosing)),t&&this.toggleProjectDropdown()},toggleProjectDropdown:function(e){e&&(e.preventDefault(),e.stopPropagation()),this.model.activeProvider.get("supportProjects")&&this.projectDropdownView.toggleDropdown()},globalClick:function(e){e!=this&&this.setChoosingState(!1)},todoChanged:function(e,t){t&&(t.hasOwnProperty("done")||t.hasOwnProperty("listId"))&&this.renderActiveItem()},topMenuReset:function(){this.topMenuDropdownView&&this.topMenuDropdownView.resetMenuItems()},autoFocusChanged:function(e){this.renderActiveItem()},showAssignedTodosOnlyChanged:function(){this.renderActiveItem()},setChoosingState:function(e){if(this.choosing!=e)if(this.choosing=e,this.$(".active-list-container").toggleClass("active",this.choosing),this.choosing){this.$el.closest(".app").css("overflow-y","auto"),m.trigger("todolist:updateHeight",this.$chooserContainer.height());var t=this;setTimeout(function(){t.$chooserContainer.show()},30)}else this.$el.closest(".app").css("overflow-y","hidden"),m.trigger("todolist:updateHeight",0),this.$chooserContainer.hide()},expandedHeight:function(){var e=0,t=0;return this.choosing&&(e=this.$chooserContainer.outerHeight()),this.topMenuDropdownView&&(t=this.topMenuDropdownView.expandedHeight()),_.max([e,t])},stopChoosing:function(e){m.views;e!=this&&e!=m.views.todoPane&&this.setChoosingState(!1)},chooseList:function(e){e&&e.stopPropagation(),this.stopChoosing();var t=$(e.currentTarget).data("list-id");this.model.activeProvider.selectList(t)},chooseProject:function(e){e&&e.stopPropagation(),this.stopChoosing();var t=$(e.currentTarget).data("list-id");this.model.activeProvider.selectProject(t)},statusActionClick:function(e){if(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).data("action");t&&m.commandManager.execute(t,this.lastStatus)}},handleCollectionChange:function(e){var t=e.get("count"),i=this.$el.find("[data-list-id='"+e.id+"']");$(i.find(".todo-count")[0]).text(t);var s=this.model.activeProvider.selectedList();s&&s.id==e.id&&$(this.$el.find(".active-todo-count")[0]).text(t)},handleTodoCountUpdate:function(e,t){var i;if((i=e?this.model.activeProvider.getListById(e):this.model.activeProvider.selectedList())&&i.itemCollection){var s=i.remainingTodoCount();this.$el.find("span.active-todo-count").text(t)}var o=this.$el.find("[data-list-id='"+i.id+"']");$(o.find(".todo-count")[0]).text(s)},renderActiveItem:function(e){if(this.$activeContainer){if(this.model.activeProvider.selectedProject()&&this.model.activeProvider.selectedProject().listCollection){var t={},i={};e||(e=this.model.activeProvider.providerStatus()),e&&"loading"!=(this.lastStatus=e).status&&e.message&&(t.statusMessage=e.message,e.actionMessage&&(t.actionMessage=e.actionMessage),e.action&&(t.action=e.action)),t.supportProjects=this.model.activeProvider.get("supportProjects"),t.no_caps=this.model.activeProvider.get("no_caps");var s=this.model.activeProvider.selectedProject();t.supportLists=void 0===s.get("supportLists")?this.model.activeProvider.get("supportLists"):s.get("supportLists"),this.$el.toggleClass("has-projects",t.supportProjects),this.$el.toggleClass("has-lists",t.supportLists);var o,n,a,l,r,d,c=s.selectedList();if(c){var h=c.get("color");t.color=h?h.indexOf("rgb")<0&&"#"!=h.charAt(0)?"#"+h:h:this.defaultColor,t.listTitle=c.get("title"),t.providerLogo=c.get("small_icon_url"),t.remaining=c.remainingTodoCount()}if(s&&(h=s.get("color"),i.color=h?h.indexOf("rgb")<0&&"#"!=h.charAt(0)?"#"+h:h:this.defaultColor,i.listTitle=s.get("title"),i.providerLogo=s.get("small_icon_url")),!t.providerLogo&&this.model.activeProvider&&1!=this.model.activeProvider.id&&(o=this.model.todoProviderDetails(this.model.activeProvider.id))&&(t.providerLogo=i.providerLogo=o.get("small_icon_url"),t.providerTitle=i.providerTitle=o.get("provider_title"),this.providerUrl=o.get("provider_url")),!this.compareObjects(t,this.lastContext)||!this.compareObjects(i,this.lastParentContext)){this.lastContext=t,this.lastParentContext=i,o=this.model.todoProviderDetails(this.model.activeProvider.id);var u=m.templates.todos.todolistactive(t);c&&(n=c.supportsFeature("assigned"),a=c.supportsFeature("subtask"),l=c.supportsFeature("showComplete"),r=c.supportsFeature("showArchivedProject"),d=c.supportsFeature("archiveCompleted"),m.models.customization.get("assigned-"+c.id)),this.$activeContainer.html(u);var g=[];if(o&&o.attributes.provider_url&&g.push({commandId:"todo.visit.external",captionText:"View in "+o.get("provider_title"),options:{urlField:c&&c.get("url")?"url":null,providerUrl:this.providerUrl},todoIcon:'<span class="todo-action"><svg class="icon icon-external" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 438.536 438.536"><path d="M414.41 24.123C398.333 8.042 378.963 0 356.315 0H82.228C59.58 0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648 0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225c-.001-22.649-8.043-42.021-24.123-58.102zm-48.961 204.279c0 7.994-3.717 13.606-11.136 16.844-2.471.951-4.859 1.427-7.139 1.427-5.134 0-9.418-1.811-12.847-5.424l-41.11-41.112-152.453 152.462c-3.621 3.614-7.9 5.425-12.85 5.425-4.952 0-9.235-1.811-12.851-5.425l-29.121-29.126c-3.617-3.61-5.426-7.901-5.426-12.847 0-4.944 1.809-9.229 5.426-12.843l152.462-152.464-41.113-41.112c-5.902-5.52-7.233-12.178-3.999-19.985 3.234-7.421 8.852-11.136 16.846-11.136h137.037c4.948 0 9.232 1.81 12.854 5.428 3.613 3.614 5.421 7.898 5.421 12.847v137.041z"/></svg></span>',toolTip:"Open in "+o.get("provider_title")}),o&&this.model.activeProvider.get("supportSubtasks")&&g.push({checkStateCmd:"todo.list.check.state.subtasks",commandId:"todo.list.toggle.subtasks",captionText:"Show subtasks"}),g.push({checkStateCmd:"todo.list.check.state.autofocus",commandId:"todo.toggle.autofocus",captionText:"Autofocus",todoIcon:'<span class="todo-action"><svg class="icon icon-autofocus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124.512 124.512" class="icon icon-autofocus"><path d="M113.956 57.006l-97.4-56.2c-4-2.3-9 .6-9 5.2v112.5c0 4.6 5 7.5 9 5.2l97.4-56.2c4-2.401 4-8.2 0-10.5z"/></svg></span>',toolTip:"Automatically set top todo as focus"}),n&&g.push({checkStateCmd:"todo.list.check.state.assigned",commandId:"todo.toggle.assignee",captionText:"Assigned to me",todoIcon:'<span class="todo-action"><svg class="icon icon-assigned" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60"><path d="M9.56 48.67v2.91c0 4.18 13.21 5.35 20.46 5.4s20.46-1.21 20.46-5.4v-2.91a8.11 8.11 0 0 0-4.23-7.12l-7.81-4.26-.21-.12A2.38 2.38 0 0 1 37 35.08v-3l.26-.36a18.89 18.89 0 0 0 2.89-6.15 3.58 3.58 0 0 0 1.35-2.8V19.2a3.59 3.59 0 0 0-.9-2.36v-4.78a8.06 8.06 0 0 0-1.88-5.87C36.93 4.16 33.85 3.1 30 3c-3.83.08-6.91 1.14-8.69 3.17a8.07 8.07 0 0 0-1.88 5.87v4.78a3.59 3.59 0 0 0-.9 2.36v3.6a3.58 3.58 0 0 0 1.35 2.8 18.89 18.89 0 0 0 2.89 6.15l.26.36v3a2.38 2.38 0 0 1-1.24 2.09l-.21.12-7.81 4.26a8.11 8.11 0 0 0-4.21 7.11z"/></svg></span>',toolTip:"Show assigned to me only"}),(a||l||r||d)&&g.push({css_class:"line"}),a&&g.push({checkStateCmd:"todo.list.check.state.subtasks",commandId:"todo.list.toggle.subtasks",captionText:"Show subtasks",todoIcon:'<span class="todo-action"><svg class="icon icon-subtasks" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500"><path d="M36 387c-19 0-36 16-36 35s17 36 36 36 35-17 35-36-16-35-35-35zM36 215c-19 0-36 16-36 35s17 35 36 35 35-16 35-35-16-35-35-35zM164 110h303c18 0 33-14 33-32s-15-33-33-33H164c-18 0-33 15-33 33s15 32 33 32zM36 42C17 42 0 59 0 78s17 35 36 35 35-16 35-35-16-36-35-36zM467 217H164c-18 0-33 15-33 33s15 33 33 33h303c18 0 33-15 33-33s-15-33-33-33zM467 389H164c-18 0-33 15-33 33s15 33 33 33h303c18 0 33-15 33-33s-15-33-33-33z"/></svg></span>'}),l&&g.push({checkStateCmd:"todo.list.check.state.old.todos",commandId:"todo.list.show.old.todos",captionText:"Show all completed tasks",todoIcon:'<span class="todo-action"><svg class="icon icon-check" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 497.5 497.5"><path d="M487.75 78.125c-13-13-33-13-46 0l-272 272-114-113c-13-13-33-13-46 0s-13 33 0 46l137 136c6 6 15 10 23 10s17-4 23-10l295-294c13-13 13-34 0-47z"/></svg></span>'}),r&&g.push({checkStateCmd:"todo.check.state.archived.projects",commandId:"todo.show.archived.projects",captionText:"Show archived projects",todoIcon:'<span class="todo-action"><svg class="icon icon-archive" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 536.461 536.46"><path d="M144.752 263.52c19.603-9.038 38.354-13.559 56.243-13.559h237.548v-45.683c0-17.511-6.283-32.555-18.85-45.118-12.565-12.562-27.596-18.842-45.11-18.842H219.266v-9.136c0-17.511-6.28-32.548-18.842-45.107-12.563-12.562-27.6-18.846-45.111-18.846h-91.36c-17.511 0-32.548 6.283-45.111 18.846C6.279 98.635 0 113.672 0 131.183v274.084c0 .764.049 1.955.144 3.576.094 1.615.144 2.807.144 3.566l1.426-1.704L97.93 297.637c11.61-13.706 27.218-25.081 46.822-34.117z"/><path d="M528.898 290.214c-5.041-2.478-10.797-3.72-17.272-3.72H200.995c-12.562 0-26.219 3.381-40.968 10.14-14.75 6.766-26.219 14.986-34.401 24.701l-95.93 113.059c-5.902 6.662-8.853 12.945-8.853 18.849 0 5.708 2.523 9.802 7.566 12.272 5.043 2.478 10.8 3.716 17.273 3.716h310.64c12.56 0 26.21-3.381 40.963-10.136 14.75-6.756 26.214-14.989 34.399-24.701l95.931-113.059c5.899-6.663 8.846-12.939 8.846-18.849.004-5.707-2.515-9.797-7.563-12.272z"/></svg></span>'}),d&&g.push({commandId:"todo.list.archive",captionText:"Archive completed tasks",todoIcon:'<span class="todo-action"><svg class="icon icon-archive" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 536.461 536.46"><path d="M144.752 263.52c19.603-9.038 38.354-13.559 56.243-13.559h237.548v-45.683c0-17.511-6.283-32.555-18.85-45.118-12.565-12.562-27.596-18.842-45.11-18.842H219.266v-9.136c0-17.511-6.28-32.548-18.842-45.107-12.563-12.562-27.6-18.846-45.111-18.846h-91.36c-17.511 0-32.548 6.283-45.111 18.846C6.279 98.635 0 113.672 0 131.183v274.084c0 .764.049 1.955.144 3.576.094 1.615.144 2.807.144 3.566l1.426-1.704L97.93 297.637c11.61-13.706 27.218-25.081 46.822-34.117z"/><path d="M528.898 290.214c-5.041-2.478-10.797-3.72-17.272-3.72H200.995c-12.562 0-26.219 3.381-40.968 10.14-14.75 6.766-26.219 14.986-34.401 24.701l-95.93 113.059c-5.902 6.662-8.853 12.945-8.853 18.849 0 5.708 2.523 9.802 7.566 12.272 5.043 2.478 10.8 3.716 17.273 3.716h310.64c12.56 0 26.21-3.381 40.963-10.136 14.75-6.756 26.214-14.989 34.399-24.701l95.931-113.059c5.899-6.663 8.846-12.939 8.846-18.849.004-5.707-2.515-9.797-7.563-12.272z"/></svg></span>'}),g.push({css_class:"line"}),g.push({commandId:"todo.switch.feed",captionText:"Switch to...",css_class:"no-icon"}),g.push({commandId:"todo.show.settings",captionText:"Settings",css_class:"no-icon"}),g=new Backbone.Collection(g),c){var p=$(this.$el.find("#todo-top-menu")[0]);this.topMenuDropdownView&&this.lastProvider==this.model.activeProvider?this.topMenuDropdownView.attachMenuItems(p,g):(this.topMenuDropdownView&&(this.topMenuDropdownView.unbind(),this.topMenuDropdownView.remove()),this.topMenuDropdownView=new m.views.TodoDropdownMenu({el:p,iClassName:"icon-cog",dropdownClassName:"todo-actions-dropdown",menuItems:g,model:c,parentContext:this.model.activeProvider})),this.topMenuDropdownView.render();var f=this.$el.find(".project-chooser");this.projectDropdownView?(this.projectDropdownView.dropdownClassName="project-chooser-dropdown",this.projectDropdownView.providerLogo=o?o.get("small_icon_url"):null,this.projectDropdownView.attachMenuItems(f,this.projectMenuCollection)):(this.projectDropdownView=new m.views.TodoDropdownMenu({el:f,loadAllOnExpand:!0,menuItems:this.projectMenuCollection,dropdownClassName:"project-chooser-dropdown",model:c,parentContext:this.project,providerLogo:o?o.get("small_icon_url"):null,keepOpen:!0}),this.listenTo(this.projectMenuCollection,"failedLoadingItems",this.failedLoadingProjects),this.listenTo(this.projectDropdownView,"refreshItems",this.refreshProjects)),this.projectDropdownView.render(),this.lastProvider=this.model.activeProvider,n=c.supportsFeature("assigned"),this.$activeContainer.find(".control-assignee").toggleClass("disabled",!n),this.$activeContainer.find(".control-autofocus").removeClass("disabled"),this.$activeContainer.toggleClass("has-assignee",n),this.$activeContainer.find(".control-assignee").toggleClass("active",1==m.models.customization.get("assigned-"+c.id))}}this.$activeContainer&&this.$activeContainer.find(".control-autofocus").toggleClass("active",m.models.customization.getComputedSetting("autoFocus"));var v=!c||this.model.activeProvider.selectedProject().listCollection.length<=1;this.$activeContainer.find(".list-chooser-toggle").toggle(!v),this.parent.setMaxWidgetHeight(),this.$activeContainer.toggleClass("momentum-todo",1==this.model.activeProvider.id),this.fetchedAllProjects=!1}}else{var w=this;setTimeout(function(){w.renderActiveItem(e)},300)}},compareObjects:function(e,t){return e==t||JSON.stringify(e)==JSON.stringify(t)},prepareProjectList:function(){if(!(this.preparing||this.lastPreparedProjects&&this.lastPreparedProjects==this.model.activeProvider.projectCollection&&this.lastPreparedProjects.models[0]==this.model.activeProvider.projectCollection)){var t=this;this.preparing=!0;var i=this.projectItems=[];this.projectMenuCollection||(this.projectMenuCollection=new Backbone.Collection(i)),this.fetchedAllProjects=!0,this.loadingProjects=!1,this.fetchProjectsFailed=!1;var s=this.lastPreparedProjects=this.model.activeProvider.projectCollection,o=this.model.activeProvider.getAllProjects();if(s&&o){if(sortedProjects=s.sortBy("last_active").reverse(),sortedProjects=_.chain(sortedProjects).first(10).value().filter(function(e){return o.get(e.get("id"))}),sortedAllProjects=o.toArray().filter(function(e){return!s.get(e.get("id"))}),1<this.model.activeProvider.id.length){var e=this.model.activeProvider.get("variant_title")||this.model.activeProvider.get("provider_title");i.push({captionText:e,css_class:"provider-name no-icon"})}var n=this.model.activeProvider.selectedProject();if(n)var a=n.selectedList();i.push({captionText:"Recent",css_class:"section-title no-icon"}),_.map(sortedProjects,function(e){i.push({commandId:"todo.switch.parent.project",captionText:e.get("title"),color:e.get("color"),options:{projectId:e.get("id")},css_class:t.model.activeProvider.get("supportProjects")&&n&&n.id==e.get("id")||a&&e.get("id")==a.id?"active-item no-icon":"no-icon",projectId:e.get("id")})}),5<o.length&&i.push({captionText:"Other",css_class:"section-title empty-list no-icon"}),_.map(sortedAllProjects,function(e){var t;for(t in i)if(i[t].projectId==e.get("id"))return;i.push({commandId:"todo.switch.parent.project",captionText:e.get("title"),color:e.get("color"),options:{projectId:e.get("id")},css_class:"no-icon",projectId:e.get("id")})}),this.projectMenuCollection.set(i,{silent:!0}),this.projectMenuCollection.trigger("reset"),this.fetchedAllProjects=this.loadingProjects=!1,this.preparing=!1}else this.preparing=!1}},resetProjectList:function(){var e=this;setTimeout(function(){e.projectDropdownView.resetMenuItems()},250)},failedLoadingProjects:function(){this.fetchedAllProjects=!1,this.loadingProjects=!1,this.fetchProjectsFailed=!0},renderListChooser:function(o,n,a){if(o){var e=o.toArray();n.html("");var l=null;_.map(e,function(e){var t={};t.listId=e.id,t.title=e.get("title"),t.color=e.get("color"),t.count=e.get("count"),t.class=a;var i=e.get("parentTitle");i&&(t.hasParent=!0,i!=l&&(t.parentTitle=i),l=i),e.id==o.selectedList().get("id")&&(t.class="todo-list-choice-active");var s=m.templates.todos.todolistchoice(t);n.append(s).data("list-id",e.id)});var t=m.models.todoListManager.todoProviderDetails(this.model.activeProvider.get("id"));t&&t.get("add_lists")&&(this.addTodoListView||(this.addTodoListView=new m.views.AddTodoList({model:this.model}),this.listenTo(m,"todo:listAdded",this.stopChoosing)),n.append(this.addTodoListView.render().el),this.addTodoListView.delegateEvents())}},handleManagerChange:function(){if(this.topMenuDropdownView){var e=this.model.activeProvider.selectedList();this.topMenuDropdownView.updateModel(e)}this.render()},handleTodoLoadingStateChange:function(e){e!=this.lastStatus&&this.render(e),this.lastStatus=e},providerChanged:function(){this.fetchedAllProjects=!1,this.loadingProjects=!1,this.fetchProjectsFailed=!1,this.render()},handleIconHoverOn:function(){},handleIconHoverOff:function(){},refreshProjects:function(){this.model.activeProvider.refreshAllProjects()}}),m.views.TodoItem=Backbone.View.extend({attributes:{class:"todo-item"},tagName:"li",template:m.templates.todos.todoitem,events:{"click .todo-item-checkbox":"toggleDone",dblclick:"edit","keypress .editing":"handleInput","keypress .todo-item-title":"handleInput","blur .todo-item-title":"saveEdit","click .error-icon":"retrySave",dragstart:"dragstart",dragenter:"dragenter",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"},editing:!1,renderedOnce:!1,initialize:function(e){this.parent=e.parent,this.provider=e.provider,this.listId=e.list_id,this.menu_options=e.menu_options,this.selectedList=this.provider.selectedList(),this.isDoneList=this.selectedList.isDoneList(),this.isTodayList=this.selectedList.isTodayList(),this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"todo:edit",this.edit),this.listenTo(this.model,"todo:close",this.toggleDone),this.listenTo(this.model,"todo:open",this.toggleDone),this.listenTo(m,"todo:refresh",this.refreshTodo),this.listenTo(m,"todo:set:done",this.setDone),this.listenTo(m,"globalEvent:esc",this.abortEdit)},refreshTodo:function(e){e==this.model.id&&this.model.fetch()},setDone:function(e,t){e==this.model.id&&this.toggleDone()},render:function(){if(this.selectedList=this.provider.selectedList(),this.isDoneList=this.selectedList.isDoneList(),this.isTodayList=this.selectedList.isTodayList(),this.model.get("deleted"))return this.hideTodoItem(),this;if(!this.isDoneList&&(this.model.get("listId")!=this.listId&&(!this.isTodayList||!this.model.get("today"))||this.model.get("archive")))return this.hideTodoItem(),this;if(this.isDoneList&&!this.model.get("done"))return this.hideTodoItem(),this;if(!this.isTodayList&&!this.isDoneList&&this.model.get("today"))return this.hideTodoItem(),this;if(this.isTodayList&&!this.model.get("today"))return this.hideTodoItem(),this;var e=m.utils.captionFormatter(this.model.getValue("title"));if(this.renderedOnce)this.$title.text(e);else{var t={title:e};this.$el.html(this.template(t)),this.$title=this.$el.find(".todo-item-title").first(),this.$checkbox=this.$el.find(".todo-item-checkbox").first(),this.renderedOnce=!0}if(this.$checkbox.prop("checked",this.model.isTrue("done")),this.$el.toggleClass("done",this.model.isTrue("done")),this.$el.toggleClass("loading",this.model.isTrue("isLoading")),this.$el.toggleClass("failed",this.model.isTrue("saveFailed")),this.$el.attr("data-todo-id",this.model.id),this.model.isTrue("isProxy")?(this.$el.toggle(this.model.isTrue("proxyValid")),this.$el.addClass("isproxy"),this.$el.data("cid",this.model.cid)):!this.selectedList.supportsReordering()&&!this.selectedList.get("boardId")||this.model.get("noMove")||this.$el.prop("draggable","true"),this.menu_options&&"subsection"!=this.model.get("viewType")){var i=$(this.$el.find(".dropdown-container")[0]);this.topMenuDropdownView||(this.topMenuDropdownView=new m.views.TodoDropdownMenu({el:i,iClassName:"icon-ellipsis",dropdownClassName:"todo-item-dropdown",menuItems:this.menu_options,model:this.model,parentContext:this.provider,comparisonNode:this.parent.$el})),this.topMenuDropdownView.render()}return"subsection"==this.model.get("viewType")&&this.$el.addClass("todo-subsection"),this.model.get("viewSectionId")&&this.$el.attr("data-view-section-id",this.model.get("viewSectionId")),this},hideTodoItem:function(){this.$el.html(""),this.$el.hide(),this.stopListening(m,"globalEvent:spacebar"),this.parent&&this.parent.checkForEmptyState()},isHidden:function(){return!this.$el.is(":visible")},scrollIntoView:function(){this.parent.isScrolling&&this.$el[0].scrollIntoView(!1)},destroy:function(){this.stopListening(),this.remove(),this.unbind()},abortEdit:function(){this.editing&&(this.parent.toggleScroll(!0),this.$el.removeClass("editing"),this.$title.text(this.originalText),this.setEditable(this.$title,!1),this.editing=!1)},setEditable:function(e,t){e.attr("contentEditable",t),e.closest(".todo-item").attr("draggable",!t)},saveEdit:function(){if(this.editing){this.$el.removeClass("editing"),this.parent.toggleScroll(!0);var e=this.$title.text();e?0==(e=e.trim()).length?this.abortEdit():this.model.attemptSave({title:e}):this.abortEdit(),this.editing=!1,this.setEditable(this.$title,!1),this.parent.updateHeight()}},retrySave:function(){this.model.isTrue("isProxy")?this.model.targetList&&this.model.targetList.createNewModel(this.model,!0):(this.model.attemptedSaveValues||this.model.pendingReorderData)&&this.model.attemptSave()},edit:function(e){this.editing||(this.originalText=this.$title.text(),e&&e.stopPropagation(),this.$el.hasClass("isproxy")||this.$el.hasClass("loading")||this.$el.hasClass("failed")||(this.editing=!0,this.parent.toggleScroll(!1),this.$el.addClass("editing"),this.setEditable(this.$title,!0),this.$title.get(0).focus(),setEndOfContenteditable(this.$title.get(0)),m.sendEvent("Todo","Activate Edit")))},dragstart:function(e){if(e.stopPropagation(),this.editing||this.topMenuDropdownView&&this.topMenuDropdownView.expanded)return!1;if(e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("todo_id",this.model.id),0==this.model.get("leafNode")){var t=this.$el.cloneNode(!0);t.className="ghost",t.style.position="absolute",t.style.zIndex="-1",t.querySelector(".todo-item-checkbox").style.marginTop="3px",e.currentTarget.appendChild(t),e.originalEvent.dataTransfer.setDragImage(t,e.originalEvent.offsetX-15,e.originalEvent.offsetY+2)}this.parent.dragmode="todo",m.trigger("todo:dragging",this),(this.parent.dragging=this).parent.original_index=this.parent.li_index(this.$el,!0),0!=this.parent.original_index?(this.parent.$preceeding_item=this.previousSiblingTodo(),this.parent.preceedingTodoId=this.previousSiblingTodoId()):(this.parent.$preceeding_item=null,this.parent.preceedingTodoId=null),m.sendEvent("Todo","Reorder")},dragenter:function(e){if(e.stopPropagation(),!this.parent.selectedList.get("reorder"))return!1;if("todo"==this.parent.dragmode){if(!this.isSibling(this.parent.dragging.model))return!0;this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;return this.parent.$placeholder.css("display","list-item"),t.height(this.parent.dragging.$el.height()),t.after(this.parent.dragging.$el),!1}},isSibling:function(e){return this.model.isSibling(e)},previousSiblingTodo:function(){return this.$el.prevAll("li").not(".placeholder").first()},previousSiblingTodoId:function(){return this.$el.prevAll("li").not(".placeholder").first().data("todo-id")},onMouseEnter:function(e){m.views.todoPane.isHovered=!0,this.listenTo(m,"globalEvent:spacebar",this.invokeDefaultCommand)},onMouseLeave:function(e){this.stopListening(m,"globalEvent:spacebar"),m.views.todoPane.isHovered=!1},invokeDefaultCommand:function(){var t=this,e=this.selectedList.getDefaultCommands();if(e&&0<e.length){var i=_.find(e,function(e){return!!m.commandManager.canExecute(e.commandId,t.model,e.options,t.provider)});i&&(m.commandManager.execute(i.commandId,t.model,i.options,t.provider),this.parent.updateHeight())}},toggleDone:function(e){if(e&&e.stopPropagation(),this.selectedList.has("done_disabled")){e&&e.preventDefault();var t=this.selectedList.get("done_disabled");t.message&&m.trigger("todo:status",t)}else{m.sendEvent("Todo","Done");var i=!this.model.get("done");this.model.attemptSave({done:i,completedDate:i?new Date:null}),this.selectedList.recurseOnDone=!0,(this.selectedList.get("recurse_on_done")&&i||this.selectedList.get("recurse_on_done")&&this.selectedList.get("recurse_on_reopen"))&&this.recurseToggleDone(this.model.id,i),this.topMenuDropdownView.resetMenuItems(),m.trigger("todo:loadingStateChange",null);var s=this.provider.getDoneList();s&&!this.selectedList.isDoneList()&&s.changeCount(i)}},recurseToggleDone:function(e,t){var i=this;this.selectedList.itemCollection.where({parentId:e}).forEach(function(e){e.set({done:t,completedDate:new Date}),i.recurseToggleDone(e.get("id"),t)})},handleInput:function(e){this.editing&&(this.parent.updateHeight(),13==e.keyCode&&(this.saveEdit(),m.sendEvent("Todo","Edit"),e.preventDefault(),e.stopPropagation()),27==e.keyCode&&(e.stopPropagation(),this.abortEdit()))}}),m.views.TodoList=Backbone.View.extend({events:{dragover:"dragover",dragend:"dragend",drop:"drop","click .empty-link":"clickEmptyStateLink","click .empty-title":"clickEmptyTitleLink","click .todo-load-more-button":"loadMore","click .todo-section-collapsible":"toggleSection","click .new-todo-button":"showAndFocusTodoInput"},reordered:!1,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],weekdayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],itemsRendered:!0,initialize:function(){this.scrollingAllowed=!0,this.emptyListGreeting="No todos yet",this.emptyListSubmessage="Add a todo to get started",this.subViews=[],this.isScrolling=!1,this.$loading=$('<span class="message-fill"><i class="loading-icon"></i> Loading...</span>'),this.$inPlaceLoading=$('<span class="message-overlay"><i class="loading-icon"></i> <span class="loading-title">Loading...</span></span>'),this.listenTo(this.model,"change",this.providerChanged),this.listenTo(this.model.project,"change",this.providerChanged),this.listenTo(m,"todo:loadingStateChange",this.handleTodoLoadingStateChange),this.listenTo(m,"todo:providerChanged",this.providerChanged),this.listenTo(m,"todo:showAssignedTodosOnlyChanged",this.showAssignedTodosOnlyChanged),this.listenTo(m,"todolist:updateHeight",this.updateHeight),this.listenTo(m,"todo:loadingStateChange",this.renderLoading),this.listenTo(m,"todo:show-new-todo-button",this.showNewTodoButton),this.listenTo(m,"todo:dragging",this.todoDragging),this.providerChanged();var e=this;$(window).on("resize",function(){e.updateHeight()})},render:function(){if(!this.renderedOnce){this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.renderLoading({status:"loading"}),this.$el.css("max-height",this.getHeightLimit()+"px");var e=localStorage.getItem("todo-list-min-height");this.$el.css("min-height",e||"22px"),this.renderedOnce=!0}this.$el.removeClass().addClass("todo-list");var t=this.model.activeProvider.selectedList(),i=(this.model.activeProvider.selectedProject(),t&&t.get("list_class"));i&&this.$el.addClass(i);var s=this;this.addAll(function(e){s.renderItems(e)})},renderItems:function(e){var t=this.model.activeProvider.selectedList();e?(this.$el.removeClass("is-empty"),m.trigger("todo:show-input"),t&&t.isDoneList()&&0==this.$el.find(".todo-load-more").length&&(this.lastCount&&this.lastCount==t.itemCollection.length?this.$el.append('<li class="todo-load-more"><span class="todo-load-more-done" style="text">That\'s all!</span></li>'):this.$el.append('<li class="todo-load-more"><span class="button todo-load-more-button">Load More</span></li>'))):this.renderEmptyState();this.$el.css("opacity",1),this.updateHeight(0),t&&!t.itemCollection.loadingFromServer&&this.removeLoading()},showAndFocusTodoInput:function(){this.$el.find(".new-todo-button").css({opacity:0}),m.trigger("todo:show-and-focus-input")},showNewTodoButton:function(){this.$el.find(".new-todo-button").css({opacity:1})},showAssignedTodosOnly:function(){this.model.activeProvider.selectedList().showAssignedTodosOnlyChanged()},toggleSubtasks:function(){this.model.activeProvider.selectedList().toggleSubtasks()},toggleShowOld:function(){this.model.activeProvider.selectedList().loadOldCompletedTodos()},loadMore:function(){this.$el.find(".todo-load-more-button").remove(),this.$el.find(".todo-load-more").prepend(this.$inPlaceLoading);var e=this.model.activeProvider.selectedList();this.lastCount=e.itemCollection.length,e.itemCollection.loadMore(this.endDate)},dismissEmptyState:function(){this.emptyStateActive&&(this.$el.find(".empty").hide(),m.trigger("todo:show-input"),this.emptyStateActive=!1)},checkForEmptyState:function(){this.subViews&&(_.every(this.subViews,function(e){return e.isHidden()})&&this.render())},renderEmptyState:function(){var e;this.$el.addClass("is-empty"),this.emptyListGreeting="No todos yet",this.emptyListSubmessage="Add a todo to get started",this.overrideListType=null;var t=this.model.activeProvider.selectedList(),i=this.model.activeProvider.selectedProject();if(t){var s=t&&t.get("list_class");s&&this.$el.addClass(s);var o=t.get("todo_type");t.get("todo_type")&&(this.emptyListGreeting="No "+o+"s yet",this.emptyListSubmessage="Add a new "+o+" to get started",this.overrideListType=o.charAt(0).toUpperCase()+o.slice(1))}var n=i&&i.get("todo_type");if(n&&(this.emptyListGreeting="No "+n+"s yet",this.emptyListSubmessage="Add a new "+n+" to get started",this.overrideListType=n.charAt(0).toUpperCase()+n.slice(1)),t&&t.itemCollection&&t.itemCollection.firstLoadCompleted){var a={};if(t.has("empty_message"))a.message=t.get("empty_message"),a.submessage=t.get("empty_submessage"),a.use_command=!!t.get("empty_command");else if("today"==t.listType()){a.message=this.emptyListGreeting;var l=this.model.activeProvider.selectedProject().getListOfType("inbox");if(l){a.targetListId=l.id;var r=l.get("count");1==r?a.submessage="1 todo in Inbox":1<r?a.submessage=r+" todos in Inbox":(a.submessage="Switch to Inbox",a.message="Add a todo to get started")}}else if("inbox"==t.listType())a.message=this.emptyListGreeting,(e=this.model.activeProvider.selectedProject().getListOfType("today"))&&(a.targetListId=e.id,a.submessage="Switch to Today",a.message="Add a todo to get started");else if("done"==t.listType())a.message="No completed todos yet",(e=this.model.activeProvider.selectedProject().getListOfType("today"))&&(a.targetListId=e.id,a.submessage="Get started in Today");else if(t.showAssignedTodosOnly&&0<t.itemCollection.models.length){var d="No tasks assigned to me";t.get("todo_type")&&(d="No "+t.get("todo_type")+"s assigned to me"),t.get("project")&&t.get("project").get("todo_type")&&(d="No "+t.get("project").get("todo_type")+"s assigned to me"),a.message=d}else a.message=this.emptyListGreeting,a.submessage=this.emptyListSubmessage;a.subMessageClickable=a.targetListId||a.use_comand,a.listType=this.overrideListType||"Todo",m.trigger("todo:hide-input"),this.$el.find("new-todo-button").css({opacity:1}),this.emptyStateActive=!0,this.$el.append(m.templates.todos["todo-list-empty-state"](a)),this.itemsRendered=!0,this.updateHeight(0)}},addedToProxyCollection:function(e,t,i){this.isScrolling||this.$el.addClass("hide-scroll"),this.dismissEmptyState(),this.addOne(e,i?i.at:null)},addOne:function(e,t,i){var s=this,o=null,n=this.model.activeProvider.selectedList();n&&(o=n.todoItemMenuOptions());var a=new m.views.TodoItem({model:e,parent:this,menu_options:o,provider:this.model.activeProvider,list_id:n.id});this.subViews.push(a);var l=a.render().el,r=e.get("parentId");if(r){var d=this.getTodoSubelementContainer(r);d?d.append(l):this.$el.append(l)}else if(1<e.get("depth")){var c=this.$el.find("li").last().attr("data-todo-id"),h=n.itemCollection.where({id:c});if(0<h.length&&(e.get("depth")==h[0].get("depth")&&h[0].get("parentId")&&(c=h[0].get("parentId")),e.get("depth")<=h[0].get("depth")-1&&h[0].get("parentId"))){c=h[0].get("parentId");var u=n.itemCollection.where({id:c});if(u[0].get("parentId")&&(c=u[0].get("parentId")),e.get("depth")==h[0].get("depth")-2&&h[0].get("parentId")){c=u[0].get("parentId");var g=n.itemCollection.where({id:c});g[0].get("parentId")&&(c=g[0].get("parentId"))}}e.set("parentId",c);var p=this.getTodoSubelementContainer(c);p&&p.append(l)}else if(e.get("isProxy")&&n.isDoneList())$(this.$el.find("li.todo-section")[0]).after(l);else if(t||0===t){for(var f=-1,v=this.$el.children(),w=0;f<t;){var b=$(v[w++]);b.hasClass("todo-section")||f++}0<=f?b.before(l):this.$el.prepend(l)}else this.$el.append(l);e.get("isProxy")&&e.get("proxyValid")?(this.isScrolling&&a.scrollIntoView(),this.newTodoAdded=!0,function(){var e=!1;s.addedToTop&&(s.$el.addClass("drop-top-margin"),e=!0);m.trigger("todolist:updateHeight"),$(l).addClass("transition"),setTimeout(function(){e&&s.$el.removeClass("drop-top-margin"),$(l).addClass("visible"),setTimeout(function(){$(l).removeClass("transition")},200)},1)}()):$(l).addClass("visible")},getTodoSubelementContainer:function(e){var t=this.$el.find('[data-todo-id="'+e+'"]');if(t&&0<t.length){var i=$(t[0]).find("ol").first();if(!i||0==i.length){var s=$("<ol>");return $(t[0]).append(s),s}return $(i)}return null},addAll:function(t){var i=this,e=function(){var e=i.addAllNow();t(e)};this.lastLisId!=this.model.activeProvider.selectedList()?(this.lastLisId=this.model.activeProvider.selectedList(),setTimeout(e,200),this.$el.css("opacity",0)):e()},addAllNow:function(){_.each(this.subViews,function(e){e&&e.destroy()});var e=!(this.subViews=[]);this.reordered=!1;var t,s=this;if(this.$el.html(""),t=this.model.activeProvider.selectedList()){var i=t.itemCollection.activeToday(),o=t.proxyCollection.where({proxyValid:!0});0<i.length&&(e=!0),o&&0<o.length&&(e=!0);var n,a=!1,l=t.groupingInfo();if(l){var r=[];if("date"==l.type){if(!_.isEmpty(i)){var d=_.map(i,function(e){var t=e.get(l.field),i=new Date(t);return{sortDate:i.getTime(),year:i.getFullYear(),month:i.getMonth(),day:i.getDate(),item:e}});n=_(d).chain().sortBy("sortDate").reverse().value();var c=null,h=null,u=null;_.each(n,function(e){if(e.year!=c||e.month!=h||e.day!=u){c=e.year,h=e.month,u=e.day;var t=s.formatDate(e),i=t.calendarDate;r.push(i),s.$el.append('<li draggable="false" data-view-section-parent-id="'+i+'" class="todo-section" title="'+t.calendarDate+'">'+t.friendlyDate+"</li>"),e.item.set("viewSectionId",t.calendarDate)}s.addOne(e.item),s.endDate=e.item.get("completedDate")})}a=!0}else if("viewSection"==l.type){var m="";n=_.sortBy(i,function(e){return l.order[e.get("viewSection")]}),_.each(n,function(e){if(e.get("viewSection")!=m){m=e.get("viewSection");r.push(m),s.$el.append('<li data-view-section-parent-id="'+m+'"class="todo-section todo-section-collapsible">'+m.replace("_"," ")+'<svg class="icon-tick" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 292.362 292.362"><path d="M286.935 69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952 0-9.233 1.807-12.85 5.424C1.807 72.998 0 77.279 0 82.228c0 4.948 1.807 9.229 5.424 12.847l127.907 127.907c3.621 3.617 7.902 5.428 12.85 5.428s9.233-1.811 12.847-5.428L286.935 95.074c3.613-3.617 5.427-7.898 5.427-12.847 0-4.948-1.814-9.229-5.427-12.85z"/></svg></li>')}e.set("viewSectionId",m),s.addOne(e)}),a=!0}r.forEach(function(e){s.updateSectionExpansion(e)})}a||(_.each(i,function(e,t){s.addOne(e,!1,t==i.length-1),s.endDate=e.get("completedDate")},this),_.each(o,function(e){s.addOne(e)},this))}if(e&&(this.itemsRendered=!0),(t=this.model.activeProvider.selectedList())&&(this.addedToTop=t.addedToTop),this.newTodoAdded){var g=this.addedToTop?this.$el.children().first():this.$el.children().last();g&&0<g.length&&this.isScrolling&&g[0].scrollIntoView(!1),this.newTodoAdded=!1,this.addedToTop=!1}return e},updateSectionExpansion:function(e){var t="collapsed-"+this.model.activeProvider.selectedList().id+":"+e,i=m.models.customization.get(t);null==i&&(i=!1),this.$el.find('[data-view-section-id="'+e+'"]').toggleClass("hidden",i),this.$el.find('[data-view-section-parent-id="'+e+'"]').toggleClass("todo-section-collapsed",i),m.trigger("todo:sectionExpansion")},toggleSection:function(e){var t=this.model.activeProvider.selectedList(),i=e.currentTarget.dataset.viewSectionParentId,s="collapsed-"+t.id+":"+i;m.models.customization.set(s,!m.models.customization.get(s)),this.updateSectionExpansion(i),this.updateHeight()},formatDate:function(e){var t=new Date,i=this.monthNames[e.month]+" "+e.day+(t.getFullYear()==e.year?"":", "+e.year);if(e.year==t.getFullYear()&&e.month==t.getMonth()&&e.day==t.getDate())return{friendlyDate:"Today",calendarDate:i};var s=new Date(t.getTime()-864e5);if(e.year==s.getFullYear()&&e.month==s.getMonth()&&e.day==s.getDate())return{friendlyDate:"Yesterday",calendarDate:i};var o=new Date(e.sortDate);return new Date(t.getTime()-5184e5)<o?{friendlyDate:this.weekdayNames[o.getDay()],calendarDate:i}:{friendlyDate:i,calendarDate:""}},clickEmptyStateLink:function(e){if(e&&e.currentTarget){if(e.preventDefault(),e.stopPropagation(),$(e.currentTarget).data("use-command")){var t=this.model.activeProvider.selectedList(),i=t.get("empty_command"),s=t.get("empty_command_options");return void m.commandManager.execute(i,null,s)}var o=$(e.currentTarget).data("target-list-id");o&&this.model.activeProvider.selectList(o)}},clickEmptyTitleLink:function(e){if(e&&e.currentTarget&&(e.preventDefault(),e.stopPropagation(),$(e.currentTarget).text()==this.emptyListGreeting)){var t=this.$el.parent().find(".todo-new")[0];t&&t.focus()}},dragover:function(e){return e.preventDefault(),!(e.originalEvent.dataTransfer.dropEffect="move")},dragend:function(e,t){e.preventDefault(),this.$el.removeClass("dragging"),this.$el.closest(".app").removeClass("has-drop-left has-drop-right");var i=this.$el[0].getBoundingClientRect(),s=e.originalEvent.pageX,o=e.originalEvent.pageY,n=this.dragging.model.id;if(this.move_target_id!=n&&!0!==t){if(s-10<i.right&&s+30>i.left&&o-20<i.top&&i.top-o<40)return void this.drop(e);if(s-10<i.right&&s+30>i.left&&o+20>i.bottom&&o-i.bottom<40)return void this.drop(e)}if("todo"==this.dragmode){var a=this.dragging.$el;"none"==e.originalEvent.dataTransfer.dropEffect&&(null!=this.$preceeding_item?this.$preceeding_item.after(a):this.$el.prepend(a)),this.$placeholder.hide(),a.show(),a.find(".ghost").remove()}return!1},drop:function(e){if(!this.selectedList.get("reorder"))return this.dragend(e,!0),!1;if("todo"==this.dragmode){var t=this.dragging.$el,i=this.dragging.model.id,s=this.move_target_id;if(s==i)return void this.dragend(e);e.preventDefault(),this.$el.closest(".app").removeClass("has-drop-left has-drop-right");var o=this.move_offset;if(0==this.li_index(this.dragging.$el,!0)&&0==this.original_index)return this.dragend(e,!0),!1;if(this.preceedingTodoId==this.dragging.previousSiblingTodoId())return this.$placeholder.hide(),t.show(),!1;var n=this.model.activeProvider.selectedList(),a=n.itemCollection.get(i),l=n.itemCollection.get(s);if(!a||!l||!a.isSibling(l))return!1;this.$placeholder.hide(),t.show(),n.itemCollection.reorderItem({move_id:i,move_target_id:s,move_offset:o,list_id:n.id}),this.reordered=!0}},getTopActiveTodoId:function(){return this.$("li:not(.done, .placeholder, .todo-section, .todo-subsection, .hidden)").first().data("todo-id")},li_index:function(e,t){return t?this.$("li").not(".placeholder").index(e):this.$("li").index(e)},handleManagerChange:function(){this.render()},handleTodoLoadingStateChange:function(e){this.selectedList&&this.selectedList.waitForReorder||e&&"loading"==e.status||this.render()},showAssignedTodosOnlyChanged:function(e){var t=this.model.activeProvider.selectedList();t&&t.id==e&&this.render()},providerChanged:function(){var e=this.model.activeProvider.selectedList();this.selectedList!=e&&(this.itemsRendered=!1,this.selectedList&&this.stopListening(this.selectedList.proxyCollection),(this.selectedList=e)&&this.listenTo(e.proxyCollection,"add",this.addedToProxyCollection)),this.render(),e&&e.supportsFeature("assigned")&&this.listenTo(m.models.customization,"change:assigned-"+e.id,this.showAssignedTodosOnly),e&&(this.listenTo(m.models.customization,"change:subtask-"+e.id,this.toggleSubtasks),this.listenTo(m.models.customization,"change:showOld-"+e.id,this.toggleShowOld))},todoDragging:function(){this.$el.addClass("dragging"),this.isScrolling||this.$el.addClass("hide-scroll")},toggleScroll:function(e){this.scrollingAllowed=e,this.$el.toggleClass("hide-scroll",!e)},updateHeight:function(s){if(!(0<this.lastHeight&&void 0===s)){this.lastHeight=s;var e,t=0,i=this;0==s&&(s=void 0);var o=this.$el;if(o.is(":visible")){var n=this.$el.closest(".app");this.isScrolling?s>o.outerHeight(!0)&&o.addClass("animating"):o.addClass("hide-scroll"),n.addClass("animating"),this.$el.bind("transitionend webkitTransitionEnd",r),setTimeout(r,500);var a=this.getHeightLimit();if(void 0===s){var l="Firefox"===getBrowserName();if(s=2,this.$loading.parent()&&0==o.children().length)return;o.children().each(function(e,t){var i=$(t);"none"!=i.css("display")&&(s+=l?i.outerHeight(!0)+1:i.outerHeight(!0))});try{m.views.todoPane.todoHeader.projectDropdownView.expanded&&(s=Math.max(m.views.todoPane.todoHeader.projectDropdownView.$dropdown.outerHeight(!0),s)),m.views.todoPane.todoHeader.topMenuDropdownView.expanded&&(s=Math.max(m.views.todoPane.todoHeader.topMenuDropdownView.$dropdown.outerHeight(!0),s))}catch(e){}e=!0,this.contentHeight=s,this.visibleHeight=Math.min(s,a)}s>=o.outerHeight(!0)?(s=Math.min(s,a),this.isScrolling=s==a,t=s+"px",o.parent().css({"min-height":t})):(o.parent().css({"min-height":Math.max(this.visibleHeight,s)+"px"}),t=Math.max(this.visibleHeight,s)+"px"),o.css({"min-height":t}),o.parent().css({"max-height":(e?s:a)+"px"}),o.css({"max-height":(e?s:a)+"px"}),localStorage.setItem("todo-list-min-height",t)}}function r(){i.scrollingAllowed&&o.removeClass("hide-scroll"),o.removeClass("animating"),n.removeClass("animating"),i.$el.unbind("transitionend webkitTransitionEnd",r)}},renderLoading:function(e){this.renderedOnce&&this.updateHeight();var t=this;e&&("loading"==e.status?(this.loadingRemoved=!1,setTimeout(function(){t.loadingRemoved||(0<t.subViews.length||t.$el.find(".empty").is(":visible")?(t.$loading.removeClass("message-fill"),t.$loading.addClass("message-overlay u--bg"),e.listChanged||t.$el.parent().append(t.$loading)):(t.$loading.removeClass("message-overlay u--bg"),t.$loading.addClass("message-fill"),t.$el.parent().append(t.$loading)))},10)):"error"==e.status&&setTimeout(function(){t.removeLoading()},20))},removeLoading:function(){this.loadingRemoved=!0,this.$loading.remove(),this.$inPlaceLoading.remove(),this.updateHeight()},isLoading:function(){return 0<this.$loading.parent().length},getHeightLimit:function(){var e=this.$el.parent().parent(),t=e.find(".todo-header").outerHeight(!0),i=e.find(".todo-message").outerHeight(!0)||0,s=e.find(".todo-new").outerHeight(),o=$(".top-right").outerHeight(!0)+$(".bottom").outerHeight(!0),n=$(".bookmarks-wrapper"),a=0;return n.css("transform")&&(a=parseInt(n.css("height"))-parseInt(n.css("transform").split(",")[5])),document.body.getBoundingClientRect().height-(o+t+i+s+a+4)}}),m.views.TodoPane=Backbone.View.extend({attributes:{id:"todo",class:"app-container todo"},template:m.templates.todos.todopane,renderedOnce:!1,todoListOpen:!1,events:{"click .todo-toggle":"toggleShow","dragover .drop-left-zone":"ignoreDragOver","dragover .drop-right-zone":"ignoreDragOver","dragenter .drop-left-zone":"hoverLeftBar","dragenter .drop-right-zone":"hoverRightBar","dragleave .drop-left-zone":"hoverLeftBar","dragleave .drop-right-zone":"hoverRightBar","dragend .drop-right-zone":"dragend","dragend .drop-left-zone":"dragend","drop .drop-right-zone":"drop","drop .drop-left-zone":"drop"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenToOnce(m,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(m,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(m,"globalEvent:toggle:bottom-right",this.onToggleBottomRight),this.listenTo(m,"globalEvent:esc globalEvent:click",this.setTodoStateClosed),this.listenTo(m,"todo:visible",this.todoVisible),this.listenTo(m,"globalEvent:key:shiftN",this.focusOnNewTodo),this.listenTo(m,"globalEvent:key:A",this.focusOnNewTodo),this.listenTo(m,"globalEvent:arrowLeft",this.arrowLeft),this.listenTo(m,"globalEvent:arrowRight",this.arrowRight),this.listenTo(m,"globalEvent:altArrowUp",this.altUp),this.listenTo(m,"globalEvent:altArrowDown",this.altDown),this.listenTo(m,"globalEvent:window:resize",this.windowResize),this.listenTo(m,"todo:hide-input",this.hideInput),this.listenTo(m,"todo:show-input",this.showInput),this.listenTo(m,"todo:show-and-focus-input",this.showAndFocusInput),this.listenTo(m,"todo:hidden",this.todoHidden),this.listenTo(m,"todo:dragging",this.todoDragging),this.listenTo(m,"todo:newProvider",this.openTodo),this.listenTo(m,"todo:providerChanged",this.providerChanged),this.listenTo(m.models.customization,"change:todoVisible",this.visibleChanged),m.models.customization.get("keepTodoState")&&this.showTodoList()&&this.toggleShow(),this.isHovered=!1},render:function(){if(!this.renderedOnce){this.setMaxWidgetHeight();var e=this.template({}),t=(this.options.order||"append")+"To";this.$el[t]("."+this.options.region).mFadeIn().html(e),this.$popup=this.$(".app-wrapper"),this.$app=this.$(".app"),this.$listcontainer=this.$el.find(".todo-list")[0],this.$headercontainer=this.$el.find(".todo-header")[0],this.$newTodoFooter=this.$el.find(".new-todo-footer"),this.$newtodoinput=this.$el.find("#todo-new"),this.$el.toggleClass("show",this.todoListOpen),this.renderedOnce=!0}var i=this;return setTimeout(function(){i.$el.find(".todo-item").first().find(".dropdown").show()},1e3),this},showUpsell:function(e){if(this.upsellView)this.upsellView.options=e,this.upsellView.render();else{e.template=m.templates.upsell.appupsell,this.upsellView=new m.views.upsell.message(e);var t=this.upsellView.render().$el;this.$app.append(t)}this.upsellView.show()},showTodoList:function(){var e=localStorage.getItem("showTodoList");return!!e&&JSON.parse(e)},toggleShow:function(e){m.trigger("globalEvent:closeDropdowns",this),m.trigger("globalEvent:toggle:bottom-left",this),!this.todoListOpen?this.todoVisible():this.todoHidden(),this.setMaxWidgetHeight()},onToggleBottomRight:function(e){e!=this&&this.todoListOpen&&this.todoHidden()},openTodo:function(){this.setTodoOpenState(!0)},setTodoStateClosed:function(e){if(e!=this&&!(e.originalEvent&&"click"==e.type&&e.target&&$.contains(this.el,e.target))){var i=!1;$(".todo-item-title").each(function(e,t){"true"==$(this).attr("contentEditable")&&(i=!0)}),i||m.models.customization.get("keepTodoState")&&"27"!=e.keyCode||this.todoHidden()}},setTodoOpenState:function(e){this.todoListOpen=e,m.models.customization.get("keepTodoState")?localStorage.showTodoList=e:localStorage.showTodoList=!1,1==e?this.showPopup():this.hidePopup(),e?(this.newTodoInput&&this.newTodoInput.focusInputField(),this.doFirstFetch()):this.todoHeader&&this.todoHeader.stopChoosing()},windowResize:function(){this.setMaxWidgetHeight()},setMaxWidgetHeight:function(){var e=$(window).height()-125,t=this.$el;if(t.css("max-height",e),t){var i=t.find(".active-list").outerHeight(),s=t.find(".todo-message").outerHeight(!0),o=t.find(".todo-new").outerHeight();0==i&&(i=39),null==s&&(s=0),0==o&&(o=38)}return e},showPopup:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in").find(".pane").css("height","auto")},hidePopup:function(){if(this.$el.hasClass("show")){var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show").find(".pane").css("height","auto")})}},hideInput:function(){this.$newTodoFooter.css({visibility:"hidden"})},showInput:function(){this.$newTodoFooter.css({visibility:"visible"})},showAndFocusInput:function(){this.showInput(),this.$newtodoinput.focus()},doFirstFetch:function(){this.initializeManager(),m.models.todoListManager.externallyFetchedOnce=!0,m.models.todoListManager.activeProvider.doFetchIfNeeded()},todoVisible:function(){this.setTodoOpenState(!0)},todoDragging:function(e){if(this.draggingTodo=e,this.hoverCounter=0,!e.model.get("noMove")){var t=m.models.todoListManager.activeProvider.selectedProject().getNeighboringList(-1);t&&t.get("boardId")&&t.get("boardId")==e.selectedList.get("boardId")&&(this.$app.addClass("has-drop-left"),this.$el.find(".left-bar .bar-name").html(t.get("title")));var i=m.models.todoListManager.activeProvider.selectedProject().getNeighboringList(1);i&&i.get("boardId")&&i.get("boardId")==e.selectedList.get("boardId")&&(this.$app.addClass("has-drop-right"),this.$el.find(".right-bar .bar-name").html(i.get("title")))}},todoHidden:function(){this.setTodoOpenState(!1)},onBackgroundLoaded:function(){this.initializeManager()},initializeManager:function(){m.models.todoListManager||(m.models.todoListManager=new m.models.TodoListManager({prefetchTodos:this.todoListOpen}),m.trigger("todo:managerReady"),this.todoHeader=new m.views.TodoListHeader({el:this.$headercontainer,model:m.models.todoListManager,parent:this}),this.todoList=new m.views.TodoList({el:this.$listcontainer,model:m.models.todoListManager}),this.newTodoInput=new m.views.NewTodoInput({todoList:this.todoList,el:this.$newtodoinput[0],model:m.models.todoListManager}),this.setMaxWidgetHeight())},visibleChanged:function(e){m.models.customization.getComputedSetting("todoVisible")?this.renderedOnce?this.$el.mFadeIn():this.render():this.$el.mFadeOut()},arrowLeft:function(e){this.todoListOpen&&(m.trigger("globalEvent:closeDropdowns"),e.shiftKey?m.models.todoListManager.selectPreviousProvider():m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectedProject().selectPreviousList())},arrowRight:function(e){this.todoListOpen&&(m.trigger("globalEvent:closeDropdowns"),e.shiftKey?m.models.todoListManager.selectNextProvider():m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectedProject().selectNextList())},altUp:function(e){this.todoListOpen&&(m.trigger("globalEvent:closeDropdowns"),m.models.todoListManager.activeProvider.selectPreviousProject())},altDown:function(e){this.todoListOpen&&(m.trigger("globalEvent:closeDropdowns"),m.models.todoListManager.activeProvider.selectNextProject())},focusOnNewTodo:function(e){this.todoListOpen&&(e&&(e.preventDefault(),e.stopPropagation()),this.newTodoInput.focusInputField())},getHoverInfo:function(e){var t=this,i="dragenter"==e.type;i&&e.preventDefault(),this.hoverCounter+=i?1:-1;var s=0<this.hoverCounter;return s?this.$el.find(".todo-list .placeholder").hide():setTimeout(function(){t.dropListOffset=null},400),s},hoverRightBar:function(e){var t=this.getHoverInfo(e);this.$el.find(".drop-right-zone").toggleClass("hover",t),t&&(this.dropListOffset=1)},hoverLeftBar:function(e){var t=this.getHoverInfo(e);this.$el.find(".drop-left-zone").toggleClass("hover",t),t&&(this.dropListOffset=-1)},dragend:function(e){this.hoverCounter=0,e.preventDefault(),this.$el.find(".todo-list").removeClass("dragging"),this.$el.find(".todo-list .placeholder").hide(),this.$el.find(".drop-left-zone").removeClass("hover"),this.$el.find(".drop-right-zone").removeClass("hover"),this.$app.removeClass("has-drop-left has-drop-right"),this.dropListOffset=null,this.draggingTodo=null},drop:function(e){if(this.$el.find(".todo-list .placeholder").hide(),this.dropListOffset){var t=m.models.todoListManager.activeProvider.selectedProject().getNeighboringList(this.dropListOffset);(new m.commands.TodoMove).execute(this.draggingTodo.model,{target_id:t.id}),this.dragend(e)}else this.dragend(e)},ignoreDragOver:function(e){return e.preventDefault(),!(e.originalEvent.dataTransfer.dropEffect="move")},storedTodoPaneHeight:function(e){if(null!=e)return 0<e&&localStorage.setItem("todo-pane-height",e),e;var t=localStorage["todo-pane-height"];return t?JSON.parse(t):null}}),m.views.upsell=m.views.upsell||{},m.views.upsell.message=Backbone.View.extend({events:{"click .hide":"hideUpsell","click .upsell-action":"clickButton"},initialize:function(e){this.template=e.template,this.options=e,this.listenTo(m,"globalEvent:click",this.handleClick)},render:function(){return this.options.class=(this.options.class?this.options.class+" ":"")+this.options.targetRegion+"-upsell",this.$el.html(this.template(this.options)),this.$el.addClass("overlay upsell"),this.$el.addClass(this.options.class),this},show:function(){var e=this,t=e.$el.height();e.$el.addClass("show"),setTimeout(function(){e.parentMinHeight=e.$el.parent().css("min-height"),e.parentMinHeight&&(e.parentMinHeight=parseInt(e.parentMinHeight.substring(0,e.parentMinHeight.length-2))),e.$el.parent().css("min-height",Math.max(t,e.parentMinHeight)),e.$el.addClass("show-fade-in")},10)},hideUpsell:function(e){e&&e.stopPropagation(),this.$el.removeClass("show-fade-in");var t=this;t.$el.parent().css("min-height",t.parentMinHeight?t.parentMinHeight:0),setTimeout(function(){t.$el.removeClass("show")},300)},handleClick:function(e){this.$el[0]===e.target||$.contains(this.$el[0],e.target)||1!=this.$el.css("opacity")||this.hideUpsell()},clickButton:function(e){e.stopPropagation(),m.commandManager.execute("upsell.website",null,{source:this.options.sourceEvent})}}),m.commands.UpsellMessage=m.models.Command.extend({defaults:{id:"upsell.message"},execute:function(e){switch(e.targetRegion){case"settings":m.views.settings.mainSettings.showUpsell(e);break;case"todos":m.views.todoPane.showUpsell(e);break;case"weather":m.views.weather.showUpsell(e)}}}),m.commands.UpsellWebsite=m.models.Command.extend({defaults:{id:"upsell.website"},execute:function(e,t,i){var s="https://momentumdash.com/plus?utm_source=extension&utm_medium=organic";t&&t.source?s+="&utm_campaign="+encodeURIComponent(t.source):!t&&e&&e.source&&(s+="&utm_campaign="+encodeURIComponent(e.source)),m.commandManager.execute("window.open",null,{url:s})}}),m.views.Greeting=Backbone.View.extend({attributes:{id:"greeting",class:"app-container greeting"},template:m.templates.greeting["greeting-template"],events:{"dblclick .name":"editName","keypress .name":"onKeypress","keydown .name":"onKeydown","blur .name":"saveName","webkitAnimationEnd .name":"onAnimationEnd"},initialize:function(){this.render(),this.listenTo(this.model,"change:time",this.updatePeriod,this),this.listenTo(m.models.customization,"change:displayname",this.onUpdateName)},render:function(){var e={period:this.getPeriod(),name:m.models.customization.get("displayname")},t=(this.options.order||"append")+"To";this.$el[t]("."+this.options.region).html(this.template(e)),this.$period=this.$(".period"),this.$name=this.$(".name");var i=this;m.models.customization.getComputedSetting("clockVisible")?i.$el.addClass("transition"):setTimeout(function(){i.moveToCenter(),setTimeout(function(){i.$el.addClass("transition")},1e3)},10),setTimeout(function(){i.renderedOnce=!0},1e3)},getPeriod:function(){var e,t=this.model.get("date").getHours();return 3<=t&&t<12&&(e="morning"),12<=t&&t<17&&(e="afternoon"),(17<=t||t<3)&&(e="evening"),e},updatePeriod:function(){this.$period.html(this.getPeriod())},editName:function(){this.$name.hasClass("editing")||(this.$name.attr("contenteditable",!0).addClass("editing pulse").focus(),setEndOfContenteditable(this.$name.get(0)))},onUpdateName:function(){this.$name.html(m.models.customization.get("displayname")),this.$name.attr("contenteditable",!1),this.renderedOnce&&this.$name.addClass("pulse")},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$name.removeClass("pulse")},onKeypress:function(e){13==e.keyCode&&(e.preventDefault(),this.saveName())},onKeydown:function(e){27===e.keyCode&&(this.$name.html(m.models.customization.get("displayname")),this.doneEditingName())},saveName:function(){var e=this.$name.text();""===e?this.$name.html(m.models.customization.get("displayname")):m.models.customization.save({displayname:e}),this.doneEditingName()},doneEditingName:function(){this.$name.attr("contenteditable",!1).removeClass("editing").addClass("pulse")},moveToCenter:function(){if(!this.isCenter){var e=(document.body.getBoundingClientRect().height-this.$el.outerHeight(!0))/2-this.$el[0].getBoundingClientRect().top;this.$el.css("transform","translateY("+e+"px)"),this.isCenter=!0}},moveOffCenter:function(){this.isCenter&&(this.$el.css("transform","translateY(0)"),this.isCenter=!1)}}),m.views.CenterClock=Backbone.View.extend({attributes:{class:"app-container clock"},events:{dblclick:"toggleMode"},initialize:function(){var e=localStorage.getItem("percentClockActive");e&&(m.models.customization.save("percentClockActive",e),localStorage.removeItem("percentClockActive")),this.listenTo(m.models.customization,"change:percentClock",this.percentClockToggled),this.listenTo(m.models.customization,"change:percentClockActive",this.percentClockToggled),this.listenTo(m.models.customization,"change:clockVisible",this.balanceChanged),this.listenTo(m.models.customization,"change:balanceModeStr",this.balanceChanged),this.renderedOnce=!1,this.render()},render:function(){var e=m.models.customization.getComputedSetting("clockVisible");if(e||!this.renderedOnce){var t=(this.options.order||"append")+"To";m.models.customization.get("percentClock")&&m.models.customization.get("percentClockActive")&&m.models.balanceMode.getDays()[(new Date).getDay()]?m.views.percentClock=m.views.clockView=new m.views.PercentClock({model:this.model,parent:this}):m.views.clockView=new m.views.DefaultClock({model:this.model,parent:this,renderedOnce:this.renderedOnce});var i=this;return this.$el[t]("."+this.options.region).html(""),this.$el.append(m.views.clockView.render().$el),e&&this.$el.mFadeIn(),setTimeout(function(){i.renderedOnce=!0},1e3),this}},balanceChanged:function(){var e=m.models.customization.getComputedSetting("clockVisible");if(this.oldVisibility!==e){var t=this;this.oldVisibility=e;var i=!1,s=!1;e?(this.renderedOnce?i=!0:(setTimeout(function(){t.render()},5),s=!0),setTimeout(function(){i&&t.$el.mFadeIn(),m.views.greeting.moveOffCenter()},s?10:0)):(t.$el.mFadeOut(500,!0),m.views.greeting.moveToCenter())}},percentClockToggled:function(e){e&&e.changed&&1==Object.keys(e.changed).length&&e.changed.percentClock&&m.models.customization.get("percentClock")&&m.models.customization.save("percentClockActive",!0),this.render()},toggleMode:function(){m.models.customization.get("percentClock")&&(m.models.customization.save("percentClockActive",!m.models.customization.get("percentClockActive")),this.render())}}),m.views.DefaultClock=Backbone.View.extend({attributes:{class:"default-clock"},template:m.templates.centerclock.clock,events:{dblclick:"toggleFormat"},initialize:function(e){this.type="default",this.renderedOnce=e.renderedOnce,this.render(),this.listenTo(this.model,"change:time",this.update,this),this.listenTo(m.models.customization,"change:hour12clock",this.timeFormatSettingChanged)},render:function(){var e={time:this.model.getTimeString(),format:this.model.getTimePeriod()};this.$el.html(this.template(e)),this.$time=this.$(".time"),this.$format=this.$(".format"),this.update();var t=this;return this.renderedOnce?this.setTimeFormat(m.models.customization.get("hour12clock")):setTimeout(function(){t.renderedOnce=!0},1e3),this},update:function(){this.$time.html(this.formatOnes(this.model.getTimeString()))},formatOnes:function(e){return e.replace(/1/g,'<span class="clock-one">1</span>')},toggleFormat:function(){if(!m.models.customization.get("percentClock")){var e=m.models.customization.get("hour12clock");e=!e,m.models.customization.save({hour12clock:e}),this.setTimeFormat(e,!0)}},timeFormatSettingChanged:function(){var e=m.models.customization.get("hour12clock");this.setTimeFormat(e,!0),this.update()},setTimeFormat:function(e,t){e&&this.renderedOnce?(t&&setTimeout(function(){$(".format").addClass("show")},40),this.$format.html(this.model.getTimePeriod())):$(".format").removeClass("show")}}),m.views.PercentClock=Backbone.View.extend({attributes:{class:"percent-clock"},template:m.templates.centerclock.clock,events:{},initialize:function(){this.type="percent",this.render(),this.listenTo(this.model,"change:time",this.update,this),this.listenTo(m.models.balanceMode,"change",this.update,this)},render:function(){return this.$el.html(this.template({time:this.getPercent(),format:"%"})),this.$time=this.$(".time"),this.$format=this.$(".format"),this.$format.css({opacity:1,"font-size":"250%",left:"106%",bottom:"7%"}),this},getPercent:function(){var e=m.models.balanceMode.getStart(),t=m.models.balanceMode.getEnd(),i=parseInt(e.hour);12===i&&(i=0);var s=parseInt(t.hour);12===s&&(s=0);var o=i+("PM"===e.noon?12:0),n=parseInt(e.minute),a=s+("PM"===t.noon?12:0),l=parseInt(t.minute)-1;24<a-o&&(a-=24);var r=new Date,d=new Date;d.setHours(o,n,0,0);var c=new Date;c.setHours(a,l,0,0),d.getTime()>c.getTime()&&(r.getTime()<=c.getTime()?o-=24:a+=24),d.setHours(o,n,0,0),c.setHours(a,l,0,0);var h=60*(a+l/60-(o+n/60))*60,u=(r.getTime()-d.getTime())/1e3,g=Math.floor(u/h*100);return 100<g&&(g="+"+(g-100)),g},update:function(){this.$time.html(this.getPercent())}}),m.commands.AuthConnect=m.models.Command.extend({defaults:{id:"auth.connect"},execute:function(e){m.commandManager.execute("auth.connect.provider",e.actionParameter,function(){m.models.todoListManager.doFetchIfNeeded(!0)})}}),m.commands.AuthConnectProvider=m.models.Command.extend({defaults:{id:"auth.connect.provider"},execute:function(e,t,i){if(e&&e.status&&"authRequired"===e.status&&e.authorizationUrl){var s=e.winWidth?e.winWidth:600,o=e.winHeight?e.winHeight:510,n=e.windowFeatures?e.windowFeatures:"titlebar,resizable,status",a=window.screen.width/2-s/2,l=window.screen.height/2-o/2,r=window.open(e.authorizationUrl,"MomentumAuthWindow",n+",left="+a+",top="+l+",width="+s+",height="+o),d=function(){r.closed||setTimeout(function(){r.closed||r.close()},1e3),t&&t()},c=e.authorizationUrl.split("/"),h="";1<c.length&&(h=c[c.length-1]);var u=m.globals.urlRootApi+"user/auth/status/"+h,g=0,p=1e3,f=function(){r.closed?d():100<++g||(g%30&&(p+=1e3),$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:u}).done(function(e){e&&e.token_obtained?d():setTimeout(function(){f()},p)}).fail(function(e,t){setTimeout(function(){f()},p)}))};f()}else i&&i()}}),m.commands.CleanLocalStorage=m.models.Command.extend({defaults:{id:"clean.localstorage"},initialize:function(){this.twoDaysAgo=Date.now()-1728e5},execute:function(){var o=this;if(!(localStorage.getItem("last_cleanup")>this.twoDaysAgo))var n=setTimeout(function(){try{if(!m||!m.collect||!m.collect.backgrounds)return;clearTimeout(n);for(var e=[],t=!1,i=null,s=0;s<localStorage.length;s++)t=!1,"archived-"==(i=localStorage.key(s)).substring(0,9)&&(t=!0),"fallback-"==i.substring(0,9)&&(t=!0),"image_displayed-"==i.substring(0,16)&&(t=!0),"weather-loc-"==i.substring(0,12)?t=!0:"ddl-bg-"==i.substring(0,7)?localStorage.getItem(i)<o.twoDaysAgo&&(t=!0):"ddl-qt-"==i.substring(0,7)&&localStorage.getItem(i)<o.twoDaysAgo&&(t=!0),t&&e.push(i);for(s=0;s<e.length;s++)localStorage.removeItem(e[s]);e.length,o.collectionCleaner(m.collect.backgrounds),o.collectionCleaner(m.collect.quotes),o.collectionCleaner(m.collect.shortquotes),m.commandManager.execute("clean.localstorage.addin"),localStorage.setItem("last_cleanup",Date.now())}catch(e){}},500)},collectionCleaner:function(e,i){var s=this;if(e){i=i||"forDate",entriesToClean=[],e.each(function(e){var t=e.get(i);Date.parse(t)<s.twoDaysAgo&&entriesToClean.push(t)});for(var t=0;t<entriesToClean.length;t++){e.get(entriesToClean[t]).destroy()}return entriesToClean.length}return 0}}),m.commands.CleanupUserData=m.models.Command.extend({defaults:{id:"user.cleanup"},execute:function(e,t){e&&e.type&&("notifications"==e.type?this.cleanNotifications():"all"==e.type&&(this.cleanUserData(),this.managerCleanup(m),this.managerCleanup(m.models))),t&&t()},managerCleanup:function(e){var t=Object.keys(e);for(i in t){var s=t[i];if(m.hasOwnProperty(s)){var o=m[s];(o instanceof m.models.Manager||o instanceof m.collect.Manager)&&o.cleanup&&o.cleanup()}}},cleanNotifications:function(){for(var e=[],t=!1,i=null,s=0;s<localStorage.length;s++)t=!1,(i=localStorage.key(s)).startsWith("momentum-messages")?t=!0:"ts_notifications"==i&&(t=!0),t&&e.push(i);for(s=0;s<e.length;s++)localStorage.removeItem(e[s])},cleanUserData:function(){for(var e=[],t=!1,i=null,s=0;s<localStorage.length;s++)t=!1,"notes"==(i=localStorage.key(s))?t=!0:i.startsWith("momentum-messages")?t=!0:"notes-"==i.substring(0,6)?t=!0:"cachedTodoProviders"==i?t=!0:"cachedFocus"==i?t=!0:"f3t6b23d"==i?t=!0:"current-countdown"==i?t=!0:"clocks"==i?t=!0:"countdowns"==i?t=!0:"countdown"==i?t=!0:"countdown-"==i.substring(0,10)?t=!0:"countdowns-"==i.substring(0,11)?t=!0:"clocks-"==i.substring(0,7)?t=!0:"activeTodoProvider"==i?t=!0:"activeTodoListId-"==i.substring(0,17)?t=!0:"font-"==i.substring(0,5)?t=!0:"listCache-"==i.substring(0,10)?t=!0:"projectCache-"==i.substring(0,13)?t=!0:"activeTodo"==i.substring(0,10)?t=!0:"tsCachedTodoProviders"==i?t=!0:"ts_notifications"==i?t=!0:"todos-updated"==i&&(t=!0),t&&e.push(i);for(s=0;s<e.length;s++)localStorage.removeItem(e[s])}}),m.commands.LoadAddins=m.models.Command.extend({defaults:{id:"addins.load"},execute:function(e){if(e){if(!this.addInsLoaded)for(this.addInsLoaded=!0,i=0;i<e.length;i++){var t=e[i];t&&m.addinManager.loadAddin(t)}m.trigger("processAddIns")}}}),m.commands.AccountLogin=m.models.Command.extend({defaults:{id:"account.login"},execute:function(e,t,i){localStorage.token?m.commandManager.execute("notification.show.enhanced",{message:"You are already logged in.",display_time:5e3,viewLimit:1,priority:2}):(m.commandManager.execute("user.cleanup",{type:"notifications"}),localStorage.doLoginOnNextLoad=!0,window.location.reload())}}),m.commands.Logout=m.models.Command.extend({defaults:{id:"logout"},execute:function(){var i=this;if(m.commandManager.execute("user.cleanup",{type:"all"}),localStorage.token&&localStorage.token_uuid){var e={token:localStorage.token,token_uuid:localStorage.token_uuid};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(e),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/logout"}).done(function(e){}).fail(function(e,t){}).always(function(e,t){localStorage.removeItem("token"),localStorage.removeItem("token_uuid"),m.conditionalFeatures.clearFeatures(),i.showLogoutMessageAndReload()})}else localStorage.removeItem("token"),this.showLogoutMessageAndReload()},showLogoutMessageAndReload:function(e){localStorage.setItem("loggedOut",Date.now()),m.commandManager.execute("notification.show.enhanced",{message:"You have been logged out.",display_time:5e3,viewLimit:1,priority:2},function(){window.location.reload()},!0)}}),m.commands.SyncEnable=m.models.Command.extend({defaults:{id:"sync.enable"},execute:function(e,t,i){m.conditionalFeatures.featureEnabled("serverfocus")||m.conditionalFeatures.featureEnabled("servertodos")||m.conditionalFeatures.featureEnabled("serverlinks")||localStorage.token&&m.syncCoordinator.submitFeatureAccessRequest("sync-early-access",function(){window.location.reload()},function(){m.commandManager.execute("notification.show.enhanced",{message:"Unable to enable account sync. Reload the tab and try again, or check our help site.",viewLimit:1,priority:2})})}}),m.commands.WindowNavigate=m.models.Command.extend({defaults:{id:"window.navigate"},execute:function(e,t){if(t){var i=null;t.url&&(i=t.url),e&&t.urlField&&(i=e.get(t.urlField)),i&&(window.location.href=i)}}}),m.commands.WindowOpen=m.models.Command.extend({defaults:{id:"window.open"},execute:function(e,t){if(t){var i=null;t.url&&(i=t.url),e&&t.urlField&&(i=e.get(t.urlField)),i&&window.open(i,t.windowName||"_blank")}}}),m.commands.NotificationShow=m.models.Command.extend({defaults:{id:"notification.show"},execute:function(e,t){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessage(e,t)},10)}}),m.commands.NotificationShowEnhanced=m.models.Command.extend({defaults:{id:"notification.show.enhanced"},execute:function(e,t,i){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessageEnhanced(e,t,i)},10)}}),m.commands.NotificationDismiss=m.models.Command.extend({defaults:{id:"notification.dismiss"},execute:function(){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.dismissMessage()},5)}}),m.commands.SettingsColorPicker=m.models.Command.extend({defaults:{id:"settings.color.picker"},initialize:function(){this.views=[]},execute:function(e,t){if(t&&t.settingName){var i=_.findWhere(this.views,{settingName:t.settingName});return i||(i=new m.views.settings.ColorPicker(t.settingName,e,t),this.views.push(i)),i}return null}}),m.commands.SettingsDisplay=m.models.Command.extend({defaults:{id:"settings.display"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.showSettings(t)}}),m.commands.SettingsDisplayUpgrade=m.models.Command.extend({defaults:{id:"settings.display.upgrade"},execute:function(e,t,i){var s="https://momentumdash.com/plus?utm_source=extension&utm_medium=organic";t&&t.source?s+="&utm_campaign="+encodeURIComponent(t.source):!t&&e&&e.source&&(s+="&utm_campaign="+encodeURIComponent(e.source)),m.commandManager.execute("window.open",null,{url:s})}}),m.commands.SettingsDisplayUpgradePanel=m.models.Command.extend({defaults:{id:"settings.display.upgrade.panel"},execute:function(e,t,i){m.views.settings.mainSettings&&((t=t||{}).section="upgrade",m.views.settings.mainSettings.showSettings(t))}}),m.commands.SettingsToggle=m.models.Command.extend({defaults:{id:"settings.toggle"},execute:function(e,t){t&&t.section?(m.views.settings.mainSettings.toggleVisible(),m.views.settings.mainSettings.visible&&m.views.settings.mainSettings.showSettings(t)):m.views.settings.mainSettings&&m.views.settings.mainSettings.toggleVisible()}}),m.commands.SettingsHide=m.models.Command.extend({defaults:{id:"settings.hide"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.hideSettings()}}),m.commands.SettingEnable=m.models.Command.extend({defaults:{id:"setting.enable"},execute:function(e,t){if(t&&t.name){var i={};i[t.name]=!!t.value,m.models.customization.set(i)}}}),m.commands.SettingsCacheUpgradeCopy=m.models.Command.extend({defaults:{id:"settings.cache.upgradecopy"},fetching:!1,fetched:!1,execute:function(e,t){var i=this;if((e||!m.conditionalFeatures.featureEnabled("plus"))&&(e||!i.fetching&&!i.fetched)){i.fetching=!0;var s=m.globals.urlRootApi+"settings/upgradecopy";t&&e?s=s+"?refresh=1&src="+encodeURIComponent(t):t?s=s+"?src="+encodeURIComponent(t):e&&(s+="?refresh=1"),$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:s}).done(function(e){i.fetching=!1,e&&(i.fetched=!0,localStorage.setItem("cachedUpgradeCopy",JSON.stringify(e)),m.trigger("settings:upgradeCopyChanged"))}).fail(function(e,t){i.fetched=!1,i.fetching=!1}),setTimeout(function(){i.fetching&&(i.fetching=!1)},1e4)}}}),m.commands.enableBookmarks=m.models.Command.extend({defaults:{id:"settings.enableBookmarks"},execute:function(e){var t=m.models.bookmarksSettings.permissions,i=e.callback,s=m.models.customization;if(s.get("bookmarksVisible"))return m.views.bookmarks.hidePopup(),s.save("bookmarksVisible",!1),void i();var o=function(){s.save("bookmarksVisible",!0),i()};try{getBrowser().bookmarks.get("1",function(){}),o()}catch(e){new m.views.BookmarksPrimer({permissions:t,callback:function(){o()}}).render()}}}),m.commands.TodoAsanaMoveSectionMenu=m.models.Command.extend({defaults:{id:"todo.asana.move.section.menu"},execute:function(e,t,i){return this.parentContext=i,!0},canExecute:function(e,t){return e.collection.parentList.get("allow_move")},getSubmenu:function(){var o=[],n=this,a=n.parentContext.selectedList().id;return this.parentContext.selectedProject().listCollection.map(function(e){var t=a.substring(0,a.lastIndexOf("-")),i=e.id.substring(0,e.id.lastIndexOf("-"));if(n.parentContext.selectedList().id!=e.id&&i==t){var s={};s.listId=e.id,s.captionText=e.get("title"),s.count=e.get("count"),o.push(s),s.commandId="todo.asana.move.section",s.options={target_id:e.id}}}),{title:null,items:new Backbone.Collection(o)}}}),m.commands.TodoAsanaMoveSection=m.models.Command.extend({defaults:{id:"todo.asana.move.section"},execute:function(e,t){var i={listId:t.target_id};e.attemptSave(i),m.trigger("todo:loadingStateChange",null)},canExecute:function(e,t){return t&&e.get("listId")!=t.target_id}}),m.commands.TodoGithubMoveSectionMenu=m.models.Command.extend({defaults:{id:"todo.github.move.section.menu"},execute:function(e,t,i){return this.parentContext=i,!0},canExecute:function(e,t){return e.collection.parentList.get("allow_move")},getSubmenu:function(){var o=[],n=this,a=n.parentContext.selectedList().id;return this.parentContext.selectedProject().listCollection.map(function(e){var t=a.substring(0,a.lastIndexOf("-")),i=e.id.substring(0,e.id.lastIndexOf("-"));if(n.parentContext.selectedList().id!=e.id&&i==t){var s={};s.listId=e.id,s.captionText=e.get("title"),s.count=e.get("count"),o.push(s),s.commandId="todo.github.move.section",s.options={target_id:e.id}}}),{title:null,items:new Backbone.Collection(o)}}}),m.commands.TodoGithubMoveSection=m.models.Command.extend({defaults:{id:"todo.github.move.section"},execute:function(e,t){var i={listId:t.target_id};e.attemptSave(i),m.trigger("todo:loadingStateChange",null)},canExecute:function(e,t){return!!t&&e.get("listId")!=t.target_id}}),m.commands.TodoMove=m.models.Command.extend({defaults:{id:"todo.move.id"},execute:function(e,t){var i=e.collection.parentList.collection.findWhere({id:t.target_id}),s={};e.collection.parentList.isTodayList()?m.utils.mergeObjects(s,e.getTodayStateChanges(!1)):e.collection.parentList.isDoneList()&&m.utils.mergeObjects(s,e.getDoneStateChanges(!1)),i.isTodayList()?m.utils.mergeObjects(s,e.getTodayStateChanges(!0)):i.isDoneList()&&m.utils.mergeObjects(s,e.getDoneStateChanges(!0)),i.isTodayList()||i.isDoneList()||m.utils.mergeObjects(s,{listId:t.target_id}),e.attemptSave(s),i.changeCount(!0),m.trigger("todo:loadingStateChange",null),setTimeout(function(){i.refreshItems()},200)},canExecute:function(e,t){return!!t&&e.get("listId")!=t.target_id}}),m.commands.TodoDoneAndArchive=m.models.Command.extend({defaults:{id:"todo.done.archive"},execute:function(e,t){e.setDoneState(!0,!0),e.collection.parentList.collection.findWhere({id:"1-done"}).changeCount(!0)},canExecute:function(e,t,i){return!i.selectedList().isDoneList()}}),m.commands.TodoToggleToday=m.models.Command.extend({defaults:{id:"todo.toggle.today"},execute:function(e,t,i){var s=!e.get("today");e.setTodayState(s),"today"!=e.collection.parentList.get("type")&&e.collection.parentList.collection.findWhere({type:"today"}).changeCount(s),"today"==e.collection.parentList.get("type")&&e.collection.parentList.collection.findWhere({id:e.get("homeListId")}).changeCount(!s)},canExecute:function(e,t,i){return!(e.collection.parentList.id==e.get("homeListId")&&e.get("today")||i.selectedList().isDoneList())},getProperties:function(e,t,i){var s=e.collection.parentList.collection.findWhere({id:e.get("homeListId")});return s?{captionText:"Move to "+(e.get("today")?s.get("title"):"Today")}:{captionText:null}}}),m.commands.TodoUnDone=m.models.Command.extend({defaults:{id:"todo.undone"},execute:function(e,t,i){e.get("archive");e.setDoneState(!1),e.collection.parentList.collection.findWhere({id:e.get("homeListId")}).changeCount(!0),m.trigger("todo:loadingStateChange",null)},canExecute:function(e,t,i){return i.selectedList().isDoneList()},getProperties:function(e,t,i){var s=e.collection.parentList.collection.findWhere({id:e.get("homeListId")});return s?{captionText:"Move to "+(e.get("today")?"Today":s.get("title"))}:{captionText:null}}}),m.commands.TodoArchive=m.models.Command.extend({defaults:{id:"todo.archive"},execute:function(e,t,i){e.get("archive");e.setArchiveState(!0),m.trigger("todolist:updateHeight")},canExecute:function(e,t,i){return!i.selectedList().isDoneList()&&e.get("done")}}),m.commands.TodoArchiveAlways=m.models.Command.extend({defaults:{id:"todo.archive.always"},execute:function(e,t,i){e.get("archive");e.setArchiveState(!0),m.trigger("todolist:updateHeight")},canExecute:function(e,t,i){return!0}}),m.commands.TodoDelete=m.models.Command.extend({defaults:{id:"todo.delete"},execute:function(t){t.collection.models.map(function(e){e.get("parentId")==t.get("id")&&e.deleteItem()}),t.deleteItem(),m.trigger("todo:loadingStateChange")},canExecute:function(e,t){return!0}}),m.commands.TodoMoveTo=m.models.Command.extend({defaults:{id:"todo.moveTo"},execute:function(e,t,i){return this.parentContext=i,!0},canExecute:function(e,t){return e.collection.parentList.get("allow_move")},getSubmenu:function(){var i=[],s=this;return this.parentContext.selectedProject().listCollection.map(function(e){if(s.parentContext.selectedList().id!=e.id){var t={};t.listId=e.id,t.captionText=e.get("title"),t.color=e.get("color"),t.count=e.get("count"),i.push(t),e.isDoneList()&&(t.commandId="todo.done.archive"),t.commandId||(t.commandId="todo.move.id"),t.options={target_id:e.id}}}),{title:null,items:new Backbone.Collection(i)}}}),m.commands.TodoSwitchFeed=m.models.Command.extend({defaults:{id:"todo.switch.feed"},execute:function(e,t,i){if(!(this.parentContext=i)){m.commandManager.execute("upsell.message",{targetRegion:"todos",sourceEvent:"integrations",buttonText:"Learn more",title:"Todo Integrations",description:"Sync your todos from other task managers with Momentum"})}return!0},canExecute:function(e,t){return!0},getSubmenu:function(){if(!this.parentContext)return null;var e=this.parentContext.selectedList().topMenuItems();return e.fetchIfRequired(this.parentContext.id),{title:null,items:e}}}),m.commands.TodoVisitExternal=m.models.Command.extend({defaults:{id:"todo.visit.external"},execute:function(e,t,i){var s=t.providerUrl;return t.urlField&&(s=e.get(t.urlField)||s),getBrowser().tabs.create({url:s}),!0}}),m.commands.TodoToggleAssignee=m.models.Command.extend({defaults:{id:"todo.toggle.assignee"},execute:function(e,t,i){var s="assigned-"+i.selectedList().id;m.models.customization.set(s,!m.models.customization.get(s)),m.trigger("toggleAssignee",s)}}),m.commands.ToggleAutoFocus=m.models.Command.extend({defaults:{id:"todo.toggle.autofocus"},execute:function(e){if(m.conditionalFeatures.featureEnabled("pinfocus"))return m.models.customization.toggle("autoFocus"),m.trigger("toggleAutoFocus",m.models.customization.get("autoFocus")),!0;m.commandManager.execute("upsell.message",{targetRegion:"todos",sourceEvent:"autofocus",buttonText:"Learn more",title:"Autofocus",description:"Automatically display your top to-do in the center of the screen"})}}),m.commands.TodoShowSettings=m.models.Command.extend({defaults:{id:"todo.show.settings"},execute:function(){m.commandManager.execute("settings.display",null,{section:"todo"})}}),m.commands.MenuIgnore=m.models.Command.extend({defaults:{id:"menu.ignore"},execute:function(e){return!0},canExecute:function(e,t){return!0}}),m.commands.TodoDeleteWarn=m.models.Command.extend({defaults:{id:"todo.delete.warn"},execute:function(e){return!0},canExecute:function(e,t){return!0},getSubmenu:function(){return{title:"Delete?",items:new Backbone.Collection([{captionText:"Yes",commandId:"todo.delete"},{captionText:"No",commandId:"menu.ignore",css_class:"dropdown-detail-back"}])}}}),m.commands.TodoFocusPin=m.models.Command.extend({defaults:{id:"todo.focus.pin"},execute:function(e){m.views.focuses.displayConnectingText('<i class="loading-icon"></i>Saving...',!0);var t=getActiveDateString(),i=e.collection.parentList.project,s={todoId:e.id,listId:e.get("listId"),projectId:e.get("projectId")||i.id,providerId:i.provider.id,forDate:t};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(s),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"focus/pin"}).done(function(e){e.success&&1==e.success&&(m.views.focuses.successfulConnection(),m.models.customization.getComputedSetting("autoFocus")?m.models.customization.set("autoFocus",!1):m.collect.focuses.fetch({reset:!0}))}).fail(function(e,t){})},canExecute:function(e,t){return!e.get("done")}}),m.commands.TodoRetryConnection=m.models.Command.extend({defaults:{id:"todo.connection.retry"},execute:function(e){m.models.todoListManager&&(m.models.todoListManager.doFetchIfNeeded(!0),m.models.todoListManager.activeProvider.refreshTodoItems())}}),m.commands.ToggleKeepTodoState=m.models.Command.extend({defaults:{id:"todo.toggle.keepstate"},execute:function(e){m.models.customization.toggle("keepTodoState"),m.models.customization.get("keepTodoState")||(localStorage.showTodoList=!1)}}),m.commands.EditTodo=m.models.Command.extend({defaults:{id:"todo.edit"},execute:function(e){e.trigger("todo:edit")}}),m.commands.CloseTodo=m.models.Command.extend({defaults:{id:"todo.close"},execute:function(e){e.trigger("todo:close")},canExecute:function(e,t){return!e.get("done")}}),m.commands.OpenTodo=m.models.Command.extend({defaults:{id:"todo.open"},execute:function(e){e.trigger("todo:open")},canExecute:function(e,t){return!!e.get("done")}}),m.commands.TodoListDefaultCommand=m.models.Command.extend({defaults:{id:"todo.list.defaultcommand"},execute:function(e,t){return t&&t.get("done")?{captionText:"Archive to Done",commandId:"todo.move.done"}:{captionText:"Move to Today",commandId:"todo.toggle.today",options:{}}}}),m.commands.TodoListArchiveAllDone=m.models.Command.extend({defaults:{id:"todo.list.archive"},execute:function(e,t){if(e&&!e.isDoneList()){var i=e.itemCollection.models;_.each(i,function(e){e.get("done")&&!e.get("archive")&&e.archive()}),m.trigger("globalEvent:closeDropdowns"),m.trigger("todolist:updateHeight")}},canExecute:function(e){if(e&&e.isDoneList())return!1;if(e)var t=e.itemCollection;return!!(t&&0<t.completedCount())}}),m.commands.TodoProviderChange=m.models.Command.extend({defaults:{id:"settings.todo.provider.change"},execute:function(e,t){t&&t.provider_id&&m.models.todoListManager.changeProvider(t.provider_id)},canExecute:function(e,t){return t.provider_id!=m.models.todoListManager.activeProvider.id}}),m.commands.TodoSwitchParentProject=m.models.Command.extend({defaults:{id:"todo.switch.parent.project"},execute:function(e,t){m.models.todoListManager.switchProject(t.projectId)},canExecute:function(e,t){return!0}}),m.commands.TodoListCheckStateAutofocus=m.models.Command.extend({defaults:{id:"todo.list.check.state.autofocus"},execute:function(){return m.models.customization.get("autoFocus")}}),m.commands.TodoListCheckStateAssigned=m.models.Command.extend({defaults:{id:"todo.list.check.state.assigned"},execute:function(e,t,i){if(e){var s=e.get("id");return!!m.models.customization.get("assigned-"+s)}}}),m.commands.TodoListCheckToggleAssigned=m.models.Command.extend({defaults:{id:"todo.list.toggle.assigned"},execute:function(e,t){var i=e.get("id"),s=m.models.customization.get("assigned-"+i);return m.models.customization.set("assigned-"+i,!s),!1}}),m.commands.TodoListCheckStateSubtasks=m.models.Command.extend({defaults:{id:"todo.list.check.state.subtasks"},execute:function(e,t,i){if(e){var s=e.get("id");return 1==m.models.customization.get("subtask-"+s)}}}),m.commands.TodoListToggleSubtasks=m.models.Command.extend({defaults:{id:"todo.list.toggle.subtasks"},execute:function(e,t){var i=e.get("id"),s=m.models.customization.get("subtask-"+i);return m.models.customization.set("subtask-"+i,!s),!1}}),m.commands.TodoListShowOldTasks=m.models.Command.extend({defaults:{id:"todo.list.show.old.todos"},execute:function(e,t,i){var s=e.get("id"),o=m.models.customization.get("showOld-"+s);return m.models.customization.set("showOld-"+s,!o),!1}}),m.commands.TodoListCheckStateOldTodos=m.models.Command.extend({defaults:{id:"todo.list.check.state.old.todos"},execute:function(e,t,i){if(e){var s=e.get("id");return 1==m.models.customization.get("showOld-"+s)}}}),m.commands.TodoShowArchivedProjects=m.models.Command.extend({defaults:{id:"todo.show.archived.projects"},execute:function(e,t,i){var s="archived-"+i.id,o=m.models.customization.get(s);(m.models.customization.save(s,!o),i.get("supportProjects"))?i.refreshAllProjects(!0):i.selectedProject().doFetchIfNeeded(!0);return!1}}),m.commands.TodoCheckStateArchivedProjects=m.models.Command.extend({defaults:{id:"todo.check.state.archived.projects"},execute:function(e,t,i){return 1==m.models.customization.get("archived-"+i.id)}}),m.commands.TodoTrelloAuxData=m.models.Command.extend({defaults:{id:"todo.trello.aux"},execute:function(e,t){var i={};return e.collection&&e.collection.parentList&&(i.showAssignedOnly=m.models.customization.get("assigned-"+e.collection.parentList.id)),i}}),m.commands.TodoTrelloOpenConfig=m.models.Command.extend({defaults:{id:"todo.trello.config"},execute:function(){m.commandManager.execute("settings.display",null,{section:"trello"})}}),m.commands.UpsellMessage=m.models.Command.extend({defaults:{id:"upsell.message"},execute:function(e){switch(e.targetRegion){case"settings":m.views.settings.mainSettings.showUpsell(e);break;case"todos":m.views.todoPane.showUpsell(e);break;case"weather":m.views.weather.showUpsell(e)}}}),m.commands.UpsellWebsite=m.models.Command.extend({defaults:{id:"upsell.website"},execute:function(e,t,i){var s="https://momentumdash.com/plus?utm_source=extension&utm_medium=organic";t&&t.source?s+="&utm_campaign="+encodeURIComponent(t.source):!t&&e&&e.source&&(s+="&utm_campaign="+encodeURIComponent(e.source)),m.commandManager.execute("window.open",null,{url:s})}}),m.isValidDate=function(e){return"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime())},function(e){e.fn.mFadeIn=function(e,t){e=void 0!==e?e:500,this.timeouts&&this.timeouts.forEach(function(e){clearTimeout(e)}),this.timeouts=[];var i=this;return this.addClass("m-hide"),this.removeClass("m-hide-display"),this.timeouts.push(setTimeout(function(){i.removeClass("m-hide-visibility m-hide")},10)),this.timeouts.push(setTimeout(function(){t&&t()},e+10)),this},e.fn.mFadeOut=function(e,t,i){e=void 0!==e?e:500,this.timeouts&&this.timeouts.forEach(function(e){clearTimeout(e)}),this.timeouts=[];var s=this;return this.addClass("m-hide"),this.timeouts.push(setTimeout(function(){t?s.addClass("m-hide-visibility"):s.addClass("m-hide-display"),i&&i()},e)),this},e.fn.mShow=function(){return this.removeClass("m-hide-display m-hide-visibility"),this},e.fn.mHide=function(e){return e?this.addClass("m-hide-visibility"):this.addClass("m-hide-display"),this}}(jQuery),m.models.Date=Backbone.Model.extend({defaults:function(){return{date:new Date}},initialize:function(){this.listenTo(this,"change:date",this.updateTime,this)},setUpdateTimer:function(){var e=this,t=6e4,i=new Date;t=t-1e3*i.getSeconds()-i.getMilliseconds(),this.dateTimeoutId=setTimeout(function(){e.set("date",new Date),e.setUpdateTimer()},t)},getTimeString:function(e){var t=m.models.customization.get("hour12clock"),i=(e=e||this.get("date")).getHours(),s=e.getMinutes();return 1==t&&(i=(i+11)%12+1),i<10&&!t&&(i="0"+i),s<10&&(s="0"+s),i+":"+s},getTimePeriod:function(){return 12<=this.get("date").getHours()?"PM":"AM"},updateTime:function(){var e=this.getTimeString();this.get("time")!=e&&this.set("time",e)}}),m.views.Dashboard=Backbone.View.extend({initialize:function(){var t=this;this.$loading=$('<span class="message-fill"><i class="loading-icon"></i> Loading...</span>'),m.models.themeManager=new m.models.ThemeManager,m.models.customization.fetch({error:function(){m.models.customization.save(),m.models.themeManager.initializeThemes()},success:function(){m.models.themeManager.initializeThemes()}}),this.listenTo(m,"processAddIns",this.processAddIns),m.models.backgroundManager=new m.models.BackgroundManager,m.views.background=new m.views.Background({region:"background"}),m.views.backgroundInfo=new m.views.BackgroundInfo({region:"bottom-left"}),m.models.backgroundManager.firstFetch(),m.models.notificationManager=new m.models.NotificationManager,m.bootstrappers.InitializeQuote(m,$),m.models.date&&m.models.date.setUpdateTimer(),this.newDayIntervalId=setInterval(function(){if(localStorage.activeDate){if(localStorage.activeDate!=getActiveDateString()){var e=9e3*Math.random()+1e3;setTimeout(function(){localStorage.activeDate=getActiveDateString(),m.trigger("newDay")},e)}}else localStorage.activeDate=getActiveDateString()},1e4),!m.models.customization.get("displayname")||localStorage.doLoginOnNextLoad?m.views.introduction=new m.views.Introduction({region:"full"}):(m.bootstrappers.InitializeFocus(m,$),this.render());var i=$("body");i.addClass(getBrowserName()),"Firefox"==getBrowserName()&&getBrowserVersion()<57&&i.addClass("oldFireFox"),m.conditionalFeatures.featureEnabled("custom-bg")&&!m.models.customization.get("disableDrop")&&(this.addEventHandler(document.body,"dragover",function(e){e.stopPropagation(),e.preventDefault(),_.contains(e.dataTransfer.types,"Files")?e.dataTransfer.dropEffect="copy":e.dataTransfer.dropEffect="none"}),window.addEventListener("dragenter",function(e){_.contains(e.dataTransfer.types,"Files")&&(t.lastTarget=e.target,i.addClass("blur show-drop"))}),window.addEventListener("dragleave",function(e){e.preventDefault(),e.target!==document&&e.target!==t.lastTarget||i.removeClass("blur show-drop")},!1),window.addEventListener("dragover",function(e){e.preventDefault()}),this.addEventHandler(document.body,"drop",function(e){if(e.stopPropagation(),e.preventDefault(),i.removeClass("blur show-drop"),_.contains(e.dataTransfer.types,"Files"))if(m.conditionalFeatures.featureEnabled("custom-bg")){var t=e.dataTransfer.files;t&&0<t.length&&m.commandManager.ensureCommandLoaded("background.custom.uploadfiles",function(){m.commandManager.execute("background.custom.uploadfiles",t)},null,function(e){})}else{m.commandManager.execute("upsell.message",{targetRegion:"settings",sourceEvent:"customBackgrounds-dropFiles",buttonText:"Learn more",title:"Custom Backgrounds",description:"Add your own backgrounds with Plus"})}})),this.initializeCompleted=!0},addEventHandler:function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent?e.attachEvent("on"+t,i):e["on"+t]=i},processAddIns:function(){var e=this;m.conditionalFeatures.featureEnabled("randomWidget")&&(m.models.genericMetric=new m.models.GenericMetric,m.views.genericMetric=new m.views.GenericMetric({model:m.models.genericMetric,region:"top-right",order:"append"}),m.widgets.push(m.views.genericMetric)),e.processAddInsIntervalId=setInterval(function(){e.initializeCompleted&&(clearInterval(e.processAddInsIntervalId),m.addinManager.processPending())},50)},render:function(e,t){this.renderedOnce||(this.renderedOnce=!0,m.bootstrappers.RenderQuote(m,$,e),m.bootstrappers.RenderFocus(m,$,e),m.views.backgroundInfo&&(m.views.backgroundInfo.parentReady(e),m.widgets.push(m.views.backgroundInfo)),m.views.settingsPane=new m.views.settings.SettingsPane({region:"bottom-left",order:"prepend"}),m.widgets.push(m.views.settingsPane),m.models.notificationManager.setParent(m.views.settingsPane),m.bootstrappers.RenderSearch(m,$),m.bootstrappers.RenderDashLinks(m,$),m.bootstrappers.RenderQuickLinks(m,$),m.bootstrappers.RenderBookmarks(m,$),m.views.greeting=new m.views.Greeting({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.greeting),m.views.centerClock=new m.views.CenterClock({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.centerClock),m.bootstrappers.RenderTodos(m,$),m.bootstrappers.RenderWeather(m,$),m.trigger("main-render-complete"),t&&t())},getViewById:function(t){var i=null;return _.each(m.widgets,function(e){e.el.id===t&&(i=e)}),i},removeView:function(t){_.each(m.widgets,function(e){e.el.id===t&&e.$el.fadeTo(500,0,function(){e.remove(),m.widgets.splice(m.widgets.indexOf(e),1)})})},removeAllViews:function(e){_.each(m.widgets,function(e){e&&e.$el.fadeTo(500,0,function(){e.remove()})}),m.widgets=[],_.delay(e,475)}}),$(function(){!function(){try{for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<1e3;i++)e+=t.charAt(Math.floor(Math.random()*t.length));localStorage.setItem("capacityTest",e),localStorage.removeItem("capacityTest")}catch(e){try{localStorage.removeItem("capacityTest");var s=Date.now()-1728e5,o=[],n=!1,a=null;for(i=0;i<localStorage.length;i++)n=!1,"last_cleanup"==(a=localStorage.key(i)).substring(0,12)&&(n=!0),"archived-"==a.substring(0,9)&&(n=!0),"fallback-"==a.substring(0,9)&&(n=!0),"listCache-"==a.substring(0,10)&&(n=!0),"font-"==a.substring(0,5)&&(n=!0),"image_displayed-"==a.substring(0,16)&&(n=!0),"weather-loc-"==a.substring(0,12)?n=!0:"ddl-bg-"==a.substring(0,7)?localStorage.getItem(a)<s&&(n=!0):"ddl-qt-"==a.substring(0,7)&&localStorage.getItem(a)<s&&(n=!0),n&&o.push(a);for(i=0;i<o.length;i++)localStorage.removeItem(o[i])}catch(e){}}}(),m.utils.setMomentumAuthHeader=setMomentumAuthHeader,m.utils.validateEmail=validateEmail,m.utils.getQueryParameter=getQueryParameter,m.utils.getActiveDateString=getActiveDateString,m.utils.activeDateStringForDate=activeDateStringForDate,m.utils.getDayName=getDayName,m.utils.getMonthName=getMonthName,m.utils.getDaysInMonth=getDaysInMonth,m.utils.dateDiffIntegerDays=dateDiffIntegerDays,m.utils.dateIsYesterday=dateIsYesterday,m.utils.dateIsToday=dateIsToday,m.utils.dateIsTomorrow=dateIsTomorrow,m.utils.dateIsInLast7d=dateIsInLast7d,m.utils.getFriendlyDate=getFriendlyDate,m.utils.formatYearRelative=formatYearRelative,m.utils.formatMonthDayRelative=formatMonthDayRelative,m.utils.getHoursMinsStr=getHoursMinsStr,m.utils.toUTC=toUTC,m.utils.toLocalTime=toLocalTime,m.utils.nightsBetween=nightsBetween,m.utils.dateAdd=dateAdd,m.utils.twoDigit=twoDigit,m.utils.captionFormatter=function(e){return e},m.utils.mergeObjects=function(e,t,i){for(var s in e=e||{},t)e[s]=i&&e[s]||t[s];return e},m.utils.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},m.utils.toTodaysTime=function(e){var t=new Date,i=e.indexOf(":"),s=e.substring(0,i);return s=12==s?0:s,t.setHours(parseInt(s)+("p"===e[e.length-2].toLowerCase()?12:0)),t.setMinutes(parseInt(e.substring(i+1,e.length-2))),t},m.utils.memberwiseCompareObject=function(e,t,i){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var s in e)if((!i||!_.contains(i,s))&&e.hasOwnProperty(s)){if(!t.hasOwnProperty(s))return!1;if(e[s]!==t[s]){if("object"!=typeof e[s])return!1;if(!Object.equals(e[s],t[s]))return!1}}for(s in t)if((!i||!_.contains(i,s))&&t.hasOwnProperty(s)&&!e.hasOwnProperty(s))return!1;return!0},m.models.date=new m.models.Date;m.models.customization=new m.models.ComputedSettings({id:1}),m.listenToOnce(m.models.customization,"initialized",function(){m.sendEvent("/dashboard.html?v="+m.globals.version,null,null,"pageview");var e="installed-"+m.globals.version;localStorage.getItem(e)||localStorage.setItem(e,!0),window.onblur=function(){m.trigger("globalEvent:windowBlur")},$(document).click(function(e){m.trigger("globalEvent:click",e)});var o=this;$(document).keyup(function(e){27==e.keyCode&&m.trigger("globalEvent:esc",e),32==e.keyCode&&o.focusingOnBg&&(o.focusingOnBg=!1,m.views.backgroundInfo.unfocusBg(),$(".background-info-title, .background-info-source").removeClass("hotkey-hover")),"Alt"==e.key&&m.trigger("globalEvent:altUp",e)}),$(document).keydown(function(e){if(9===e.keyCode&&"BODY"===document.activeElement.tagName){e.preventDefault();var t=$("#search-input");if(t.length)t.focus();else{var i=$("#focuses").find("input");i.length?i.focus():$("a:visible:first").focus()}}if(8==e.keyCode&&e.shiftKey&&e.metaKey&&m.trigger("globalEvent:metaBackspace",e),13==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaEnter",e),219==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaBracketLeft",e),221==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaBracketRight",e),78==e.keyCode&&e.ctrlKey&&m.trigger("globalEvent:ctrlN",e),70==e.keyCode&&e.altKey&&m.trigger("globalEvent:altF",e),76==e.keyCode&&e.altKey&&m.trigger("globalEvent:altL",e),e.altKey&&38==e.keyCode&&m.trigger("globalEvent:altArrowUp",e),e.altKey&&40==e.keyCode&&m.trigger("globalEvent:altArrowDown",e),!(e.ctrlKey||e.metaKey||e.altKey&&78!=e.keyCode||"INPUT"==document.activeElement.tagName||"TEXTAREA"==document.activeElement.tagName||1==document.activeElement.isContentEditable)){var s;if(76==e.keyCode)s="Quick Links";else if(70==e.keyCode)s="Focus";else if(84==e.keyCode)s="Todo";else if(83==e.keyCode)s="Search";else if(188==e.keyCode){if(e.metaKey)return;s="Settings"}else{if(67==e.keyCode&&isChrome())return s="Chrome Tab",m.sendEvent(s,"Hotkey"),void getBrowser().tabs.update({url:"chrome-search://local-ntp/local-ntp.html"});if(8==e.keyCode)m.trigger("globalEvent:key:backspace",e);else if(13==e.keyCode)m.trigger("globalEvent:key:enter",e);else if(32==e.keyCode){if(m.trigger("globalEvent:spacebar",e),m.views.todoPane&&m.views.todoPane.isHovered)return;o.focusingOnBg=!0,m.views.backgroundInfo.focusOnBg(),$(".background-info-title, .background-info-source").addClass("hotkey-hover")}else 38==e.keyCode?m.trigger("globalEvent:arrowUp",e):40==e.keyCode?m.trigger("globalEvent:arrowDown",e):37==e.keyCode?m.trigger("globalEvent:arrowLeft",e):65==e.keyCode?m.trigger("globalEvent:key:A",e):39==e.keyCode?m.trigger("globalEvent:arrowRight",e):78==e.keyCode&&e.shiftKey?m.trigger("globalEvent:key:shiftN",e):78!=e.keyCode||e.shiftKey||m.trigger("globalEvent:key:N",e)}87==e.keyCode?m.views.weather.togglePopup():66==e.keyCode?null!=getBrowser().topSites&&m.trigger("bookmarks:toggle",e):e.shiftKey&&191==e.keyCode&&m.commandManager.execute("settings.toggle",null,{section:"help"}),s&&(m.trigger("globalEvent:toggle"+s.replace(/\s+/g,"")),m.sendEvent(s,"Toggle Show","Hotkey"),e.preventDefault())}}),"safari"==m.globals.platform&&$("a").on("click",function(e){safari.self.tab.dispatchMessage("sendClick",{link:this.href,time:(new Date).getTime()})}),m.listenTo(m,"user:successfulLogout",function(){m.appView.removeAllViews(function(){m.appView=new m.views.Dashboard})}),m.addinManager=new m.models.AddinManager,m.commandManager=new m.CommandManager,m.settingsManager=new m.models.SettingsManager,m.widgetManager=new m.models.WidgetManager,m.appView=new m.views.Dashboard,$(window).resize(function(){m.trigger("globalEvent:window:resize")}),localStorage.client_uuid||$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({action:"registerClient"}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/client"}).done(function(e){e.client_uuid&&localStorage.client_uuid!=e.client_uuid&&(localStorage.client_uuid=e.client_uuid,m.trigger("client:id_created"))}).fail(function(e,t){}),m.syncCoordinator=new m.models.SyncCoordinator,window.addEventListener("storage",function(e){if("activeDate"==e.key&&e.oldValue!=e.newValue){var t=9e3*Math.random()+1e3;setTimeout(function(){m.trigger("newDay")},t)}}),localStorage.firstSynchronized&&m.trigger("sync:downloadIfNeeded"),m.syncCoordinator.syncSettings()}),m.models.customization.initializeSettings()});